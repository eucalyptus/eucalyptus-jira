{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"34922","self":"https://eucalyptus.atlassian.net/rest/api/2/issue/34922","key":"EUCA-10563","fields":{"issuetype":{"self":"https://eucalyptus.atlassian.net/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://eucalyptus.atlassian.net/secure/viewavatar?size=xsmall&avatarId=14803&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":14803},"timespent":null,"customfield_13100":null,"project":{"self":"https://eucalyptus.atlassian.net/rest/api/2/project/10000","id":"10000","key":"EUCA","name":"Eucalyptus","avatarUrls":{"48x48":"https://eucalyptus.atlassian.net/secure/projectavatar?pid=10000&avatarId=10011","24x24":"https://eucalyptus.atlassian.net/secure/projectavatar?size=small&pid=10000&avatarId=10011","16x16":"https://eucalyptus.atlassian.net/secure/projectavatar?size=xsmall&pid=10000&avatarId=10011","32x32":"https://eucalyptus.atlassian.net/secure/projectavatar?size=medium&pid=10000&avatarId=10011"}},"customfield_11000":null,"customfield_11001":null,"fixVersions":[],"aggregatetimespent":null,"customfield_10310":null,"resolution":null,"customfield_11401":null,"customfield_10311":null,"customfield_11400":null,"customfield_10500":{"self":"https://eucalyptus.atlassian.net/rest/api/2/customFieldOption/10403","value":"Not Applicable","id":"10403"},"customfield_10302":null,"customfield_10104":["com.atlassian.greenhopper.service.sprint.Sprint@23e67f15[id=126,rapidViewId=92,state=CLOSED,name=4.2.0 Sprint 8,goal=<null>,startDate=2015-07-24T17:18:30.088Z,endDate=2015-08-14T17:18:00.000Z,completeDate=2015-08-19T20:57:28.154Z,sequence=126]","com.atlassian.greenhopper.service.sprint.Sprint@4cc50719[id=127,rapidViewId=92,state=CLOSED,name=4.2.0 Sprint 9,goal=<null>,startDate=2015-08-18T21:33:50.479Z,endDate=2015-09-08T21:33:00.000Z,completeDate=2015-09-11T20:28:07.867Z,sequence=127]","com.atlassian.greenhopper.service.sprint.Sprint@715520b3[id=128,rapidViewId=92,state=CLOSED,name=4.2.0 Sprint 10,goal=<null>,startDate=2015-09-09T20:38:52.383Z,endDate=2015-10-02T20:38:00.000Z,completeDate=2015-11-03T02:34:19.117Z,sequence=128]"],"customfield_10303":null,"customfield_10105":null,"customfield_10700":null,"customfield_10304":null,"customfield_10701":null,"customfield_10702":null,"customfield_10306":{"self":"https://eucalyptus.atlassian.net/rest/api/2/customFieldOption/10200","value":"High","id":"10200"},"customfield_10703":null,"customfield_10704":null,"customfield_10308":null,"resolutiondate":null,"customfield_10705":null,"customfield_10309":null,"workratio":-1,"lastViewed":null,"watches":{"self":"https://eucalyptus.atlassian.net/rest/api/2/issue/EUCA-10563/watchers","watchCount":6,"isWatching":false},"created":"2015-02-17T18:52:50.147-0600","customfield_12000":null,"priority":{"self":"https://eucalyptus.atlassian.net/rest/api/2/priority/3","iconUrl":"https://eucalyptus.atlassian.net/images/icons/priorities/major.svg","name":"Major","id":"3"},"customfield_12400":null,"customfield_12201":null,"customfield_10102":null,"customfield_12600":"{}","customfield_10300":null,"customfield_10301":null,"labels":[],"customfield_11700":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[{"self":"https://eucalyptus.atlassian.net/rest/api/2/version/14301","id":"14301","description":"Eucalyptus 4.1.0","name":"4.1.0","archived":false,"released":true,"releaseDate":"2015-01-29"}],"customfield_11901":null,"issuelinks":[],"assignee":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=vasya","name":"vasya","key":"vasya","accountId":"557058:1c63481a-0634-4ae7-9004-cb0f143e141f","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/fa832ffa4e20c9aa05ac272214d43196?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dvasya%26avatarId%3D10408%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/fa832ffa4e20c9aa05ac272214d43196?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dvasya%26avatarId%3D10408%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/fa832ffa4e20c9aa05ac272214d43196?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dvasya%26avatarId%3D10408%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/fa832ffa4e20c9aa05ac272214d43196?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dvasya%26avatarId%3D10408%26noRedirect%3Dtrue"},"displayName":"Vasiliy Kochergin","active":false,"timeZone":"America/Los_Angeles"},"updated":"2016-05-24T12:20:46.037-0500","status":{"self":"https://eucalyptus.atlassian.net/rest/api/2/status/10001","description":"This issue has been validated/reproduced, but has not been prioritized yet.","iconUrl":"https://eucalyptus.atlassian.net/images/icons/statuses/generic.png","name":"Confirmed","id":"10001","statusCategory":{"self":"https://eucalyptus.atlassian.net/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://eucalyptus.atlassian.net/rest/api/2/component/10014","id":"10014","name":"Storage Controller"}],"timeoriginalestimate":null,"description":"The runTask method as it is currently written can return incorrect data when executing a command against a SAN. For reference:\r\n\r\n{code}\r\n\t\t\tpublic String runTask( final AbstractSANTask task ) throws InterruptedException {\r\n\t\t\t\tString returnValue = \"\";\r\n\t\t\t\tif ( !connected ) {\r\n\t\t\t\t\ttimingMap.put( \"begin\", System.currentTimeMillis( ) );\r\n\t\t\t\t\tinit( );\r\n\t\t\t\t\ttimingMap.put( \"connect\", System.currentTimeMillis() );\r\n\t\t\t\t}\r\n\t\t\t\tif ( !connected ) return returnValue;\r\n\t\t\t\ttimingMap.put( \"pre-task-\" + taskNumber, System.currentTimeMillis( ) );\r\n\t\t\t\ttry {\r\n\t\t\t\t\twriter.write(\"\" + task.getCommand() + task.getEOFCommand());\r\n\t\t\t\t\twriter.flush();\r\n\t\t\t\t\tfor (String line = null; (line = reader.readLine()) != null;) {\r\n\t\t\t\t\t\tline = line + \"\\r\";\r\n\t\t\t\t\t\tif(line.contains(\"\" + task.getEOFCommand()))\r\n\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\treturnValue += line;\r\n\t\t\t\t\t}\r\n\t\t\t\t} catch (IOException e) {\r\n\t\t\t\t\tLOG.error(e, e);\r\n\t\t\t\t} finally {\r\n\t\t\t\t\ttimingMap.put( \"task-\" + taskNumber, System.currentTimeMillis( ) );\r\n\t\t\t\t\ttaskNumber++;\r\n\t\t\t\t}\r\n\t\t\t\treturn returnValue;\r\n\t\t\t}\r\n{code}\r\n\r\nFrom this code we can tell that if we aren't connected to the SAN, it will return an empty string. Also if there is an IOError, it will return a (possibly) empty string.\r\n\r\nThis leads to the following code, where it is hard to tell if the SAN is connected or is actually returning an empty string, in this case, does the chapuser exist or not:\r\n{code}\r\n                     // Check if the chap user exists on SAN by asking for password\r\n                        returnValue = execFastCommand(\"chapuser show \" + userName);\r\n\r\n                        /// execFastcommand called sessionManager.runTask()..\r\n                        /// is returnValue == \"\" because it really is, or because it isn't connected?\r\n                        password = matchPattern(returnValue, USER_SHOW_PATTERN);\r\n\r\n                        if (password != null) { // Chap user exists on SAN\r\n                                password = password.trim();\r\n                        } else { // Chap user does not exist, create the user on SAN\r\n\r\n                                /// password is null (possibly because it isn't connected)\r\n                                /// now we try to create the user, because it doesn't exist... or does it?\r\n                                returnValue = execFastCommand(\"chapuser create \" + userName);\r\n                                password = matchPattern(returnValue, USER_CREATE_PATTERN);\r\n                                if (password != null) {\r\n                                        password = password.trim();\r\n                                } else {\r\n                                        throw new EucalyptusCloudException(\"Unable to create CHAP user \" + userName);\r\n                                }\r\n                        }\r\n{code}\r\n\r\nThis error has been seen in the wild, and it leads to difficult debugging because it isn't clear why the pattern match could be failing. It would be much clearer if runTask() threw some sort of SANNotConnectedError() so that we can easily tell that the command failed to run. And we shouldn't be trying to create a user on the SAN, unless we *really* know the user doesn't exist, or performing other actions. \r\n\r\nFull stack trace of the CHAP user issue above:\r\n{code}\r\nFri Feb 13 12:29:30 2015 ERROR [EquallogicProvider:Eucalyptus.bootstrap:EphemeralConfiguration:arn:euca:bootstrap:Topology::external/.class java.util.concurrent.ThreadPoolExecutor$Worker#17] Failed to add chap user chapluser\r\ncom.eucalyptus.util.EucalyptusCloudException: Unable to create CHAP user chapluser\r\n        at com.eucalyptus.blockstorage.san.equallogic.EquallogicProvider.addUser(EquallogicProvider.java:499)\r\n        at com.eucalyptus.blockstorage.san.equallogic.EquallogicProvider.checkConnection(EquallogicProvider.java:181)\r\n        at com.eucalyptus.blockstorage.san.common.SANManager.checkReady(SANManager.java:949)\r\n        at com.eucalyptus.blockstorage.BlockStorageController.check(BlockStorageController.java:236)\r\n        at com.eucalyptus.blockstorage.bootstrap.BlockStorageBootstrapper.check(BlockStorageBootstrapper.java:153)\r\n        at com.eucalyptus.component.Component$ComponentBootstrapper$BootstrapperTransition$7.runBootstrapper(Component.java:725)\r\n        at com.eucalyptus.component.Component$ComponentBootstrapper$BootstrapperTransition.apply(Component.java:734)\r\n        at com.eucalyptus.component.Component$ComponentBootstrapper$BootstrapperTransition$7.apply(Component.java:722)\r\n        at com.eucalyptus.component.Component$ComponentBootstrapper.doTransition(Component.java:640)\r\n        at com.eucalyptus.component.Component$ComponentBootstrapper.doTransition(Component.java:627)\r\n        at com.eucalyptus.component.Component$ComponentBootstrapper.check(Component.java:773)\r\n        at com.eucalyptus.component.ServiceTransitions$ServiceLocalTransitionCallbacks$3.fire(ServiceTransitions.java:626)\r\n        at com.eucalyptus.component.ServiceTransitions.processTransition(ServiceTransitions.java:360)\r\n        at com.eucalyptus.component.ServiceTransitions.access$000(ServiceTransitions.java:123)\r\n        at com.eucalyptus.component.ServiceTransitions$TransitionActions.leave(ServiceTransitions.java:412)\r\n        at com.eucalyptus.component.ServiceTransitions$TransitionActions.leave(ServiceTransitions.java:379)\r\n        at com.eucalyptus.util.fsm.TransitionImpl.leave(TransitionImpl.java:218)\r\n        at com.eucalyptus.util.fsm.AtomicMarkedState$ActiveTransition.leave(AtomicMarkedState.java:524)\r\n        at com.eucalyptus.util.fsm.AtomicMarkedState.afterLeave(AtomicMarkedState.java:342)\r\n        at com.eucalyptus.util.fsm.AtomicMarkedState.transition(AtomicMarkedState.java:185)\r\n        at com.eucalyptus.component.ServiceState.transition(ServiceState.java:136)\r\n        at com.eucalyptus.component.ServiceState.transition(ServiceState.java:83)\r\n        at com.eucalyptus.util.fsm.Automata$1.call(Automata.java:141)\r\n        at com.eucalyptus.util.fsm.Automata$1.call(Automata.java:126)\r\n        at com.eucalyptus.component.ServiceTransitions.executeTransition(ServiceTransitions.java:317)\r\n        at com.eucalyptus.component.ServiceTransitions.pathTo(ServiceTransitions.java:183)\r\n        at com.eucalyptus.component.Topology$TopologyChange.doTopologyChange(Topology.java:1297)\r\n        at com.eucalyptus.component.Topology$TopologyChange.apply(Topology.java:1288)\r\n        at com.eucalyptus.component.Topology$Transitions.apply(Topology.java:1260)\r\n        at com.eucalyptus.component.Topology$Transitions$3.apply(Topology.java:1238)\r\n        at com.eucalyptus.component.Topology$Transitions$3.apply(Topology.java:1229)\r\n        at com.eucalyptus.component.Topology$8.call(Topology.java:1139)\r\n        at com.eucalyptus.component.Topology$8.call(Topology.java:1127)\r\n        at java.util.concurrent.FutureTask.run(FutureTask.java:262)\r\n        at com.eucalyptus.system.Threads$Queue$EucaFutureTask.run(Threads.java:695)\r\n        at com.eucalyptus.system.Threads$Queue.run(Threads.java:752)\r\n        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471)\r\n        at java.util.concurrent.FutureTask.run(FutureTask.java:262)\r\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\r\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\r\n        at java.lang.Thread.run(Thread.java:745)\r\nFri Feb 13 12:29:30 2015 ERROR [Component:Eucalyptus.bootstrap:EphemeralConfiguration:arn:euca:bootstrap:Topology::external/.class java.util.concurrent.ThreadPoolExecutor$Worker#17] java.lang.RuntimeException: Unable to create CHAP user chapluser\r\n{code}","customfield_13000":null,"customfield_13200":null,"customfield_11300":null,"customfield_11500":null,"timetracking":{},"customfield_10005":null,"customfield_10401":null,"customfield_10600":null,"customfield_12900":null,"aggregatetimeestimate":null,"attachment":[],"summary":"ShellSessionManager.TaskRunner.runTask() should throw an error on connection failures.","creator":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=sgraham","name":"sgraham","key":"sgraham","accountId":"557058:dab30ab9-44e7-4b70-a841-8b188c40edfc","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/a40e2a7b21096d27f2427d53d5f45fbf?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dsgraham%26avatarId%3D18000%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/a40e2a7b21096d27f2427d53d5f45fbf?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dsgraham%26avatarId%3D18000%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/a40e2a7b21096d27f2427d53d5f45fbf?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dsgraham%26avatarId%3D18000%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/a40e2a7b21096d27f2427d53d5f45fbf?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dsgraham%26avatarId%3D18000%26noRedirect%3Dtrue"},"displayName":"Steven Graham","active":true,"timeZone":"US/Central"},"subtasks":[],"reporter":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=sgraham","name":"sgraham","key":"sgraham","accountId":"557058:dab30ab9-44e7-4b70-a841-8b188c40edfc","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/a40e2a7b21096d27f2427d53d5f45fbf?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dsgraham%26avatarId%3D18000%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/a40e2a7b21096d27f2427d53d5f45fbf?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dsgraham%26avatarId%3D18000%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/a40e2a7b21096d27f2427d53d5f45fbf?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dsgraham%26avatarId%3D18000%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/a40e2a7b21096d27f2427d53d5f45fbf?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dsgraham%26avatarId%3D18000%26noRedirect%3Dtrue"},"displayName":"Steven Graham","active":true,"timeZone":"US/Central"},"customfield_12100":"0|i001e1:","customfield_10000":null,"aggregateprogress":{"progress":0,"total":0},"customfield_10001":"2015-05-23T14:54:11.724-0500","customfield_10200":null,"customfield_10002":[{"self":"https://eucalyptus.atlassian.net/rest/api/2/customFieldOption/10000","value":"Customer Affecting","id":"10000"}],"customfield_10003":null,"customfield_12500":null,"customfield_10400":null,"customfield_10116":null,"customfield_11600":["jgallucci32(jgallucci32)","sgraham(sgraham)","vasya(vasya)"],"environment":null,"customfield_10117":null,"customfield_11800":null,"customfield_11802":null,"duedate":null,"customfield_11805":null,"customfield_11806":null,"progress":{"progress":0,"total":0},"votes":{"self":"https://eucalyptus.atlassian.net/rest/api/2/issue/EUCA-10563/votes","votes":0,"hasVoted":false},"comment":{"comments":[{"self":"https://eucalyptus.atlassian.net/rest/api/2/issue/34922/comment/86867","id":"86867","author":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=jgallucci32","name":"jgallucci32","key":"jgallucci32","accountId":"557058:1cd98ee4-b2ee-4683-a315-2a6abd75b048","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/31cfdf964a6ac26962c22f3279e2c85c?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FavatarId%3D10122%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/31cfdf964a6ac26962c22f3279e2c85c?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26avatarId%3D10122%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/31cfdf964a6ac26962c22f3279e2c85c?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26avatarId%3D10122%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/31cfdf964a6ac26962c22f3279e2c85c?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26avatarId%3D10122%26noRedirect%3Dtrue"},"displayName":"John Gallucci","active":true,"timeZone":"America/Los_Angeles"},"body":"I am able to confirm this situation and exact error message.  I logged into the EQL and was able to confirm that the SC did in fact create the chap user with a random password. This indicates that the commands are being executed, but something in the code isn't connecting correctly to confirm.\r\n\r\nMy suspicion is that there is a specific version of the firmware required for compatibility.  The documents say it only has to be a PS6000 series array, however, we are running older firmware, V5.2.2, and it is possible the code is being written against a newer CLI.  I haven't yet received a confirmation on what specific firmware version is required for EQL and Eucalyptus.","updateAuthor":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=jgallucci32","name":"jgallucci32","key":"jgallucci32","accountId":"557058:1cd98ee4-b2ee-4683-a315-2a6abd75b048","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/31cfdf964a6ac26962c22f3279e2c85c?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FavatarId%3D10122%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/31cfdf964a6ac26962c22f3279e2c85c?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26avatarId%3D10122%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/31cfdf964a6ac26962c22f3279e2c85c?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26avatarId%3D10122%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/31cfdf964a6ac26962c22f3279e2c85c?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26avatarId%3D10122%26noRedirect%3Dtrue"},"displayName":"John Gallucci","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-05-23T14:54:11.724-0500","updated":"2015-05-23T14:54:11.724-0500"}],"maxResults":1,"total":1,"startAt":0},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_11808":null}}