{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"34541","self":"https://eucalyptus.atlassian.net/rest/api/2/issue/34541","key":"EUCA-10515","fields":{"issuetype":{"self":"https://eucalyptus.atlassian.net/rest/api/2/issuetype/10301","id":"10301","description":"","iconUrl":"https://eucalyptus.atlassian.net/secure/viewavatar?size=xsmall&avatarId=14911&avatarType=issuetype","name":"Spike","subtask":false,"avatarId":14911},"timespent":null,"customfield_13100":null,"project":{"self":"https://eucalyptus.atlassian.net/rest/api/2/project/10000","id":"10000","key":"EUCA","name":"Eucalyptus","avatarUrls":{"48x48":"https://eucalyptus.atlassian.net/secure/projectavatar?pid=10000&avatarId=10011","24x24":"https://eucalyptus.atlassian.net/secure/projectavatar?size=small&pid=10000&avatarId=10011","16x16":"https://eucalyptus.atlassian.net/secure/projectavatar?size=xsmall&pid=10000&avatarId=10011","32x32":"https://eucalyptus.atlassian.net/secure/projectavatar?size=medium&pid=10000&avatarId=10011"}},"customfield_11000":null,"customfield_11001":null,"fixVersions":[{"self":"https://eucalyptus.atlassian.net/rest/api/2/version/17801","id":"17801","description":"Eucalyptus 5.0.0","name":"5.0.0","archived":false,"released":false}],"aggregatetimespent":null,"resolution":{"self":"https://eucalyptus.atlassian.net/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_10310":null,"customfield_11401":null,"customfield_10311":null,"customfield_11400":null,"customfield_10104":[],"customfield_10303":null,"customfield_10105":null,"customfield_10700":null,"customfield_10304":null,"customfield_10701":null,"customfield_10306":null,"customfield_10702":null,"customfield_10703":null,"customfield_10704":null,"customfield_10308":null,"resolutiondate":"2016-08-31T18:16:33.372-0500","customfield_10705":null,"customfield_10309":null,"workratio":-1,"watches":{"self":"https://eucalyptus.atlassian.net/rest/api/2/issue/EUCA-10515/watchers","watchCount":2,"isWatching":false},"lastViewed":null,"created":"2015-02-03T13:06:29.636-0600","customfield_12000":null,"customfield_12400":null,"priority":{"self":"https://eucalyptus.atlassian.net/rest/api/2/priority/3","iconUrl":"https://eucalyptus.atlassian.net/images/icons/priorities/major.svg","name":"Major","id":"3"},"customfield_12201":null,"customfield_10102":null,"customfield_12600":"{}","labels":[],"customfield_11700":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_11901":null,"versions":[],"issuelinks":[],"assignee":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=ethomas","name":"ethomas","key":"ethomas","accountId":"557058:8f092f9a-0724-44c0-84a3-0220705f856a","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/a01d066493c57e5dee4b94dc87395576?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FavatarId%3D10122%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/a01d066493c57e5dee4b94dc87395576?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26avatarId%3D10122%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/a01d066493c57e5dee4b94dc87395576?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26avatarId%3D10122%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/a01d066493c57e5dee4b94dc87395576?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26avatarId%3D10122%26noRedirect%3Dtrue"},"displayName":"Evan Thomas","active":false,"timeZone":"America/Los_Angeles"},"updated":"2016-11-04T10:46:41.858-0500","status":{"self":"https://eucalyptus.atlassian.net/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://eucalyptus.atlassian.net/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://eucalyptus.atlassian.net/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://eucalyptus.atlassian.net/rest/api/2/component/13600","id":"13600","name":"SQS"}],"timeoriginalestimate":null,"customfield_13000":null,"description":"Comcast CMB is a message bus product that implements the SQS (and SNS) protocols from Amazon.  We would like to analyze this product, and see what components are used: network, persistence, etc, to better inform our own design going forward.  The analysis does not need to contain every single detail of the product, just enough to get a general idea of its design.  This is for the SQS component only.","customfield_13200":null,"customfield_11300":"EUCA-10344","customfield_11500":null,"timetracking":{},"customfield_10401":null,"customfield_10600":null,"customfield_12900":null,"attachment":[],"aggregatetimeestimate":null,"summary":"SQS: Investigate CMB","creator":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=ethomas","name":"ethomas","key":"ethomas","accountId":"557058:8f092f9a-0724-44c0-84a3-0220705f856a","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/a01d066493c57e5dee4b94dc87395576?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FavatarId%3D10122%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/a01d066493c57e5dee4b94dc87395576?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26avatarId%3D10122%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/a01d066493c57e5dee4b94dc87395576?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26avatarId%3D10122%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/a01d066493c57e5dee4b94dc87395576?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26avatarId%3D10122%26noRedirect%3Dtrue"},"displayName":"Evan Thomas","active":false,"timeZone":"America/Los_Angeles"},"subtasks":[],"reporter":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=ethomas","name":"ethomas","key":"ethomas","accountId":"557058:8f092f9a-0724-44c0-84a3-0220705f856a","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/a01d066493c57e5dee4b94dc87395576?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FavatarId%3D10122%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/a01d066493c57e5dee4b94dc87395576?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26avatarId%3D10122%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/a01d066493c57e5dee4b94dc87395576?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26avatarId%3D10122%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/a01d066493c57e5dee4b94dc87395576?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26avatarId%3D10122%26noRedirect%3Dtrue"},"displayName":"Evan Thomas","active":false,"timeZone":"America/Los_Angeles"},"customfield_10000":"1_*:*_1_*:*_94500_*|*_3_*:*_1_*:*_49694909248_*|*_5_*:*_1_*:*_0","aggregateprogress":{"progress":0,"total":0},"customfield_12100":"0|i0339j:","customfield_10001":null,"customfield_10200":null,"customfield_10002":null,"customfield_10003":null,"customfield_12500":null,"customfield_10400":null,"customfield_11600":["ethomas(ethomas)"],"customfield_10116":null,"customfield_10117":null,"environment":null,"customfield_11800":null,"customfield_11802":null,"customfield_11805":null,"duedate":null,"customfield_11806":null,"progress":{"progress":0,"total":0},"votes":{"self":"https://eucalyptus.atlassian.net/rest/api/2/issue/EUCA-10515/votes","votes":0,"hasVoted":false},"comment":{"comments":[{"self":"https://eucalyptus.atlassian.net/rest/api/2/issue/34541/comment/109815","id":"109815","author":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=ethomas","name":"ethomas","key":"ethomas","accountId":"557058:8f092f9a-0724-44c0-84a3-0220705f856a","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/a01d066493c57e5dee4b94dc87395576?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FavatarId%3D10122%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/a01d066493c57e5dee4b94dc87395576?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26avatarId%3D10122%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/a01d066493c57e5dee4b94dc87395576?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26avatarId%3D10122%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/a01d066493c57e5dee4b94dc87395576?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26avatarId%3D10122%26noRedirect%3Dtrue"},"displayName":"Evan Thomas","active":false,"timeZone":"America/Los_Angeles"},"body":"The analysis below is sufficient for Sprint 1.\r\n\r\nCMB consists of CMB nodes (embedded jetty and netty java application), a Cassandra ring, and a sharded Redis cluster.\r\n\r\nThe CMB node application uses Servlets to serve up AWS style REST requests.  \r\n\r\nUsers are stored in a Cassandra table.   ‘CMB/Users’ (I have not looked at this part much)  Fields include ‘key’, ‘accessKey’,’accessSecret’,description, ’hashPassword’,’userId’,’isAdmin’.  This is not something we will need to use.\r\n\r\nCMB has a Netty Server Listener called ‘LongPollReceiver’.  This is used to receive requests from other CMB nodes (Netty client: ‘LongPollSender’) to perform some cache loading when messages are sent, or a ‘receiveMessage’ API call is made.\r\n\r\nCMB uses the asynchronous model Servlet (3.0) to handle certain actions, such as receiveMessage during long polling.  A list of CQS Servers exists in the Cassandra table “CQS/CQSAPIServers”.  Work is done to ping servers and such.\r\n\r\n \r\n\r\nCassandra is used to store Queues.  There is a table ‘CQS/CQSQueues’ which nominally has the following columns: key, arn, createdTime, delaySeconds, maxMsgSize, msgRetentionPeriod, name, ownerUserId, policy, region, and VisibilityTO.  Because THRIFT (old Cassandra API) allows arbitrary fields in a table,\r\n\r\nThere is also a CQS/CQSQueuesByUserId table in Cassandra, which is used to ListQueue by users,  This has fields ‘key’, ‘column1’, ‘value’.  (The names are weird as this is looking at a CQL3 schema when it was originally a Thrift type design.  More details below). This maps how you think it would.\r\n\r\nIt is necessary as Cassandra only allows queries against indexed fields or partition/cluster keys.\r\n\r\nCassandra is also used to store Queue Messages.   Messages have a ‘partition’  (representing the Cassandra ‘row’), and a ‘shard (representing which Redis node will store the cache info about this message).  The table used here is CQS/CQSPartitionedMessage.\r\n\r\nEssentially the only fields are the row key, which is the queue_arn + shard + partition, and two more columns, one that kind of represents a timestamp for message creation (high bits are timestamp, one bit for ‘hidden’ (not used currently), and bottom 20 for internal sequence num).  There is another long for a machine unique UUIDGen.getClockSeqAndNode(), which is the same for the duration of a vm run, I think.  There is also a text field for the message body and attributes which is stored in JSON.  When a message is created, it is given a random partition and shard.\r\n\r\nRedis is used to store queue caches.  Queue caches essentially use a zset, which is a ranged set.  That is, think of a named set, which is the set name, consisting of several values, each of which has a numeric weight.  In this case, redis uses the queue_arn + shard as the zset ‘name’.  This represents cached messages for a particular queue, shard.  The weight is the timestamp of when a message will become visible, and the value is the message id.  As such, redis caches a bunch of message ids based on expiration time.  When visibility timeout is set on a queue, all of the weights are pushed forward, making the messages visible later.  No changes are ever made (to my knowledge) at the Cassandra layer.  Redis is also used to store cache state (i.e. if it is being filled, etc) and for concurrency checking.\r\n\r\nWhen receive messages is called, one of the shards randomly is chosen to look for messages.  It will most likely have previously been cached from messages in Cassandra.  Message ids whose weight are between NOW – queueRetentitionPeriod and NOW are returned.  Cassandra messages are then all looked up by id.  Both redis and Cassandra use TTL extensively to purge messages that have expired.\r\n\r\nI have not looked at how IAM policy stuff is implemented yet, nor CNS.\r\n\r\nThere are also a couple of peculiarities to consider.\r\n\r\n \r\n\r\nOne final thing.  For Cassandra, the original model did not look like a relational ‘table’, with fixed column names and rows, but arbitrary collections of ‘columns’  (key/value pairs) grouped together by a row ‘key’.  If all ‘rows’ had some common fields (not necessarily used by every row), they could be indicated in the schema definition.  The API used in this model was called THRIFT, and CMB uses it extensively.  The two java client drivers that were used by CMB are Apache Hector, and Netflix Astyanax.   Recently, however, (I think with Cassandra 1.2 and beyond, but especially 3.0 and beyond) THRIFT has been deprecated, and CQL3 has been introduced, which looks a lot more like a relational model.  Now, any ‘column’ used in a row has to have its name predefined in the schema  (alter table can be done after table creation).  Not all rows have to have values defined for every column, but the total list of columns must be defined.  To make this more extensible, collection data types are allowed.  DataStax java driver is now the preferred driver for Cassandra 3.0 and above.  According to O’Reilly’s ‘Cassandra, The Definitive Guide: Second Edition’: Hector is no longer Active, and Astyanax was retired in February 2016).  CMB has persistence layer implementations in both Hector and Astyanax, but both also use the THRIFT API.  The THRIFT API is now ‘off’ by default in Cassandra 3.0 and above and is slated to be removed entirely in an upcoming version.  As such, we will need to tweak the Cassandra model a bit.\r\n\r\n \r\n\r\n \r\n\r\n \r\n","updateAuthor":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=ethomas","name":"ethomas","key":"ethomas","accountId":"557058:8f092f9a-0724-44c0-84a3-0220705f856a","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/a01d066493c57e5dee4b94dc87395576?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FavatarId%3D10122%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/a01d066493c57e5dee4b94dc87395576?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26avatarId%3D10122%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/a01d066493c57e5dee4b94dc87395576?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26avatarId%3D10122%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/a01d066493c57e5dee4b94dc87395576?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26avatarId%3D10122%26noRedirect%3Dtrue"},"displayName":"Evan Thomas","active":false,"timeZone":"America/Los_Angeles"},"created":"2016-08-31T18:16:21.514-0500","updated":"2016-08-31T18:16:21.514-0500"}],"maxResults":1,"total":1,"startAt":0},"customfield_11808":null,"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]}}}