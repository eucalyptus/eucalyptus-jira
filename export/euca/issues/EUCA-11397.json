{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"38256","self":"https://eucalyptus.atlassian.net/rest/api/2/issue/38256","key":"EUCA-11397","fields":{"issuetype":{"self":"https://eucalyptus.atlassian.net/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://eucalyptus.atlassian.net/secure/viewavatar?size=xsmall&avatarId=14803&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":14803},"timespent":null,"customfield_13100":null,"project":{"self":"https://eucalyptus.atlassian.net/rest/api/2/project/10000","id":"10000","key":"EUCA","name":"Eucalyptus","avatarUrls":{"48x48":"https://eucalyptus.atlassian.net/secure/projectavatar?pid=10000&avatarId=10011","24x24":"https://eucalyptus.atlassian.net/secure/projectavatar?size=small&pid=10000&avatarId=10011","16x16":"https://eucalyptus.atlassian.net/secure/projectavatar?size=xsmall&pid=10000&avatarId=10011","32x32":"https://eucalyptus.atlassian.net/secure/projectavatar?size=medium&pid=10000&avatarId=10011"}},"customfield_11000":null,"customfield_11001":null,"fixVersions":[],"aggregatetimespent":null,"customfield_10310":[{"self":"https://eucalyptus.atlassian.net/rest/api/2/customFieldOption/10211","value":"RHEL 6","id":"10211"}],"resolution":null,"customfield_11401":null,"customfield_10311":[{"self":"https://eucalyptus.atlassian.net/rest/api/2/customFieldOption/11500","value":"Edge","id":"11500"}],"customfield_11400":null,"customfield_10500":{"self":"https://eucalyptus.atlassian.net/rest/api/2/customFieldOption/10403","value":"Not Applicable","id":"10403"},"customfield_10104":[],"customfield_10302":null,"customfield_10105":null,"customfield_10303":null,"customfield_10700":null,"customfield_10304":null,"customfield_10701":null,"customfield_10306":null,"customfield_10702":null,"customfield_10703":null,"customfield_10308":null,"customfield_10704":null,"resolutiondate":null,"customfield_10705":null,"customfield_10309":[{"self":"https://eucalyptus.atlassian.net/rest/api/2/customFieldOption/10204","value":"KVM","id":"10204"}],"workratio":-1,"watches":{"self":"https://eucalyptus.atlassian.net/rest/api/2/issue/EUCA-11397/watchers","watchCount":4,"isWatching":false},"lastViewed":null,"created":"2015-09-18T17:11:57.355-0500","customfield_12000":null,"priority":{"self":"https://eucalyptus.atlassian.net/rest/api/2/priority/1","iconUrl":"https://eucalyptus.atlassian.net/images/icons/priorities/blocker.svg","name":"Blocker","id":"1"},"customfield_12400":null,"customfield_12201":null,"customfield_12600":"{}","customfield_10102":null,"customfield_10300":null,"labels":[],"customfield_10301":null,"customfield_11700":null,"aggregatetimeoriginalestimate":null,"timeestimate":null,"customfield_11901":null,"versions":[{"self":"https://eucalyptus.atlassian.net/rest/api/2/version/15501","id":"15501","description":"Eucalyptus 4.1.2","name":"4.1.2","archived":false,"released":true,"releaseDate":"2015-07-30"}],"issuelinks":[],"assignee":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=kedwards","name":"kedwards","key":"kedwards","accountId":"557058:f9c2f8da-1fc6-4aa7-8fb0-750e7e422b6b","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/d1746a6d05a30ca027012a7da4545962?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dkedwards%26avatarId%3D10200%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/d1746a6d05a30ca027012a7da4545962?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dkedwards%26avatarId%3D10200%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/d1746a6d05a30ca027012a7da4545962?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dkedwards%26avatarId%3D10200%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/d1746a6d05a30ca027012a7da4545962?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dkedwards%26avatarId%3D10200%26noRedirect%3Dtrue"},"displayName":"Ken Edwards","active":true,"timeZone":"America/Los_Angeles"},"updated":"2015-09-24T16:52:52.542-0500","status":{"self":"https://eucalyptus.atlassian.net/rest/api/2/status/10000","description":"This issue has not yet been validated, and is not currently being investigated.","iconUrl":"https://eucalyptus.atlassian.net/images/icons/statuses/generic.png","name":"Unconfirmed","id":"10000","statusCategory":{"self":"https://eucalyptus.atlassian.net/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[],"timeoriginalestimate":null,"description":"h2. Problem\r\n\r\nAll user-related objects have gone missing from Eucalyptus.  New objects can be created, but anything that existed before is no longer accessible.  This objects missing include but are not limited to:\r\n* Running Instances\r\n* Volumes\r\n* Snapshots\r\n* Key pairs\r\n\r\nRunning {{euca-describe-nodes}} shows that there are in fact running instances, but the command {{euca-describe-instances}} show no running instances for any user except ones created as 'admin'.  The same is for volumes and snapshots, they are simply non-existent from a user perspective.\r\n\r\nh2. Cause\r\n\r\nThere was an identified glitch with the LDAP query where for a brief moment no users were returned, causing all user accounts to be deleted.  Once the situation was corrected, the user accounts were re-created.\r\n\r\nThis is due to the fact that {{\"clean-deletion\"}} was set to {{true}} in the LDAP configuration JSON file.  Under the following conditions user accounts will be deleted:\r\n* User is moved from one OU to another accidentally\r\n* User leaves the organization and account is deleted from the directory\r\n* Problem with LDAP Query/Filter causing bad results to return\r\n\r\nAfter additional investigation, it appears that the {{auth_user.auth_user_id_external}} value in the database changed when the account was recreated.  This caused over 25 tables which reference this value with the {{metadata_user_id}} column to have invalid references, thus returning no results when queried by the application.\r\n\r\nIt was also discovered that none of the tables that contain {{metadata_user_id}} have a foreign key constraint on the {{auth_user_id_external}} column in the {{eucalyptus_auth.auth_user}} table, which would prevent any account from being deleted with existing objects in the system.\r\n\r\nh2. Workaround\r\n\r\nTo correct the issue for existing objects, you can update each of the tables that contain the {{metadata_user_id}} column with the correct value of the re-created user account.\r\n\r\nTo update the database records do the following:\r\n# Create the file *fix_metadata_user_id.sql*\r\n{code:title=fix_metadata_user_id.sql}\r\ndo $$\r\n  declare\r\n    result1 record;\r\n    result2 record;\r\n    tablename varchar;\r\n    account varchar;\r\n    username varchar;\r\n    olduserid varchar;\r\n    newuserid varchar;\r\n  begin\r\n    for result1 in\r\n      SELECT table_schema,table_name\r\n      FROM information_schema.columns\r\n      WHERE column_name='metadata_user_id'\r\n    loop\r\n          tablename := result1.table_schema || '.' || result1.table_name;\r\n\r\n      begin\r\n        for result2 in\r\n          EXECUTE 'SELECT metadata_account_id,metadata_user_name,metadata_user_id\r\n          FROM ' || tablename\r\n        loop\r\n          account := result2.metadata_account_id;\r\n          username := result2.metadata_user_name;\r\n          olduserid := result2.metadata_user_id;\r\n\r\n          SELECT DISTINCT eucalyptus_auth.auth_user.auth_user_id_external INTO newuserid\r\n          FROM eucalyptus_auth.auth_account\r\n          INNER JOIN eucalyptus_auth.auth_group\r\n          ON (eucalyptus_auth.auth_account.id = eucalyptus_auth.auth_group.auth_group_owning_account)\r\n          INNER JOIN eucalyptus_auth.auth_group_has_users\r\n          ON (eucalyptus_auth.auth_group.id = eucalyptus_auth.auth_group_has_users.auth_group_id)\r\n          INNER JOIN eucalyptus_auth.auth_user\r\n          ON (eucalyptus_auth.auth_user.id = eucalyptus_auth.auth_group_has_users.auth_user_id)\r\n          WHERE eucalyptus_auth.auth_account.auth_account_number=account AND eucalyptus_auth.auth_user.auth_user_name=username;\r\n\r\n          IF olduserid != newuserid THEN\r\n            EXECUTE 'UPDATE '||tablename||\r\n            ' SET metadata_user_id='||quote_literal(newuserid)||\r\n            ' WHERE metadata_account_id='||quote_literal(account)||' AND metadata_user_name='||quote_literal(username);\r\n          END IF;\r\n\r\n        end loop;\r\n      end;\r\n    end loop;\r\n  end;\r\n$$;\r\n{code}\r\n# Execute the SQL code on the CLC node\r\n{noformat}\r\npsql -h /var/lib/eucalyptus/db/data -p 8777 eucalyptus_shared < fix_metadata_user_id.sql\r\n{noformat}\r\n\r\nh2. Resolution\r\n\r\nRecommendations to resolve are as follows:\r\n* Add a foreign key constraint for all the tables that reference {{eucalyptus_auth.auth_user.auth_user_id_external}} to prevent accidental deletion of user accounts\r\n* Discontinue the use of an external user ID for objects that are shared within an account.  This would prevent volumes from disappearing when a user is deleted (such as when he/she leaves the organization)","customfield_13000":null,"customfield_13200":null,"customfield_11300":null,"customfield_11500":null,"timetracking":{},"customfield_10401":null,"customfield_10005":null,"customfield_10600":null,"customfield_12900":null,"attachment":[],"aggregatetimeestimate":null,"summary":"User-related objects such as volumes, snapshots, and key pairs are missing after LDAP sync deletes accounts","creator":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=jgallucci32","name":"jgallucci32","key":"jgallucci32","accountId":"557058:1cd98ee4-b2ee-4683-a315-2a6abd75b048","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/31cfdf964a6ac26962c22f3279e2c85c?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FavatarId%3D10122%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/31cfdf964a6ac26962c22f3279e2c85c?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26avatarId%3D10122%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/31cfdf964a6ac26962c22f3279e2c85c?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26avatarId%3D10122%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/31cfdf964a6ac26962c22f3279e2c85c?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26avatarId%3D10122%26noRedirect%3Dtrue"},"displayName":"John Gallucci","active":true,"timeZone":"America/Los_Angeles"},"subtasks":[],"reporter":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=jgallucci32","name":"jgallucci32","key":"jgallucci32","accountId":"557058:1cd98ee4-b2ee-4683-a315-2a6abd75b048","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/31cfdf964a6ac26962c22f3279e2c85c?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FavatarId%3D10122%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/31cfdf964a6ac26962c22f3279e2c85c?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26avatarId%3D10122%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/31cfdf964a6ac26962c22f3279e2c85c?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26avatarId%3D10122%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/31cfdf964a6ac26962c22f3279e2c85c?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26avatarId%3D10122%26noRedirect%3Dtrue"},"displayName":"John Gallucci","active":true,"timeZone":"America/Los_Angeles"},"aggregateprogress":{"progress":0,"total":0},"customfield_12100":"0|i03e1r:","customfield_10000":null,"customfield_10001":"2015-09-24T16:52:44.327-0500","customfield_10200":null,"customfield_10002":[{"self":"https://eucalyptus.atlassian.net/rest/api/2/customFieldOption/10000","value":"Customer Affecting","id":"10000"}],"customfield_10003":null,"customfield_10400":null,"customfield_12500":null,"customfield_11600":["jgallucci32(jgallucci32)","kedwards(kedwards)"],"customfield_10116":null,"environment":"1xCLC\r\n1xCON\r\n2xCC\r\n2xCC\r\n4xNC","customfield_10117":null,"customfield_11800":null,"customfield_11802":null,"duedate":null,"customfield_11805":null,"progress":{"progress":0,"total":0},"customfield_11806":null,"votes":{"self":"https://eucalyptus.atlassian.net/rest/api/2/issue/EUCA-11397/votes","votes":1,"hasVoted":false},"comment":{"comments":[],"maxResults":0,"total":0,"startAt":0},"customfield_11808":null,"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]}}}