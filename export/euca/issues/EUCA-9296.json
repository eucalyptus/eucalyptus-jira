{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"29453","self":"https://eucalyptus.atlassian.net/rest/api/2/issue/29453","key":"EUCA-9296","fields":{"issuetype":{"self":"https://eucalyptus.atlassian.net/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://eucalyptus.atlassian.net/secure/viewavatar?size=xsmall&avatarId=14803&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":14803},"timespent":null,"customfield_13100":null,"project":{"self":"https://eucalyptus.atlassian.net/rest/api/2/project/10000","id":"10000","key":"EUCA","name":"Eucalyptus","avatarUrls":{"48x48":"https://eucalyptus.atlassian.net/secure/projectavatar?pid=10000&avatarId=10011","24x24":"https://eucalyptus.atlassian.net/secure/projectavatar?size=small&pid=10000&avatarId=10011","16x16":"https://eucalyptus.atlassian.net/secure/projectavatar?size=xsmall&pid=10000&avatarId=10011","32x32":"https://eucalyptus.atlassian.net/secure/projectavatar?size=medium&pid=10000&avatarId=10011"}},"customfield_11000":null,"fixVersions":[{"self":"https://eucalyptus.atlassian.net/rest/api/2/version/14203","id":"14203","description":"Eucalyptus 3.4.3","name":"3.4.3","archived":false,"released":true,"releaseDate":"2014-07-11"}],"customfield_11001":null,"aggregatetimespent":null,"resolution":{"self":"https://eucalyptus.atlassian.net/rest/api/2/resolution/7","id":"7","description":"Signifies completion of tasks, info requests, etc.","name":"Completed"},"customfield_10310":[{"self":"https://eucalyptus.atlassian.net/rest/api/2/customFieldOption/10209","value":"CentOS 6","id":"10209"}],"customfield_10311":null,"customfield_11401":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=tony","name":"tony","key":"tony","accountId":"557058:353956db-b78c-4f3b-9096-f8f58e6709c8","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/14ec1b18e630cc0743492fc327a12df7?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dtony%26avatarId%3D16600%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/14ec1b18e630cc0743492fc327a12df7?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dtony%26avatarId%3D16600%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/14ec1b18e630cc0743492fc327a12df7?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dtony%26avatarId%3D16600%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/14ec1b18e630cc0743492fc327a12df7?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dtony%26avatarId%3D16600%26noRedirect%3Dtrue"},"displayName":"Tony Beckham","active":true,"timeZone":"America/Tijuana"},"customfield_11400":null,"customfield_10500":{"self":"https://eucalyptus.atlassian.net/rest/api/2/customFieldOption/10403","value":"Not Applicable","id":"10403"},"customfield_10104":[],"customfield_10302":null,"customfield_10303":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=sjones","name":"sjones","key":"sjones","accountId":"557058:f5dce1b0-db45-4dd6-a0e8-3cea5effb5ce","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/037fddf6d3bf6d691a448e01136f233a?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dsjones%26avatarId%3D18300%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/037fddf6d3bf6d691a448e01136f233a?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dsjones%26avatarId%3D18300%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/037fddf6d3bf6d691a448e01136f233a?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dsjones%26avatarId%3D18300%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/037fddf6d3bf6d691a448e01136f233a?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dsjones%26avatarId%3D18300%26noRedirect%3Dtrue"},"displayName":"Steve Jones","active":true,"timeZone":"America/Los_Angeles"},"customfield_10105":{"self":"https://eucalyptus.atlassian.net/rest/api/2/customFieldOption/10101","value":"No","id":"10101"},"customfield_10304":null,"customfield_10700":null,"customfield_10701":null,"customfield_10702":null,"customfield_10306":{"self":"https://eucalyptus.atlassian.net/rest/api/2/customFieldOption/10200","value":"High","id":"10200"},"customfield_10703":null,"customfield_10308":null,"resolutiondate":"2014-12-08T16:42:45.790-0600","customfield_10704":null,"customfield_10309":[{"self":"https://eucalyptus.atlassian.net/rest/api/2/customFieldOption/10204","value":"KVM","id":"10204"}],"customfield_10705":null,"workratio":-1,"watches":{"self":"https://eucalyptus.atlassian.net/rest/api/2/issue/EUCA-9296/watchers","watchCount":6,"isWatching":false},"lastViewed":null,"created":"2014-05-02T10:23:13.828-0500","customfield_12000":null,"customfield_12400":null,"priority":{"self":"https://eucalyptus.atlassian.net/rest/api/2/priority/1","iconUrl":"https://eucalyptus.atlassian.net/images/icons/priorities/blocker.svg","name":"Blocker","id":"1"},"customfield_12201":null,"customfield_12600":"{repository={count=6, dataType=repository}, json={\"cachedValue\":{\"errors\":[],\"summary\":{\"repository\":{\"overall\":{\"count\":6,\"lastUpdated\":\"2014-05-07T17:18:45.000-0500\",\"dataType\":\"repository\"},\"byInstanceType\":{\"github\":{\"count\":6,\"name\":\"GitHub\"}}}}},\"isStale\":true}}","customfield_10300":null,"customfield_10102":null,"customfield_10301":null,"labels":[],"customfield_11700":null,"aggregatetimeoriginalestimate":null,"timeestimate":null,"customfield_11901":null,"versions":[{"self":"https://eucalyptus.atlassian.net/rest/api/2/version/13700","id":"13700","description":"Eucalyptus 3.4.2","name":"3.4.2","archived":false,"released":true,"releaseDate":"2014-02-24"},{"self":"https://eucalyptus.atlassian.net/rest/api/2/version/12806","id":"12806","description":"Eucalyptus 4.0.0","name":"4.0.0","archived":false,"released":true,"releaseDate":"2014-05-30"}],"issuelinks":[{"id":"25342","self":"https://eucalyptus.atlassian.net/rest/api/2/issueLink/25342","type":{"id":"10101","name":"Cloners","inward":"is cloned by","outward":"clones","self":"https://eucalyptus.atlassian.net/rest/api/2/issueLinkType/10101"},"inwardIssue":{"id":"30863","key":"EUCA-9574","self":"https://eucalyptus.atlassian.net/rest/api/2/issue/30863","fields":{"summary":"CLONE - for 4.0.1 - volumes leftover in SC database as \"available\" after multiple instances fail to run","status":{"self":"https://eucalyptus.atlassian.net/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://eucalyptus.atlassian.net/images/icons/statuses/generic.png","name":"Closed","id":"6","statusCategory":{"self":"https://eucalyptus.atlassian.net/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://eucalyptus.atlassian.net/rest/api/2/priority/1","iconUrl":"https://eucalyptus.atlassian.net/images/icons/priorities/blocker.svg","name":"Blocker","id":"1"},"issuetype":{"self":"https://eucalyptus.atlassian.net/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://eucalyptus.atlassian.net/secure/viewavatar?size=xsmall&avatarId=14803&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":14803}}}},{"id":"25343","self":"https://eucalyptus.atlassian.net/rest/api/2/issueLink/25343","type":{"id":"10101","name":"Cloners","inward":"is cloned by","outward":"clones","self":"https://eucalyptus.atlassian.net/rest/api/2/issueLinkType/10101"},"inwardIssue":{"id":"30864","key":"EUCA-9575","self":"https://eucalyptus.atlassian.net/rest/api/2/issue/30864","fields":{"summary":"CLONE - for 4.1 - volumes leftover in SC database as \"available\" after multiple instances fail to run","status":{"self":"https://eucalyptus.atlassian.net/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://eucalyptus.atlassian.net/images/icons/statuses/generic.png","name":"Closed","id":"6","statusCategory":{"self":"https://eucalyptus.atlassian.net/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://eucalyptus.atlassian.net/rest/api/2/priority/1","iconUrl":"https://eucalyptus.atlassian.net/images/icons/priorities/blocker.svg","name":"Blocker","id":"1"},"issuetype":{"self":"https://eucalyptus.atlassian.net/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://eucalyptus.atlassian.net/secure/viewavatar?size=xsmall&avatarId=14803&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":14803}}}},{"id":"24396","self":"https://eucalyptus.atlassian.net/rest/api/2/issueLink/24396","type":{"id":"10103","name":"Relates","inward":"relates to","outward":"relates to","self":"https://eucalyptus.atlassian.net/rest/api/2/issueLinkType/10103"},"outwardIssue":{"id":"29454","key":"EUCA-9297","self":"https://eucalyptus.atlassian.net/rest/api/2/issue/29454","fields":{"summary":"volumes leftover in SC/CLC database as \"available\" after instance fail to run due to low space on SAN","status":{"self":"https://eucalyptus.atlassian.net/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://eucalyptus.atlassian.net/images/icons/statuses/generic.png","name":"Closed","id":"6","statusCategory":{"self":"https://eucalyptus.atlassian.net/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://eucalyptus.atlassian.net/rest/api/2/priority/1","iconUrl":"https://eucalyptus.atlassian.net/images/icons/priorities/blocker.svg","name":"Blocker","id":"1"},"issuetype":{"self":"https://eucalyptus.atlassian.net/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://eucalyptus.atlassian.net/secure/viewavatar?size=xsmall&avatarId=14803&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":14803}}}},{"id":"25334","self":"https://eucalyptus.atlassian.net/rest/api/2/issueLink/25334","type":{"id":"10103","name":"Relates","inward":"relates to","outward":"relates to","self":"https://eucalyptus.atlassian.net/rest/api/2/issueLinkType/10103"},"inwardIssue":{"id":"29454","key":"EUCA-9297","self":"https://eucalyptus.atlassian.net/rest/api/2/issue/29454","fields":{"summary":"volumes leftover in SC/CLC database as \"available\" after instance fail to run due to low space on SAN","status":{"self":"https://eucalyptus.atlassian.net/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://eucalyptus.atlassian.net/images/icons/statuses/generic.png","name":"Closed","id":"6","statusCategory":{"self":"https://eucalyptus.atlassian.net/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://eucalyptus.atlassian.net/rest/api/2/priority/1","iconUrl":"https://eucalyptus.atlassian.net/images/icons/priorities/blocker.svg","name":"Blocker","id":"1"},"issuetype":{"self":"https://eucalyptus.atlassian.net/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://eucalyptus.atlassian.net/secure/viewavatar?size=xsmall&avatarId=14803&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":14803}}}}],"assignee":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=tony","name":"tony","key":"tony","accountId":"557058:353956db-b78c-4f3b-9096-f8f58e6709c8","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/14ec1b18e630cc0743492fc327a12df7?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dtony%26avatarId%3D16600%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/14ec1b18e630cc0743492fc327a12df7?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dtony%26avatarId%3D16600%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/14ec1b18e630cc0743492fc327a12df7?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dtony%26avatarId%3D16600%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/14ec1b18e630cc0743492fc327a12df7?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dtony%26avatarId%3D16600%26noRedirect%3Dtrue"},"displayName":"Tony Beckham","active":true,"timeZone":"America/Tijuana"},"updated":"2014-12-08T16:45:23.965-0600","status":{"self":"https://eucalyptus.atlassian.net/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://eucalyptus.atlassian.net/images/icons/statuses/generic.png","name":"Closed","id":"6","statusCategory":{"self":"https://eucalyptus.atlassian.net/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://eucalyptus.atlassian.net/rest/api/2/component/10014","id":"10014","name":"Storage Controller"}],"timeoriginalestimate":null,"customfield_13000":null,"description":"Hi All,\r\n\r\nI am sharing simple steps in order to reproduce the problem in 4.0.0 with the storage backend set to any SAN device. I reproduce it on netapp. I think it is not related to the SAN backend. \r\n\r\nFirst of all the problem that we are trying to reproduce is\r\n\r\n'SC database leaves volumes in state 'Available' which are not known to the CLC'\r\n\r\na) Setup a 4.0.0 cloud with following topology\r\n\r\nCLC+UFS - 1 machine\r\nCC/SC - 1 machine\r\nNC - 1\r\nNetwork Mode - EDGE\r\nBlock device storage backend - Netapp\r\nObject storage backend - Walrus\r\n\r\nb) Configure the cloud with an HVM backed EBS image of size 3GB. I used ubuntu precise as my preferred choice of guest operating system\r\n\r\nc) Lower down the property for {{storage.maxtotalvolumesizeingb}} to 15 where default is 100.\r\n\r\nd) Run multiple new instances of this HVM backed EBS image at 1 request such that all of them combined would create volumes on the cloud that exceeds the limit set to the property.\r\n\r\nI ran 6 instances as that would cause a total of 18GB of volumes to be created on the cloud (image size is 3GB) hence causing a exceed of max total of all volumes set in the cloud.\r\n\r\n{code}\r\neuca-run-instances -k sshlogin -t m1.small -n 6 emi-5350d811\r\n{code}\r\n\r\ne) You will notice almost immediately all instances failed to get running, {{euca-describe-instances verbose}} does not show them up. Following is seen immediately after the {{euca-run-instances}} was issued:\r\n\r\n{code}\r\n[root@odc-d-06-02 ~]# euca-run-instances -k sshlogin -t m1.small -n 6 emi-5350d811\r\nRESERVATION\tr-5bc3deb3\t507133477975\tdefault\r\nINSTANCE\ti-5d096e1d\temi-5350d811\t\teuca-10-104-3-37.eucalyptus.internal\tpending\tsshlogin\t0\t\tm1.small\t2014-05-01T02:41:17.385Z\tcloud4\t\t\t\tmonitoring-disabled\t10.104.3.37\t10.104.3.37\t\t\tebs\t\t\t\t\thvm\t\t\tsg-3fd8d792\t\t\t\r\nINSTANCE\ti-174f3ea8\temi-5350d811\t\teuca-10-104-3-43.eucalyptus.internal\tpending\tsshlogin\t1\t\tm1.small\t2014-05-01T02:41:17.425Z\tcloud4\t\t\t\tmonitoring-disabled\t10.104.3.43\t10.104.3.43\t\t\tebs\t\t\t\t\thvm\t\t\tsg-3fd8d792\t\t\t\r\nINSTANCE\ti-5efd6aec\temi-5350d811\t\teuca-10-104-3-35.eucalyptus.internal\tpending\tsshlogin\t2\t\tm1.small\t2014-05-01T02:41:17.463Z\tcloud4\t\t\t\tmonitoring-disabled\t10.104.3.35\t10.104.3.35\t\t\tebs\t\t\t\t\thvm\t\t\tsg-3fd8d792\t\t\t\r\nINSTANCE\ti-69ea59e3\temi-5350d811\t\teuca-10-104-3-34.eucalyptus.internal\tpending\tsshlogin\t3\t\tm1.small\t2014-05-01T02:41:17.502Z\tcloud4\t\t\t\tmonitoring-disabled\t10.104.3.34\t10.104.3.34\t\t\tebs\t\t\t\t\thvm\t\t\tsg-3fd8d792\t\t\t\r\nINSTANCE\ti-15eca329\temi-5350d811\t\teuca-10-104-3-33.eucalyptus.internal\tpending\tsshlogin\t4\t\tm1.small\t2014-05-01T02:41:17.542Z\tcloud4\t\t\t\tmonitoring-disabled\t10.104.3.33\t10.104.3.33\t\t\tebs\t\t\t\t\thvm\t\t\tsg-3fd8d792\t\t\t\r\nINSTANCE\ti-b0c095cf\temi-5350d811\t\teuca-10-104-3-39.eucalyptus.internal\tpending\tsshlogin\t5\t\tm1.small\t2014-05-01T02:41:17.582Z\tcloud4\t\t\t\tmonitoring-disabled\t10.104.3.39\t10.104.3.39\t\t\tebs\t\t\t\t\thvm\t\t\tsg-3fd8d792\t\t\t\r\n{code}\r\n\r\nIn few seconds output of {{euca-describe-instances verbose}} becomes empty.\r\n\r\nThen following is seen in cloud-output.log of CLC\r\n\r\n{code}\r\n2014-04-30 19:41:18 ERROR 000004099 Volumes                  | Failed to create volume: com.eucalyptus.blockstorage.Volume@74a7df5a\r\n2014-04-30 19:41:18 ERROR 000004099 ClusterAllocator         | com.eucalyptus.entities.TransactionCallbackException: java.lang.RuntimeException: com.eucalyptus.ws.EucalyptusRemoteFault: Action:ProblemAction Code:CreateStorageVolumeType Id:RelatesTo Error: Total Volume Size Limit Exceeded volume: vol-5c54f597Total Volume Size Limit Exceeded volume: vol-5c54f597\r\n2014-04-30 19:41:19 ERROR 000004099 ClusterAllocator         | java.util.NoSuchElementException: example: [VmInstance networkConfig=null vmId=null bootRecord=null usageStats=null launchRecord=null runtimeState=null transientVolumeState=null placement=null expiration=null privateNetwork=null networkGroups=[] networkGroupIds=[] networkIndex=null tags=null ownerUserId=null ownerUserName=null ownerAccountNumber=null uniqueName=null ownerFullNameCached=null state=null lastState=null stateChangeStack=null displayName=i-5d096e1d id=null version=null creationTimestamp=null lastUpdateTimestamp=null naturalId=null]\r\n2014-04-30 19:41:19 ERROR 000004099 ClusterAllocator         | java.util.NoSuchElementException: example: [VmInstance networkConfig=null vmId=null bootRecord=null usageStats=null launchRecord=null runtimeState=null transientVolumeState=null placement=null expiration=null privateNetwork=null networkGroups=[] networkGroupIds=[] networkIndex=null tags=null ownerUserId=null ownerUserName=null ownerAccountNumber=null uniqueName=null ownerFullNameCached=null state=null lastState=null stateChangeStack=null displayName=i-174f3ea8 id=null version=null creationTimestamp=null lastUpdateTimestamp=null naturalId=null]\r\n2014-04-30 19:41:19 ERROR 000004099 ClusterAllocator         | java.util.NoSuchElementException: example: [VmInstance networkConfig=null vmId=null bootRecord=null usageStats=null launchRecord=null runtimeState=null transientVolumeState=null placement=null expiration=null privateNetwork=null networkGroups=[] networkGroupIds=[] networkIndex=null tags=null ownerUserId=null ownerUserName=null ownerAccountNumber=null uniqueName=null ownerFullNameCached=null state=null lastState=null stateChangeStack=null displayName=i-5efd6aec id=null version=null creationTimestamp=null lastUpdateTimestamp=null naturalId=null]\r\n2014-04-30 19:41:19 ERROR 000004099 ClusterAllocator         | java.util.NoSuchElementException: example: [VmInstance networkConfig=null vmId=null bootRecord=null usageStats=null launchRecord=null runtimeState=null transientVolumeState=null placement=null expiration=null privateNetwork=null networkGroups=[] networkGroupIds=[] networkIndex=null tags=null ownerUserId=null ownerUserName=null ownerAccountNumber=null uniqueName=null ownerFullNameCached=null state=null lastState=null stateChangeStack=null displayName=i-69ea59e3 id=null version=null creationTimestamp=null lastUpdateTimestamp=null naturalId=null]\r\n2014-04-30 19:41:19 ERROR 000004099 ClusterAllocator         | java.util.NoSuchElementException: example: [VmInstance networkConfig=null vmId=null bootRecord=null usageStats=null launchRecord=null runtimeState=null transientVolumeState=null placement=null expiration=null privateNetwork=null networkGroups=[] networkGroupIds=[] networkIndex=null tags=null ownerUserId=null ownerUserName=null ownerAccountNumber=null uniqueName=null ownerFullNameCached=null state=null lastState=null stateChangeStack=null displayName=i-15eca329 id=null version=null creationTimestamp=null lastUpdateTimestamp=null naturalId=null]\r\n2014-04-30 19:41:19 ERROR 000004099 ClusterAllocator         | java.util.NoSuchElementException: example: [VmInstance networkConfig=null vmId=null bootRecord=null usageStats=null launchRecord=null runtimeState=null transientVolumeState=null placement=null expiration=null privateNetwork=null networkGroups=[] networkGroupIds=[] networkIndex=null tags=null ownerUserId=null ownerUserName=null ownerAccountNumber=null uniqueName=null ownerFullNameCached=null state=null lastState=null stateChangeStack=null displayName=i-b0c095cf id=null version=null creationTimestamp=null lastUpdateTimestamp=null naturalId=null]\r\n{code}\r\n\r\nThen check the databases\r\n\r\nCLC\r\n\r\n{code}\r\neucalyptus_cloud=# select * from metadata_volumes;\r\n id | creation_timestamp | last_update_timestamp | metadata_perm_uuid | version | metadata_display_name | metadata_last_state | metadata_state | metadata_state_change_sta\r\nck | metadata_account_id | metadata_unique_name | metadata_user_id | metadata_user_name | metadata_volume_localdevice | metadata_volume_parentsnapshot | metadata_volume_p\r\nartition | metadata_volume_remotedevice | metadata_volume_sc_name | metadata_volume_size \r\n----+--------------------+-----------------------+--------------------+---------+-----------------------+---------------------+----------------+--------------------------\r\n---+---------------------+----------------------+------------------+--------------------+-----------------------------+--------------------------------+------------------\r\n---------+------------------------------+-------------------------+----------------------\r\n(0 rows)\r\n{code}\r\n\r\nSC\r\n{code}\r\neucalyptus_storage=# select * from volumes;\r\n                id                |   creation_timestamp    |  last_update_timestamp  |          metadata_perm_uuid          | version |       create_time       |      de\r\nletion_time      | sc_name | size |  snapshot_id  |  status   | volume_user_name | volume_name  | zone \r\n----------------------------------+-------------------------+-------------------------+--------------------------------------+---------+-------------------------+--------\r\n-----------------+---------+------+---------------+-----------+------------------+--------------+------\r\n 8ae8815445b39db10145b5a216d90022 | 2014-04-30 19:34:29.977 | 2014-04-30 19:37:54.489 | ff0c9f73-386e-4e4a-8bcb-9ea99c8f6870 |       3 | 2014-04-30 19:34:29.977 | 2014-04\r\n-30 19:37:54.488 | cloud4  |    3 | snap-d8de081b | deleted   | eucalyptus       | vol-1154668e | \r\n 8ae8815445b39db10145b54c57310012 | 2014-04-30 18:00:50.353 | 2014-04-30 19:38:54.308 | 8ca6d2f3-b8d0-429e-bf99-971e037d1d11 |       3 | 2014-04-30 18:00:50.353 | 2014-04\r\n-30 19:38:54.308 | cloud4  |    1 |               | deleted   | eucalyptus       | vol-0d0f8478 | \r\n 8ae8815445b39db10145b561bb820014 | 2014-04-30 18:24:12.29  | 2014-04-30 19:38:54.734 | 2a3c0cab-fcc4-448a-ae68-fe38bdf2bebd |       3 | 2014-04-30 18:24:12.289 | 2014-04\r\n-30 19:38:54.733 | cloud4  |    3 |               | deleted   | eucalyptus       | vol-5030f3eb | \r\n 8ae8815445b39db10145b5a84fc20026 | 2014-04-30 19:41:17.762 | 2014-04-30 19:42:00.02  | 7ceda4c0-0a7a-4e5d-a7cb-7309dda646fe |       1 | 2014-04-30 19:41:17.762 |        \r\n                 | cloud4  |    3 | snap-d8de081b | available | eucalyptus       | vol-c3eca2d7 | \r\n 8ae8815445b39db10145b5a850fa002a | 2014-04-30 19:41:18.074 | 2014-04-30 19:42:10.199 | b675de92-2572-436d-95c6-e3bc3fa627a0 |       1 | 2014-04-30 19:41:18.074 |        \r\n                 | cloud4  |    3 | snap-d8de081b | available | eucalyptus       | vol-5dfe29a1 | \r\n 8ae8815445b39db10145b5a8505a0028 | 2014-04-30 19:41:17.914 | 2014-04-30 19:42:29.822 | 9681c3ce-9124-4d0b-8457-1747d7645576 |       1 | 2014-04-30 19:41:17.914 |        \r\n                 | cloud4  |    3 | snap-d8de081b | available | eucalyptus       | vol-8df2f180 | \r\n 8ae8815445b39db10145b5a85183002c | 2014-04-30 19:41:18.211 | 2014-04-30 19:42:30.705 | a8890225-ab5f-48a3-ba14-d3a961efd8e5 |       1 | 2014-04-30 19:41:18.211 |        \r\n                 | cloud4  |    3 | snap-d8de081b | available | eucalyptus       | vol-198c17d0 | \r\n 8ae8815445b39db10145b5a85200002e | 2014-04-30 19:41:18.336 | 2014-04-30 19:42:34.636 | a4cd68cc-e10b-4dbe-9c25-81838850c063 |       1 | 2014-04-30 19:41:18.336 |        \r\n                 | cloud4  |    3 | snap-d8de081b | available | eucalyptus       | vol-6fb1a2a5 | \r\n(8 rows)\r\n{code}\r\n\r\nIf we look at the CLC there are no volumes on the cloud because all instances failed to get created. On the SC however we have recorded volumes that are marked as available causing the accounting to provide incorrect result, see below:\r\n\r\n{code}\r\neucalyptus_storage=# select sum(size) from volumes where status<>'deleted';\r\n sum \r\n-----\r\n  15\r\n(1 row)\r\n{code}\r\n\r\nNow according to the CLC I can create volumes but according to the SC I cannot create volumes, here:\r\n\r\n{code}\r\n[root@odc-d-06-02 ~]# euca-create-volume -s 1 -z cloud4\r\neuca-create-volume: error (CreateStorageVolumeType): Total Volume Size Limit Exceeded volume: vol-5d6e38e8\r\n[root@odc-d-06-02 ~]# euca-describe-volumes verbose\r\n{code}\r\n\r\nThis is the problem that needs to be fixed. I hope the above simple steps to reproduce the problem will help in finding the root cause of the issue. Please let me know if you have any additional questions.\r\n\r\nCheers!\r\nDeependra","customfield_13200":null,"customfield_11300":null,"customfield_11500":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=sjones","name":"sjones","key":"sjones","accountId":"557058:f5dce1b0-db45-4dd6-a0e8-3cea5effb5ce","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/037fddf6d3bf6d691a448e01136f233a?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dsjones%26avatarId%3D18300%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/037fddf6d3bf6d691a448e01136f233a?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dsjones%26avatarId%3D18300%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/037fddf6d3bf6d691a448e01136f233a?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dsjones%26avatarId%3D18300%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/037fddf6d3bf6d691a448e01136f233a?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dsjones%26avatarId%3D18300%26noRedirect%3Dtrue"},"displayName":"Steve Jones","active":true,"timeZone":"America/Los_Angeles"},"timetracking":{},"customfield_10401":null,"customfield_10005":null,"customfield_10600":null,"customfield_12900":null,"aggregatetimeestimate":null,"attachment":[],"summary":"volumes leftover in SC database as \"available\" after multiple instances fail to run","creator":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=dshekhawat","name":"dshekhawat","key":"dshekhawat","accountId":"557058:dc10d216-39f8-4d84-a5ff-7d4daf8a44ed","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/7cda271db1cec24c198fdfb42ec8a8ae?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Ddshekhawat%26avatarId%3D15400%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/7cda271db1cec24c198fdfb42ec8a8ae?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Ddshekhawat%26avatarId%3D15400%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/7cda271db1cec24c198fdfb42ec8a8ae?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Ddshekhawat%26avatarId%3D15400%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/7cda271db1cec24c198fdfb42ec8a8ae?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Ddshekhawat%26avatarId%3D15400%26noRedirect%3Dtrue"},"displayName":"Deependra Shekhawat","active":false,"timeZone":"Asia/Kolkata"},"subtasks":[],"reporter":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=dshekhawat","name":"dshekhawat","key":"dshekhawat","accountId":"557058:dc10d216-39f8-4d84-a5ff-7d4daf8a44ed","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/7cda271db1cec24c198fdfb42ec8a8ae?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Ddshekhawat%26avatarId%3D15400%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/7cda271db1cec24c198fdfb42ec8a8ae?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Ddshekhawat%26avatarId%3D15400%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/7cda271db1cec24c198fdfb42ec8a8ae?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Ddshekhawat%26avatarId%3D15400%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/7cda271db1cec24c198fdfb42ec8a8ae?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Ddshekhawat%26avatarId%3D15400%26noRedirect%3Dtrue"},"displayName":"Deependra Shekhawat","active":false,"timeZone":"Asia/Kolkata"},"aggregateprogress":{"progress":0,"total":0},"customfield_10000":"3_*:*_1_*:*_84279286_*|*_10001_*:*_1_*:*_2784274750_*|*_10002_*:*_1_*:*_155062772_*|*_10000_*:*_1_*:*_8632013_*|*_10006_*:*_1_*:*_0_*|*_10003_*:*_1_*:*_1057750619","customfield_12100":"0|i02o8f:","customfield_10001":"2014-05-02T12:47:05.834-0500","customfield_10200":null,"customfield_10002":null,"customfield_10003":null,"customfield_10400":null,"customfield_12500":null,"customfield_10116":null,"customfield_11600":["dshekhawat(dshekhawat)","kedwards(kedwards)","lbiasi(lbiasi)","tony(tony)"],"customfield_10117":null,"environment":null,"customfield_11800":null,"customfield_11802":null,"duedate":null,"customfield_11805":null,"customfield_11806":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://eucalyptus.atlassian.net/rest/api/2/issue/29453/comment/68899","id":"68899","author":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=dshekhawat","name":"dshekhawat","key":"dshekhawat","accountId":"557058:dc10d216-39f8-4d84-a5ff-7d4daf8a44ed","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/7cda271db1cec24c198fdfb42ec8a8ae?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Ddshekhawat%26avatarId%3D15400%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/7cda271db1cec24c198fdfb42ec8a8ae?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Ddshekhawat%26avatarId%3D15400%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/7cda271db1cec24c198fdfb42ec8a8ae?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Ddshekhawat%26avatarId%3D15400%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/7cda271db1cec24c198fdfb42ec8a8ae?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Ddshekhawat%26avatarId%3D15400%26noRedirect%3Dtrue"},"displayName":"Deependra Shekhawat","active":false,"timeZone":"Asia/Kolkata"},"body":"I debugged this further on a smaller scale in 4.0.0 and was able to reproduce successfully. Here are my findings so far:\r\n\r\nWhen user tries to launch multiple instances of an EBS image this is what happens inside {{VmControl}} under method {{runInstances}}\r\n\r\na) {{AdmissionControl}} runs and find outs the availability zone for the 2 instances I am asking to run\r\n\r\n{code}\r\nTue Apr 29 01:05:54 2014  INFO [AdmissionControl:Compute.15] [?.?(?):?] Found authorized clusters: [cc-01]\r\nTue Apr 29 01:05:54 2014  INFO [AdmissionControl:Compute.15] [?.?(?):?] Availability: cc-01 -> 4\r\nTue Apr 29 01:05:54 2014  INFO [AdmissionControl:Compute.15] [?.?(?):?] Availability: cc-01 -> 4\r\n{code}\r\n\r\nb) Then {{ClusterAllocator}} runs that gets me network addresses for these 2 instances as shown below (job done via method {{setupNetworkMessages( )}} :\r\n\r\n{code}\r\nTue Apr 29 01:05:54 2014  INFO [Address:Eucalyptus.eucalyptus:EphemeralConfiguration:arn:euca:eucalyptus:::com.eucalyptus.network.DispatchingNetworkingService/.class java.util.concurrent.ThreadPoolExecutor$Worker#375] [?.?(?):?] :1398713754439:Address:ADDRESS_STATE:TOP:Address 192.168.25.131 arn:aws:euare:000000000001:user/nobody available 0.0.0.0  AddressTransition system:unallocated->impending(true)\r\nTue Apr 29 01:05:54 2014  INFO [Address:Eucalyptus.eucalyptus:EphemeralConfiguration:arn:euca:eucalyptus:::com.eucalyptus.network.DispatchingNetworkingService/.class java.util.concurrent.ThreadPoolExecutor$Worker#375] [?.?(?):?] :1398713754439:Address:ADDRESS_STATE:TOP:Address 192.168.25.132 arn:aws:euare:000000000001:user/nobody available 0.0.0.0  AddressTransition system:unallocated->impending(true)\r\n{code}\r\n\r\nc) Now as the instance uses EBS backed image {{ClusterAllocator}} runs method {{setupVolumeMessages}} (here I am using overlay backend). As seen below the first volume {{vol-cd96daf6}} got created successfully: \r\n\r\n{code}\r\nTue Apr 29 01:05:54 2014  INFO [BlockStorageController:Eucalyptus.cluster:ClusterConfiguration:arn:euca:eucalyptus:cloud4:cluster:cc-01/.class java.util.concurrent.ThreadPoolExecutor$Worker#350] [?.?(?):?] Processing CreateStorageVolume request for volume vol-cd96daf6\r\nTue Apr 29 01:05:54 2014  INFO [OverlayManager:pool-52-thread-5] [?.?(?):?] Finished executing: losetup /dev/loop0 //var/lib/eucalyptus/volumes/vol-cd96daf6\r\nTue Apr 29 01:05:54 2014  INFO [OverlayManager:pool-52-thread-5] [?.?(?):?] Result of: losetup /dev/loop0 //var/lib/eucalyptus/volumes/vol-cd96daf6 stdout:\r\nTue Apr 29 01:05:54 2014  INFO [OverlayManager:pool-52-thread-5] [?.?(?):?] Result of: losetup/dev/loop0 //var/lib/eucalyptus/volumes/vol-cd96daf6 return value:\r\n{code}\r\n\r\nThis is because the limit is not yet reached. But as soon as this (above) volume is created we reach the limit (the limit is set such that 1 volume creation above reaches the limit).\r\n\r\nNow the system tries to run a new volume creation request for the 2nd instance, but in this case it fails because we have reached the limit as seen below:\r\n\r\n{code}\r\nTue Apr 29 01:05:54 2014  INFO [BlockStorageController:Eucalyptus.cluster:ClusterConfiguration:arn:euca:eucalyptus:cloud4:cluster:cc-01/.class java.util.concurrent.ThreadPoolExecutor$Worker#350] [?.?(?):?] Processing CreateStorageVolume request for volume vol-d859fa84\r\nTue Apr 29 01:05:54 2014  INFO [Exceptions:Eucalyptus.cluster:ClusterConfiguration:arn:euca:eucalyptus:cloud4:cluster:cc-01/.class java.util.concurrent.ThreadPoolExecutor$Worker#350] [?.?(?):?] Failed to send message CreateStorageVolumeType to service StorageInternal because: Component that caused exception is: DefaultJavaComponent{StorageInternal.component}. Message payload is of type: CreateStorageVolumeType\r\nTue Apr 29 01:05:54 2014 ERROR [Volumes:Eucalyptus.cluster:ClusterConfiguration:arn:euca:eucalyptus:cloud4:cluster:cc-01/.class java.util.concurrent.ThreadPoolExecutor$Worker#350] [?.?(?):?] Failed to create volume: com.eucalyptus.blockstorage.Volume@ecc6604f\r\ncom.eucalyptus.context.ServiceDispatchException: Failed to send message CreateStorageVolumeType to service StorageInternal because: Component that caused exception is: DefaultJavaComponent{StorageInternal.component}. Message payload is of type: CreateStorageVolumeType\r\n        at com.eucalyptus.context.ServiceContext.send(ServiceContext.java:212)\r\n        at com.eucalyptus.context.ServiceContext.send(ServiceContext.java:192)\r\n        at com.eucalyptus.util.async.AsyncRequests.sendSync(AsyncRequests.java:133)\r\n        at com.eucalyptus.util.async.AsyncRequests.sendSync(AsyncRequests.java:114)\r\n        at com.eucalyptus.blockstorage.Volumes$2.fire(Volumes.java:411)\r\n        at com.eucalyptus.blockstorage.Volumes$2.fire(Volumes.java:404)\r\n        at com.eucalyptus.entities.Transactions.save(Transactions.java:346)\r\n        at com.eucalyptus.blockstorage.Volumes.createStorageVolume(Volumes.java:404)\r\n        at com.eucalyptus.cloud.run.ClusterAllocator.setupVolumeMessages(ClusterAllocator.java:414)\r\n        at com.eucalyptus.cloud.run.ClusterAllocator.<init>(ClusterAllocator.java:229)\r\n        at com.eucalyptus.cloud.run.ClusterAllocator.<init>(ClusterAllocator.java:162)\r\n        at com.eucalyptus.cloud.run.ClusterAllocator$SubmitAllocation$1.call(ClusterAllocator.java:201)\r\n        at com.eucalyptus.cloud.run.ClusterAllocator$SubmitAllocation$1.call(ClusterAllocator.java:197)\r\n        at java.util.concurrent.FutureTask.run(FutureTask.java:262)\r\n        at com.eucalyptus.system.Threads$Queue.run(Threads.java:684)\r\n        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471)\r\n        at java.util.concurrent.FutureTask.run(FutureTask.java:262)\r\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\r\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\r\n        at java.lang.Thread.run(Thread.java:744)\r\nCaused by: org.mule.component.ComponentException: Component that caused exception is: DefaultJavaComponent{StorageInternal.component}. Message payload is of type: CreateStorageVolumeType\r\n        at org.mule.component.DefaultComponentLifecycleAdapter.invoke(DefaultComponentLifecycleAdapter.java:352)\r\n        at org.mule.component.AbstractJavaComponent.invokeComponentInstance(AbstractJavaComponent.java:86)\r\n        at org.mule.component.AbstractJavaComponent.doInvoke(AbstractJavaComponent.java:77)\r\n        at org.mule.component.AbstractComponent.invokeInternal(AbstractComponent.java:126)\r\n        at org.mule.component.AbstractComponent.access$000(AbstractComponent.java:61)\r\n        at org.mule.component.AbstractComponent$1$1.process(AbstractComponent.java:242)\r\n        at org.mule.execution.ExceptionToMessagingExceptionExecutionInterceptor.execute(ExceptionToMessagingExceptionExecutionInterceptor.java:27)\r\n        at org.mule.execution.MessageProcessorNotificationExecutionInterceptor.execute(MessageProcessorNotificationExecutionInterceptor.java:61)\r\n        at org.mule.execution.MessageProcessorExecutionTemplate.execute(MessageProcessorExecutionTemplate.java:47)\r\n        at org.mule.processor.chain.DefaultMessageProcessorChain.doProcess(DefaultMessageProcessorChain.java:95)\r\n        at org.mule.processor.chain.AbstractMessageProcessorChain.process(AbstractMessageProcessorChain.java:70)\r\n        at org.mule.processor.chain.InterceptingChainLifecycleWrapper.doProcess(InterceptingChainLifecycleWrapper.java:54)\r\n        at org.mule.processor.chain.AbstractMessageProcessorChain.process(AbstractMessageProcessorChain.java:70)\r\n        at org.mule.processor.chain.InterceptingChainLifecycleWrapper.access$001(InterceptingChainLifecycleWrapper.java:26)\r\n        at org.mule.processor.chain.InterceptingChainLifecycleWrapper$1.process(InterceptingChainLifecycleWrapper.java:70)\r\n        at org.mule.execution.ExceptionToMessagingExceptionExecutionInterceptor.execute(ExceptionToMessagingExceptionExecutionInterceptor.java:27)\r\n        at org.mule.execution.MessageProcessorNotificationExecutionInterceptor.execute(MessageProcessorNotificationExecutionInterceptor.java:61)\r\n        at org.mule.execution.MessageProcessorExecutionTemplate.execute(MessageProcessorExecutionTemplate.java:47)\r\n        at org.mule.processor.chain.InterceptingChainLifecycleWrapper.process(InterceptingChainLifecycleWrapper.java:65)\r\n        at org.mule.component.AbstractComponent.process(AbstractComponent.java:160)\r\n        at org.mule.service.processor.ServiceInternalMessageProcessor.process(ServiceInternalMessageProcessor.java:44)\r\n        at org.mule.execution.ExceptionToMessagingExceptionExecutionInterceptor.execute(ExceptionToMessagingExceptionExecutionInterceptor.java:27)\r\n        at org.mule.execution.MessageProcessorNotificationExecutionInterceptor.execute(MessageProcessorNotificationExecutionInterceptor.java:61)\r\n        at org.mule.execution.MessageProcessorExecutionTemplate.execute(MessageProcessorExecutionTemplate.java:47)\r\n        at org.mule.processor.AbstractInterceptingMessageProcessorBase.processNext(AbstractInterceptingMessageProcessorBase.java:106)\r\n        at org.mule.processor.AsyncInterceptingMessageProcessor.process(AsyncInterceptingMessageProcessor.java:101)\r\n        at org.mule.execution.ExceptionToMessagingExceptionExecutionInterceptor.execute(ExceptionToMessagingExceptionExecutionInterceptor.java:27)\r\n        at org.mule.execution.MessageProcessorNotificationExecutionInterceptor.execute(MessageProcessorNotificationExecutionInterceptor.java:61)\r\n        at org.mule.execution.MessageProcessorExecutionTemplate.execute(MessageProcessorExecutionTemplate.java:47)\r\n        at org.mule.processor.chain.DefaultMessageProcessorChain.doProcess(DefaultMessageProcessorChain.java:95)\r\n        at org.mule.processor.chain.AbstractMessageProcessorChain.process(AbstractMessageProcessorChain.java:70)\r\n        at org.mule.execution.ExceptionToMessagingExceptionExecutionInterceptor.execute(ExceptionToMessagingExceptionExecutionInterceptor.java:27)\r\n        at org.mule.execution.MessageProcessorExecutionTemplate.execute(MessageProcessorExecutionTemplate.java:47)\r\n        at org.mule.processor.AbstractInterceptingMessageProcessorBase.processNext(AbstractInterceptingMessageProcessorBase.java:106)\r\n        at org.mule.interceptor.AbstractEnvelopeInterceptor.process(AbstractEnvelopeInterceptor.java:55)\r\n        at org.mule.execution.ExceptionToMessagingExceptionExecutionInterceptor.execute(ExceptionToMessagingExceptionExecutionInterceptor.java:27)\r\n        at org.mule.execution.MessageProcessorNotificationExecutionInterceptor.execute(MessageProcessorNotificationExecutionInterceptor.java:61)\r\n        at org.mule.execution.MessageProcessorExecutionTemplate.execute(MessageProcessorExecutionTemplate.java:47)\r\n        at org.mule.processor.AbstractInterceptingMessageProcessorBase.processNext(AbstractInterceptingMessageProcessorBase.java:106)\r\n        at org.mule.lifecycle.processor.ProcessIfStartedWaitIfSyncPausedMessageProcessor.process(ProcessIfStartedWaitIfSyncPausedMessageProcessor.java:56)\r\n        at org.mule.execution.ExceptionToMessagingExceptionExecutionInterceptor.execute(ExceptionToMessagingExceptionExecutionInterceptor.java:27)\r\n        at org.mule.execution.MessageProcessorNotificationExecutionInterceptor.execute(MessageProcessorNotificationExecutionInterceptor.java:61)\r\n        at org.mule.execution.MessageProcessorExecutionTemplate.execute(MessageProcessorExecutionTemplate.java:47)\r\n        at org.mule.processor.chain.DefaultMessageProcessorChain.doProcess(DefaultMessageProcessorChain.java:95)\r\n        at org.mule.processor.chain.AbstractMessageProcessorChain.process(AbstractMessageProcessorChain.java:70)\r\n        at org.mule.processor.chain.InterceptingChainLifecycleWrapper.doProcess(InterceptingChainLifecycleWrapper.java:54)\r\n        at org.mule.processor.chain.AbstractMessageProcessorChain.process(AbstractMessageProcessorChain.java:70)\r\n        at org.mule.processor.chain.InterceptingChainLifecycleWrapper.access$001(InterceptingChainLifecycleWrapper.java:26)\r\n        at org.mule.processor.chain.InterceptingChainLifecycleWrapper$1.process(InterceptingChainLifecycleWrapper.java:70)\r\n        at org.mule.execution.ExceptionToMessagingExceptionExecutionInterceptor.execute(ExceptionToMessagingExceptionExecutionInterceptor.java:27)\r\n        at org.mule.execution.MessageProcessorNotificationExecutionInterceptor.execute(MessageProcessorNotificationExecutionInterceptor.java:61)\r\n        at org.mule.execution.MessageProcessorExecutionTemplate.execute(MessageProcessorExecutionTemplate.java:47)\r\n        at org.mule.processor.chain.InterceptingChainLifecycleWrapper.process(InterceptingChainLifecycleWrapper.java:65)\r\n        at org.mule.service.AbstractService.sendEvent(AbstractService.java:517)\r\n        at org.mule.module.client.MuleClient.sendDirect(MuleClient.java:325)\r\n        at org.mule.module.client.MuleClient.sendDirect(MuleClient.java:289)\r\n        at com.eucalyptus.context.ServiceContext.send(ServiceContext.java:203)\r\n        ... 19 more\r\nCaused by: edu.ucsb.eucalyptus.cloud.VolumeSizeExceededException: Total Volume Size Limit Exceeded volume: vol-d859fa84\r\n        at com.eucalyptus.blockstorage.BlockStorageController.CreateStorageVolume(BlockStorageController.java:1076)\r\n        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\r\n        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)\r\n        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\r\n        at java.lang.reflect.Method.invoke(Method.java:606)\r\n        at org.mule.model.resolvers.AbstractEntryPointResolver.invokeMethod(AbstractEntryPointResolver.java:151)\r\n        at org.mule.model.resolvers.ReflectionEntryPointResolver.invoke(ReflectionEntryPointResolver.java:121)\r\n        at org.mule.model.resolvers.DefaultEntryPointResolverSet.invoke(DefaultEntryPointResolverSet.java:39)\r\n        at org.mule.component.DefaultComponentLifecycleAdapter.invoke(DefaultComponentLifecycleAdapter.java:343)\r\n        ... 75 more\r\n{code}\r\n\r\nAn error is registered in {{ClusterAllocator}} as shown below:\r\n\r\n{code}\r\nTue Apr 29 01:05:54 2014 ERROR [ClusterAllocator:Eucalyptus.cluster:ClusterConfiguration:arn:euca:eucalyptus:cloud4:cluster:cc-01/.class java.util.concurrent.ThreadPoolExecutor$Worker#350] [?.?(?):?] com.eucalyptus.entities.TransactionCallbackException: java.lang.RuntimeException: Failed to send message CreateStorageVolumeType to service StorageInternal because: Component that caused exception is: DefaultJavaComponent{StorageInternal.component}. Message payload is of type: CreateStorageVolumeType \r\n{code}\r\n\r\nd) Now system perform {{abort}} operation, here\r\n\r\nI am not sure why abort operation was performed, but looks like this is by *design* written such that if in a middle of operation we cross a limit we abort and {{cleanup}} every artifact that was created before the limit was exceeded. So that means we will delete the volume the system created successfully for the first instance as well as release network addresses \r\n\r\n{code}\r\nTue Apr 29 01:05:54 2014  WARN [Allocations:Eucalyptus.cluster:ClusterConfiguration:arn:euca:eucalyptus:cloud4:cluster:cc-01/.class java.util.concurrent.ThreadPoolExecutor$Worker#350] [?.?(?):?] Aborting resource token: ResourceToken:i-26df6f46:resources=TypedContext:{com.eucalyptus.util.TypedKey(NetworkResources)=[com.eucalyptus.compute.common.network.PublicIPResource(), com.eucalyptus.compute.common.network.PrivateIPResource()]}\r\nTue Apr 29 01:05:54 2014  INFO [Address:Eucalyptus.eucalyptus:EphemeralConfiguration:arn:euca:eucalyptus:::com.eucalyptus.network.DispatchingNetworkingService/.class java.util.concurrent.ThreadPoolExecutor$Worker#376] [?.?(?):?] :1398713754593:Address:ADDRESS_STATE:TOP:Address 192.168.25.131  AddressTransition unallocating:impending->unallocated(true)\r\nTue Apr 29 01:05:54 2014  WARN [Allocations:Eucalyptus.cluster:ClusterConfiguration:arn:euca:eucalyptus:cloud4:cluster:cc-01/.class java.util.concurrent.ThreadPoolExecutor$Worker#350] [?.?(?):?] Aborting resource token: ResourceToken:i-1e81ddcc:resources=TypedContext:{com.eucalyptus.util.TypedKey(NetworkResources)=[com.eucalyptus.compute.common.network.PublicIPResource(), com.eucalyptus.compute.common.network.PrivateIPResource()]}\r\nTue Apr 29 01:05:54 2014  INFO [Address:Eucalyptus.eucalyptus:EphemeralConfiguration:arn:euca:eucalyptus:::com.eucalyptus.network.DispatchingNetworkingService/.class java.util.concurrent.ThreadPoolExecutor$Worker#378] [?.?(?):?] :1398713754635:Address:ADDRESS_STATE:TOP:Address 192.168.25.132  AddressTransition unallocating:impending->unallocated(true)\r\n{code}\r\n\r\nThis cleanup is done by method {{cleanupOnFailure}} in {{ClusterAllocator}} which looks like this:\r\n\r\n{code}\r\n    this.allocInfo.abort( );\r\n    for ( final ResourceToken token : allocInfo.getAllocationTokens( ) ) {\r\n      try {\r\n        final VmInstance vm = VmInstances.lookup( token.getInstanceId() );\r\n        if ( VmState.STOPPED.equals( vm.getLastState( ) ) ) {\r\n          VmInstances.stopped( vm );\r\n        } else {\r\n          VmInstances.terminated( vm );\r\n          VmInstances.terminated( vm );\r\n        }\r\n      } catch ( final Exception e1 ) {\r\n        LOG.error( e1 );\r\n        Logs.extreme( ).error( e1, e1 );\r\n      }\r\n    }\r\n{code}\r\n\r\nBefore this method {{cleanupOnFailure}} is executed we have rolled back the DB, I checked and found the records from CLC database are gone for the instances. As can be seen below:\r\n\r\n{code}\r\ncatch ( final Exception e ) {\r\n      db.rollback( );\r\n      cleanupOnFailure( allocInfo, e );\r\n      return;\r\n    }\r\n{code}\r\n\r\nIn {{cleanupOnFailure}} we execute the {{abort}} method that ran just fine and later when this statement ran\r\n\r\n{code}\r\nfinal VmInstance vm = VmInstances.lookup( token.getInstanceId() );\r\n{code}\r\n\r\nit generated an exception causing following message in log:\r\n\r\n{code}\r\n2014-04-29 02:24:50 ERROR | java.util.NoSuchElementException: example: [VmInstance networkConfig=null vmId=null bootRecord=null usageStats=null launchRecord=null runtimeState=null transientVolumeState=null placement=null expiration=null privateNetwork=null networkGroups=[] networkGroupIds=[] networkIndex=null tags=null ownerUserId=null ownerUserName=null ownerAccountNumber=null uniqueName=null ownerFullNameCached=null state=null lastState=null stateChangeStack=null displayName=i-82250eb6 id=null version=null creationTimestamp=null lastUpdateTimestamp=null naturalId=null]\r\n{code}\r\n\r\nThis is done for both the instances , hence the problem seems to be that we are rolling back the DB and then *trying* to perform a proper cleanup via {{VmInstances.terminated()}} which obviously seems to have failed in this case causing the SC to not get a message from CLC to cleanup its record.\r\n\r\nThis is my conclusion. Please review and provide feedback. If you have any questions please do let me know.","updateAuthor":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=dshekhawat","name":"dshekhawat","key":"dshekhawat","accountId":"557058:dc10d216-39f8-4d84-a5ff-7d4daf8a44ed","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/7cda271db1cec24c198fdfb42ec8a8ae?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Ddshekhawat%26avatarId%3D15400%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/7cda271db1cec24c198fdfb42ec8a8ae?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Ddshekhawat%26avatarId%3D15400%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/7cda271db1cec24c198fdfb42ec8a8ae?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Ddshekhawat%26avatarId%3D15400%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/7cda271db1cec24c198fdfb42ec8a8ae?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Ddshekhawat%26avatarId%3D15400%26noRedirect%3Dtrue"},"displayName":"Deependra Shekhawat","active":false,"timeZone":"Asia/Kolkata"},"created":"2014-05-02T10:24:09.906-0500","updated":"2014-05-02T10:24:09.906-0500"},{"self":"https://eucalyptus.atlassian.net/rest/api/2/issue/29453/comment/68936","id":"68936","author":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=kedwards","name":"kedwards","key":"kedwards","accountId":"557058:f9c2f8da-1fc6-4aa7-8fb0-750e7e422b6b","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/d1746a6d05a30ca027012a7da4545962?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dkedwards%26avatarId%3D10200%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/d1746a6d05a30ca027012a7da4545962?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dkedwards%26avatarId%3D10200%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/d1746a6d05a30ca027012a7da4545962?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dkedwards%26avatarId%3D10200%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/d1746a6d05a30ca027012a7da4545962?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dkedwards%26avatarId%3D10200%26noRedirect%3Dtrue"},"displayName":"Ken Edwards","active":true,"timeZone":"America/Los_Angeles"},"body":"relates to EUCA-9297","updateAuthor":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=kedwards","name":"kedwards","key":"kedwards","accountId":"557058:f9c2f8da-1fc6-4aa7-8fb0-750e7e422b6b","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/d1746a6d05a30ca027012a7da4545962?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dkedwards%26avatarId%3D10200%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/d1746a6d05a30ca027012a7da4545962?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dkedwards%26avatarId%3D10200%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/d1746a6d05a30ca027012a7da4545962?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dkedwards%26avatarId%3D10200%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/d1746a6d05a30ca027012a7da4545962?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dkedwards%26avatarId%3D10200%26noRedirect%3Dtrue"},"displayName":"Ken Edwards","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-05-02T12:47:05.834-0500","updated":"2014-05-02T12:47:05.834-0500"},{"self":"https://eucalyptus.atlassian.net/rest/api/2/issue/29453/comment/72668","id":"72668","author":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=tony","name":"tony","key":"tony","accountId":"557058:353956db-b78c-4f3b-9096-f8f58e6709c8","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/14ec1b18e630cc0743492fc327a12df7?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dtony%26avatarId%3D16600%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/14ec1b18e630cc0743492fc327a12df7?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dtony%26avatarId%3D16600%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/14ec1b18e630cc0743492fc327a12df7?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dtony%26avatarId%3D16600%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/14ec1b18e630cc0743492fc327a12df7?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dtony%26avatarId%3D16600%26noRedirect%3Dtrue"},"displayName":"Tony Beckham","active":true,"timeZone":"America/Tijuana"},"body":"Fix Verified.\r\n\r\nIn the given scenario where there is not enough capacity for the desired reservation, the CLC and SC have matching views of volumes present in the system after the operation completes.\r\n\r\nInstalled Packages\r\nName        : eucalyptus\r\nArch        : x86_64\r\nVersion     : 3.4.2\r\nRelease     : 0.0.555.20140617git96293fb1.el6\r\n\r\nNote: The system will create as many volumes as it can within the limits even though the instances will not run because there is not capacity for the entire reservation.  This behavior is not planned to be fixed in 3.4.X or 4.0.X. There is an ARCH ticket for that (ARCH-91) ","updateAuthor":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=tony","name":"tony","key":"tony","accountId":"557058:353956db-b78c-4f3b-9096-f8f58e6709c8","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/14ec1b18e630cc0743492fc327a12df7?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dtony%26avatarId%3D16600%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/14ec1b18e630cc0743492fc327a12df7?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dtony%26avatarId%3D16600%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/14ec1b18e630cc0743492fc327a12df7?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dtony%26avatarId%3D16600%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/14ec1b18e630cc0743492fc327a12df7?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dtony%26avatarId%3D16600%26noRedirect%3Dtrue"},"displayName":"Tony Beckham","active":true,"timeZone":"America/Tijuana"},"created":"2014-06-18T18:29:53.223-0500","updated":"2014-06-18T18:29:53.223-0500"},{"self":"https://eucalyptus.atlassian.net/rest/api/2/issue/29453/comment/80130","id":"80130","author":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=lbiasi","name":"lbiasi","key":"lbiasi","accountId":"557058:daaebf52-3713-4e4f-a29b-79f55aed32c9","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/3d92822583af436915b8264dbff0d30a?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dlbiasi%26avatarId%3D15002%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/3d92822583af436915b8264dbff0d30a?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dlbiasi%26avatarId%3D15002%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/3d92822583af436915b8264dbff0d30a?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dlbiasi%26avatarId%3D15002%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/3d92822583af436915b8264dbff0d30a?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dlbiasi%26avatarId%3D15002%26noRedirect%3Dtrue"},"displayName":"Leslie Biasi","active":false,"timeZone":"US/Central"},"body":"3.4.3 release 7/11/2014","updateAuthor":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=lbiasi","name":"lbiasi","key":"lbiasi","accountId":"557058:daaebf52-3713-4e4f-a29b-79f55aed32c9","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/3d92822583af436915b8264dbff0d30a?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dlbiasi%26avatarId%3D15002%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/3d92822583af436915b8264dbff0d30a?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dlbiasi%26avatarId%3D15002%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/3d92822583af436915b8264dbff0d30a?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dlbiasi%26avatarId%3D15002%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/3d92822583af436915b8264dbff0d30a?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dlbiasi%26avatarId%3D15002%26noRedirect%3Dtrue"},"displayName":"Leslie Biasi","active":false,"timeZone":"US/Central"},"created":"2014-12-08T16:42:45.807-0600","updated":"2014-12-08T16:42:45.807-0600"}],"maxResults":4,"total":4,"startAt":0},"votes":{"self":"https://eucalyptus.atlassian.net/rest/api/2/issue/EUCA-9296/votes","votes":0,"hasVoted":false},"customfield_11808":null,"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]}}}