{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"62401","self":"https://eucalyptus.atlassian.net/rest/api/2/issue/62401","key":"EUCA-13450","fields":{"issuetype":{"self":"https://eucalyptus.atlassian.net/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://eucalyptus.atlassian.net/secure/viewavatar?size=xsmall&avatarId=14803&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":14803},"timespent":null,"customfield_13100":null,"project":{"self":"https://eucalyptus.atlassian.net/rest/api/2/project/10000","id":"10000","key":"EUCA","name":"Eucalyptus","avatarUrls":{"48x48":"https://eucalyptus.atlassian.net/secure/projectavatar?pid=10000&avatarId=10011","24x24":"https://eucalyptus.atlassian.net/secure/projectavatar?size=small&pid=10000&avatarId=10011","16x16":"https://eucalyptus.atlassian.net/secure/projectavatar?size=xsmall&pid=10000&avatarId=10011","32x32":"https://eucalyptus.atlassian.net/secure/projectavatar?size=medium&pid=10000&avatarId=10011"}},"customfield_11000":null,"fixVersions":[{"self":"https://eucalyptus.atlassian.net/rest/api/2/version/19700","id":"19700","description":"Eucalyptus 4.4.3","name":"4.4.3","archived":false,"released":false}],"customfield_11001":null,"aggregatetimespent":null,"customfield_10310":null,"resolution":null,"customfield_11401":null,"customfield_10311":null,"customfield_11400":null,"customfield_10104":[],"customfield_10500":{"self":"https://eucalyptus.atlassian.net/rest/api/2/customFieldOption/10403","value":"Not Applicable","id":"10403"},"customfield_10302":null,"customfield_10105":null,"customfield_10303":null,"customfield_10304":null,"customfield_10700":null,"customfield_10701":null,"customfield_10306":null,"customfield_10702":null,"customfield_10703":null,"customfield_10704":null,"customfield_10308":null,"resolutiondate":null,"customfield_10309":null,"customfield_10705":null,"workratio":-1,"lastViewed":null,"watches":{"self":"https://eucalyptus.atlassian.net/rest/api/2/issue/EUCA-13450/watchers","watchCount":1,"isWatching":false},"created":"2017-10-19T11:13:13.479-0500","customfield_12000":null,"customfield_12400":null,"priority":{"self":"https://eucalyptus.atlassian.net/rest/api/2/priority/3","iconUrl":"https://eucalyptus.atlassian.net/images/icons/priorities/major.svg","name":"Major","id":"3"},"customfield_12201":null,"customfield_10102":null,"customfield_10300":null,"customfield_12600":"{}","customfield_10301":null,"labels":[],"customfield_11700":null,"aggregatetimeoriginalestimate":null,"timeestimate":null,"customfield_11901":null,"versions":[],"issuelinks":[],"assignee":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=kedwards","name":"kedwards","key":"kedwards","accountId":"557058:f9c2f8da-1fc6-4aa7-8fb0-750e7e422b6b","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/d1746a6d05a30ca027012a7da4545962?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dkedwards%26avatarId%3D10200%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/d1746a6d05a30ca027012a7da4545962?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dkedwards%26avatarId%3D10200%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/d1746a6d05a30ca027012a7da4545962?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dkedwards%26avatarId%3D10200%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/d1746a6d05a30ca027012a7da4545962?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dkedwards%26avatarId%3D10200%26noRedirect%3Dtrue"},"displayName":"Ken Edwards","active":true,"timeZone":"America/Los_Angeles"},"updated":"2017-10-25T10:51:25.375-0500","status":{"self":"https://eucalyptus.atlassian.net/rest/api/2/status/10001","description":"This issue has been validated/reproduced, but has not been prioritized yet.","iconUrl":"https://eucalyptus.atlassian.net/images/icons/statuses/generic.png","name":"Confirmed","id":"10001","statusCategory":{"self":"https://eucalyptus.atlassian.net/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://eucalyptus.atlassian.net/rest/api/2/component/11502","id":"11502","name":"Cloudwatch"}],"timeoriginalestimate":null,"description":"In a cloud deployment using multiple ufs hosts each host with a cloudwatch service will attempt to flush updates for list metrics data every five minutes. If the same item is present on multiple hosts then there can be conflicts when persisting the data. Some example errors are:\r\n\r\n{code}\r\nWed Oct 18 17:21:47 2017 ERROR [ListMetricQueue:cloudwatch-list-metrics-flush-0] [com.eucalyptus.cloudwatch.service.queue.listmetrics.ListMetricQueue$1.run(ListMetricQueue.java):112] org.hibernate.exception.Lock\r\nAcquisitionException: could not execute batch\r\norg.hibernate.exception.LockAcquisitionException: could not execute batch\r\n        at org.hibernate.dialect.PostgreSQL81Dialect$2.convert(PostgreSQL81Dialect.java:416)\r\n        at org.hibernate.exception.internal.StandardSQLExceptionConverter.convert(StandardSQLExceptionConverter.java:49)\r\n        at org.hibernate.engine.jdbc.spi.SqlExceptionHelper.convert(SqlExceptionHelper.java:126)\r\n        at org.hibernate.engine.jdbc.batch.internal.BatchingBatch.performExecution(BatchingBatch.java:136)\r\n        at org.hibernate.engine.jdbc.batch.internal.BatchingBatch.doExecuteBatch(BatchingBatch.java:114)\r\n        at org.hibernate.engine.jdbc.batch.internal.AbstractBatchImpl.execute(AbstractBatchImpl.java:163)\r\n        at org.hibernate.engine.jdbc.internal.JdbcCoordinatorImpl.executeBatch(JdbcCoordinatorImpl.java:226)\r\n        at org.hibernate.engine.spi.ActionQueue.executeActions(ActionQueue.java:484)\r\n        at org.hibernate.engine.spi.ActionQueue.executeActions(ActionQueue.java:351)\r\n        at org.hibernate.event.internal.AbstractFlushingEventListener.performExecutions(AbstractFlushingEventListener.java:350)\r\n        at org.hibernate.event.internal.DefaultAutoFlushEventListener.onAutoFlush(DefaultAutoFlushEventListener.java:67)\r\n        at org.hibernate.internal.SessionImpl.autoFlushIfRequired(SessionImpl.java:1227)\r\n        at org.hibernate.internal.SessionImpl.list(SessionImpl.java:1711)\r\n        at org.hibernate.internal.CriteriaImpl.list(CriteriaImpl.java:380)\r\n        at com.eucalyptus.cloudwatch.common.internal.domain.listmetrics.ListMetricManager.addMetricBatch(ListMetricManager.java:325)\r\n        at com.eucalyptus.cloudwatch.service.queue.listmetrics.ListMetricQueue$1.run(ListMetricQueue.java:106)\r\n        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)\r\n        at java.util.concurrent.FutureTask.runAndReset(FutureTask.java:308)\r\n        at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$301(ScheduledThreadPoolExecutor.java:180)\r\n        at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:294)\r\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)\r\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)\r\n        at java.lang.Thread.run(Thread.java:748)\r\nCaused by: java.sql.BatchUpdateException: Batch entry 0 update eucalyptus_cloudwatch.list_metrics set creation_timestamp='2017-10-10 14:39:32.512000 -07:00:00', last_update_timestamp='2017-10-18 17:21:46.031000 -07:00:00', version=2302, dim_10_name=NULL, dim_10_value=NULL, dim_1_name='AvailabilityZone', dim_1_value='one', dim_2_name='LoadBalancerName', dim_2_value='balancer-5', dim_3_name=NULL, dim_3_value=NULL, dim_4_name=NULL, dim_4_value=NULL, dim_5_name=NULL, dim_5_value=NULL, dim_6_name=NULL, dim_6_value=NULL, dim_7_name=NULL, dim_7_value=NULL, dim_8_name=NULL, dim_8_value=NULL, dim_9_name=NULL, dim_9_value=NULL, account_id='000260257127', metric_name='HealthyHostCount', metric_type='System', namespace='AWS/ELB' where id='8aef85be5f080747015f083a80200c51' and version=2301 was aborted.  Call getNextException to see the cause.\r\n        at org.postgresql.jdbc2.AbstractJdbc2Statement$BatchResultHandler.handleError(AbstractJdbc2Statement.java:2762)\r\n        at org.postgresql.core.v3.QueryExecutorImpl.processResults(QueryExecutorImpl.java:1891)\r\n        at org.postgresql.core.v3.QueryExecutorImpl.execute(QueryExecutorImpl.java:405)\r\n        at org.postgresql.jdbc2.AbstractJdbc2Statement.executeBatch(AbstractJdbc2Statement.java:2909)\r\n        at sun.reflect.GeneratedMethodAccessor595.invoke(Unknown Source)\r\n        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\r\n        at java.lang.reflect.Method.invoke(Method.java:498)\r\n        at org.logicalcobwebs.proxool.ProxyStatement.invoke(ProxyStatement.java:100)\r\n        at org.logicalcobwebs.proxool.ProxyStatement.intercept(ProxyStatement.java:57)\r\n        at $java.sql.Statement$$EnhancerByProxool$$d38e20e9.executeBatch(<generated>)\r\n        at org.hibernate.engine.jdbc.batch.internal.BatchingBatch.performExecution(BatchingBatch.java:127)\r\n        ... 19 more\r\n{code}\r\n\r\n{code}\r\nWed Oct 18 17:26:48 2017 ERROR [ListMetricQueue:cloudwatch-list-metrics-flush-0] [com.eucalyptus.cloudwatch.service.queue.listmetrics.ListMetricQueue$1.run(ListMetricQueue.java):112] org.hibernate.StaleStateException: Batch update returned unexpected row count from update [0]; actual row count: 0; expected: 1\r\norg.hibernate.StaleStateException: Batch update returned unexpected row count from update [0]; actual row count: 0; expected: 1\r\n        at org.hibernate.jdbc.Expectations$BasicExpectation.checkBatched(Expectations.java:81)\r\n        at org.hibernate.jdbc.Expectations$BasicExpectation.verifyOutcome(Expectations.java:73)\r\n        at org.hibernate.engine.jdbc.batch.internal.BatchingBatch.checkRowCounts(BatchingBatch.java:155)\r\n        at org.hibernate.engine.jdbc.batch.internal.BatchingBatch.performExecution(BatchingBatch.java:132)\r\n        at org.hibernate.engine.jdbc.batch.internal.BatchingBatch.doExecuteBatch(BatchingBatch.java:114)\r\n        at org.hibernate.engine.jdbc.batch.internal.AbstractBatchImpl.execute(AbstractBatchImpl.java:163)\r\n        at org.hibernate.engine.jdbc.internal.JdbcCoordinatorImpl.executeBatch(JdbcCoordinatorImpl.java:226)\r\n        at org.hibernate.engine.spi.ActionQueue.executeActions(ActionQueue.java:484)\r\n        at org.hibernate.engine.spi.ActionQueue.executeActions(ActionQueue.java:351)\r\n        at org.hibernate.event.internal.AbstractFlushingEventListener.performExecutions(AbstractFlushingEventListener.java:350)\r\n        at org.hibernate.event.internal.DefaultAutoFlushEventListener.onAutoFlush(DefaultAutoFlushEventListener.java:67)\r\n        at org.hibernate.internal.SessionImpl.autoFlushIfRequired(SessionImpl.java:1227)\r\n        at org.hibernate.internal.SessionImpl.list(SessionImpl.java:1711)\r\n        at org.hibernate.internal.CriteriaImpl.list(CriteriaImpl.java:380)\r\n        at com.eucalyptus.cloudwatch.common.internal.domain.listmetrics.ListMetricManager.addMetricBatch(ListMetricManager.java:325)\r\n        at com.eucalyptus.cloudwatch.service.queue.listmetrics.ListMetricQueue$1.run(ListMetricQueue.java:106)\r\n        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)\r\n        at java.util.concurrent.FutureTask.runAndReset(FutureTask.java:308)\r\n        at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$301(ScheduledThreadPoolExecutor.java:180)\r\n        at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:294)\r\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)\r\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)\r\n        at java.lang.Thread.run(Thread.java:748)\r\n{code}\r\n\r\nIn a test with 4 ufs hosts running a few instances these persistence errors occur frequently as system metrics are updated multiple times during each period and it is likely each metric will hit more than one host.\r\n\r\nWhen an error occurs a batch of list metric data is not persisted, though some of the data could be persisted by other hosts (i.e. the \"duplicate\" items). This may impact the output of the \"euwatch-list-metrics\" command which could be missing some items. This does not impact the metric data itself (euwatch-put-data) as that is separately persisted.\r\n\r\nA work around could be to adjust the timing of metric data collection for ec2, elb, etc. Or to disable metric collection if not used (e.g. autoscaling group metrics). If one of each item was generated during each five minute period then conflicts would not occur.","customfield_13000":null,"customfield_13200":null,"customfield_11300":null,"customfield_11500":null,"timetracking":{},"customfield_10401":null,"customfield_10005":null,"customfield_10600":null,"customfield_12900":null,"attachment":[],"aggregatetimeestimate":null,"summary":"Cloudwatch sometimes fails to persist system metrics with multiple ufs hosts","creator":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=sjones","name":"sjones","key":"sjones","accountId":"557058:f5dce1b0-db45-4dd6-a0e8-3cea5effb5ce","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/037fddf6d3bf6d691a448e01136f233a?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dsjones%26avatarId%3D18300%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/037fddf6d3bf6d691a448e01136f233a?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dsjones%26avatarId%3D18300%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/037fddf6d3bf6d691a448e01136f233a?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dsjones%26avatarId%3D18300%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/037fddf6d3bf6d691a448e01136f233a?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dsjones%26avatarId%3D18300%26noRedirect%3Dtrue"},"displayName":"Steve Jones","active":true,"timeZone":"America/Los_Angeles"},"subtasks":[],"reporter":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=sjones","name":"sjones","key":"sjones","accountId":"557058:f5dce1b0-db45-4dd6-a0e8-3cea5effb5ce","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/037fddf6d3bf6d691a448e01136f233a?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dsjones%26avatarId%3D18300%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/037fddf6d3bf6d691a448e01136f233a?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dsjones%26avatarId%3D18300%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/037fddf6d3bf6d691a448e01136f233a?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dsjones%26avatarId%3D18300%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/037fddf6d3bf6d691a448e01136f233a?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dsjones%26avatarId%3D18300%26noRedirect%3Dtrue"},"displayName":"Steve Jones","active":true,"timeZone":"America/Los_Angeles"},"customfield_12100":"0|i0455r:","aggregateprogress":{"progress":0,"total":0},"customfield_10000":null,"customfield_10001":null,"customfield_10200":null,"customfield_10002":null,"customfield_10003":null,"customfield_12500":null,"customfield_10400":null,"customfield_11600":["kedwards(kedwards)","sjones(sjones)"],"customfield_10116":null,"environment":null,"customfield_10117":null,"customfield_11800":null,"customfield_11802":null,"duedate":null,"customfield_11805":null,"progress":{"progress":0,"total":0},"customfield_11806":null,"votes":{"self":"https://eucalyptus.atlassian.net/rest/api/2/issue/EUCA-13450/votes","votes":0,"hasVoted":false},"comment":{"comments":[{"self":"https://eucalyptus.atlassian.net/rest/api/2/issue/62401/comment/128026","id":"128026","author":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=sjones","name":"sjones","key":"sjones","accountId":"557058:f5dce1b0-db45-4dd6-a0e8-3cea5effb5ce","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/037fddf6d3bf6d691a448e01136f233a?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dsjones%26avatarId%3D18300%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/037fddf6d3bf6d691a448e01136f233a?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dsjones%26avatarId%3D18300%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/037fddf6d3bf6d691a448e01136f233a?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dsjones%26avatarId%3D18300%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/037fddf6d3bf6d691a448e01136f233a?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dsjones%26avatarId%3D18300%26noRedirect%3Dtrue"},"displayName":"Steve Jones","active":true,"timeZone":"America/Los_Angeles"},"body":"A candidate fix for this issue is here:\r\n\r\nhttps://github.com/sjones4/eucalyptus/commit/d99c50291483edaa54c18b7ddc11eacd95be7e47\r\n\r\nThis fix puts system metrics for a specific account/service to a consistent ufs host which generally avoids the potential for conflict.","updateAuthor":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=sjones","name":"sjones","key":"sjones","accountId":"557058:f5dce1b0-db45-4dd6-a0e8-3cea5effb5ce","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/037fddf6d3bf6d691a448e01136f233a?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dsjones%26avatarId%3D18300%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/037fddf6d3bf6d691a448e01136f233a?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dsjones%26avatarId%3D18300%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/037fddf6d3bf6d691a448e01136f233a?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dsjones%26avatarId%3D18300%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/037fddf6d3bf6d691a448e01136f233a?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dsjones%26avatarId%3D18300%26noRedirect%3Dtrue"},"displayName":"Steve Jones","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-10-20T15:18:01.787-0500","updated":"2017-10-20T15:18:01.787-0500"}],"maxResults":1,"total":1,"startAt":0},"customfield_11808":null,"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]}}}