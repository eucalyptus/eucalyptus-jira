{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"47009","self":"https://eucalyptus.atlassian.net/rest/api/2/issue/47009","key":"EUCA-12642","fields":{"issuetype":{"self":"https://eucalyptus.atlassian.net/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://eucalyptus.atlassian.net/secure/viewavatar?size=xsmall&avatarId=14803&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":14803},"timespent":null,"customfield_13100":null,"project":{"self":"https://eucalyptus.atlassian.net/rest/api/2/project/10000","id":"10000","key":"EUCA","name":"Eucalyptus","avatarUrls":{"48x48":"https://eucalyptus.atlassian.net/secure/projectavatar?pid=10000&avatarId=10011","24x24":"https://eucalyptus.atlassian.net/secure/projectavatar?size=small&pid=10000&avatarId=10011","16x16":"https://eucalyptus.atlassian.net/secure/projectavatar?size=xsmall&pid=10000&avatarId=10011","32x32":"https://eucalyptus.atlassian.net/secure/projectavatar?size=medium&pid=10000&avatarId=10011"}},"customfield_11000":null,"fixVersions":[{"self":"https://eucalyptus.atlassian.net/rest/api/2/version/17800","id":"17800","description":"Eucalyptus 4.3.1","name":"4.3.1","archived":false,"released":true,"releaseDate":"2016-12-14"}],"customfield_11001":null,"aggregatetimespent":null,"customfield_10310":null,"resolution":{"self":"https://eucalyptus.atlassian.net/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_11401":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=tony","name":"tony","key":"tony","accountId":"557058:353956db-b78c-4f3b-9096-f8f58e6709c8","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/14ec1b18e630cc0743492fc327a12df7?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dtony%26avatarId%3D16600%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/14ec1b18e630cc0743492fc327a12df7?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dtony%26avatarId%3D16600%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/14ec1b18e630cc0743492fc327a12df7?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dtony%26avatarId%3D16600%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/14ec1b18e630cc0743492fc327a12df7?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dtony%26avatarId%3D16600%26noRedirect%3Dtrue"},"displayName":"Tony Beckham","active":true,"timeZone":"America/Tijuana"},"customfield_10311":null,"customfield_11400":null,"customfield_10104":[],"customfield_10302":null,"customfield_10500":{"self":"https://eucalyptus.atlassian.net/rest/api/2/customFieldOption/10403","value":"Not Applicable","id":"10403"},"customfield_10303":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=swathi","name":"swathi","key":"swathi","accountId":"557058:ab7e71b5-781c-49ea-9f4d-ea9148c88f03","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/d6487612d6674329ecef11be0a95552b?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dswathi%26avatarId%3D17901%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/d6487612d6674329ecef11be0a95552b?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dswathi%26avatarId%3D17901%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/d6487612d6674329ecef11be0a95552b?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dswathi%26avatarId%3D17901%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/d6487612d6674329ecef11be0a95552b?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dswathi%26avatarId%3D17901%26noRedirect%3Dtrue"},"displayName":"Swathi Gangisetty","active":true,"timeZone":"America/Los_Angeles"},"customfield_10105":null,"customfield_10304":null,"customfield_10700":null,"customfield_10701":null,"customfield_10306":null,"customfield_10702":null,"customfield_10703":null,"customfield_10308":null,"customfield_10704":null,"resolutiondate":"2016-11-02T21:42:21.550-0500","customfield_10309":null,"customfield_10705":null,"workratio":-1,"watches":{"self":"https://eucalyptus.atlassian.net/rest/api/2/issue/EUCA-12642/watchers","watchCount":6,"isWatching":false},"lastViewed":null,"created":"2016-08-11T20:44:27.776-0500","customfield_12000":null,"customfield_12400":null,"priority":{"self":"https://eucalyptus.atlassian.net/rest/api/2/priority/2","iconUrl":"https://eucalyptus.atlassian.net/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"customfield_12201":null,"customfield_10300":null,"customfield_10102":null,"customfield_12600":"{repository={count=3, dataType=repository}, json={\"cachedValue\":{\"errors\":[],\"summary\":{\"repository\":{\"overall\":{\"count\":3,\"lastUpdated\":\"2016-08-25T16:21:53.000-0500\",\"dataType\":\"repository\"},\"byInstanceType\":{\"github\":{\"count\":3,\"name\":\"GitHub\"}}}}},\"isStale\":true}}","labels":[],"customfield_10301":null,"customfield_11700":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[{"self":"https://eucalyptus.atlassian.net/rest/api/2/version/17200","id":"17200","description":"Eucalyptus 4.2.2","name":"4.2.2","archived":false,"released":true,"releaseDate":"2016-04-28"},{"self":"https://eucalyptus.atlassian.net/rest/api/2/version/16800","id":"16800","description":"Eucalyptus 4.3.0","name":"4.3.0","archived":false,"released":true,"releaseDate":"2016-08-09"}],"customfield_11901":null,"issuelinks":[],"assignee":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=ccassler","name":"ccassler","key":"ccassler","accountId":"557058:8fb32702-a3cf-42d3-9846-95c74f801354","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/ace94e80ebc0a3b718cc5422760b57de?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dccassler%26avatarId%3D14700%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/ace94e80ebc0a3b718cc5422760b57de?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dccassler%26avatarId%3D14700%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/ace94e80ebc0a3b718cc5422760b57de?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dccassler%26avatarId%3D14700%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/ace94e80ebc0a3b718cc5422760b57de?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dccassler%26avatarId%3D14700%26noRedirect%3Dtrue"},"displayName":"Casey Cassler","active":true,"timeZone":"America/Los_Angeles"},"updated":"2017-01-05T16:26:38.643-0600","status":{"self":"https://eucalyptus.atlassian.net/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://eucalyptus.atlassian.net/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://eucalyptus.atlassian.net/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://eucalyptus.atlassian.net/rest/api/2/component/10010","id":"10010","name":"Node Controller"}],"timeoriginalestimate":null,"customfield_13000":null,"description":"Found during upgrade testing, but easily reproducible:\r\n\r\n# Attach an EBS volume to a running EBS-backed (Boot-From-EBS) instance.\r\n# Stop the instance. (don't reboot)\r\n# Start the instance. \r\n# Verify it shows \"attached\" in euca-describe-volumes.\r\n# Detach that EBS volume you attached.\r\n# Verify it shows \"available\" in euca-describe-volumes.\r\n# Stop the NC (systemctl stop eucalyptus-node.service).\r\n# Restart the NC (systemctl start eucalyptus-node.service).\r\n\r\nThat volume should show \"available\" in euca-describe-volumes, but instead it shows \"attached\". But the instance cannot see the volume (it's not a /dev/vd* device).\r\n\r\nWorkaround: If you want it to be available (detached), then:\r\n# Stop the instance (don't reboot)\r\n# Detach the volume (it will succeed now)\r\n# Restart the instance\r\n\r\n[~swathi] found the likely smoking gun:\r\n\r\nhttps://github.com/eucalyptus/eucalyptus/blob/master/storage/backing.c#L743\r\n{noformat}\r\nncInstance *load_instance_struct(const char *instanceId)\r\n{\r\n...\r\n            if (save_volume(instance,\r\n                            volumeId,\r\n                            vbr->resourceLocation, // attachmentToken\r\n                            vbr->preparedResourceLocation, // connect_string\r\n                            vbr->guestDeviceName,\r\n                            VOL_STATE_ATTACHED,\r\n                            vbr->backingPath) == NULL) { // the XML\r\n...\t\r\n{noformat}\r\n\r\nThis instance adoption code runs when an NC starts up. It should check what the actual volume state is, might not be VOL_STATE_ATTACHED!\r\n","customfield_13200":null,"customfield_11300":null,"customfield_11500":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=jbreiding","name":"jbreiding","key":"jbreiding","accountId":"557058:2be99265-2170-4b3d-8e28-2f0728ab294e","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/dc55053b5c09c4537ccb41597d60fece?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Djbreiding%26avatarId%3D17000%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/dc55053b5c09c4537ccb41597d60fece?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Djbreiding%26avatarId%3D17000%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/dc55053b5c09c4537ccb41597d60fece?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Djbreiding%26avatarId%3D17000%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/dc55053b5c09c4537ccb41597d60fece?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Djbreiding%26avatarId%3D17000%26noRedirect%3Dtrue"},"displayName":"jeremy breiding","active":true,"timeZone":"US/Central"},"timetracking":{},"customfield_10401":null,"customfield_10005":null,"customfield_10600":null,"customfield_12900":null,"attachment":[],"aggregatetimeestimate":null,"summary":"EBS volume detached from EBS-backed instance says attached","creator":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=lincoln.thomas","name":"lincoln.thomas","key":"lincoln.thomas","accountId":"557058:f9364c00-87ee-4948-b657-bb8f8f2030ea","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/c21bba9797b880c34a5d772e6db4664f?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dlincoln.thomas%26avatarId%3D17800%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/c21bba9797b880c34a5d772e6db4664f?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dlincoln.thomas%26avatarId%3D17800%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/c21bba9797b880c34a5d772e6db4664f?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dlincoln.thomas%26avatarId%3D17800%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/c21bba9797b880c34a5d772e6db4664f?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dlincoln.thomas%26avatarId%3D17800%26noRedirect%3Dtrue"},"displayName":"Lincoln Thomas","active":true,"timeZone":"America/Los_Angeles"},"subtasks":[],"reporter":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=lincoln.thomas","name":"lincoln.thomas","key":"lincoln.thomas","accountId":"557058:f9364c00-87ee-4948-b657-bb8f8f2030ea","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/c21bba9797b880c34a5d772e6db4664f?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dlincoln.thomas%26avatarId%3D17800%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/c21bba9797b880c34a5d772e6db4664f?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dlincoln.thomas%26avatarId%3D17800%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/c21bba9797b880c34a5d772e6db4664f?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dlincoln.thomas%26avatarId%3D17800%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/c21bba9797b880c34a5d772e6db4664f?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dlincoln.thomas%26avatarId%3D17800%26noRedirect%3Dtrue"},"displayName":"Lincoln Thomas","active":true,"timeZone":"America/Los_Angeles"},"aggregateprogress":{"progress":0,"total":0},"customfield_10000":"3_*:*_1_*:*_14795_*|*_10000_*:*_1_*:*_667144339_*|*_10002_*:*_1_*:*_5482231_*|*_10003_*:*_2_*:*_3729187950_*|*_10006_*:*_2_*:*_2772844477","customfield_12100":"0|i03wan:","customfield_10001":"2016-08-12T07:39:32.288-0500","customfield_10200":null,"customfield_10002":null,"customfield_10003":null,"customfield_12500":null,"customfield_10400":null,"customfield_10116":null,"customfield_11600":["ccassler(ccassler)","jbreiding(jbreiding)","lincoln.thomas(lincoln.thomas)","swathi(swathi)","vasya(vasya)"],"customfield_10117":null,"environment":null,"customfield_11800":null,"customfield_11802":null,"duedate":null,"customfield_11805":null,"customfield_11806":null,"progress":{"progress":0,"total":0},"votes":{"self":"https://eucalyptus.atlassian.net/rest/api/2/issue/EUCA-12642/votes","votes":0,"hasVoted":false},"comment":{"comments":[{"self":"https://eucalyptus.atlassian.net/rest/api/2/issue/47009/comment/108225","id":"108225","author":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=jbreiding","name":"jbreiding","key":"jbreiding","accountId":"557058:2be99265-2170-4b3d-8e28-2f0728ab294e","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/dc55053b5c09c4537ccb41597d60fece?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Djbreiding%26avatarId%3D17000%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/dc55053b5c09c4537ccb41597d60fece?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Djbreiding%26avatarId%3D17000%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/dc55053b5c09c4537ccb41597d60fece?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Djbreiding%26avatarId%3D17000%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/dc55053b5c09c4537ccb41597d60fece?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Djbreiding%26avatarId%3D17000%26noRedirect%3Dtrue"},"displayName":"jeremy breiding","active":true,"timeZone":"US/Central"},"body":"I don't think the reproduction steps are right, this logic would require the disk be in the VBR which requires it be part of the run instance not be attached a post run.\r\n\r\nThe code identified would only copy all ebs volumes from the VBR records and set the state to attached.\r\n\r\nI don't think see how the volume should be able to be attached if it is found in the VBR. Looking at the definition of the structs there is no state captured, based on the assumption that those cannot be detached.","updateAuthor":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=jbreiding","name":"jbreiding","key":"jbreiding","accountId":"557058:2be99265-2170-4b3d-8e28-2f0728ab294e","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/dc55053b5c09c4537ccb41597d60fece?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Djbreiding%26avatarId%3D17000%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/dc55053b5c09c4537ccb41597d60fece?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Djbreiding%26avatarId%3D17000%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/dc55053b5c09c4537ccb41597d60fece?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Djbreiding%26avatarId%3D17000%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/dc55053b5c09c4537ccb41597d60fece?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Djbreiding%26avatarId%3D17000%26noRedirect%3Dtrue"},"displayName":"jeremy breiding","active":true,"timeZone":"US/Central"},"created":"2016-08-12T07:39:32.288-0500","updated":"2016-08-12T07:39:32.288-0500"},{"self":"https://eucalyptus.atlassian.net/rest/api/2/issue/47009/comment/108230","id":"108230","author":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=lincoln.thomas","name":"lincoln.thomas","key":"lincoln.thomas","accountId":"557058:f9364c00-87ee-4948-b657-bb8f8f2030ea","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/c21bba9797b880c34a5d772e6db4664f?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dlincoln.thomas%26avatarId%3D17800%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/c21bba9797b880c34a5d772e6db4664f?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dlincoln.thomas%26avatarId%3D17800%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/c21bba9797b880c34a5d772e6db4664f?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dlincoln.thomas%26avatarId%3D17800%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/c21bba9797b880c34a5d772e6db4664f?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dlincoln.thomas%26avatarId%3D17800%26noRedirect%3Dtrue"},"displayName":"Lincoln Thomas","active":true,"timeZone":"America/Los_Angeles"},"body":"According to [~swathi], if you attach volumes to a running EBS-backed instance, and then stop it, those volumes become VBR records which are labeled as attached when you start the instance again. If such a volume is ever detached before stopping the instance, that state is not honored by this code when you start the instance later, and it appears to be attached, but it isn't. The instance doesn't see it because it's not really attached. Hence the problem. You can't detach nor attach it, unless you do the workaround.","updateAuthor":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=lincoln.thomas","name":"lincoln.thomas","key":"lincoln.thomas","accountId":"557058:f9364c00-87ee-4948-b657-bb8f8f2030ea","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/c21bba9797b880c34a5d772e6db4664f?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dlincoln.thomas%26avatarId%3D17800%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/c21bba9797b880c34a5d772e6db4664f?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dlincoln.thomas%26avatarId%3D17800%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/c21bba9797b880c34a5d772e6db4664f?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dlincoln.thomas%26avatarId%3D17800%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/c21bba9797b880c34a5d772e6db4664f?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dlincoln.thomas%26avatarId%3D17800%26noRedirect%3Dtrue"},"displayName":"Lincoln Thomas","active":true,"timeZone":"America/Los_Angeles"},"created":"2016-08-12T10:59:13.187-0500","updated":"2016-08-12T10:59:13.187-0500"},{"self":"https://eucalyptus.atlassian.net/rest/api/2/issue/47009/comment/108234","id":"108234","author":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=swathi","name":"swathi","key":"swathi","accountId":"557058:ab7e71b5-781c-49ea-9f4d-ea9148c88f03","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/d6487612d6674329ecef11be0a95552b?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dswathi%26avatarId%3D17901%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/d6487612d6674329ecef11be0a95552b?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dswathi%26avatarId%3D17901%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/d6487612d6674329ecef11be0a95552b?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dswathi%26avatarId%3D17901%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/d6487612d6674329ecef11be0a95552b?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dswathi%26avatarId%3D17901%26noRedirect%3Dtrue"},"displayName":"Swathi Gangisetty","active":true,"timeZone":"America/Los_Angeles"},"body":"[~jbreiding], volumes are sent in vbrs both at run instance and start instance time. From the NC's perspective stop and start instance operations are synonymous to terminate and launch operations respectively. When an EBS instance with multiple attached volumes is stopped and started, the start request from CLC sends all attached volumes as VBRs for a few reasons (to indicate that NC boot the instance with all attached volumes as that was the state before stopping and also because kvm dislikes attaching devices to the guest while the guest boots up). The logic to indiscriminately mark all volumes in vbrs as attached predates the ebs redesign in a 3.x release and should have been removed.  ","updateAuthor":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=swathi","name":"swathi","key":"swathi","accountId":"557058:ab7e71b5-781c-49ea-9f4d-ea9148c88f03","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/d6487612d6674329ecef11be0a95552b?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dswathi%26avatarId%3D17901%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/d6487612d6674329ecef11be0a95552b?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dswathi%26avatarId%3D17901%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/d6487612d6674329ecef11be0a95552b?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dswathi%26avatarId%3D17901%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/d6487612d6674329ecef11be0a95552b?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dswathi%26avatarId%3D17901%26noRedirect%3Dtrue"},"displayName":"Swathi Gangisetty","active":true,"timeZone":"America/Los_Angeles"},"created":"2016-08-12T12:15:02.041-0500","updated":"2016-08-12T12:15:02.041-0500"},{"self":"https://eucalyptus.atlassian.net/rest/api/2/issue/47009/comment/108235","id":"108235","author":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=jbreiding","name":"jbreiding","key":"jbreiding","accountId":"557058:2be99265-2170-4b3d-8e28-2f0728ab294e","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/dc55053b5c09c4537ccb41597d60fece?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Djbreiding%26avatarId%3D17000%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/dc55053b5c09c4537ccb41597d60fece?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Djbreiding%26avatarId%3D17000%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/dc55053b5c09c4537ccb41597d60fece?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Djbreiding%26avatarId%3D17000%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/dc55053b5c09c4537ccb41597d60fece?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Djbreiding%26avatarId%3D17000%26noRedirect%3Dtrue"},"displayName":"jeremy breiding","active":true,"timeZone":"US/Central"},"body":"[~swathi] Thanks for that explanation. So it sounds like the issue is the start instance request and that the CLC needs to adjust how it presents these volumes.","updateAuthor":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=jbreiding","name":"jbreiding","key":"jbreiding","accountId":"557058:2be99265-2170-4b3d-8e28-2f0728ab294e","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/dc55053b5c09c4537ccb41597d60fece?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Djbreiding%26avatarId%3D17000%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/dc55053b5c09c4537ccb41597d60fece?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Djbreiding%26avatarId%3D17000%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/dc55053b5c09c4537ccb41597d60fece?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Djbreiding%26avatarId%3D17000%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/dc55053b5c09c4537ccb41597d60fece?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Djbreiding%26avatarId%3D17000%26noRedirect%3Dtrue"},"displayName":"jeremy breiding","active":true,"timeZone":"US/Central"},"created":"2016-08-12T12:24:21.987-0500","updated":"2016-08-12T12:24:21.987-0500"},{"self":"https://eucalyptus.atlassian.net/rest/api/2/issue/47009/comment/108236","id":"108236","author":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=swathi","name":"swathi","key":"swathi","accountId":"557058:ab7e71b5-781c-49ea-9f4d-ea9148c88f03","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/d6487612d6674329ecef11be0a95552b?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dswathi%26avatarId%3D17901%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/d6487612d6674329ecef11be0a95552b?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dswathi%26avatarId%3D17901%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/d6487612d6674329ecef11be0a95552b?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dswathi%26avatarId%3D17901%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/d6487612d6674329ecef11be0a95552b?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dswathi%26avatarId%3D17901%26noRedirect%3Dtrue"},"displayName":"Swathi Gangisetty","active":true,"timeZone":"America/Los_Angeles"},"body":"Another workflow to reproduce the issue\r\n\r\n# Launch an ebs instance with multiple block device mappings\r\n{noformat}\r\neuca-run-instances emi-4931419B -b /dev/sdb=:1:false\r\n{noformat}\r\n# After the instance is running verify that a new volume is created for /dev/sdb mapping and available from the guest\r\n# Detach the volume created for /dev/sdb mapping and verify EC2 volume state transitions to 'available' and volume is not accessible from the guest\r\n# Stop the NC (systemctl stop eucalyptus-node.service).\r\n# Restart the NC (systemctl start eucalyptus-node.service)\r\n# Check EC2 volume state for the detached volume. Due to this bug the state will be 'attached' although the volume is not actually attached to the instance","updateAuthor":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=swathi","name":"swathi","key":"swathi","accountId":"557058:ab7e71b5-781c-49ea-9f4d-ea9148c88f03","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/d6487612d6674329ecef11be0a95552b?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dswathi%26avatarId%3D17901%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/d6487612d6674329ecef11be0a95552b?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dswathi%26avatarId%3D17901%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/d6487612d6674329ecef11be0a95552b?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dswathi%26avatarId%3D17901%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/d6487612d6674329ecef11be0a95552b?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dswathi%26avatarId%3D17901%26noRedirect%3Dtrue"},"displayName":"Swathi Gangisetty","active":true,"timeZone":"America/Los_Angeles"},"created":"2016-08-12T12:33:26.113-0500","updated":"2016-08-12T12:33:26.113-0500"},{"self":"https://eucalyptus.atlassian.net/rest/api/2/issue/47009/comment/108237","id":"108237","author":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=swathi","name":"swathi","key":"swathi","accountId":"557058:ab7e71b5-781c-49ea-9f4d-ea9148c88f03","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/d6487612d6674329ecef11be0a95552b?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dswathi%26avatarId%3D17901%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/d6487612d6674329ecef11be0a95552b?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dswathi%26avatarId%3D17901%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/d6487612d6674329ecef11be0a95552b?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dswathi%26avatarId%3D17901%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/d6487612d6674329ecef11be0a95552b?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dswathi%26avatarId%3D17901%26noRedirect%3Dtrue"},"displayName":"Swathi Gangisetty","active":true,"timeZone":"America/Los_Angeles"},"body":"[~jbreiding], I don't think the issue is in the messaging construct between CLC and NC. The NC should not blanket assume that all volumes in the vbrs are attached. In addition, volume detachment logic on the NC should update the vbr so the instance state is more accurately reflected in the instance.xml. I think the first step is to remove [lines 729 through 749|https://github.com/eucalyptus/eucalyptus/blob/57d5555cfb46b2f3ac9d3f7da3f96792e072980d/storage/backing.c#L729-L749]\r\n{noformat}\r\ndiff --git a/storage/backing.c b/storage/backing.c\r\nindex b41a18f..789f7c2 100644\r\n--- a/storage/backing.c\r\n+++ b/storage/backing.c\r\n@@ -726,28 +726,6 @@ ncInstance *load_instance_struct(const char *instanceId)\r\n \r\n     // perform any upgrade-related manipulations to bring the struct up to date\r\n \r\n-    // copy EBS entries from VBR[] to volumes[], as ebs vols are always in volumes[] as of 4.1.0\r\n-    for (int i = 0; ((i < EUCA_MAX_VBRS) && (i < instance->params.virtualBootRecordLen)); i++) {\r\n-        virtualBootRecord *vbr = &(instance->params.virtualBootRecord[i]);\r\n-        if (vbr->locationType == NC_LOCATION_SC) {\r\n-            char *volumeId = vbr->id; // id is 'emi-XXXX', replace it with 'vol-XXXX'\r\n-            ebs_volume_data *vol_data = NULL;\r\n-            if (deserialize_volume(vbr->resourceLocation, &vol_data) == 0) {\r\n-                volumeId = vol_data->volumeId;\r\n-            }\r\n-            if (save_volume(instance,\r\n-                            volumeId,\r\n-                            vbr->resourceLocation, // attachmentToken\r\n-                            vbr->preparedResourceLocation, // connect_string\r\n-                            vbr->guestDeviceName,\r\n-                            VOL_STATE_ATTACHED,\r\n-                            vbr->backingPath) == NULL) { // the XML\r\n-                LOGERROR(\"[%s] failed to add record for volume %s during instance adoption\\n\", instance->instanceId, volumeId);\r\n-            }\r\n-            EUCA_FREE(vol_data);\r\n-        }\r\n-    }\r\n-\r\n     // save the struct back to disk after the upgrade routine had a chance to modify it\r\n     if (gen_instance_xml(instance) != EUCA_OK) {\r\n         LOGERROR(\"failed to create instance XML in %s\\n\", instance->xmlFilePath);\r\n\r\n{noformat}\r\n\r\nVolumes would be read and updated correctly by [{{read_instance_xml(xmlFP, instance)}}|https://github.com/eucalyptus/eucalyptus/blob/57d5555cfb46b2f3ac9d3f7da3f96792e072980d/storage/backing.c#L708]","updateAuthor":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=swathi","name":"swathi","key":"swathi","accountId":"557058:ab7e71b5-781c-49ea-9f4d-ea9148c88f03","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/d6487612d6674329ecef11be0a95552b?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dswathi%26avatarId%3D17901%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/d6487612d6674329ecef11be0a95552b?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dswathi%26avatarId%3D17901%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/d6487612d6674329ecef11be0a95552b?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dswathi%26avatarId%3D17901%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/d6487612d6674329ecef11be0a95552b?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dswathi%26avatarId%3D17901%26noRedirect%3Dtrue"},"displayName":"Swathi Gangisetty","active":true,"timeZone":"America/Los_Angeles"},"created":"2016-08-12T12:47:19.511-0500","updated":"2016-08-12T12:47:19.511-0500"},{"self":"https://eucalyptus.atlassian.net/rest/api/2/issue/47009/comment/108238","id":"108238","author":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=jbreiding","name":"jbreiding","key":"jbreiding","accountId":"557058:2be99265-2170-4b3d-8e28-2f0728ab294e","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/dc55053b5c09c4537ccb41597d60fece?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Djbreiding%26avatarId%3D17000%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/dc55053b5c09c4537ccb41597d60fece?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Djbreiding%26avatarId%3D17000%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/dc55053b5c09c4537ccb41597d60fece?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Djbreiding%26avatarId%3D17000%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/dc55053b5c09c4537ccb41597d60fece?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Djbreiding%26avatarId%3D17000%26noRedirect%3Dtrue"},"displayName":"jeremy breiding","active":true,"timeZone":"US/Central"},"body":"[~swathi] I think we need to have a sit down and discuss how far reaching the side effects of this could be.\r\n\r\nWould this change mean these volumes will no longer have volume nodes in the instance xml? It seems like perhaps that detaching the volume maybe needs to go a bit further in removing its association with the instance. \r\n\r\nThere is no attachment state in the VBR struct and that maybe means the intention was that anything coming in from a VBR should be attached or not be present in the VBR list.","updateAuthor":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=jbreiding","name":"jbreiding","key":"jbreiding","accountId":"557058:2be99265-2170-4b3d-8e28-2f0728ab294e","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/dc55053b5c09c4537ccb41597d60fece?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Djbreiding%26avatarId%3D17000%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/dc55053b5c09c4537ccb41597d60fece?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Djbreiding%26avatarId%3D17000%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/dc55053b5c09c4537ccb41597d60fece?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Djbreiding%26avatarId%3D17000%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/dc55053b5c09c4537ccb41597d60fece?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Djbreiding%26avatarId%3D17000%26noRedirect%3Dtrue"},"displayName":"jeremy breiding","active":true,"timeZone":"US/Central"},"created":"2016-08-12T13:30:07.489-0500","updated":"2016-08-12T13:30:07.489-0500"},{"self":"https://eucalyptus.atlassian.net/rest/api/2/issue/47009/comment/108240","id":"108240","author":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=swathi","name":"swathi","key":"swathi","accountId":"557058:ab7e71b5-781c-49ea-9f4d-ea9148c88f03","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/d6487612d6674329ecef11be0a95552b?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dswathi%26avatarId%3D17901%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/d6487612d6674329ecef11be0a95552b?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dswathi%26avatarId%3D17901%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/d6487612d6674329ecef11be0a95552b?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dswathi%26avatarId%3D17901%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/d6487612d6674329ecef11be0a95552b?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dswathi%26avatarId%3D17901%26noRedirect%3Dtrue"},"displayName":"Swathi Gangisetty","active":true,"timeZone":"America/Los_Angeles"},"body":"[~jbreiding]: Happy to discuss this further. To answer your question, making this change would not mean that volumes will no longer have volume nodes in the instance xml. As I pointed in my previous comment, instance adoption logic will read the xml file from disk and load the volume structures from the volume nodes in the xml. Volume nodes in the xml reflect the state of the attachment accurately and that should rightfully be the source of the volumes in the cached instance structure on NC. I'll reiterate that the NC should not modify the volume state based on vbrs. The logic I asked to remove is there because the pre 3.3 code did setup volume structures for vbr based volumes making it impossible to detach them. But that has changed a long time back and we needn't worry about the upgrade case from pre 3.3 to 4.3.x release. ","updateAuthor":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=swathi","name":"swathi","key":"swathi","accountId":"557058:ab7e71b5-781c-49ea-9f4d-ea9148c88f03","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/d6487612d6674329ecef11be0a95552b?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dswathi%26avatarId%3D17901%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/d6487612d6674329ecef11be0a95552b?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dswathi%26avatarId%3D17901%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/d6487612d6674329ecef11be0a95552b?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dswathi%26avatarId%3D17901%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/d6487612d6674329ecef11be0a95552b?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dswathi%26avatarId%3D17901%26noRedirect%3Dtrue"},"displayName":"Swathi Gangisetty","active":true,"timeZone":"America/Los_Angeles"},"created":"2016-08-12T13:56:34.706-0500","updated":"2016-08-12T13:56:34.706-0500"},{"self":"https://eucalyptus.atlassian.net/rest/api/2/issue/47009/comment/108241","id":"108241","author":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=jbreiding","name":"jbreiding","key":"jbreiding","accountId":"557058:2be99265-2170-4b3d-8e28-2f0728ab294e","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/dc55053b5c09c4537ccb41597d60fece?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Djbreiding%26avatarId%3D17000%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/dc55053b5c09c4537ccb41597d60fece?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Djbreiding%26avatarId%3D17000%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/dc55053b5c09c4537ccb41597d60fece?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Djbreiding%26avatarId%3D17000%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/dc55053b5c09c4537ccb41597d60fece?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Djbreiding%26avatarId%3D17000%26noRedirect%3Dtrue"},"displayName":"jeremy breiding","active":true,"timeZone":"US/Central"},"body":"[~swathi] Okay digging deeper it seems this function is only used in two places and in both places neither should be modifying volume state and both should depend on exactly how the instance is represented in instance.xml. Like you said.\r\n\r\nThanks.","updateAuthor":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=jbreiding","name":"jbreiding","key":"jbreiding","accountId":"557058:2be99265-2170-4b3d-8e28-2f0728ab294e","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/dc55053b5c09c4537ccb41597d60fece?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Djbreiding%26avatarId%3D17000%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/dc55053b5c09c4537ccb41597d60fece?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Djbreiding%26avatarId%3D17000%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/dc55053b5c09c4537ccb41597d60fece?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Djbreiding%26avatarId%3D17000%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/dc55053b5c09c4537ccb41597d60fece?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Djbreiding%26avatarId%3D17000%26noRedirect%3Dtrue"},"displayName":"jeremy breiding","active":true,"timeZone":"US/Central"},"created":"2016-08-12T14:12:44.212-0500","updated":"2016-08-12T14:12:44.212-0500"},{"self":"https://eucalyptus.atlassian.net/rest/api/2/issue/47009/comment/109227","id":"109227","author":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=jbreiding","name":"jbreiding","key":"jbreiding","accountId":"557058:2be99265-2170-4b3d-8e28-2f0728ab294e","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/dc55053b5c09c4537ccb41597d60fece?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Djbreiding%26avatarId%3D17000%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/dc55053b5c09c4537ccb41597d60fece?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Djbreiding%26avatarId%3D17000%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/dc55053b5c09c4537ccb41597d60fece?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Djbreiding%26avatarId%3D17000%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/dc55053b5c09c4537ccb41597d60fece?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Djbreiding%26avatarId%3D17000%26noRedirect%3Dtrue"},"displayName":"jeremy breiding","active":true,"timeZone":"US/Central"},"body":"PR created for review.\r\n\r\nhttps://github.com/eucalyptus/eucalyptus/pull/67","updateAuthor":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=jbreiding","name":"jbreiding","key":"jbreiding","accountId":"557058:2be99265-2170-4b3d-8e28-2f0728ab294e","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/dc55053b5c09c4537ccb41597d60fece?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Djbreiding%26avatarId%3D17000%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/dc55053b5c09c4537ccb41597d60fece?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Djbreiding%26avatarId%3D17000%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/dc55053b5c09c4537ccb41597d60fece?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Djbreiding%26avatarId%3D17000%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/dc55053b5c09c4537ccb41597d60fece?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Djbreiding%26avatarId%3D17000%26noRedirect%3Dtrue"},"displayName":"jeremy breiding","active":true,"timeZone":"US/Central"},"created":"2016-08-19T14:03:46.907-0500","updated":"2016-08-19T14:03:46.907-0500"},{"self":"https://eucalyptus.atlassian.net/rest/api/2/issue/47009/comment/109230","id":"109230","author":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=swathi","name":"swathi","key":"swathi","accountId":"557058:ab7e71b5-781c-49ea-9f4d-ea9148c88f03","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/d6487612d6674329ecef11be0a95552b?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dswathi%26avatarId%3D17901%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/d6487612d6674329ecef11be0a95552b?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dswathi%26avatarId%3D17901%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/d6487612d6674329ecef11be0a95552b?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dswathi%26avatarId%3D17901%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/d6487612d6674329ecef11be0a95552b?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dswathi%26avatarId%3D17901%26noRedirect%3Dtrue"},"displayName":"Swathi Gangisetty","active":true,"timeZone":"America/Los_Angeles"},"body":"Refer to PR for code review comments and subsequent changes","updateAuthor":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=swathi","name":"swathi","key":"swathi","accountId":"557058:ab7e71b5-781c-49ea-9f4d-ea9148c88f03","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/d6487612d6674329ecef11be0a95552b?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dswathi%26avatarId%3D17901%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/d6487612d6674329ecef11be0a95552b?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dswathi%26avatarId%3D17901%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/d6487612d6674329ecef11be0a95552b?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dswathi%26avatarId%3D17901%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/d6487612d6674329ecef11be0a95552b?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dswathi%26avatarId%3D17901%26noRedirect%3Dtrue"},"displayName":"Swathi Gangisetty","active":true,"timeZone":"America/Los_Angeles"},"created":"2016-08-19T15:35:09.138-0500","updated":"2016-08-19T15:35:09.138-0500"},{"self":"https://eucalyptus.atlassian.net/rest/api/2/issue/47009/comment/110131","id":"110131","author":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=vasya","name":"vasya","key":"vasya","accountId":"557058:1c63481a-0634-4ae7-9004-cb0f143e141f","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/fa832ffa4e20c9aa05ac272214d43196?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dvasya%26avatarId%3D10408%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/fa832ffa4e20c9aa05ac272214d43196?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dvasya%26avatarId%3D10408%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/fa832ffa4e20c9aa05ac272214d43196?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dvasya%26avatarId%3D10408%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/fa832ffa4e20c9aa05ac272214d43196?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dvasya%26avatarId%3D10408%26noRedirect%3Dtrue"},"displayName":"Vasiliy Kochergin","active":false,"timeZone":"America/Los_Angeles"},"body":"Changes were merged c3139ba6fd8f479f704883308a34ad58d1b48ace  and 44983cc2da7e105284eaf6e61c2be803703e6db8","updateAuthor":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=vasya","name":"vasya","key":"vasya","accountId":"557058:1c63481a-0634-4ae7-9004-cb0f143e141f","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/fa832ffa4e20c9aa05ac272214d43196?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dvasya%26avatarId%3D10408%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/fa832ffa4e20c9aa05ac272214d43196?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dvasya%26avatarId%3D10408%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/fa832ffa4e20c9aa05ac272214d43196?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dvasya%26avatarId%3D10408%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/fa832ffa4e20c9aa05ac272214d43196?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dvasya%26avatarId%3D10408%26noRedirect%3Dtrue"},"displayName":"Vasiliy Kochergin","active":false,"timeZone":"America/Los_Angeles"},"created":"2016-09-09T14:27:23.685-0500","updated":"2016-09-09T14:27:23.685-0500"},{"self":"https://eucalyptus.atlassian.net/rest/api/2/issue/47009/comment/112489","id":"112489","author":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=ccassler","name":"ccassler","key":"ccassler","accountId":"557058:8fb32702-a3cf-42d3-9846-95c74f801354","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/ace94e80ebc0a3b718cc5422760b57de?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dccassler%26avatarId%3D14700%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/ace94e80ebc0a3b718cc5422760b57de?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dccassler%26avatarId%3D14700%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/ace94e80ebc0a3b718cc5422760b57de?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dccassler%26avatarId%3D14700%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/ace94e80ebc0a3b718cc5422760b57de?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dccassler%26avatarId%3D14700%26noRedirect%3Dtrue"},"displayName":"Casey Cassler","active":true,"timeZone":"America/Los_Angeles"},"body":"Verified.  I could not reproduce this.\r\n{code}\r\n[root@c-34 ~]# rpm -qi eucalyptus\r\nName        : eucalyptus                   Relocations: (not relocatable)\r\nVersion     : 4.3.1                             Vendor: Hewlett Packard Enterprise\r\nRelease     : 0.25135.61.20161031git2ca359f.el6   Build Date: Mon 31 Oct 2016 03:17:22 PM PDT\r\nInstall Date: Tue 01 Nov 2016 10:07:43 AM PDT      Build Host: buildsys.qa1.eucalyptus-systems.com\r\nGroup       : Applications/System           Source RPM: eucalyptus-4.3.1-0.25135.61.20161031git2ca359f.el6.src.rpm\r\nSize        : 272850                           License: GPLv3\r\n{code}","updateAuthor":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=ccassler","name":"ccassler","key":"ccassler","accountId":"557058:8fb32702-a3cf-42d3-9846-95c74f801354","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/ace94e80ebc0a3b718cc5422760b57de?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dccassler%26avatarId%3D14700%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/ace94e80ebc0a3b718cc5422760b57de?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dccassler%26avatarId%3D14700%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/ace94e80ebc0a3b718cc5422760b57de?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dccassler%26avatarId%3D14700%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/ace94e80ebc0a3b718cc5422760b57de?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dccassler%26avatarId%3D14700%26noRedirect%3Dtrue"},"displayName":"Casey Cassler","active":true,"timeZone":"America/Los_Angeles"},"created":"2016-11-02T21:42:21.563-0500","updated":"2016-11-02T21:42:21.563-0500"}],"maxResults":13,"total":13,"startAt":0},"customfield_11808":null,"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]}}}