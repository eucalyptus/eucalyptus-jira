{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"61400","self":"https://eucalyptus.atlassian.net/rest/api/2/issue/61400","key":"EUCA-13446","fields":{"issuetype":{"self":"https://eucalyptus.atlassian.net/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://eucalyptus.atlassian.net/secure/viewavatar?size=xsmall&avatarId=14803&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":14803},"timespent":null,"customfield_13100":null,"project":{"self":"https://eucalyptus.atlassian.net/rest/api/2/project/10000","id":"10000","key":"EUCA","name":"Eucalyptus","avatarUrls":{"48x48":"https://eucalyptus.atlassian.net/secure/projectavatar?pid=10000&avatarId=10011","24x24":"https://eucalyptus.atlassian.net/secure/projectavatar?size=small&pid=10000&avatarId=10011","16x16":"https://eucalyptus.atlassian.net/secure/projectavatar?size=xsmall&pid=10000&avatarId=10011","32x32":"https://eucalyptus.atlassian.net/secure/projectavatar?size=medium&pid=10000&avatarId=10011"}},"customfield_11000":null,"fixVersions":[{"self":"https://eucalyptus.atlassian.net/rest/api/2/version/19700","id":"19700","description":"Eucalyptus 4.4.3","name":"4.4.3","archived":false,"released":false}],"customfield_11001":null,"aggregatetimespent":null,"customfield_10310":null,"resolution":null,"customfield_10311":null,"customfield_11401":null,"customfield_11400":null,"customfield_10302":null,"customfield_10500":{"self":"https://eucalyptus.atlassian.net/rest/api/2/customFieldOption/10403","value":"Not Applicable","id":"10403"},"customfield_10104":[],"customfield_10303":null,"customfield_10105":null,"customfield_10700":null,"customfield_10304":null,"customfield_10701":null,"customfield_10702":null,"customfield_10306":null,"customfield_10703":null,"resolutiondate":null,"customfield_10308":null,"customfield_10704":null,"customfield_10705":null,"customfield_10309":null,"workratio":-1,"watches":{"self":"https://eucalyptus.atlassian.net/rest/api/2/issue/EUCA-13446/watchers","watchCount":4,"isWatching":false},"lastViewed":null,"created":"2017-08-10T12:26:07.696-0500","customfield_12000":null,"customfield_12400":null,"priority":{"self":"https://eucalyptus.atlassian.net/rest/api/2/priority/2","iconUrl":"https://eucalyptus.atlassian.net/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"customfield_12201":null,"customfield_10300":null,"customfield_10102":null,"customfield_12600":"{}","customfield_10301":null,"labels":[],"customfield_11700":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[],"customfield_11901":null,"issuelinks":[{"id":"53600","self":"https://eucalyptus.atlassian.net/rest/api/2/issueLink/53600","type":{"id":"10103","name":"Relates","inward":"relates to","outward":"relates to","self":"https://eucalyptus.atlassian.net/rest/api/2/issueLinkType/10103"},"outwardIssue":{"id":"57617","key":"EUCA-13359","self":"https://eucalyptus.atlassian.net/rest/api/2/issue/57617","fields":{"summary":"libvirtd hangs and requires a restart.","status":{"self":"https://eucalyptus.atlassian.net/rest/api/2/status/10006","description":"A fix has been committed, and will be part of the next release","iconUrl":"https://eucalyptus.atlassian.net/images/icons/statuses/generic.png","name":"Release Pending","id":"10006","statusCategory":{"self":"https://eucalyptus.atlassian.net/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://eucalyptus.atlassian.net/rest/api/2/priority/3","iconUrl":"https://eucalyptus.atlassian.net/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://eucalyptus.atlassian.net/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://eucalyptus.atlassian.net/secure/viewavatar?size=xsmall&avatarId=14803&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":14803}}}}],"assignee":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=sjones","name":"sjones","key":"sjones","accountId":"557058:f5dce1b0-db45-4dd6-a0e8-3cea5effb5ce","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/037fddf6d3bf6d691a448e01136f233a?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dsjones%26avatarId%3D18300%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/037fddf6d3bf6d691a448e01136f233a?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dsjones%26avatarId%3D18300%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/037fddf6d3bf6d691a448e01136f233a?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dsjones%26avatarId%3D18300%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/037fddf6d3bf6d691a448e01136f233a?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dsjones%26avatarId%3D18300%26noRedirect%3Dtrue"},"displayName":"Steve Jones","active":true,"timeZone":"America/Los_Angeles"},"updated":"2017-08-22T12:35:45.049-0500","status":{"self":"https://eucalyptus.atlassian.net/rest/api/2/status/10001","description":"This issue has been validated/reproduced, but has not been prioritized yet.","iconUrl":"https://eucalyptus.atlassian.net/images/icons/statuses/generic.png","name":"Confirmed","id":"10001","statusCategory":{"self":"https://eucalyptus.atlassian.net/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://eucalyptus.atlassian.net/rest/api/2/component/10010","id":"10010","name":"Node Controller"}],"timeoriginalestimate":null,"customfield_13000":null,"description":"The node controller can become unavailable, repeatedly logging the error:\r\n\r\n{code}\r\n2017-08-10 10:13:18 ERROR | timed out on libvirt refreshing thread\r\n2017-08-10 10:13:24 ERROR | timed out on libvirt refreshing thread\r\n2017-08-10 10:13:30 ERROR | timed out on libvirt refreshing thread\r\n2017-08-10 10:13:36 ERROR | timed out on libvirt refreshing thread\r\n2017-08-10 10:13:42 ERROR | timed out on libvirt refreshing thread\r\n2017-08-10 10:13:48 ERROR | timed out on libvirt refreshing thread\r\n2017-08-10 10:13:54 ERROR | timed out on libvirt refreshing thread\r\n{code}\r\n\r\nThis occurs shortly after the errors:\r\n\r\n{code}\r\n2017-08-10 10:04:35  INFO | [i-063baed0] restarting bundling instance\r\n2017-08-10 10:04:36  INFO | [i-f712b78d] rebooting\r\n2017-08-10 10:04:36  INFO | [i-0cedf702] creating partition of size 1073741824 bytes and type ext3 in prt-01024ext3-37f7dd1f\r\n2017-08-10 10:04:37  INFO | [i-11b825b6] creating partition of size 1073741824 bytes and type ext3 in prt-01024ext3-37f7dd1f\r\n2017-08-10 10:04:41  INFO | [i-805b37cc] detected disappearance of bundled domain\r\n2017-08-10 10:04:42  INFO | [i-895daffb] cleaning up state for instance\r\n2017-08-10 10:04:43 ERROR | [i-895daffb] failed to remove some artifacts in /var/lib/eucalyptus/instances/work/AIDAANVOU6GS6SFPFKX5Z/i-895daffb\r\n2017-08-10 10:04:43 ERROR | [i-895daffb] failed to remove backing directory /var/lib/eucalyptus/instances/work/AIDAANVOU6GS6SFPFKX5Z/i-895daffb\r\n2017-08-10 10:04:43  INFO | [i-e06f41b1] forgetting about instance\r\n2017-08-10 10:04:43  INFO | [i-f712b78d] instance terminated\r\n2017-08-10 10:04:43  INFO | [i-489cf833] instance terminated\r\n2017-08-10 10:04:43 ERROR | libvirt: Domain not found: no domain with matching name 'i-895daffb' (code=42)\r\n2017-08-10 10:04:50  WARN | [i-f712b78d] detected prodigal domain, terminating it\r\n2017-08-10 10:04:50  INFO | [i-f712b78d] cleaning up state for instance\r\n2017-08-10 10:04:51 ERROR | Failed to move console log file from /var/lib/eucalyptus/instances/work/AIDAANVOU6GS6SFPFKX5Z/i-489cf833/console.log to /var/lib/eucalyptus/instances/work/AIDAANVOU6GS6SFPFKX5Z/i-489c\r\nf833/console.log.old\r\n2017-08-10 10:04:51 ERROR | Failed to move console log file from /var/lib/eucalyptus/instances/work/AIDAANVOU6GS6SFPFKX5Z/i-e514e084/console.log to /var/lib/eucalyptus/instances/work/AIDAANVOU6GS6SFPFKX5Z/i-e514\r\ne084/console.log.old\r\n2017-08-10 10:04:51  INFO | [i-e514e084] instance terminated\r\n2017-08-10 10:04:51 ERROR | inconsistency in sensor database (positive history value after shift: 1250.000000 for i-489cf833:CPUUtilization:summation:default)\r\n2017-08-10 10:04:51 ERROR | inconsistency in sensor database (positive history value after shift: 3590.000000 for i-489cf833:CPUUtilization:summation:default)\r\n2017-08-10 10:04:51 ERROR | inconsistency in sensor database (positive history value after shift: 939.000000 for i-489cf833:NetworkOut:summation:total)\r\n2017-08-10 10:04:51 ERROR | inconsistency in sensor database (positive history value after shift: 3509.000000 for i-489cf833:NetworkOut:summation:total)\r\n2017-08-10 10:04:51 ERROR | inconsistency in sensor database (positive history value after shift: 80.000000 for i-e514e084:CPUUtilization:summation:default)\r\n2017-08-10 10:04:51 ERROR | inconsistency in sensor database (positive history value after shift: 159775.000000 for i-e514e084:NetworkIn:summation:total)\r\n2017-08-10 10:04:51 ERROR | inconsistency in sensor database (positive history value after shift: 3452.000000 for i-e514e084:NetworkOut:summation:total)\r\n2017-08-10 10:04:51 ERROR | Failed to move console log file from /var/lib/eucalyptus/instances/work/AIDAANVOU6GS6SFPFKX5Z/i-895daffb/console.log to /var/lib/eucalyptus/instances/work/AIDAANVOU6GS6SFPFKX5Z/i-895daffb/console.log.old\r\n2017-08-10 10:04:51  INFO | [i-895daffb] instance terminated\r\n2017-08-10 10:04:51  INFO | [i-805b37cc] starting to bundle\r\n2017-08-10 10:04:52  INFO | [i-8e3efd49] booting\r\n2017-08-10 10:04:52  INFO | [i-11b825b6] booting\r\n2017-08-10 10:04:52  INFO | [i-496c79f2] instance terminated\r\n2017-08-10 10:04:52 ERROR | [i-063baed0] instance to start is already running, giving up\r\n2017-08-10 10:04:52 ERROR | [i-063baed0] instance not found\r\n2017-08-10 10:04:52 ERROR | [i-063baed0] failed error=1\r\n2017-08-10 10:04:52  INFO | [i-489cf833] rebooting\r\n2017-08-10 10:04:52  INFO | [i-489cf833] instance terminated\r\n2017-08-10 10:04:52 ERROR |     raise ServiceInitError(msg)\r\n2017-08-10 10:04:52 ERROR | ServiceInitError: No bootstrap endpoint to connect to was given. Configured regions with bootstrap endpoints are: localhost\r\n2017-08-10 10:04:54  INFO | [i-e514e084] rebooting\r\n2017-08-10 10:04:55  INFO | [i-805b37cc] restarting bundling instance\r\n2017-08-10 10:04:55  INFO | [i-805b37cc] bundling result: succeeded\r\n2017-08-10 10:04:55  INFO | [i-805b37cc] finished bundling instance\r\n2017-08-10 10:04:56  INFO | [i-063baed0] failed while bundling instance\r\n2017-08-10 10:04:56  INFO | [i-063baed0] bundling result: failed\r\n2017-08-10 10:04:56 ERROR | euca-bundle-and-upload-image: error: No such file or directory: /tmp/bundle-i-805b37cc/euca-bundle-o7NR9e/bundle7.part.01\r\n2017-08-10 10:04:56 ERROR | IOError: [Errno 2] No such file or directory: '/tmp/bundle-i-805b37cc/euca-bundle-o7NR9e/bundle7.part.02'\r\n2017-08-10 10:04:56 ERROR | error writing output file\r\n2017-08-10 10:04:56 ERROR | IOError: [Errno 32] Broken pipe\r\n2017-08-10 10:04:56 ERROR | IOError: [Errno 32] Broken pipe\r\n2017-08-10 10:04:56 ERROR | Exception IOError: (32, 'Broken pipe') in <bound method _Stream.__del__ of <tarfile._Stream instance at 0x2c705f0>> ignored\r\n2017-08-10 10:04:56 ERROR | IOError: [Errno 2] No such file or directory: '/tmp/bundle-i-805b37cc/euca-bundle-o7NR9e/bundle7.part.01'\r\n2017-08-10 10:04:57  INFO | [i-e514e084] assigning address: [0.0.0.0]\r\n2017-08-10 10:04:59  INFO | [i-063baed0] cleaning up state for instance\r\n2017-08-10 10:05:00 ERROR | [i-063baed0] failed to remove some artifacts in /var/lib/eucalyptus/instances/work/AIDAANVOU6GS6SFPFKX5Z/i-063baed0\r\n2017-08-10 10:05:00  INFO | [i-496c79f2] cleaning up state for instance\r\n2017-08-10 10:05:01  WARN | [i-e514e084] detected prodigal domain, terminating it\r\n2017-08-10 10:05:02  INFO | [i-e514e084] cleaning up state for instance\r\n2017-08-10 10:05:04  WARN | [i-489cf833] detected prodigal domain, terminating it\r\n2017-08-10 10:05:04  INFO | [i-489cf833] cleaning up state for instance\r\n2017-08-10 10:05:06  INFO | [i-f8750807] instance terminated\r\n2017-08-10 10:05:06  INFO | [i-e514e084] termination requested\r\n2017-08-10 10:05:12 ERROR | timed out on libvirt refreshing thread\r\n2017-08-10 10:05:18 ERROR | timed out on libvirt refreshing thread\r\n2017-08-10 10:05:24 ERROR | timed out on libvirt refreshing thread\r\n2017-08-10 10:05:30 ERROR | timed out on libvirt refreshing thread\r\n2017-08-10 10:05:36 ERROR | timed out on libvirt refreshing thread\r\n2017-08-10 10:05:42 ERROR | timed out on libvirt refreshing thread\r\n2017-08-10 10:05:48 ERROR | timed out on libvirt refreshing thread\r\n2017-08-10 10:05:54 ERROR | timed out on libvirt refreshing thread\r\n2017-08-10 10:06:00 ERROR | timed out on libvirt refreshing thread\r\n2017-08-10 10:06:06 ERROR | timed out on libvirt refreshing thread\r\n{code}\r\n\r\nStack dump:\r\n\r\n{code}\r\n# pstack 36339\r\nThread 18 (Thread 0x7f4f65c5f700 (LWP 36349)):\r\n#0  0x00007f4f71f566d5 in pthread_cond_wait@@GLIBC_2.3.2 () from /usr/lib64/axis2c/lib/libpthread.so.0\r\n#1  0x00007f4f6acd277b in sem_prolaag (pSem=0x7f4f7483ac50, doLog=doLog@entry=1 '\\001') at ipc.c:378\r\n#2  0x00007f4f6acd27fa in sem_p (pSem=<optimized out>) at ipc.c:410\r\n#3  0x00007f4f6acdc8b5 in sensor_bottom_half () at sensor.c:505\r\n#4  0x00007f4f6acdcd63 in sensor_thread (arg=<optimized out>) at sensor.c:529\r\n#5  0x00007f4f71f52dc5 in start_thread () from /usr/lib64/axis2c/lib/libpthread.so.0\r\n#6  0x00007f4f71a7d76d in clone () from /usr/lib64/axis2c/lib/libc.so.6\r\nThread 17 (Thread 0x7f4f64851700 (LWP 37380)):\r\n#0  0x00007f4f71f566d5 in pthread_cond_wait@@GLIBC_2.3.2 () from /usr/lib64/axis2c/lib/libpthread.so.0\r\n#1  0x00007f4f6acd277b in sem_prolaag (pSem=0x7f4f7483ac50, doLog=doLog@entry=1 '\\001') at ipc.c:378\r\n#2  0x00007f4f6acd27fa in sem_p (pSem=<optimized out>) at ipc.c:410\r\n#3  0x00007f4f6ac8bda6 in lock_hypervisor_conn () at handlers.c:942\r\n#4  0x00007f4f6ac944b5 in refresh_instance_info (instance=0x7f4f74911500, nc=0x7f4f6afa3080 <nc_state>) at handlers.c:1156\r\n#5  monitoring_thread (arg=<optimized out>) at handlers.c:1572\r\n#6  0x00007f4f71f52dc5 in start_thread () from /usr/lib64/axis2c/lib/libpthread.so.0\r\n#7  0x00007f4f71a7d76d in clone () from /usr/lib64/axis2c/lib/libc.so.6\r\nThread 16 (Thread 0x7f4f5ffff700 (LWP 37381)):\r\n#0  0x00007f4f71a4466d in nanosleep () from /usr/lib64/axis2c/lib/libc.so.6\r\n#1  0x00007f4f71a752f4 in usleep () from /usr/lib64/axis2c/lib/libc.so.6\r\n#2  0x00007f4f6acc2cd6 in run_stats (run_once=run_once@entry=0, execution_interval_sec=<optimized out>, update_config_fn=update_config_fn@entry=0x0) at stats.c:190\r\n#3  0x00007f4f6ac8a37d in nc_run_stats (ignored_arg=<optimized out>) at handlers.c:317\r\n#4  0x00007f4f71f52dc5 in start_thread () from /usr/lib64/axis2c/lib/libpthread.so.0\r\n#5  0x00007f4f71a7d76d in clone () from /usr/lib64/axis2c/lib/libc.so.6\r\nThread 15 (Thread 0x7f4f477fe700 (LWP 9422)):\r\n#0  0x00007f4f71a74bd3 in select () from /usr/lib64/axis2c/lib/libc.so.6\r\n#1  0x00007f4f6acd4257 in log_fds (fds=fds@entry=0x7f4f477f7b40, custom_parser=custom_parser@entry=0x7f4f6aca0d10 <euca_run_bundle_parser>, parser_data=parser_data@entry=0x7f4f75cff960, nfds=2) at misc.c:2339\r\n#2  0x00007f4f6acd839e in euca_execlp_log (pStatus=0x7f4f477f7d8c, custom_parser=custom_parser@entry=0x7f4f6aca0d10 <euca_run_bundle_parser>, parser_data=parser_data@entry=0x7f4f75cff960, file=file@entry=0x7f4f477fada0 \"//usr/libexec/eucalyptus/euca-run-workflow\") at misc.c:2440\r\n#3  0x00007f4f6ac9decb in bundling_thread (arg=0x7f4f7487c1f0) at handlers_default.c:2285\r\n#4  0x00007f4f71f52dc5 in start_thread () from /usr/lib64/axis2c/lib/libpthread.so.0\r\n#5  0x00007f4f71a7d76d in clone () from /usr/lib64/axis2c/lib/libc.so.6\r\nThread 14 (Thread 0x7f4f45ffb700 (LWP 25087)):\r\n#0  0x00007f4f71a74bd3 in select () from /usr/lib64/axis2c/lib/libc.so.6\r\n#1  0x00007f4f6acd4257 in log_fds (fds=fds@entry=0x7f4f45ff4b40, custom_parser=custom_parser@entry=0x7f4f6aca0d10 <euca_run_bundle_parser>, parser_data=parser_data@entry=0x7f4f74f96be0, nfds=2) at misc.c:2339\r\n#2  0x00007f4f6acd839e in euca_execlp_log (pStatus=0x7f4f45ff4d8c, custom_parser=custom_parser@entry=0x7f4f6aca0d10 <euca_run_bundle_parser>, parser_data=parser_data@entry=0x7f4f74f96be0, file=file@entry=0x7f4f45ff7da0 \"//usr/libexec/eucalyptus/euca-run-workflow\") at misc.c:2440\r\n#3  0x00007f4f6ac9decb in bundling_thread (arg=0x7f4f748b5f10) at handlers_default.c:2285\r\n#4  0x00007f4f71f52dc5 in start_thread () from /usr/lib64/axis2c/lib/libpthread.so.0\r\n#5  0x00007f4f71a7d76d in clone () from /usr/lib64/axis2c/lib/libc.so.6\r\nThread 13 (Thread 0x7f4f5edba700 (LWP 61593)):\r\n#0  0x00007f4f71a74bd3 in select () from /usr/lib64/axis2c/lib/libc.so.6\r\n#1  0x00007f4f6acd4257 in log_fds (fds=fds@entry=0x7f4f5edb3b40, custom_parser=custom_parser@entry=0x7f4f6aca0d10 <euca_run_bundle_parser>, parser_data=parser_data@entry=0x7f4f74bc1ee0, nfds=2) at misc.c:2339\r\n#2  0x00007f4f6acd839e in euca_execlp_log (pStatus=0x7f4f5edb3d8c, custom_parser=custom_parser@entry=0x7f4f6aca0d10 <euca_run_bundle_parser>, parser_data=parser_data@entry=0x7f4f74bc1ee0, file=file@entry=0x7f4f5edb6da0 \"//usr/libexec/eucalyptus/euca-run-workflow\") at misc.c:2440\r\n#3  0x00007f4f6ac9decb in bundling_thread (arg=0x7f4f74875530) at handlers_default.c:2285\r\n#4  0x00007f4f71f52dc5 in start_thread () from /usr/lib64/axis2c/lib/libpthread.so.0\r\n#5  0x00007f4f71a7d76d in clone () from /usr/lib64/axis2c/lib/libc.so.6\r\nThread 12 (Thread 0x7f4f5f5bb700 (LWP 19557)):\r\n#0  0x00007f4f71a74bd3 in select () from /usr/lib64/axis2c/lib/libc.so.6\r\n#1  0x00007f4f6acd4257 in log_fds (fds=fds@entry=0x7f4f5f5b4b40, custom_parser=custom_parser@entry=0x7f4f6aca0d10 <euca_run_bundle_parser>, parser_data=parser_data@entry=0x7f4f7687e060, nfds=2) at misc.c:2339\r\n#2  0x00007f4f6acd839e in euca_execlp_log (pStatus=0x7f4f5f5b4d8c, custom_parser=custom_parser@entry=0x7f4f6aca0d10 <euca_run_bundle_parser>, parser_data=parser_data@entry=0x7f4f7687e060, file=file@entry=0x7f4f5f5b7da0 \"//usr/libexec/eucalyptus/euca-run-workflow\") at misc.c:2440\r\n#3  0x00007f4f6ac9decb in bundling_thread (arg=0x7f4f748c1a50) at handlers_default.c:2285\r\n#4  0x00007f4f71f52dc5 in start_thread () from /usr/lib64/axis2c/lib/libpthread.so.0\r\n#5  0x00007f4f71a7d76d in clone () from /usr/lib64/axis2c/lib/libc.so.6\r\nThread 11 (Thread 0x7f4f467fc700 (LWP 64690)):\r\n#0  0x00007f4f71a74bd3 in select () from /usr/lib64/axis2c/lib/libc.so.6\r\n#1  0x00007f4f6acd4257 in log_fds (fds=fds@entry=0x7f4f467f5b40, custom_parser=custom_parser@entry=0x7f4f6aca0d10 <euca_run_bundle_parser>, parser_data=parser_data@entry=0x7f4f766d5b40, nfds=2) at misc.c:2339\r\n#2  0x00007f4f6acd839e in euca_execlp_log (pStatus=0x7f4f467f5d8c, custom_parser=custom_parser@entry=0x7f4f6aca0d10 <euca_run_bundle_parser>, parser_data=parser_data@entry=0x7f4f766d5b40, file=file@entry=0x7f4f467f8da0 \"//usr/libexec/eucalyptus/euca-run-workflow\") at misc.c:2440\r\n#3  0x00007f4f6ac9decb in bundling_thread (arg=0x7f4f74849870) at handlers_default.c:2285\r\n#4  0x00007f4f71f52dc5 in start_thread () from /usr/lib64/axis2c/lib/libpthread.so.0\r\n#5  0x00007f4f71a7d76d in clone () from /usr/lib64/axis2c/lib/libc.so.6\r\nThread 10 (Thread 0x7f4f44ff9700 (LWP 16926)):\r\n#0  0x00007f4f71a74bd3 in select () from /usr/lib64/axis2c/lib/libc.so.6\r\n#1  0x00007f4f6acd4257 in log_fds (fds=fds@entry=0x7f4f44ff2b40, custom_parser=custom_parser@entry=0x7f4f6aca0d10 <euca_run_bundle_parser>, parser_data=parser_data@entry=0x7f4f74ddb740, nfds=2) at misc.c:2339\r\n#2  0x00007f4f6acd839e in euca_execlp_log (pStatus=0x7f4f44ff2d8c, custom_parser=custom_parser@entry=0x7f4f6aca0d10 <euca_run_bundle_parser>, parser_data=parser_data@entry=0x7f4f74ddb740, file=file@entry=0x7f4f44ff5da0 \"//usr/libexec/eucalyptus/euca-run-workflow\") at misc.c:2440\r\n#3  0x00007f4f6ac9decb in bundling_thread (arg=0x7f4f748e0270) at handlers_default.c:2285\r\n#4  0x00007f4f71f52dc5 in start_thread () from /usr/lib64/axis2c/lib/libpthread.so.0\r\n#5  0x00007f4f71a7d76d in clone () from /usr/lib64/axis2c/lib/libc.so.6\r\nThread 9 (Thread 0x7f4f227fc700 (LWP 57608)):\r\n#0  0x00007f4f71a74bd3 in select () from /usr/lib64/axis2c/lib/libc.so.6\r\n#1  0x00007f4f6acd4257 in log_fds (fds=fds@entry=0x7f4f227f5b40, custom_parser=custom_parser@entry=0x7f4f6aca0d10 <euca_run_bundle_parser>, parser_data=parser_data@entry=0x7f4f7574d400, nfds=2) at misc.c:2339\r\n#2  0x00007f4f6acd839e in euca_execlp_log (pStatus=0x7f4f227f5d8c, custom_parser=custom_parser@entry=0x7f4f6aca0d10 <euca_run_bundle_parser>, parser_data=parser_data@entry=0x7f4f7574d400, file=file@entry=0x7f4f227f8da0 \"//usr/libexec/eucalyptus/euca-run-workflow\") at misc.c:2440\r\n#3  0x00007f4f6ac9decb in bundling_thread (arg=0x7f4f74850b30) at handlers_default.c:2285\r\n#4  0x00007f4f71f52dc5 in start_thread () from /usr/lib64/axis2c/lib/libpthread.so.0\r\n#5  0x00007f4f71a7d76d in clone () from /usr/lib64/axis2c/lib/libc.so.6\r\nThread 8 (Thread 0x7f4f02ffd700 (LWP 60522)):\r\n#0  0x00007f4f71a74bd3 in select () from /usr/lib64/axis2c/lib/libc.so.6\r\n#1  0x00007f4f6acd4257 in log_fds (fds=fds@entry=0x7f4f02ff6b40, custom_parser=custom_parser@entry=0x7f4f6aca0d10 <euca_run_bundle_parser>, parser_data=parser_data@entry=0x7f4f75562d80, nfds=2) at misc.c:2339\r\n#2  0x00007f4f6acd839e in euca_execlp_log (pStatus=0x7f4f02ff6d8c, custom_parser=custom_parser@entry=0x7f4f6aca0d10 <euca_run_bundle_parser>, parser_data=parser_data@entry=0x7f4f75562d80, file=file@entry=0x7f4f02ff9da0 \"//usr/libexec/eucalyptus/euca-run-workflow\") at misc.c:2440\r\n#3  0x00007f4f6ac9decb in bundling_thread (arg=0x7f4f748b5410) at handlers_default.c:2285\r\n#4  0x00007f4f71f52dc5 in start_thread () from /usr/lib64/axis2c/lib/libpthread.so.0\r\n#5  0x00007f4f71a7d76d in clone () from /usr/lib64/axis2c/lib/libc.so.6\r\nThread 7 (Thread 0x7f4f47fff700 (LWP 61952)):\r\n#0  0x00007f4f71a4466d in nanosleep () from /usr/lib64/axis2c/lib/libc.so.6\r\n#1  0x00007f4f71a44504 in sleep () from /usr/lib64/axis2c/lib/libc.so.6\r\n#2  0x00007f4f6ac93588 in instance_network_gate (instance=instance@entry=0x7f4f76f74680, timeout_seconds=<optimized out>) at handlers.c:4102\r\n#3  0x00007f4f6ac95da0 in startup_thread (arg=0x7f4f76f74680) at handlers.c:1858\r\n#4  0x00007f4f71f52dc5 in start_thread () from /usr/lib64/axis2c/lib/libpthread.so.0\r\n#5  0x00007f4f71a7d76d in clone () from /usr/lib64/axis2c/lib/libc.so.6\r\nThread 6 (Thread 0x7f4f46ffd700 (LWP 61956)):\r\n#0  0x00007f4f71a4466d in nanosleep () from /usr/lib64/axis2c/lib/libc.so.6\r\n#1  0x00007f4f71a44504 in sleep () from /usr/lib64/axis2c/lib/libc.so.6\r\n#2  0x00007f4f6ac93588 in instance_network_gate (instance=instance@entry=0x7f4f75c1b260, timeout_seconds=<optimized out>) at handlers.c:4102\r\n#3  0x00007f4f6ac95da0 in startup_thread (arg=0x7f4f75c1b260) at handlers.c:1858\r\n#4  0x00007f4f71f52dc5 in start_thread () from /usr/lib64/axis2c/lib/libpthread.so.0\r\n#5  0x00007f4f71a7d76d in clone () from /usr/lib64/axis2c/lib/libc.so.6\r\nThread 5 (Thread 0x7f4f21ffb700 (LWP 63772)):\r\n#0  0x00007f4f71a4466d in nanosleep () from /usr/lib64/axis2c/lib/libc.so.6\r\n#1  0x00007f4f71a44504 in sleep () from /usr/lib64/axis2c/lib/libc.so.6\r\n#2  0x00007f4f6ac93588 in instance_network_gate (instance=instance@entry=0x7f4f76e7f340, timeout_seconds=<optimized out>) at handlers.c:4102\r\n#3  0x00007f4f6ac95da0 in startup_thread (arg=0x7f4f76e7f340) at handlers.c:1858\r\n#4  0x00007f4f71f52dc5 in start_thread () from /usr/lib64/axis2c/lib/libpthread.so.0\r\n#5  0x00007f4f71a7d76d in clone () from /usr/lib64/axis2c/lib/libc.so.6\r\nThread 4 (Thread 0x7f4f20ff9700 (LWP 63781)):\r\n#0  0x00007f4f71a74bd3 in select () from /usr/lib64/axis2c/lib/libc.so.6\r\n#1  0x00007f4f6acd4257 in log_fds (fds=fds@entry=0x7f4f20ff2b40, custom_parser=custom_parser@entry=0x7f4f6aca0d10 <euca_run_bundle_parser>, parser_data=parser_data@entry=0x7f4f74ce6400, nfds=2) at misc.c:2339\r\n#2  0x00007f4f6acd839e in euca_execlp_log (pStatus=0x7f4f20ff2d8c, custom_parser=custom_parser@entry=0x7f4f6aca0d10 <euca_run_bundle_parser>, parser_data=parser_data@entry=0x7f4f74ce6400, file=file@entry=0x7f4f20ff5da0 \"//usr/libexec/eucalyptus/euca-run-workflow\") at misc.c:2440\r\n#3  0x00007f4f6ac9decb in bundling_thread (arg=0x7f4f748e8290) at handlers_default.c:2285\r\n#4  0x00007f4f71f52dc5 in start_thread () from /usr/lib64/axis2c/lib/libpthread.so.0\r\n#5  0x00007f4f71a7d76d in clone () from /usr/lib64/axis2c/lib/libc.so.6\r\nThread 3 (Thread 0x7f4f01ffb700 (LWP 64891)):\r\n#0  0x00007f4f71f592c5 in __lll_timedwait_tid () from /usr/lib64/axis2c/lib/libpthread.so.0\r\n#1  0x00007f4f71f5415f in pthread_timedjoin_np () from /usr/lib64/axis2c/lib/libpthread.so.0\r\n#2  0x00007f4f6ac8bea9 in lock_hypervisor_conn () at handlers.c:1003\r\n#3  0x00007f4f6ac9cc31 in shutdown_then_destroy_domain (instanceId=instanceId@entry=0x7f4f622a8350 \"i-063baed0\", do_destroy=do_destroy@entry=1 '\\001') at handlers_default.c:498\r\n#4  0x00007f4f6ac9cfb6 in find_and_terminate_instance (instanceId=instanceId@entry=0x7f4f622a8350 \"i-063baed0\") at handlers_default.c:590\r\n#5  0x00007f4f6ac8c55f in terminating_thread (arg=0x7f4f622a8350) at handlers.c:2026\r\n#6  0x00007f4f71f52dc5 in start_thread () from /usr/lib64/axis2c/lib/libpthread.so.0\r\n#7  0x00007f4f71a7d76d in clone () from /usr/lib64/axis2c/lib/libc.so.6\r\nThread 2 (Thread 0x7f4f237fe700 (LWP 65167)):\r\n#0  0x00007f4f71a72e2d in poll () from /usr/lib64/axis2c/lib/libc.so.6\r\n#1  0x00007f4f6a0536c7 in virNetClientIOEventLoop () from /usr/lib64/axis2c/lib/libvirt.so.0\r\n#2  0x00007f4f6a053f0b in virNetClientSendInternal () from /usr/lib64/axis2c/lib/libvirt.so.0\r\n#3  0x00007f4f6a055333 in virNetClientSendWithReply () from /usr/lib64/axis2c/lib/libvirt.so.0\r\n#4  0x00007f4f6a055b42 in virNetClientProgramCall () from /usr/lib64/axis2c/lib/libvirt.so.0\r\n#5  0x00007f4f6a02a982 in callFull.isra.2 () from /usr/lib64/axis2c/lib/libvirt.so.0\r\n#6  0x00007f4f6a045260 in remoteConnectClose () from /usr/lib64/axis2c/lib/libvirt.so.0\r\n#7  0x00007f4f69fd8220 in virConnectDispose () from /usr/lib64/axis2c/lib/libvirt.so.0\r\n#8  0x00007f4f69f2d6db in virObjectUnref () from /usr/lib64/axis2c/lib/libvirt.so.0\r\n#9  0x00007f4f69fdde94 in virConnectClose () from /usr/lib64/axis2c/lib/libvirt.so.0\r\n#10 0x00007f4f6ac8a082 in libvirt_thread (ptr=<optimized out>) at handlers.c:916\r\n#11 0x00007f4f71f52dc5 in start_thread () from /usr/lib64/axis2c/lib/libpthread.so.0\r\n#12 0x00007f4f71a7d76d in clone () from /usr/lib64/axis2c/lib/libc.so.6\r\nThread 1 (Thread 0x7f4f7347d880 (LWP 36339)):\r\n#0  0x00007f4f71f566d5 in pthread_cond_wait@@GLIBC_2.3.2 () from /usr/lib64/axis2c/lib/libpthread.so.0\r\n#1  0x00007f4f6acd277b in sem_prolaag (pSem=0x7f4f7483ac50, doLog=doLog@entry=1 '\\001') at ipc.c:378\r\n#2  0x00007f4f6acd27fa in sem_p (pSem=<optimized out>) at ipc.c:410\r\n#3  0x00007f4f6ac9b352 in refresh_instance_resources (instanceId=instanceId@entry=0x7f4f750ec778 \"i-e514e084\") at handlers_default.c:299\r\n#4  0x00007f4f6ac9c6d2 in doTerminateInstance (nc=<optimized out>, pMeta=<optimized out>, instanceId=0x7f4f750ec778 \"i-e514e084\", force=<optimized out>, shutdownState=0x7ffef8700fe8, previousState=0x7ffef8700fec) at handlers_default.c:808\r\n#5  0x00007f4f6ac8452f in ncTerminateInstanceMarshal (ncTerminateInstance=ncTerminateInstance@entry=0x7f4f750ea318, env=env@entry=0x7f4f75e12a28) at server-marshal.c:869\r\n#6  0x00007f4f6ac72cce in axis2_skel_EucalyptusNC_ncTerminateInstance (env=env@entry=0x7f4f75e12a28, ncTerminateInstance=ncTerminateInstance@entry=0x7f4f750ea318) at axis2_skel_EucalyptusNC.c:284\r\n#7  0x00007f4f6ac7e795 in axis2_svc_skel_EucalyptusNC_invoke (svc_skeleton=<optimized out>, env=0x7f4f75e12a28, content_node=0x7f4f7489c368, msg_ctx=0x7f4f75e18d50) at axis2_svc_skel_EucalyptusNC.c:996\r\n#8  0x00007f4f7070f764 in axis2_raw_xml_in_out_msg_recv_invoke_business_logic_sync () from /usr/lib64/libaxis2_engine.so.0\r\n#9  0x00007f4f7070f461 in axis2_msg_recv_receive_impl () from /usr/lib64/libaxis2_engine.so.0\r\n#10 0x00007f4f707067df in axis2_engine_receive () from /usr/lib64/libaxis2_engine.so.0\r\n#11 0x00007f4f7095df8f in axis2_http_transport_utils_process_http_post_request () from /usr/lib64/httpd/modules/libmod_axis2.so\r\n#12 0x00007f4f7095b113 in axis2_apache2_worker_process_request () from /usr/lib64/httpd/modules/libmod_axis2.so\r\n#13 0x00007f4f70958e2b in axis2_handler () from /usr/lib64/httpd/modules/libmod_axis2.so\r\n#14 0x00007f4f734ca690 in ap_run_handler ()\r\n#15 0x00007f4f734cabd9 in ap_invoke_handler ()\r\n#16 0x00007f4f734df00a in ap_process_async_request ()\r\n#17 0x00007f4f734df2e4 in ap_process_request ()\r\n#18 0x00007f4f734dbc32 in ap_process_http_connection ()\r\n#19 0x00007f4f734d3c90 in ap_run_process_connection ()\r\n#20 0x00007f4f7117580f in child_main () from /usr/lib64/httpd/modules/mod_mpm_prefork.so\r\n#21 0x00007f4f71175a55 in make_child () from /usr/lib64/httpd/modules/mod_mpm_prefork.so\r\n#22 0x00007f4f711766ee in prefork_run () from /usr/lib64/httpd/modules/mod_mpm_prefork.so\r\n#23 0x00007f4f734aef6e in ap_run_mpm ()\r\n#24 0x00007f4f734a7d76 in main ()\r\n{code}\r\n\r\nThe node controller is notready when this occurs:\r\n\r\n{code}\r\n# euserv-describe-node-controllers \r\nNODE  one  10.111.5.63  notready    \r\nINSTANCE  i-2ad61d06      \r\nINSTANCE  i-f8750807      \r\nINSTANCE  i-c5df0948      \r\nINSTANCE  i-14c33039      \r\nINSTANCE  i-f712b78d      \r\nINSTANCE  i-d4bc9e38      \r\nINSTANCE  i-43842e54      \r\nINSTANCE  i-063baed0      \r\nINSTANCE  i-2f7cb2a5      \r\nINSTANCE  i-b6ff6616      \r\nINSTANCE  i-8e3efd49      \r\nINSTANCE  i-f1863b64      \r\nINSTANCE  i-496c79f2      \r\nINSTANCE  i-0cedf702      \r\nINSTANCE  i-2f5b961b      \r\n....\r\n{code}\r\n\r\nThis was seen when churning instances using:\r\n\r\n* launch/terminate on 8 threads\r\n* start/stop/reboot on 8 threads\r\n* bundling on 8 threads\r\n\r\non a node controller.","customfield_13200":null,"customfield_11300":null,"customfield_11500":null,"timetracking":{},"customfield_10005":null,"customfield_10401":null,"customfield_10600":null,"customfield_12900":null,"aggregatetimeestimate":null,"attachment":[{"self":"https://eucalyptus.atlassian.net/rest/api/2/attachment/43500","id":"43500","filename":"TestEC2InstanceBundleTerminate.groovy","author":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=sjones","name":"sjones","key":"sjones","accountId":"557058:f5dce1b0-db45-4dd6-a0e8-3cea5effb5ce","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/037fddf6d3bf6d691a448e01136f233a?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dsjones%26avatarId%3D18300%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/037fddf6d3bf6d691a448e01136f233a?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dsjones%26avatarId%3D18300%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/037fddf6d3bf6d691a448e01136f233a?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dsjones%26avatarId%3D18300%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/037fddf6d3bf6d691a448e01136f233a?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dsjones%26avatarId%3D18300%26noRedirect%3Dtrue"},"displayName":"Steve Jones","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-08-21T15:35:18.768-0500","size":8548,"mimeType":"application/octet-stream","content":"https://eucalyptus.atlassian.net/secure/attachment/43500/TestEC2InstanceBundleTerminate.groovy"}],"summary":"Node controller libvirt connection error : timed out on libvirt refreshing thread","creator":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=sjones","name":"sjones","key":"sjones","accountId":"557058:f5dce1b0-db45-4dd6-a0e8-3cea5effb5ce","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/037fddf6d3bf6d691a448e01136f233a?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dsjones%26avatarId%3D18300%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/037fddf6d3bf6d691a448e01136f233a?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dsjones%26avatarId%3D18300%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/037fddf6d3bf6d691a448e01136f233a?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dsjones%26avatarId%3D18300%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/037fddf6d3bf6d691a448e01136f233a?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dsjones%26avatarId%3D18300%26noRedirect%3Dtrue"},"displayName":"Steve Jones","active":true,"timeZone":"America/Los_Angeles"},"subtasks":[],"reporter":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=sjones","name":"sjones","key":"sjones","accountId":"557058:f5dce1b0-db45-4dd6-a0e8-3cea5effb5ce","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/037fddf6d3bf6d691a448e01136f233a?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dsjones%26avatarId%3D18300%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/037fddf6d3bf6d691a448e01136f233a?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dsjones%26avatarId%3D18300%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/037fddf6d3bf6d691a448e01136f233a?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dsjones%26avatarId%3D18300%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/037fddf6d3bf6d691a448e01136f233a?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dsjones%26avatarId%3D18300%26noRedirect%3Dtrue"},"displayName":"Steve Jones","active":true,"timeZone":"America/Los_Angeles"},"customfield_10000":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12100":"0|i0451z:","customfield_10001":null,"customfield_10200":null,"customfield_10002":null,"customfield_10003":null,"customfield_10400":null,"customfield_12500":null,"customfield_11600":["sjones(sjones)"],"customfield_10116":null,"environment":null,"customfield_10117":null,"customfield_11800":null,"customfield_11802":null,"duedate":null,"customfield_11805":null,"customfield_11806":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://eucalyptus.atlassian.net/rest/api/2/issue/61400/comment/126701","id":"126701","author":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=sjones","name":"sjones","key":"sjones","accountId":"557058:f5dce1b0-db45-4dd6-a0e8-3cea5effb5ce","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/037fddf6d3bf6d691a448e01136f233a?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dsjones%26avatarId%3D18300%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/037fddf6d3bf6d691a448e01136f233a?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dsjones%26avatarId%3D18300%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/037fddf6d3bf6d691a448e01136f233a?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dsjones%26avatarId%3D18300%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/037fddf6d3bf6d691a448e01136f233a?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dsjones%26avatarId%3D18300%26noRedirect%3Dtrue"},"displayName":"Steve Jones","active":true,"timeZone":"America/Los_Angeles"},"body":"To check what the libvirt client is doing when the timeout occurs:\r\n\r\n# find the pid of the node controller httpd process\r\n# find the thread in that process that is stuck\r\n# strace the stuck thread to check what is being polled (file descriptors)\r\n# list the open files for the process to get more info on the file descriptors\r\n\r\nfor example:\r\n\r\n{code}\r\n#\r\n# ps aux | grep httpd | grep \"^euca\"\r\neucalyp+ 46169 19.7  0.2 3229432 289652 ?      Sl   10:21  37:42 /usr/sbin/httpd -f //run/eucalyptus/httpd-nc.conf -DFOREGROUND\r\n#\r\n#\r\n# pstack 46169 | grep -B 3 -A 3 libvirt\r\n#6  0x00007f65f6dc276d in clone () from /usr/lib64/axis2c/lib/libc.so.6\r\nThread 2 (Thread 0x7f6537fff700 (LWP 49334)):\r\n#0  0x00007f65f6db7e2d in poll () from /usr/lib64/axis2c/lib/libc.so.6\r\n#1  0x00007f65ef3986c7 in virNetClientIOEventLoop () from /usr/lib64/axis2c/lib/libvirt.so.0\r\n#2  0x00007f65ef398f0b in virNetClientSendInternal () from /usr/lib64/axis2c/lib/libvirt.so.0\r\n#3  0x00007f65ef39a333 in virNetClientSendWithReply () from /usr/lib64/axis2c/lib/libvirt.so.0\r\n#4  0x00007f65ef39ab42 in virNetClientProgramCall () from /usr/lib64/axis2c/lib/libvirt.so.0\r\n#5  0x00007f65ef36f982 in callFull.isra.2 () from /usr/lib64/axis2c/lib/libvirt.so.0\r\n#6  0x00007f65ef38a260 in remoteConnectClose () from /usr/lib64/axis2c/lib/libvirt.so.0\r\n#7  0x00007f65ef31d220 in virConnectDispose () from /usr/lib64/axis2c/lib/libvirt.so.0\r\n#8  0x00007f65ef2726db in virObjectUnref () from /usr/lib64/axis2c/lib/libvirt.so.0\r\n#9  0x00007f65ef322e94 in virConnectClose () from /usr/lib64/axis2c/lib/libvirt.so.0\r\n#10 0x00007f65effcf0d2 in libvirt_thread (ptr=<optimized out>) at handlers.c:951\r\n#11 0x00007f65f7297dc5 in start_thread () from /usr/lib64/axis2c/lib/libpthread.so.0\r\n#12 0x00007f65f6dc276d in clone () from /usr/lib64/axis2c/lib/libc.so.6\r\nThread 1 (Thread 0x7f65f87c2880 (LWP 46169)):\r\n#\r\n#\r\n# stdbuf -oL strace -p 49334 2>&1 | grep --line-buffered poll | head -n 1\r\npoll([{fd=0, events=POLLIN}, {fd=13, events=POLLIN}], 2, 4294967295) = ? ERESTART_RESTARTBLOCK (Interrupted by signal)\r\n#\r\n#\r\n# lsof -a -p 46169 -d 0,13\r\nCOMMAND   PID       USER   FD   TYPE    DEVICE SIZE/OFF      NODE NAME\r\nhttpd   46169 eucalyptus    0u  IPv6 115976669      0t0       TCP a-16-l.qa1.eucalyptus-systems.com:8775->a-32-l.qa1.eucalyptus-systems.com:52172 (ESTABLISHED)\r\nhttpd   46169 eucalyptus   13r  FIFO       0,8      0t0 115965370 pipe\r\n#\r\n#\r\n{code}\r\n\r\nEvery time the issue is reproduced the file descriptor zero is being used. The details of the file for descriptor zero will differ, in this case it is a tcp (http) connection, we would expect this to be the socket that is connected to libvirt, e.g.:\r\n\r\n{code}\r\n# lsof -a -p 51498 -d 12,13\r\nCOMMAND   PID       USER   FD   TYPE             DEVICE SIZE/OFF      NODE NAME\r\nhttpd   51498 eucalyptus   12u  unix 0xffff880fa225d000      0t0 116271867 socket\r\nhttpd   51498 eucalyptus   13r  FIFO                0,8      0t0 116271868 pipe\r\n{code}\r\n\r\nAdditionally the httpd-node_error_log will sometimes show:\r\n\r\n{code}\r\n2017-08-18 00:24:29.601+0000: 58089: warning : virFileClose:95 : Tried to close invalid fd 0\r\n{code}\r\n\r\nbut this is only ever seen for file descriptor zero.\r\n\r\nFile descriptor zero is expected to be /dev/null, so it seems something is occasionally closing this file descriptor allowing it to be reused and then causing errors when it is next closed. Periodically logging fd/0 during a test:\r\n\r\n{code}\r\nlr-x------. 1 root root 64 Aug 17 21:43 /proc/4051/fd/0 -> /dev/null\r\nlr-x------. 1 root root 64 Aug 17 21:43 /proc/4051/fd/0 -> /dev/null\r\nlr-x------. 1 root root 64 Aug 17 21:43 /proc/4051/fd/0 -> /dev/null\r\nlr-x------. 1 root root 64 Aug 17 21:43 /proc/4051/fd/0 -> /dev/null\r\nlr-x------. 1 root root 64 Aug 17 21:43 /proc/4051/fd/0 -> /dev/null\r\nlr-x------. 1 root root 64 Aug 17 21:43 /proc/4051/fd/0 -> /dev/null\r\nlr-x------. 1 root root 64 Aug 17 21:43 /proc/4051/fd/0 -> /dev/null\r\nlrwx------. 1 root root 64 Aug 17 21:43 /proc/4051/fd/0 -> socket:[1018072]\r\n{code}\r\n\r\nso after some time the file descriptor is closed then reused.\r\n\r\nThe \"failed to remove some artifacts\" error logging suggests that this relates to clean up on failure for instance artifacts. Reviewing the blobstore, we see:\r\n\r\n{code}\r\n        if (close(bb->fd_blocks) == -1) {\r\n            ret = -1;\r\n        } else {\r\n            bb->fd_blocks = 0;         //! @TODO needed? maybe -1?\r\n        }\r\n{code}\r\n\r\nand testing shows that using the value -1 instead of zero here prevents erroneous closure of file descriptor zero.\r\n\r\nThis issue can occur whenever blockblob_close is called after a blockblob_delete failure, for example in blobstore_delete_regex.  In this case the \"failed to remove some artifacts\" error logging will occur.\r\n\r\nClosing/replacing an in use file descriptor can cause many different failures, not only the libvirt failure that was observed. The libvirt failure is obvious since it causes the service to fail, other errors would likely fail a single request/action.\r\n\r\nIt is easy to check if this issue is impacting a node controller by listing fd/0 for the httpd node controller process:\r\n\r\n{code}\r\n# ll /proc/23675/fd/0\r\nlr-x------. 1 root root 64 Aug 17 23:39 /proc/23675/fd/0 -> /dev/null\r\n{code}\r\n\r\nif the value is something other than /dev/null then this issue may be the cause.\r\n\r\nCandidate fixes related to this issue:\r\n\r\nFree domain before connection on error\r\nhttps://github.com/sjones4/eucalyptus/commit/b19ba71bd1511fbf82e5410b62e9f106121ca945\r\n\r\nClear blobstore file descriptors on close \r\nhttps://github.com/sjones4/eucalyptus/commit/2f495de70cf306894aa3b24a2a5a851c51e0e89b\r\n","updateAuthor":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=sjones","name":"sjones","key":"sjones","accountId":"557058:f5dce1b0-db45-4dd6-a0e8-3cea5effb5ce","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/037fddf6d3bf6d691a448e01136f233a?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dsjones%26avatarId%3D18300%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/037fddf6d3bf6d691a448e01136f233a?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dsjones%26avatarId%3D18300%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/037fddf6d3bf6d691a448e01136f233a?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dsjones%26avatarId%3D18300%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/037fddf6d3bf6d691a448e01136f233a?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dsjones%26avatarId%3D18300%26noRedirect%3Dtrue"},"displayName":"Steve Jones","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-08-18T14:05:48.798-0500","updated":"2017-08-18T14:05:48.798-0500"}],"maxResults":1,"total":1,"startAt":0},"votes":{"self":"https://eucalyptus.atlassian.net/rest/api/2/issue/EUCA-13446/votes","votes":0,"hasVoted":false},"customfield_11808":null,"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]}}}