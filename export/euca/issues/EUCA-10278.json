{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"33993","self":"https://eucalyptus.atlassian.net/rest/api/2/issue/33993","key":"EUCA-10278","fields":{"issuetype":{"self":"https://eucalyptus.atlassian.net/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://eucalyptus.atlassian.net/secure/viewavatar?size=xsmall&avatarId=14803&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":14803},"timespent":7200,"customfield_13100":null,"project":{"self":"https://eucalyptus.atlassian.net/rest/api/2/project/10000","id":"10000","key":"EUCA","name":"Eucalyptus","avatarUrls":{"48x48":"https://eucalyptus.atlassian.net/secure/projectavatar?pid=10000&avatarId=10011","24x24":"https://eucalyptus.atlassian.net/secure/projectavatar?size=small&pid=10000&avatarId=10011","16x16":"https://eucalyptus.atlassian.net/secure/projectavatar?size=xsmall&pid=10000&avatarId=10011","32x32":"https://eucalyptus.atlassian.net/secure/projectavatar?size=medium&pid=10000&avatarId=10011"}},"customfield_11000":null,"fixVersions":[{"self":"https://eucalyptus.atlassian.net/rest/api/2/version/15500","id":"15500","description":"Eucalyptus 4.1.1","name":"4.1.1","archived":false,"released":true,"releaseDate":"2015-05-11"}],"customfield_11001":null,"aggregatetimespent":7200,"resolution":{"self":"https://eucalyptus.atlassian.net/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_10310":[{"self":"https://eucalyptus.atlassian.net/rest/api/2/customFieldOption/10209","value":"CentOS 6","id":"10209"}],"customfield_11401":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=viglesias","name":"viglesias","key":"viglesias","accountId":"557058:49b276ff-ebf9-4dd6-ada3-b568a2898707","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/5608e0aa05bd6e5d73b855a08079cceb?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dviglesias%26avatarId%3D10405%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/5608e0aa05bd6e5d73b855a08079cceb?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dviglesias%26avatarId%3D10405%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/5608e0aa05bd6e5d73b855a08079cceb?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dviglesias%26avatarId%3D10405%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/5608e0aa05bd6e5d73b855a08079cceb?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dviglesias%26avatarId%3D10405%26noRedirect%3Dtrue"},"displayName":"Victor Iglesias","active":true,"timeZone":"America/Los_Angeles"},"customfield_10311":[{"self":"https://eucalyptus.atlassian.net/rest/api/2/customFieldOption/11500","value":"Edge","id":"11500"}],"customfield_11400":null,"customfield_10302":null,"customfield_10104":[],"customfield_10500":{"self":"https://eucalyptus.atlassian.net/rest/api/2/customFieldOption/10401","value":"Standard","id":"10401"},"customfield_10105":{"self":"https://eucalyptus.atlassian.net/rest/api/2/customFieldOption/10101","value":"No","id":"10101"},"customfield_10303":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=nurmi","name":"nurmi","key":"nurmi","accountId":"557058:68718820-f5e0-4305-a46c-f867a6bc9565","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/7ac3bd8409137b5a6a6f8fc7d6e5f94b?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dnurmi%26avatarId%3D10601%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/7ac3bd8409137b5a6a6f8fc7d6e5f94b?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dnurmi%26avatarId%3D10601%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/7ac3bd8409137b5a6a6f8fc7d6e5f94b?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dnurmi%26avatarId%3D10601%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/7ac3bd8409137b5a6a6f8fc7d6e5f94b?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dnurmi%26avatarId%3D10601%26noRedirect%3Dtrue"},"displayName":"Daniel Nurmi","active":true,"timeZone":"US/Central"},"customfield_10700":null,"customfield_10304":null,"customfield_10701":null,"customfield_10702":null,"customfield_10306":{"self":"https://eucalyptus.atlassian.net/rest/api/2/customFieldOption/10200","value":"High","id":"10200"},"customfield_10703":null,"resolutiondate":"2015-04-16T18:52:17.224-0500","customfield_10308":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=dshekhawat","name":"dshekhawat","key":"dshekhawat","accountId":"557058:dc10d216-39f8-4d84-a5ff-7d4daf8a44ed","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/7cda271db1cec24c198fdfb42ec8a8ae?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Ddshekhawat%26avatarId%3D15400%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/7cda271db1cec24c198fdfb42ec8a8ae?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Ddshekhawat%26avatarId%3D15400%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/7cda271db1cec24c198fdfb42ec8a8ae?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Ddshekhawat%26avatarId%3D15400%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/7cda271db1cec24c198fdfb42ec8a8ae?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Ddshekhawat%26avatarId%3D15400%26noRedirect%3Dtrue"},"displayName":"Deependra Shekhawat","active":false,"timeZone":"Asia/Kolkata"},"customfield_10704":null,"customfield_10309":[{"self":"https://eucalyptus.atlassian.net/rest/api/2/customFieldOption/10204","value":"KVM","id":"10204"}],"customfield_10705":null,"workratio":-1,"watches":{"self":"https://eucalyptus.atlassian.net/rest/api/2/issue/EUCA-10278/watchers","watchCount":9,"isWatching":false},"lastViewed":null,"created":"2015-01-05T09:37:55.047-0600","customfield_12000":null,"priority":{"self":"https://eucalyptus.atlassian.net/rest/api/2/priority/2","iconUrl":"https://eucalyptus.atlassian.net/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"customfield_12400":null,"customfield_12201":null,"customfield_12600":"{repository={count=4, dataType=repository}, json={\"cachedValue\":{\"errors\":[],\"summary\":{\"repository\":{\"overall\":{\"count\":4,\"lastUpdated\":\"2015-03-11T14:58:51.000-0500\",\"dataType\":\"repository\"},\"byInstanceType\":{\"github\":{\"count\":4,\"name\":\"GitHub\"}}}}},\"isStale\":true}}","customfield_10300":null,"customfield_10102":null,"customfield_10301":null,"labels":[],"customfield_11700":null,"timeestimate":0,"aggregatetimeoriginalestimate":null,"versions":[{"self":"https://eucalyptus.atlassian.net/rest/api/2/version/14606","id":"14606","description":"Eucalyptus 4.0.2","name":"4.0.2","archived":false,"released":true,"releaseDate":"2014-10-20"},{"self":"https://eucalyptus.atlassian.net/rest/api/2/version/14301","id":"14301","description":"Eucalyptus 4.1.0","name":"4.1.0","archived":false,"released":true,"releaseDate":"2015-01-29"}],"customfield_11901":null,"issuelinks":[],"assignee":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=mbacchi","name":"mbacchi","key":"mbacchi","accountId":"557058:d650aabc-f00c-4262-93a9-7799945b8eed","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/24b916c1ff78f38b51f4bb1dc66ed58c?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dmbacchi%26avatarId%3D16201%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/24b916c1ff78f38b51f4bb1dc66ed58c?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dmbacchi%26avatarId%3D16201%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/24b916c1ff78f38b51f4bb1dc66ed58c?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dmbacchi%26avatarId%3D16201%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/24b916c1ff78f38b51f4bb1dc66ed58c?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dmbacchi%26avatarId%3D16201%26noRedirect%3Dtrue"},"displayName":"Matt Bacchi","active":true,"timeZone":"US/Central"},"updated":"2016-06-06T16:32:05.094-0500","status":{"self":"https://eucalyptus.atlassian.net/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://eucalyptus.atlassian.net/images/icons/statuses/generic.png","name":"Closed","id":"6","statusCategory":{"self":"https://eucalyptus.atlassian.net/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://eucalyptus.atlassian.net/rest/api/2/component/12800","id":"12800","name":"eucanetd","description":"Used to track component level items associated with Edge."}],"timeoriginalestimate":null,"description":"To reproduce the problem:\r\n\r\n*Configuration*:\r\n* Eucalyptus 4.0.2 cloud in edge mode. This is a problem with eucanetd so it only shows up in edge mode.\r\n* Windows EBS image. We’ve seen this in Windows 7, 2008R2, and 2012.\r\n* The cloud should have a relatively large range of private IP addresses such that when a stopped EBS instance starts, it most likely gets assigned a different IP address from the one it had before.\r\n\r\nSteps to reproduce the problem:\r\n* For best results, no other instances should be running.\r\n* Start a Windows EBS instance. Verify network connectivity by making sure a remote desktop session can be established. Note the private IP address assigned to the instance.\r\n* Stop the instance. Verify the instance is in stopped state.\r\n* Immediately start the instance back up, before the stopped instance’s DHCP lease expires. Verify:\r\n** The instance gets assigned a different private IP address.\r\n** If there are other instances running in the cloud, make sure no instance is assigned the old private IP address the Windows EBS instance had before it was stopped.\r\n\r\n*Symptoms*:\r\n* The Windows EBS instance does not have network access after it starts.\r\n* If you access the instance’s console, output of “ipconfig” command shows the Windows instance retains the old private IP address that it had before it was stopped.\r\n* dhcpd records the following in the node controller’s /var/log/messages:\r\n\r\n{code}\r\n----\r\nDec 19 11:16:35 cn0008 dhcpd: DHCPREQUEST for 128.84.11.88 from d0:0d:6c:cb:5d:e7 via br0: lease 128.84.11.88 unavailable.\r\nDec 19 11:16:35 cn0008 dhcpd: DHCPNAK on 128.84.11.88 to d0:0d:6c:cb:5d:e7 via br0\r\nDec 19 11:16:38 cn0008 dhcpd: DHCPREQUEST for 128.84.11.88 from d0:0d:6c:cb:5d:e7 via br0: lease 128.84.11.88 unavailable.\r\nDec 19 11:16:38 cn0008 dhcpd: DHCPNAK on 128.84.11.88 to d0:0d:6c:cb:5d:e7 via br0\r\nDec 19 11:16:46 cn0008 dhcpd: DHCPREQUEST for 128.84.11.88 from d0:0d:6c:cb:5d:e7 via br0: lease 128.84.11.88 unavailable.\r\nDec 19 11:16:46 cn0008 dhcpd: DHCPNAK on 128.84.11.88 to d0:0d:6c:cb:5d:e7 via br0\r\nDec 19 11:17:02 cn0008 dhcpd: DHCPREQUEST for 128.84.11.88 from d0:0d:6c:cb:5d:e7 via br0: lease 128.84.11.88 unavailable.\r\nDec 19 11:17:02 cn0008 dhcpd: DHCPNAK on 128.84.11.88 to d0:0d:6c:cb:5d:e7 via br0\r\nDec 19 11:17:05 cn0008 dhcpd: DHCPREQUEST for 128.84.11.88 from d0:0d:6c:cb:5d:e7 via br0: lease 128.84.11.88 unavailable.\r\nDec 19 11:17:05 cn0008 dhcpd: DHCPNAK on 128.84.11.88 to d0:0d:6c:cb:5d:e7 via br0\r\nDec 19 11:17:13 cn0008 dhcpd: DHCPREQUEST for 128.84.11.88 from d0:0d:6c:cb:5d:e7 via br0: lease 128.84.11.88 unavailable.\r\nDec 19 11:17:13 cn0008 dhcpd: DHCPNAK on 128.84.11.88 to d0:0d:6c:cb:5d:e7 via br0\r\nDec 19 11:17:33 cn0008 dhcpd: DHCPINFORM from 128.84.11.88 via br0: not authoritative for subnet 128.84.8.0\r\n----\r\n{code}\r\n\r\n* You can restore the network access for the affected Windows EBS instance by issuing “ipconfig /release” followed by “ipconfig /renew” commands in the affected instance.\r\n\r\n*Analysis*:\r\n\r\nRFC2131 (https://www.ietf.org/rfc/rfc2131.txt) says when a host boots up with an unexpired DHCP lease it obtained prior to reboot, the DHCP client enters the INIT-REBOOT state and:\r\n\r\n---\r\nThe client times out and retransmits the DHCPREQUEST message if the client receives neither a DHCPACK nor a DHCPNAK message. The client retransmits the DHCPREQUEST according to the retransmission algorithm in section 4.1. The client should choose to retransmit the DHCPREQUEST enough times to give adequate probability of contacting the server without causing the client (and the user of that client) to wait overly long before giving up; e.g., a client retransmitting as described in section 4.1 might retransmit the DHCPREQUEST message four times, for a total delay of 60 seconds, before restarting the initialization procedure. If the client receives neither a DHCPACK or a DHCPNAK message after employing the retransmission algorithm, the client MAY choose to use the previously allocated network address and configuration parameters for the remainder of the unexpired lease. This corresponds to moving to BOUND state in the client state transition diagram shown in figure 5.\r\n---\r\n\r\nIn Euca 4.0.2 running Edge mode, when a stopped EBS instance starts, eucanetd inserts the following ebtables rule on the NC, essentially dropping all DHCP messages except unicast messages destined for the instances running on that node:\r\n\r\n{code}\r\n-A EUCA_EBT_NAT_POST -p IPv4 -d ! d0:d:6c:cb:5d:e7 -o vnet0 --ip-proto udp --ip-dport 67:68 -j DROP\r\n{code}\r\n\r\nThis rule blocks DHCPNAK messages issued by the DHCP server on the NC from the instance because the DHCPNAK message uses the broadcast address {{ff:ff:ff:ff:ff:ff}} as destination, as shown by the packet sniffer here.\r\n\r\nSo the DHCP client in the instance would eventually time out DHCPREQUEST when it fails to receive DHCPNAK. In Windows, DHCP client would retain the IP address of the unexpired lease it obtained before the reboot, as described in this TechNote (http://technet.microsoft.com/en-us/library/cc958945.aspx):\r\n\r\n----\r\nIf the client fails to locate a DHCP server during the renewal process, it attempts to ping the default gateway listed in the current lease, with the following results:\r\n\r\nIf a ping of the default gateway succeeds, the DHCP client assumes it is still located on the same network where it obtained its current lease, and the client continues to use the current lease. By default, the client attempts, in the background, to renew its current lease when 50 percent of its assigned lease time has expired.\r\n----\r\n\r\nBecause Windows decides to retain its old IP address, eucanetd will drop all network packets to and from the instance, cutting off network access (until the user manually force the DHCP client to reinitialize with “ipconfig /release” and “ipconfig /renew” commands and sends DHCPDISCOVER message to the server. DHCPOFFER and DHCPACK replies from the server, according to RFC 2131, are unicast back to the client so they are not blocked by the ebtable rule referenced above).\r\n\r\nWhen a Linux EBS instance starts under the same circumstances, it also will not receive the DHCPNAK messages from the DHCP server on the NC. However, dhclient will start initialization procedure according to dhclient’s man pages:\r\n\r\n---\r\nreboot time;\r\nWhen the client is restarted, it first tries to reacquire the last address it had. This is called the INIT-REBOOT state. If\r\nit is still attached to the same network it was attached to when it last ran, this is the quickest way to get started. The reboot statement sets the time that must elapse after the client first tries to reacquire its old address before it gives up and tries to discover a new address. By default, the reboot timeout is ten seconds.\r\n---\r\n\r\nI can confirm this in the node’s /var/log/message when a Linux EBS instance starts up under the same circumstances. It shows DHCPREQUEST <old address> -> DHCPNAK -> DCPREQUEST <old address> -> DHCPNAK -> DHCPDISCOVER -> DHCP OFFER <new address> -> DHCPREQUEST <new address> -> DHCPACK <new address>. Because RFC 2131 gives the DHCP client the options to either 1) reinitialize or 2) keep using the IP address of the unexpired lease after the client times out on DHCPREQUEST in the INIT-REBOOT state, both Windows and Linux clients behave correctly. However, when eucanetd erroneously blocks DHCPNAK in Euca 4.0.2, Windows instances are severely impacted whereas Linux instances are able to recover after a 10-second timeout.\r\n\r\nI verified my analysis by doing the following:\r\n\r\n* Reproduce the problem with a Windows 2008R2 EBS instance.\r\nWith the instance retaining the old private IP address, \r\n* On the CC host, I stopped eucalyptus-cc so CC won’t come around to overwrite the change I am about to make.\r\n* On the NC, I removed the ebtables rule that drops the DHCPNAK packet:\r\n\r\n{code}\r\nebtables -t nat -D EUCA_EBT_NAT_POST -p IPv4 -d ! d0:d:6c:cb:5d:e7 -o vnet0 --ip-proto udp --ip-dport 67:68 -j DROP \r\n{code}\r\n\r\n* From the console of the affected Windows instance, I rebooted Windows.\r\n* In the NC’s /var/log/messages, I saw:\r\n\r\n{code}\r\n---\r\nDec 19 15:29:28 cn0008 dhcpd: DHCPNAK on 128.84.11.131 to d0:0d:6c:cb:5d:e7 via br0\r\nDec 19 15:29:31 cn0008 dhcpd: DHCPREQUEST for 128.84.11.131 from d0:0d:6c:cb:5d:e7 via br0: lease 128.84.11.131 unavailable.\r\nDec 19 15:29:31 cn0008 dhcpd: DHCPNAK on 128.84.11.131 to d0:0d:6c:cb:5d:e7 via br0\r\nDec 19 15:29:39 cn0008 dhcpd: DHCPREQUEST for 128.84.11.131 from d0:0d:6c:cb:5d:e7 via br0: lease 128.84.11.131 unavailable.\r\nDec 19 15:29:39 cn0008 dhcpd: DHCPNAK on 128.84.11.131 to d0:0d:6c:cb:5d:e7 via br0\r\nDec 19 15:33:57 cn0008 dhcpd: DHCPREQUEST for 128.84.11.131 from d0:0d:6c:cb:5d:e7 via br0: lease 128.84.11.131 unavailable.\r\nDec 19 15:33:57 cn0008 dhcpd: DHCPNAK on 128.84.11.131 to d0:0d:6c:cb:5d:e7 via br0\r\nDec 19 15:33:57 cn0008 dhcpd: DHCPDISCOVER from d0:0d:6c:cb:5d:e7 via br0\r\nDec 19 15:33:57 cn0008 dhcpd: DHCPOFFER on 128.84.11.166 to d0:0d:6c:cb:5d:e7 via br0\r\nDec 19 15:33:57 cn0008 dhcpd: DHCPREQUEST for 128.84.11.166 (128.84.8.28) from d0:0d:6c:cb:5d:e7 via br0\r\nDec 19 15:33:57 cn0008 dhcpd: DHCPACK on 128.84.11.166 to d0:0d:6c:cb:5d:e7 via br0\r\nDec 19 15:34:27 cn0008 dhcpd: DHCPREQUEST for 128.84.11.166 from d0:0d:6c:cb:5d:e7 via br0\r\nDec 19 15:34:27 cn0008 dhcpd: DHCPACK on 128.84.11.166 to d0:0d:6c:cb:5d:e7 via br0\r\n---\r\n{code}\r\n\r\nI was able to access the instance via remote desktop after the instance is rebooted.\r\n\r\nI believe my analysis is correct but cannot think of an acceptable workaround so our users can stop and then start a Windows EBS instance right away. eucanetd should allow broadcast packets from the DHCP server on the NC to reach the instances, in addition to unicast packets. \r\n","customfield_13000":null,"customfield_13200":null,"customfield_11300":null,"customfield_11500":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=chuck","name":"chuck","key":"chuck","accountId":"557058:95e4b012-7cd1-4fd1-995d-eba573d35653","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/39b69736417cafd9d6dddeb1c2e00169?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dchuck%26avatarId%3D12900%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/39b69736417cafd9d6dddeb1c2e00169?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dchuck%26avatarId%3D12900%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/39b69736417cafd9d6dddeb1c2e00169?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dchuck%26avatarId%3D12900%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/39b69736417cafd9d6dddeb1c2e00169?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dchuck%26avatarId%3D12900%26noRedirect%3Dtrue"},"displayName":"Chuck","active":false,"timeZone":"America/Los_Angeles"},"timetracking":{"remainingEstimate":"0m","timeSpent":"2h","remainingEstimateSeconds":0,"timeSpentSeconds":7200},"customfield_10401":null,"customfield_10005":null,"customfield_10600":null,"customfield_12900":null,"attachment":[{"self":"https://eucalyptus.atlassian.net/rest/api/2/attachment/22832","id":"22832","filename":"Screen-Shot-2014-12-19-at-3.49.49-PM.png","author":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=shl1%40cornell.edu","name":"shl1@cornell.edu","key":"shl1@cornell.edu","accountId":"557058:8f59fb40-eb43-4f07-aa9b-4cb9f8019714","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/42f6dd3a4d305212fd8179d125b823db?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FavatarId%3D10122%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/42f6dd3a4d305212fd8179d125b823db?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26avatarId%3D10122%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/42f6dd3a4d305212fd8179d125b823db?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26avatarId%3D10122%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/42f6dd3a4d305212fd8179d125b823db?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26avatarId%3D10122%26noRedirect%3Dtrue"},"displayName":"Steven Lee","active":true,"timeZone":"America/New_York"},"created":"2015-01-05T09:37:55.062-0600","size":120305,"mimeType":"image/png","content":"https://eucalyptus.atlassian.net/secure/attachment/22832/Screen-Shot-2014-12-19-at-3.49.49-PM.png","thumbnail":"https://eucalyptus.atlassian.net/secure/thumbnail/22832/Screen-Shot-2014-12-19-at-3.49.49-PM.png"}],"aggregatetimeestimate":0,"summary":"Stopped Windows EBS instances do not start correctly as DHCP clients request server to respond using L2 Broadcast","creator":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=shl1%40cornell.edu","name":"shl1@cornell.edu","key":"shl1@cornell.edu","accountId":"557058:8f59fb40-eb43-4f07-aa9b-4cb9f8019714","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/42f6dd3a4d305212fd8179d125b823db?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FavatarId%3D10122%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/42f6dd3a4d305212fd8179d125b823db?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26avatarId%3D10122%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/42f6dd3a4d305212fd8179d125b823db?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26avatarId%3D10122%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/42f6dd3a4d305212fd8179d125b823db?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26avatarId%3D10122%26noRedirect%3Dtrue"},"displayName":"Steven Lee","active":true,"timeZone":"America/New_York"},"subtasks":[],"reporter":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=shl1%40cornell.edu","name":"shl1@cornell.edu","key":"shl1@cornell.edu","accountId":"557058:8f59fb40-eb43-4f07-aa9b-4cb9f8019714","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/42f6dd3a4d305212fd8179d125b823db?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FavatarId%3D10122%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/42f6dd3a4d305212fd8179d125b823db?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26avatarId%3D10122%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/42f6dd3a4d305212fd8179d125b823db?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26avatarId%3D10122%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/42f6dd3a4d305212fd8179d125b823db?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26avatarId%3D10122%26noRedirect%3Dtrue"},"displayName":"Steven Lee","active":true,"timeZone":"America/New_York"},"aggregateprogress":{"progress":7200,"total":7200,"percent":100},"customfield_10000":"3_*:*_1_*:*_630634240_*|*_10000_*:*_1_*:*_284309700_*|*_10002_*:*_2_*:*_2207018116_*|*_10001_*:*_2_*:*_14209937_*|*_10003_*:*_1_*:*_5619890711_*|*_10006_*:*_1_*:*_0","customfield_12100":"0|i030vj:","customfield_10001":"2015-01-08T16:36:24.742-0600","customfield_10200":null,"customfield_10002":[{"self":"https://eucalyptus.atlassian.net/rest/api/2/customFieldOption/10000","value":"Customer Affecting","id":"10000"}],"customfield_10003":null,"customfield_10400":null,"customfield_12500":null,"customfield_11600":["chuck(chuck)","mbacchi(mbacchi)","shl1@cornell.edu(shl1@cornell.edu)","tjcramer(tjcramer)","viglesias(viglesias)"],"customfield_10116":null,"customfield_10117":null,"environment":null,"customfield_11800":null,"customfield_11802":null,"customfield_11805":null,"duedate":null,"customfield_11806":null,"progress":{"progress":7200,"total":7200,"percent":100},"votes":{"self":"https://eucalyptus.atlassian.net/rest/api/2/issue/EUCA-10278/votes","votes":0,"hasVoted":false},"comment":{"comments":[{"self":"https://eucalyptus.atlassian.net/rest/api/2/issue/33993/comment/81393","id":"81393","author":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=tjcramer","name":"tjcramer","key":"tjcramer","accountId":"557058:e076cf45-80ca-4b67-befb-7b0c21f32739","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/65e7a5c18fc469f1978f6367993c3bf0?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dtjcramer%26avatarId%3D10401%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/65e7a5c18fc469f1978f6367993c3bf0?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dtjcramer%26avatarId%3D10401%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/65e7a5c18fc469f1978f6367993c3bf0?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dtjcramer%26avatarId%3D10401%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/65e7a5c18fc469f1978f6367993c3bf0?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dtjcramer%26avatarId%3D10401%26noRedirect%3Dtrue"},"displayName":"Tim Cramer","active":true,"timeZone":"America/Los_Angeles"},"body":"Let's test and reproduce in 4.1.0 in order to get a handle on this one.  \r\nLook for a workaround in 4.0.2 for them in EDGE mode.\r\nToday they manually do an ipconfig renew (or wait a day) which is impractical.\r\n\r\n[~kedwards] for your radar.","updateAuthor":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=tjcramer","name":"tjcramer","key":"tjcramer","accountId":"557058:e076cf45-80ca-4b67-befb-7b0c21f32739","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/65e7a5c18fc469f1978f6367993c3bf0?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dtjcramer%26avatarId%3D10401%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/65e7a5c18fc469f1978f6367993c3bf0?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dtjcramer%26avatarId%3D10401%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/65e7a5c18fc469f1978f6367993c3bf0?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dtjcramer%26avatarId%3D10401%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/65e7a5c18fc469f1978f6367993c3bf0?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dtjcramer%26avatarId%3D10401%26noRedirect%3Dtrue"},"displayName":"Tim Cramer","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-01-08T16:36:24.742-0600","updated":"2015-01-08T16:36:24.742-0600"},{"self":"https://eucalyptus.atlassian.net/rest/api/2/issue/33993/comment/81946","id":"81946","author":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=chuck","name":"chuck","key":"chuck","accountId":"557058:95e4b012-7cd1-4fd1-995d-eba573d35653","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/39b69736417cafd9d6dddeb1c2e00169?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dchuck%26avatarId%3D12900%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/39b69736417cafd9d6dddeb1c2e00169?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dchuck%26avatarId%3D12900%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/39b69736417cafd9d6dddeb1c2e00169?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dchuck%26avatarId%3D12900%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/39b69736417cafd9d6dddeb1c2e00169?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dchuck%26avatarId%3D12900%26noRedirect%3Dtrue"},"displayName":"Chuck","active":false,"timeZone":"America/Los_Angeles"},"body":"I'm able to reproduce the problem and this is not related to DHCP lease expiration. I can't quite tell what the problem is but sometimes my EBS instance would pick up the new IP and be reachable and sometimes it would not. Every time it works, I can confirm the following steps\r\n\r\n# Windows sends a DHCP request for the old IP\r\n# Server NAK that IP\r\n# Windows sends a DHCP Discovery\r\n# Server offers new IP\r\n# Windows Request that new IP\r\n# Server ACK\r\n\r\nIn the failing cases, I always see the same:\r\n# a series of:\r\n## Windows request the OLD IP (seen at the DHCP server)\r\n## Server NACK (but not seen on br0 nor the vn_i-XXXXXXXX interface)\r\n# After a while, this changes to a series of\r\n## Windows sending DHCP discover\r\n## Server sending offer (but not seen on br0 nor the vn_i-XXXXXXXX interface)\r\n\r\nI'm digging a little more at this time","updateAuthor":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=chuck","name":"chuck","key":"chuck","accountId":"557058:95e4b012-7cd1-4fd1-995d-eba573d35653","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/39b69736417cafd9d6dddeb1c2e00169?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dchuck%26avatarId%3D12900%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/39b69736417cafd9d6dddeb1c2e00169?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dchuck%26avatarId%3D12900%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/39b69736417cafd9d6dddeb1c2e00169?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dchuck%26avatarId%3D12900%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/39b69736417cafd9d6dddeb1c2e00169?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dchuck%26avatarId%3D12900%26noRedirect%3Dtrue"},"displayName":"Chuck","active":false,"timeZone":"America/Los_Angeles"},"created":"2015-01-15T16:49:40.924-0600","updated":"2015-01-15T16:49:40.924-0600"},{"self":"https://eucalyptus.atlassian.net/rest/api/2/issue/33993/comment/81951","id":"81951","author":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=chuck","name":"chuck","key":"chuck","accountId":"557058:95e4b012-7cd1-4fd1-995d-eba573d35653","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/39b69736417cafd9d6dddeb1c2e00169?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dchuck%26avatarId%3D12900%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/39b69736417cafd9d6dddeb1c2e00169?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dchuck%26avatarId%3D12900%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/39b69736417cafd9d6dddeb1c2e00169?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dchuck%26avatarId%3D12900%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/39b69736417cafd9d6dddeb1c2e00169?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dchuck%26avatarId%3D12900%26noRedirect%3Dtrue"},"displayName":"Chuck","active":false,"timeZone":"America/Los_Angeles"},"body":"Bingo!!!\r\n\r\nCouldn't see the offer on br0 because I was explicitly using tcpdump looking for the VM's MAC... So essentially, what's happening here is that Windows is sending DHCP request specifically indicating to the server to respond using a broadcast MAC address which we'll intentionally drop in the ebtables:\r\n\r\n{noformat}\r\n15:07:40.239738 d0:0d:4f:24:84:e1 > Broadcast, ethertype IPv4 (0x0800), length 352: 0.0.0.0.bootpc > 255.255.255.255.bootps: BOOTP/DHCP, Request from d0:0d:4f:24:84:e1, length 310\r\n15:07:40.240070 e8:9a:8f:74:0f:44 > Broadcast, ethertype IPv4 (0x0800), length 342: 10.111.5.180.bootps > 255.255.255.255.bootpc: BOOTP/DHCP, Reply, length 300\r\n15:07:45.234871 d0:0d:4f:24:84:e1 > Broadcast, ethertype IPv4 (0x0800), length 352: 0.0.0.0.bootpc > 255.255.255.255.bootps: BOOTP/DHCP, Request from d0:0d:4f:24:84:e1, length 310\r\n15:07:45.235128 e8:9a:8f:74:0f:44 > Broadcast, ethertype IPv4 (0x0800), length 342: 10.111.5.180.bootps > 255.255.255.255.bootpc: BOOTP/DHCP, Reply, length 300\r\n{noformat}\r\n\r\n{noformat}\r\nBridge chain: EUCA_EBT_NAT_POST, entries: 10, policy: ACCEPT\r\n-p IPv4 -d ! d0:d:2:bb:5c:39 -o vn_i-02bb5c39 --ip-proto udp --ip-dport 67:68 -j DROP \r\n{noformat}\r\n\r\nA good solution would be to configure the DHCP server to ignore this broadcast request and force a unicast request. As far as workaround, I'm still on it.","updateAuthor":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=chuck","name":"chuck","key":"chuck","accountId":"557058:95e4b012-7cd1-4fd1-995d-eba573d35653","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/39b69736417cafd9d6dddeb1c2e00169?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dchuck%26avatarId%3D12900%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/39b69736417cafd9d6dddeb1c2e00169?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dchuck%26avatarId%3D12900%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/39b69736417cafd9d6dddeb1c2e00169?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dchuck%26avatarId%3D12900%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/39b69736417cafd9d6dddeb1c2e00169?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dchuck%26avatarId%3D12900%26noRedirect%3Dtrue"},"displayName":"Chuck","active":false,"timeZone":"America/Los_Angeles"},"created":"2015-01-15T17:11:09.704-0600","updated":"2015-01-15T17:11:09.704-0600"},{"self":"https://eucalyptus.atlassian.net/rest/api/2/issue/33993/comment/82002","id":"82002","author":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=chuck","name":"chuck","key":"chuck","accountId":"557058:95e4b012-7cd1-4fd1-995d-eba573d35653","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/39b69736417cafd9d6dddeb1c2e00169?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dchuck%26avatarId%3D12900%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/39b69736417cafd9d6dddeb1c2e00169?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dchuck%26avatarId%3D12900%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/39b69736417cafd9d6dddeb1c2e00169?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dchuck%26avatarId%3D12900%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/39b69736417cafd9d6dddeb1c2e00169?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dchuck%26avatarId%3D12900%26noRedirect%3Dtrue"},"displayName":"Chuck","active":false,"timeZone":"America/Los_Angeles"},"body":"ok,\r\n\r\nWell I cannot get the \"always-unicast\" option work with the ISC server. Furthermore, I read a few texts where windows could potentially get offended if the response from the server is unicasted and ignore it. So the only solution is to only allow server response to a VM if and only if:\r\n\r\n# the destination MAC is for that VM\r\n# the destination MAC is Broadcast\r\n\r\nThis means that we need to add the following global rule (i.e. for all VM interfaces) to the EUCA_EBT_NAT_POST chain.\r\n{noformat}\r\n-p IPv4 -d Broadcast -o vn_i+ --ip-proto udp --ip-dport 67:68 -j ACCEPT \r\n{noformat}\r\n\r\nA possible field workaround for 4.0.2 would be to install the following rule manually:\r\n{noformat}\r\nebtables -t nat -I POSTROUTING -p IPv4 -d Broadcast -o vn_i+ --ip-proto udp --ip-dport 67:68 -j ACCEPT \r\n{noformat}\r\n\r\nI tested both cases and I was able to confirm the fix.","updateAuthor":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=chuck","name":"chuck","key":"chuck","accountId":"557058:95e4b012-7cd1-4fd1-995d-eba573d35653","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/39b69736417cafd9d6dddeb1c2e00169?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dchuck%26avatarId%3D12900%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/39b69736417cafd9d6dddeb1c2e00169?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dchuck%26avatarId%3D12900%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/39b69736417cafd9d6dddeb1c2e00169?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dchuck%26avatarId%3D12900%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/39b69736417cafd9d6dddeb1c2e00169?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dchuck%26avatarId%3D12900%26noRedirect%3Dtrue"},"displayName":"Chuck","active":false,"timeZone":"America/Los_Angeles"},"created":"2015-01-16T03:12:09.186-0600","updated":"2015-01-16T03:12:09.186-0600"},{"self":"https://eucalyptus.atlassian.net/rest/api/2/issue/33993/comment/82003","id":"82003","author":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=chuck","name":"chuck","key":"chuck","accountId":"557058:95e4b012-7cd1-4fd1-995d-eba573d35653","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/39b69736417cafd9d6dddeb1c2e00169?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dchuck%26avatarId%3D12900%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/39b69736417cafd9d6dddeb1c2e00169?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dchuck%26avatarId%3D12900%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/39b69736417cafd9d6dddeb1c2e00169?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dchuck%26avatarId%3D12900%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/39b69736417cafd9d6dddeb1c2e00169?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dchuck%26avatarId%3D12900%26noRedirect%3Dtrue"},"displayName":"Chuck","active":false,"timeZone":"America/Los_Angeles"},"body":"The following code change is for review:\r\n{noformat}\r\ncommit ced24ebbbfa392444a33916970208bc950ad618a\r\nAuthor: chuck <chuck@eucalyptus.com> 2015-01-16 01:14:21\r\nCommitter: chuck <chuck@eucalyptus.com> 2015-01-16 01:14:21\r\nParent: 1d068ae29681ed8794ea7c9ec5c4248ca820dda0 (Forces traffic to be blocked until rules are installed EUCA-10233)\r\nBranches: dev/chuck/EUCA-10278-2, origin/dev/chuck/EUCA-10278-2\r\n\r\nFix issue where the DHCP server is allowed to respond using broadcast\r\nEUCA-10278\r\n\r\n-------------------------------- net/eucanetd.c -------------------------------\r\ndiff --git a/net/eucanetd.c b/net/eucanetd.c\r\nindex d78a248..272a832 100644\r\n--- a/net/eucanetd.c\r\n+++ b/net/eucanetd.c\r\n@@ -670,6 +670,9 @@\r\n             rc = ebt_chain_add_rule(config->ebt, \"nat\", \"EUCA_EBT_NAT_PRE\", cmd);\r\n         }\r\n \r\n+        snprintf(cmd, EUCA_MAX_PATH, \"-p IPv4 -o vn_i+ -d Broadcast --ip-proto udp --ip-dport 67:68 -j DROP\");\r\n+        rc = ebt_chain_add_rule(config->ebt, \"nat\", \"EUCA_EBT_NAT_POST\", cmd);\r\n+\r\n         for (i = 0; i < max_instances; i++) {\r\n             if (instances[i].privateIp && maczero(instances[i].macAddress)) {\r\n                 strptra = strptrb = NULL;\r\n{noformat}","updateAuthor":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=chuck","name":"chuck","key":"chuck","accountId":"557058:95e4b012-7cd1-4fd1-995d-eba573d35653","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/39b69736417cafd9d6dddeb1c2e00169?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dchuck%26avatarId%3D12900%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/39b69736417cafd9d6dddeb1c2e00169?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dchuck%26avatarId%3D12900%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/39b69736417cafd9d6dddeb1c2e00169?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dchuck%26avatarId%3D12900%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/39b69736417cafd9d6dddeb1c2e00169?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dchuck%26avatarId%3D12900%26noRedirect%3Dtrue"},"displayName":"Chuck","active":false,"timeZone":"America/Los_Angeles"},"created":"2015-01-16T03:16:17.087-0600","updated":"2015-01-16T03:16:17.087-0600"},{"self":"https://eucalyptus.atlassian.net/rest/api/2/issue/33993/comment/82022","id":"82022","author":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=chuck","name":"chuck","key":"chuck","accountId":"557058:95e4b012-7cd1-4fd1-995d-eba573d35653","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/39b69736417cafd9d6dddeb1c2e00169?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dchuck%26avatarId%3D12900%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/39b69736417cafd9d6dddeb1c2e00169?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dchuck%26avatarId%3D12900%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/39b69736417cafd9d6dddeb1c2e00169?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dchuck%26avatarId%3D12900%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/39b69736417cafd9d6dddeb1c2e00169?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dchuck%26avatarId%3D12900%26noRedirect%3Dtrue"},"displayName":"Chuck","active":false,"timeZone":"America/Los_Angeles"},"body":"Just talked with Dan about this fix. He brought up a good point that we should also check for the source MAC being the node controller for the \"allow broadcast\" rule. Will work on this and test it.","updateAuthor":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=chuck","name":"chuck","key":"chuck","accountId":"557058:95e4b012-7cd1-4fd1-995d-eba573d35653","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/39b69736417cafd9d6dddeb1c2e00169?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dchuck%26avatarId%3D12900%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/39b69736417cafd9d6dddeb1c2e00169?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dchuck%26avatarId%3D12900%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/39b69736417cafd9d6dddeb1c2e00169?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dchuck%26avatarId%3D12900%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/39b69736417cafd9d6dddeb1c2e00169?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dchuck%26avatarId%3D12900%26noRedirect%3Dtrue"},"displayName":"Chuck","active":false,"timeZone":"America/Los_Angeles"},"created":"2015-01-16T11:46:22.452-0600","updated":"2015-01-16T11:46:22.452-0600"},{"self":"https://eucalyptus.atlassian.net/rest/api/2/issue/33993/comment/82033","id":"82033","author":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=chuck","name":"chuck","key":"chuck","accountId":"557058:95e4b012-7cd1-4fd1-995d-eba573d35653","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/39b69736417cafd9d6dddeb1c2e00169?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dchuck%26avatarId%3D12900%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/39b69736417cafd9d6dddeb1c2e00169?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dchuck%26avatarId%3D12900%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/39b69736417cafd9d6dddeb1c2e00169?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dchuck%26avatarId%3D12900%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/39b69736417cafd9d6dddeb1c2e00169?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dchuck%26avatarId%3D12900%26noRedirect%3Dtrue"},"displayName":"Chuck","active":false,"timeZone":"America/Los_Angeles"},"body":"New patch. This includes ensuring the DHCP broadcast going towards the VM comes from the node... Manually tested it works. Currently going through regression.\r\n\r\n{noformat}\r\ncommit 7dbce5c6b8a1b1eea1a5bf2b1f66d6d7400c8ab9\r\nAuthor: chuck <chuck@eucalyptus.com> 2015-01-16 10:11:43\r\nCommitter: chuck <chuck@eucalyptus.com> 2015-01-16 10:11:43\r\nParent: 1d068ae29681ed8794ea7c9ec5c4248ca820dda0 (Forces traffic to be blocked until rules are installed EUCA-10233)\r\nBranches: dev/chuck/EUCA-10278-3, origin/dev/chuck/EUCA-10278-3\r\n\r\nFix issue where the DHCP server is allowed to respond using broadcast\r\nEUCA-10278\r\n\r\n-------------------------------- net/eucanetd.c -------------------------------\r\ndiff --git a/net/eucanetd.c b/net/eucanetd.c\r\nindex d78a248..b4b6283 100644\r\n--- a/net/eucanetd.c\r\n+++ b/net/eucanetd.c\r\n@@ -617,6 +617,7 @@\r\n     int i = 0;\r\n     int rc = 0;\r\n     int ret = 0;\r\n+    int brMacLen = 0;\r\n     char cmd[EUCA_MAX_PATH] = \"\";\r\n     char *strptra = NULL;\r\n     char *strptrb = NULL;\r\n@@ -650,10 +651,6 @@\r\n     rc = ebt_chain_add_rule(config->ebt, \"nat\", \"POSTROUTING\", \"-j EUCA_EBT_NAT_POST\");\r\n     rc = ebt_chain_flush(config->ebt, \"nat\", \"EUCA_EBT_NAT_POST\");\r\n \r\n-    // add these for DHCP to pass\r\n-    //    rc = ebt_chain_add_rule(config->ebt, \"filter\", \"EUCA_EBT_FWD\", \"-p IPv4 -d Broadcast --ip-proto udp --ip-dport 67:68 -j ACCEPT\");\r\n-    //    rc = ebt_chain_add_rule(config->ebt, \"filter\", \"EUCA_EBT_FWD\", \"-p IPv4 -d Broadcast --ip-proto udp --ip-sport 67:68 -j ACCEPT\");\r\n-\r\n     rc = gni_find_self_node(globalnetworkinfo, &myself);\r\n     if (!rc) {\r\n         rc = gni_node_get_instances(globalnetworkinfo, myself, NULL, 0, NULL, 0, &instances, &max_instances);\r\n@@ -663,6 +660,16 @@\r\n     brmac = interface2mac(config->bridgeDev);\r\n \r\n     if (gwip && brmac) {\r\n+        // The bridge MAC does have a \\n character at the end. We must remove it to prevent issues creating the strings below.\r\n+        if ((brMacLen = strlen(brmac)) == 0) {\r\n+            if (brmac[brMacLen - 1] == '\\n')\r\n+                brmac[brMacLen - 1] = '\\0';\r\n+        }\r\n+\r\n+        // Add this one for DHCP to pass since windows may be requesting broadcast responses\r\n+        snprintf(cmd, EUCA_MAX_PATH, \"-p IPv4 -o vn_i+ -s %s -d Broadcast --ip-proto udp --ip-dport 67:68 -j DROP\", brmac);\r\n+        rc = ebt_chain_add_rule(config->ebt, \"nat\", \"EUCA_EBT_NAT_POST\", cmd);\r\n+\r\n         // If we're using the \"fake\" router option and have some instance running,\r\n         // we need to respond for out of network ARP request.\r\n         if (config->nc_router && !config->nc_router_ip && (max_instances > 0)) {\r\n@@ -783,7 +790,7 @@\r\n     }\r\n \r\n     // DROP everything from the instance by default\r\n-    snprintf(cmd, EUCA_MAX_PATH, \"-i vn_i+ -j DROP\", vnetinterface);\r\n+    snprintf(cmd, EUCA_MAX_PATH, \"-i vn_i+ -j DROP\");\r\n     rc = ebt_chain_add_rule(config->ebt, \"nat\", \"EUCA_EBT_NAT_PRE\", cmd);\r\n \r\n     // DROP everything to the instance by default\r\n{noformat}","updateAuthor":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=chuck","name":"chuck","key":"chuck","accountId":"557058:95e4b012-7cd1-4fd1-995d-eba573d35653","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/39b69736417cafd9d6dddeb1c2e00169?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dchuck%26avatarId%3D12900%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/39b69736417cafd9d6dddeb1c2e00169?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dchuck%26avatarId%3D12900%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/39b69736417cafd9d6dddeb1c2e00169?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dchuck%26avatarId%3D12900%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/39b69736417cafd9d6dddeb1c2e00169?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dchuck%26avatarId%3D12900%26noRedirect%3Dtrue"},"displayName":"Chuck","active":false,"timeZone":"America/Los_Angeles"},"created":"2015-01-16T12:13:54.287-0600","updated":"2015-01-16T12:13:54.287-0600"},{"self":"https://eucalyptus.atlassian.net/rest/api/2/issue/33993/comment/84538","id":"84538","author":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=viglesias","name":"viglesias","key":"viglesias","accountId":"557058:49b276ff-ebf9-4dd6-ada3-b568a2898707","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/5608e0aa05bd6e5d73b855a08079cceb?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dviglesias%26avatarId%3D10405%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/5608e0aa05bd6e5d73b855a08079cceb?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dviglesias%26avatarId%3D10405%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/5608e0aa05bd6e5d73b855a08079cceb?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dviglesias%26avatarId%3D10405%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/5608e0aa05bd6e5d73b855a08079cceb?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dviglesias%26avatarId%3D10405%26noRedirect%3Dtrue"},"displayName":"Victor Iglesias","active":true,"timeZone":"America/Los_Angeles"},"body":"[~chuck]\r\n\r\nWhat is the proper way to verify this fix?","updateAuthor":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=viglesias","name":"viglesias","key":"viglesias","accountId":"557058:49b276ff-ebf9-4dd6-ada3-b568a2898707","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/5608e0aa05bd6e5d73b855a08079cceb?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dviglesias%26avatarId%3D10405%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/5608e0aa05bd6e5d73b855a08079cceb?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dviglesias%26avatarId%3D10405%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/5608e0aa05bd6e5d73b855a08079cceb?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dviglesias%26avatarId%3D10405%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/5608e0aa05bd6e5d73b855a08079cceb?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dviglesias%26avatarId%3D10405%26noRedirect%3Dtrue"},"displayName":"Victor Iglesias","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-03-30T14:06:09.123-0500","updated":"2015-03-30T14:06:09.123-0500"},{"self":"https://eucalyptus.atlassian.net/rest/api/2/issue/33993/comment/84541","id":"84541","author":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=chuck","name":"chuck","key":"chuck","accountId":"557058:95e4b012-7cd1-4fd1-995d-eba573d35653","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/39b69736417cafd9d6dddeb1c2e00169?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dchuck%26avatarId%3D12900%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/39b69736417cafd9d6dddeb1c2e00169?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dchuck%26avatarId%3D12900%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/39b69736417cafd9d6dddeb1c2e00169?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dchuck%26avatarId%3D12900%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/39b69736417cafd9d6dddeb1c2e00169?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dchuck%26avatarId%3D12900%26noRedirect%3Dtrue"},"displayName":"Chuck","active":false,"timeZone":"America/Los_Angeles"},"body":"The step to reproduce are presented in the following comment:\r\n\r\nhttps://eucalyptus.atlassian.net/browse/EUCA-10278?focusedCommentId=81946&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-81946\r\n\r\nTesting should ensure we are no longer able to reproduce this case and that we did not introduce any DHCP issues with EBS instances in general (i.e. just standard networking regression testing).","updateAuthor":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=chuck","name":"chuck","key":"chuck","accountId":"557058:95e4b012-7cd1-4fd1-995d-eba573d35653","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/39b69736417cafd9d6dddeb1c2e00169?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dchuck%26avatarId%3D12900%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/39b69736417cafd9d6dddeb1c2e00169?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dchuck%26avatarId%3D12900%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/39b69736417cafd9d6dddeb1c2e00169?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dchuck%26avatarId%3D12900%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/39b69736417cafd9d6dddeb1c2e00169?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dchuck%26avatarId%3D12900%26noRedirect%3Dtrue"},"displayName":"Chuck","active":false,"timeZone":"America/Los_Angeles"},"created":"2015-03-30T14:21:06.815-0500","updated":"2015-03-30T14:21:06.815-0500"},{"self":"https://eucalyptus.atlassian.net/rest/api/2/issue/33993/comment/84542","id":"84542","author":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=viglesias","name":"viglesias","key":"viglesias","accountId":"557058:49b276ff-ebf9-4dd6-ada3-b568a2898707","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/5608e0aa05bd6e5d73b855a08079cceb?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dviglesias%26avatarId%3D10405%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/5608e0aa05bd6e5d73b855a08079cceb?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dviglesias%26avatarId%3D10405%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/5608e0aa05bd6e5d73b855a08079cceb?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dviglesias%26avatarId%3D10405%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/5608e0aa05bd6e5d73b855a08079cceb?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dviglesias%26avatarId%3D10405%26noRedirect%3Dtrue"},"displayName":"Victor Iglesias","active":true,"timeZone":"America/Los_Angeles"},"body":"[~chuck]\r\n\r\nLooks like that comment describes what to look for but not how to get there. Is it just any start/stop of a Windows instance that caused this? Did it happen on initial launch as well? Or was it probabilistic? \r\n\r\nSo far I can confirm that there hasnt been any odd DHCP behavior in linux VMs.","updateAuthor":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=viglesias","name":"viglesias","key":"viglesias","accountId":"557058:49b276ff-ebf9-4dd6-ada3-b568a2898707","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/5608e0aa05bd6e5d73b855a08079cceb?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dviglesias%26avatarId%3D10405%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/5608e0aa05bd6e5d73b855a08079cceb?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dviglesias%26avatarId%3D10405%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/5608e0aa05bd6e5d73b855a08079cceb?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dviglesias%26avatarId%3D10405%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/5608e0aa05bd6e5d73b855a08079cceb?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dviglesias%26avatarId%3D10405%26noRedirect%3Dtrue"},"displayName":"Victor Iglesias","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-03-30T14:33:29.511-0500","updated":"2015-03-30T14:33:29.511-0500"},{"self":"https://eucalyptus.atlassian.net/rest/api/2/issue/33993/comment/84577","id":"84577","author":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=chuck","name":"chuck","key":"chuck","accountId":"557058:95e4b012-7cd1-4fd1-995d-eba573d35653","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/39b69736417cafd9d6dddeb1c2e00169?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dchuck%26avatarId%3D12900%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/39b69736417cafd9d6dddeb1c2e00169?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dchuck%26avatarId%3D12900%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/39b69736417cafd9d6dddeb1c2e00169?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dchuck%26avatarId%3D12900%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/39b69736417cafd9d6dddeb1c2e00169?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dchuck%26avatarId%3D12900%26noRedirect%3Dtrue"},"displayName":"Chuck","active":false,"timeZone":"America/Los_Angeles"},"body":"[~vicnastea],\r\n\r\nThe description contains the steps to reproduce the problem and claims its a \"start/stop\" issue only. My analysis was that Windows in such condition (i.e. \"stop/start\") specifically calls the DHCP server to respond using broadcast MAC instead of the VM mac which was dropped by the EB tables resulting in the VM not to receive the DHCP packets. The solution was to add a rule in the EB tables to allow broadcast DHCP traffic to go back up to the VMs.","updateAuthor":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=chuck","name":"chuck","key":"chuck","accountId":"557058:95e4b012-7cd1-4fd1-995d-eba573d35653","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/39b69736417cafd9d6dddeb1c2e00169?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dchuck%26avatarId%3D12900%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/39b69736417cafd9d6dddeb1c2e00169?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dchuck%26avatarId%3D12900%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/39b69736417cafd9d6dddeb1c2e00169?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dchuck%26avatarId%3D12900%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/39b69736417cafd9d6dddeb1c2e00169?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dchuck%26avatarId%3D12900%26noRedirect%3Dtrue"},"displayName":"Chuck","active":false,"timeZone":"America/Los_Angeles"},"created":"2015-03-30T16:04:22.704-0500","updated":"2015-03-30T16:04:22.704-0500"},{"self":"https://eucalyptus.atlassian.net/rest/api/2/issue/33993/comment/84616","id":"84616","author":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=shl1%40cornell.edu","name":"shl1@cornell.edu","key":"shl1@cornell.edu","accountId":"557058:8f59fb40-eb43-4f07-aa9b-4cb9f8019714","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/42f6dd3a4d305212fd8179d125b823db?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FavatarId%3D10122%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/42f6dd3a4d305212fd8179d125b823db?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26avatarId%3D10122%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/42f6dd3a4d305212fd8179d125b823db?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26avatarId%3D10122%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/42f6dd3a4d305212fd8179d125b823db?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26avatarId%3D10122%26noRedirect%3Dtrue"},"displayName":"Steven Lee","active":true,"timeZone":"America/New_York"},"body":"Hi,\r\n\r\nI originally reported the problem. \r\n\r\nYou can verify if the fix is working by stopping and then starting a Windows EBS instance. If the problem is fixed, the Windows instance will start, send a DHCPREQUEST with its previous private IP address from a still valid lease, receive from NC a broadcast DHCPNAK response, send a DHCPDISCOVER request, receive from NC a DHCPACK with its new private IP address, and happily boot. \r\n\r\nWithout the fix, the Windows EBS instance will start but hold on to its previous private IP address and become unreachable on the network. \r\n\r\nThis is 100% reproducible.\r\n\r\nSteven","updateAuthor":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=shl1%40cornell.edu","name":"shl1@cornell.edu","key":"shl1@cornell.edu","accountId":"557058:8f59fb40-eb43-4f07-aa9b-4cb9f8019714","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/42f6dd3a4d305212fd8179d125b823db?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FavatarId%3D10122%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/42f6dd3a4d305212fd8179d125b823db?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26avatarId%3D10122%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/42f6dd3a4d305212fd8179d125b823db?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26avatarId%3D10122%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/42f6dd3a4d305212fd8179d125b823db?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26avatarId%3D10122%26noRedirect%3Dtrue"},"displayName":"Steven Lee","active":true,"timeZone":"America/New_York"},"created":"2015-03-31T12:15:02.197-0500","updated":"2015-03-31T12:15:02.197-0500"},{"self":"https://eucalyptus.atlassian.net/rest/api/2/issue/33993/comment/85343","id":"85343","author":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=mbacchi","name":"mbacchi","key":"mbacchi","accountId":"557058:d650aabc-f00c-4262-93a9-7799945b8eed","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/24b916c1ff78f38b51f4bb1dc66ed58c?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dmbacchi%26avatarId%3D16201%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/24b916c1ff78f38b51f4bb1dc66ed58c?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dmbacchi%26avatarId%3D16201%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/24b916c1ff78f38b51f4bb1dc66ed58c?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dmbacchi%26avatarId%3D16201%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/24b916c1ff78f38b51f4bb1dc66ed58c?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dmbacchi%26avatarId%3D16201%26noRedirect%3Dtrue"},"displayName":"Matt Bacchi","active":true,"timeZone":"US/Central"},"body":"Fix seems to work during test:\r\n\r\nprivate IP address was set to:\r\n\r\n[root@c-08 ~]# euca-describe-instances i-e8a5c3a4\r\nRESERVATION     r-55915dda      858076495270    RDP, ssh, ICMP\r\nINSTANCE        i-e8a5c3a4      emi-1060b6df    10.111.75.44    10.111.75.55    stopping        one-key 0              m2.2xlarge       2015-04-16T21:55:24.282Z        one                     windows monitoring-disabled     10.111.75.44   10.111.75.55                     ebs                                     hvm                     sg-36450c5e,sg-8236a332,sg-8dc63986                             x86_64\r\n\r\nStopped and then restarted, IP address is now:\r\n\r\n[root@c-08 ~]# euca-describe-instances i-e8a5c3a4\r\nRESERVATION     r-55915dda      858076495270    RDP, ssh, ICMP\r\nINSTANCE        i-e8a5c3a4      emi-1060b6df    10.111.75.41    10.111.75.52    pending one-key 0               m2.2xlarge      2015-04-16T21:55:24.282Z        one                     windows monitoring-disabled     10.111.75.41    10.111.75.52                    ebs                                     hvm                     sg-36450c5e,sg-8236a332,sg-8dc63986                             x86_64\r\n\r\n/var/log/messages on the NC shows:\r\n\r\nApr 16 16:43:08 a-27 dhcpd: DHCPREQUEST for 10.111.75.55 from d0:0d:e8:a5:c3:a4 via br0: unknown lease 10.111.75.55.\r\nApr 16 16:43:08 a-27 dhcpd: DHCPDISCOVER from d0:0d:e8:a5:c3:a4 via br0: network euca: no free leases\r\nApr 16 16:43:08 a-27 dhcpd: DHCPREQUEST for 10.111.75.52 (10.111.1.46) from d0:0d:e8:a5:c3:a4 via br0: unknown lease 10.111.75.52.\r\n","updateAuthor":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=mbacchi","name":"mbacchi","key":"mbacchi","accountId":"557058:d650aabc-f00c-4262-93a9-7799945b8eed","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/24b916c1ff78f38b51f4bb1dc66ed58c?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dmbacchi%26avatarId%3D16201%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/24b916c1ff78f38b51f4bb1dc66ed58c?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dmbacchi%26avatarId%3D16201%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/24b916c1ff78f38b51f4bb1dc66ed58c?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dmbacchi%26avatarId%3D16201%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/24b916c1ff78f38b51f4bb1dc66ed58c?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dmbacchi%26avatarId%3D16201%26noRedirect%3Dtrue"},"displayName":"Matt Bacchi","active":true,"timeZone":"US/Central"},"created":"2015-04-16T18:52:17.240-0500","updated":"2015-04-16T18:52:17.240-0500"}],"maxResults":13,"total":13,"startAt":0},"customfield_11808":null,"worklog":{"startAt":0,"maxResults":20,"total":1,"worklogs":[{"self":"https://eucalyptus.atlassian.net/rest/api/2/issue/33993/worklog/14001","author":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=mbacchi","name":"mbacchi","key":"mbacchi","accountId":"557058:d650aabc-f00c-4262-93a9-7799945b8eed","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/24b916c1ff78f38b51f4bb1dc66ed58c?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dmbacchi%26avatarId%3D16201%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/24b916c1ff78f38b51f4bb1dc66ed58c?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dmbacchi%26avatarId%3D16201%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/24b916c1ff78f38b51f4bb1dc66ed58c?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dmbacchi%26avatarId%3D16201%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/24b916c1ff78f38b51f4bb1dc66ed58c?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dmbacchi%26avatarId%3D16201%26noRedirect%3Dtrue"},"displayName":"Matt Bacchi","active":true,"timeZone":"US/Central"},"updateAuthor":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=mbacchi","name":"mbacchi","key":"mbacchi","accountId":"557058:d650aabc-f00c-4262-93a9-7799945b8eed","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/24b916c1ff78f38b51f4bb1dc66ed58c?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dmbacchi%26avatarId%3D16201%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/24b916c1ff78f38b51f4bb1dc66ed58c?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dmbacchi%26avatarId%3D16201%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/24b916c1ff78f38b51f4bb1dc66ed58c?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dmbacchi%26avatarId%3D16201%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/24b916c1ff78f38b51f4bb1dc66ed58c?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dmbacchi%26avatarId%3D16201%26noRedirect%3Dtrue"},"displayName":"Matt Bacchi","active":true,"timeZone":"US/Central"},"comment":"Fix seems to work during test:\r\n\r\nprivate IP address was set to:\r\n\r\n[root@c-08 ~]# euca-describe-instances i-e8a5c3a4\r\nRESERVATION     r-55915dda      858076495270    RDP, ssh, ICMP\r\nINSTANCE        i-e8a5c3a4      emi-1060b6df    10.111.75.44    10.111.75.55    stopping        one-key 0              m2.2xlarge       2015-04-16T21:55:24.282Z        one                     windows monitoring-disabled     10.111.75.44   10.111.75.55                     ebs                                     hvm                     sg-36450c5e,sg-8236a332,sg-8dc63986                             x86_64\r\n\r\nStopped and then restarted, IP address is now:\r\n\r\n[root@c-08 ~]# euca-describe-instances i-e8a5c3a4\r\nRESERVATION     r-55915dda      858076495270    RDP, ssh, ICMP\r\nINSTANCE        i-e8a5c3a4      emi-1060b6df    10.111.75.41    10.111.75.52    pending one-key 0               m2.2xlarge      2015-04-16T21:55:24.282Z        one                     windows monitoring-disabled     10.111.75.41    10.111.75.52                    ebs                                     hvm                     sg-36450c5e,sg-8236a332,sg-8dc63986                             x86_64\r\n\r\n/var/log/messages on the NC shows:\r\n\r\nApr 16 16:43:08 a-27 dhcpd: DHCPREQUEST for 10.111.75.55 from d0:0d:e8:a5:c3:a4 via br0: unknown lease 10.111.75.55.\r\nApr 16 16:43:08 a-27 dhcpd: DHCPDISCOVER from d0:0d:e8:a5:c3:a4 via br0: network euca: no free leases\r\nApr 16 16:43:08 a-27 dhcpd: DHCPREQUEST for 10.111.75.52 (10.111.1.46) from d0:0d:e8:a5:c3:a4 via br0: unknown lease 10.111.75.52.\r\n","created":"2015-04-16T18:52:17.224-0500","updated":"2015-04-16T18:52:17.224-0500","started":"2015-04-16T16:49:00.000-0500","timeSpent":"2h","timeSpentSeconds":7200,"id":"14001","issueId":"33993"}]}}}