{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"61603","self":"https://eucalyptus.atlassian.net/rest/api/2/issue/61603","key":"EUCA-13447","fields":{"issuetype":{"self":"https://eucalyptus.atlassian.net/rest/api/2/issuetype/4","id":"4","description":"An improvement or enhancement to an existing feature or task.","iconUrl":"https://eucalyptus.atlassian.net/secure/viewavatar?size=xsmall&avatarId=14810&avatarType=issuetype","name":"Improvement","subtask":false,"avatarId":14810},"timespent":null,"customfield_13100":null,"project":{"self":"https://eucalyptus.atlassian.net/rest/api/2/project/10000","id":"10000","key":"EUCA","name":"Eucalyptus","avatarUrls":{"48x48":"https://eucalyptus.atlassian.net/secure/projectavatar?pid=10000&avatarId=10011","24x24":"https://eucalyptus.atlassian.net/secure/projectavatar?size=small&pid=10000&avatarId=10011","16x16":"https://eucalyptus.atlassian.net/secure/projectavatar?size=xsmall&pid=10000&avatarId=10011","32x32":"https://eucalyptus.atlassian.net/secure/projectavatar?size=medium&pid=10000&avatarId=10011"}},"customfield_11000":null,"customfield_11001":null,"fixVersions":[{"self":"https://eucalyptus.atlassian.net/rest/api/2/version/19700","id":"19700","description":"Eucalyptus 4.4.3","name":"4.4.3","archived":false,"released":false}],"aggregatetimespent":null,"customfield_10310":null,"resolution":null,"customfield_10311":null,"customfield_11401":null,"customfield_11400":null,"customfield_10104":[],"customfield_10105":null,"customfield_10303":null,"customfield_10700":null,"customfield_10304":null,"customfield_10701":null,"customfield_10702":null,"customfield_10306":null,"customfield_10703":null,"customfield_10704":null,"customfield_10308":null,"resolutiondate":null,"customfield_10309":null,"customfield_10705":null,"workratio":-1,"watches":{"self":"https://eucalyptus.atlassian.net/rest/api/2/issue/EUCA-13447/watchers","watchCount":6,"isWatching":false},"lastViewed":null,"created":"2017-08-17T18:16:32.375-0500","customfield_12000":null,"priority":{"self":"https://eucalyptus.atlassian.net/rest/api/2/priority/2","iconUrl":"https://eucalyptus.atlassian.net/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"customfield_12400":null,"customfield_12201":null,"customfield_12600":"{repository={count=1, dataType=repository}, json={\"cachedValue\":{\"errors\":[],\"summary\":{\"repository\":{\"overall\":{\"count\":1,\"lastUpdated\":\"2017-08-22T18:19:56.000-0500\",\"dataType\":\"repository\"},\"byInstanceType\":{\"github\":{\"count\":1,\"name\":\"GitHub\"}}}}},\"isStale\":true}}","customfield_10102":null,"labels":[],"customfield_11700":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[{"self":"https://eucalyptus.atlassian.net/rest/api/2/version/19100","id":"19100","description":"Eucalyptus 4.4.2","name":"4.4.2","archived":false,"released":true,"releaseDate":"2017-08-30"}],"customfield_11901":null,"issuelinks":[{"id":"53700","self":"https://eucalyptus.atlassian.net/rest/api/2/issueLink/53700","type":{"id":"10103","name":"Relates","inward":"relates to","outward":"relates to","self":"https://eucalyptus.atlassian.net/rest/api/2/issueLinkType/10103"},"outwardIssue":{"id":"53520","key":"EUCA-13138","self":"https://eucalyptus.atlassian.net/rest/api/2/issue/53520","fields":{"summary":"SELinux prevents virtlogd from writing console.log","status":{"self":"https://eucalyptus.atlassian.net/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://eucalyptus.atlassian.net/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://eucalyptus.atlassian.net/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://eucalyptus.atlassian.net/rest/api/2/priority/2","iconUrl":"https://eucalyptus.atlassian.net/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"issuetype":{"self":"https://eucalyptus.atlassian.net/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://eucalyptus.atlassian.net/secure/viewavatar?size=xsmall&avatarId=14803&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":14803}}}}],"assignee":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=mbacchi","name":"mbacchi","key":"mbacchi","accountId":"557058:d650aabc-f00c-4262-93a9-7799945b8eed","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/24b916c1ff78f38b51f4bb1dc66ed58c?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dmbacchi%26avatarId%3D16201%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/24b916c1ff78f38b51f4bb1dc66ed58c?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dmbacchi%26avatarId%3D16201%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/24b916c1ff78f38b51f4bb1dc66ed58c?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dmbacchi%26avatarId%3D16201%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/24b916c1ff78f38b51f4bb1dc66ed58c?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dmbacchi%26avatarId%3D16201%26noRedirect%3Dtrue"},"displayName":"Matt Bacchi","active":true,"timeZone":"US/Central"},"updated":"2017-10-20T15:01:14.801-0500","status":{"self":"https://eucalyptus.atlassian.net/rest/api/2/status/10001","description":"This issue has been validated/reproduced, but has not been prioritized yet.","iconUrl":"https://eucalyptus.atlassian.net/images/icons/statuses/generic.png","name":"Confirmed","id":"10001","statusCategory":{"self":"https://eucalyptus.atlassian.net/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[],"timeoriginalestimate":null,"customfield_13000":null,"description":"!http://sadcatdiary.com/wp-content/uploads/2015/07/sadcatsmall.jpg!\r\n\r\nInstances are failing to launch on RHEL hosts. The NC log show libvirt cannot delete console.log file, permission denied error.\r\n\r\n{code}\r\n[root@d-29 ~]# less /var/log/eucalyptus/nc.log | grep i-e9180ae3\r\n2017-08-17 16:02:36  INFO | [i-e9180ae3] running instance groupId=sg-7690306a cores=1 disk=5 memory=256 vlan=-1 net=-1 priMAC=d0:0d:e9:18:0a:e3 privIp=10.111.75.118 plat=linux kernel=(null) ramdisk=(null)\r\n2017-08-17 16:02:36  INFO | [i-e9180ae3] copying/cloning blob emi-8f66d4a3-3813d3e3 to blob AIDAALP65XN5NFPLQY2ZB/i-e9180ae3/emi-8f66d4a3-3813d3e3\r\n2017-08-17 16:02:36  INFO | [i-e9180ae3] creating partition of size 125829120 bytes and type ext3 in prt-00120ext3-2d24bf0a\r\n2017-08-17 16:02:37  INFO | [i-e9180ae3] assigning address: [10.111.75.103]\r\n2017-08-17 16:02:48 ERROR | libvirt: Unable to delete file /var/lib/eucalyptus/instances/work/AIDAALP65XN5NFPLQY2ZB/i-e9180ae3/console.log: Permission denied (code=38)\r\n2017-08-17 16:02:48 ERROR | [i-e9180ae3] hypervisor failed to create the instance\r\n2017-08-17 16:02:49  INFO | [i-e9180ae3] attempt 2 of 5 to create the instance\r\n2017-08-17 16:02:49 ERROR | libvirt: Unable to delete file /var/lib/eucalyptus/instances/work/AIDAALP65XN5NFPLQY2ZB/i-e9180ae3/console.log: Permission denied (code=38)\r\n2017-08-17 16:02:49 ERROR | [i-e9180ae3] hypervisor failed to create the instance\r\n2017-08-17 16:02:50  INFO | [i-e9180ae3] attempt 3 of 5 to create the instance\r\n2017-08-17 16:02:50 ERROR | libvirt: Unable to delete file /var/lib/eucalyptus/instances/work/AIDAALP65XN5NFPLQY2ZB/i-e9180ae3/console.log: Permission denied (code=38)\r\n2017-08-17 16:02:50 ERROR | [i-e9180ae3] hypervisor failed to create the instance\r\n2017-08-17 16:02:51  INFO | [i-e9180ae3] attempt 4 of 5 to create the instance\r\n2017-08-17 16:02:51 ERROR | libvirt: Unable to delete file /var/lib/eucalyptus/instances/work/AIDAALP65XN5NFPLQY2ZB/i-e9180ae3/console.log: Permission denied (code=38)\r\n2017-08-17 16:02:51 ERROR | [i-e9180ae3] hypervisor failed to create the instance\r\n2017-08-17 16:02:52  INFO | [i-e9180ae3] attempt 5 of 5 to create the instance\r\n2017-08-17 16:02:52 ERROR | libvirt: Unable to delete file /var/lib/eucalyptus/instances/work/AIDAALP65XN5NFPLQY2ZB/i-e9180ae3/console.log: Permission denied (code=38)\r\n2017-08-17 16:02:52 ERROR | [i-e9180ae3] hypervisor failed to create the instance\r\n2017-08-17 16:02:58 ERROR | libvirt: Domain not found: no domain with matching name 'i-e9180ae3' (code=42)\r\n2017-08-17 16:02:58  INFO | [i-e9180ae3] cleaning up state for instance\r\n2017-08-17 16:06:03  INFO | [i-e9180ae3] forgetting about instance\r\n{code}\r\n\r\nI was able to get the perms of an instance work dir before it was cleaned and found console.log to have perms root/root\r\n{code}\r\n[root@d-29 ~]# ls -alF /var/lib/eucalyptus/instances/work/AIDAAYKAAOS77J2YBZYHS/i-b2d50e57/\r\ntotal 266560\r\ndrwx--x--x. 2 eucalyptus eucalyptus       4096 Aug 17 16:12 ./\r\ndrwx--x--x. 3 eucalyptus eucalyptus         24 Aug 17 16:12 ../\r\n-rw-------. 1 root       root                0 Aug 17 16:12 console.log\r\n-rw-r-----. 1 eucalyptus eucalyptus 2147483648 Aug 17 16:12 emi-034223ed-14e248fa.blocks\r\n-rw-r-----. 1 eucalyptus eucalyptus         77 Aug 17 16:12 emi-034223ed-14e248fa.deps\r\n-rw-r-----. 1 eucalyptus eucalyptus        196 Aug 17 16:12 emi-034223ed-14e248fa.dm\r\n-rw-r-----. 1 eucalyptus eucalyptus         16 Aug 17 16:12 emi-034223ed-14e248fa.lock\r\n-rw-r-----. 1 eucalyptus eucalyptus         10 Aug 17 16:12 emi-034223ed-14e248fa.loopback\r\n-rw-r-----. 1 eucalyptus eucalyptus         21 Aug 17 16:12 emi-034223ed-14e248fa.sig\r\n-rwx------. 1 eucalyptus eucalyptus    1474560 Aug 17 16:12 floppy*\r\n-rw-r--r--. 1 eucalyptus eucalyptus       1691 Aug 17 16:12 instance-libvirt.xml\r\n-rw-rw----. 1 eucalyptus eucalyptus       7332 Aug 17 16:12 instance.xml\r\nlrwxrwxrwx. 1 eucalyptus eucalyptus         71 Aug 17 16:12 link-to-vda -> /dev/mapper/euca-AIDAAYKAAOS77J2YBZYHS-i-b2d50e57-emi-034223ed-14e248fa\r\nlrwxrwxrwx. 1 eucalyptus eucalyptus         72 Aug 17 16:12 link-to-vdb -> /dev/mapper/euca-AIDAAYKAAOS77J2YBZYHS-i-b2d50e57-prt-08192ext3-8c587647\r\n-rw-r-----. 1 eucalyptus eucalyptus 8589934592 Aug 17 16:12 prt-08192ext3-8c587647.blocks\r\n-rw-r-----. 1 eucalyptus eucalyptus        199 Aug 17 16:12 prt-08192ext3-8c587647.dm\r\n-rw-r-----. 1 eucalyptus eucalyptus          0 Aug 17 16:12 prt-08192ext3-8c587647.lock\r\n-rw-r-----. 1 eucalyptus eucalyptus         10 Aug 17 16:12 prt-08192ext3-8c587647.loopback\r\n-rw-r-----. 1 eucalyptus eucalyptus         37 Aug 17 16:12 prt-08192ext3-8c587647.sig\r\n{code}\r\n\r\nI have a RHEL deployment around, feel free to poke it. Here is a link to the env file: http://jenkins.qa1.eucalyptus-systems.com/job/Quick%20Launch%20Maint_4.4/865/artifact/environment.yml/*view*/\r\n","customfield_13200":null,"customfield_11300":null,"customfield_11500":null,"timetracking":{},"customfield_10401":null,"customfield_10005":null,"customfield_10600":null,"customfield_12900":null,"aggregatetimeestimate":null,"attachment":[],"summary":"SELinux denies libvirt necessary permissions to run instances on RHEL 7.4","creator":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=tony","name":"tony","key":"tony","accountId":"557058:353956db-b78c-4f3b-9096-f8f58e6709c8","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/14ec1b18e630cc0743492fc327a12df7?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dtony%26avatarId%3D16600%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/14ec1b18e630cc0743492fc327a12df7?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dtony%26avatarId%3D16600%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/14ec1b18e630cc0743492fc327a12df7?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dtony%26avatarId%3D16600%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/14ec1b18e630cc0743492fc327a12df7?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dtony%26avatarId%3D16600%26noRedirect%3Dtrue"},"displayName":"Tony Beckham","active":true,"timeZone":"America/Tijuana"},"subtasks":[],"reporter":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=tony","name":"tony","key":"tony","accountId":"557058:353956db-b78c-4f3b-9096-f8f58e6709c8","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/14ec1b18e630cc0743492fc327a12df7?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dtony%26avatarId%3D16600%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/14ec1b18e630cc0743492fc327a12df7?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dtony%26avatarId%3D16600%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/14ec1b18e630cc0743492fc327a12df7?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dtony%26avatarId%3D16600%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/14ec1b18e630cc0743492fc327a12df7?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dtony%26avatarId%3D16600%26noRedirect%3Dtrue"},"displayName":"Tony Beckham","active":true,"timeZone":"America/Tijuana"},"aggregateprogress":{"progress":0,"total":0},"customfield_12100":"0|i04533:","customfield_10000":null,"customfield_10001":"2017-08-18T15:49:16.676-0500","customfield_10002":null,"customfield_10200":null,"customfield_10003":null,"customfield_10400":null,"customfield_12500":null,"customfield_10116":null,"customfield_11600":["ccassler(ccassler)","mbacchi(mbacchi)","sjones(sjones)","sgraham(sgraham)","tony(tony)"],"environment":null,"customfield_10117":null,"customfield_11800":null,"customfield_11802":null,"duedate":null,"customfield_11805":null,"customfield_11806":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://eucalyptus.atlassian.net/rest/api/2/issue/61603/comment/126602","id":"126602","author":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=tony","name":"tony","key":"tony","accountId":"557058:353956db-b78c-4f3b-9096-f8f58e6709c8","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/14ec1b18e630cc0743492fc327a12df7?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dtony%26avatarId%3D16600%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/14ec1b18e630cc0743492fc327a12df7?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dtony%26avatarId%3D16600%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/14ec1b18e630cc0743492fc327a12df7?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dtony%26avatarId%3D16600%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/14ec1b18e630cc0743492fc327a12df7?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dtony%26avatarId%3D16600%26noRedirect%3Dtrue"},"displayName":"Tony Beckham","active":true,"timeZone":"America/Tijuana"},"body":"Workaround: set selinux to permissive on NCs\r\n\r\nFrom the audit log:\r\n{code}\r\ntype=AVC msg=audit(1503012150.525:29009): avc:  denied  { dac_override } for  pid=16938 comm=\"virtlogd\" capability=1  scontext=system_u:system_r:virtlogd_t:s0-s0:c0.c1023 tcontext=system_u:system_r:virtlogd_t:s0-s0:c0.c1023 tclass=capability\r\n\r\n\tWas caused by:\r\n\t\tMissing type enforcement (TE) allow rule.\r\n\r\n\t\tYou can use audit2allow to generate a loadable module to allow this access.\r\n{code}\r\n\r\nAnd the suggested policy:\r\n{code}\r\n[root@d-29 ~]# auditfix\r\n\r\n\r\n#============= virtlogd_t ==============\r\nallow virtlogd_t self:capability dac_override;\r\n{code}\r\n\r\nAs to why this is just showing up perhaps it is due to the fact RHEL is now bumped to version 7.4","updateAuthor":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=tony","name":"tony","key":"tony","accountId":"557058:353956db-b78c-4f3b-9096-f8f58e6709c8","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/14ec1b18e630cc0743492fc327a12df7?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dtony%26avatarId%3D16600%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/14ec1b18e630cc0743492fc327a12df7?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dtony%26avatarId%3D16600%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/14ec1b18e630cc0743492fc327a12df7?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dtony%26avatarId%3D16600%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/14ec1b18e630cc0743492fc327a12df7?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dtony%26avatarId%3D16600%26noRedirect%3Dtrue"},"displayName":"Tony Beckham","active":true,"timeZone":"America/Tijuana"},"created":"2017-08-17T18:31:32.611-0500","updated":"2017-08-17T18:32:39.185-0500"},{"self":"https://eucalyptus.atlassian.net/rest/api/2/issue/61603/comment/126703","id":"126703","author":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=sgraham","name":"sgraham","key":"sgraham","accountId":"557058:dab30ab9-44e7-4b70-a841-8b188c40edfc","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/a40e2a7b21096d27f2427d53d5f45fbf?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dsgraham%26avatarId%3D18000%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/a40e2a7b21096d27f2427d53d5f45fbf?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dsgraham%26avatarId%3D18000%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/a40e2a7b21096d27f2427d53d5f45fbf?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dsgraham%26avatarId%3D18000%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/a40e2a7b21096d27f2427d53d5f45fbf?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dsgraham%26avatarId%3D18000%26noRedirect%3Dtrue"},"displayName":"Steven Graham","active":true,"timeZone":"US/Central"},"body":"Looks like the change works, I'm able to launch an instance:\r\n\r\n{code}\r\n[root@c-10 eucalyptus-selinux]# git diff\r\ndiff --git a/eucalyptus.te b/eucalyptus.te\r\nindex 4a8413f..cf55077 100644\r\n--- a/eucalyptus.te\r\n+++ b/eucalyptus.te\r\n@@ -547,6 +547,8 @@ optional_policy(`\r\n     type virt_log_t;\r\n   ')\r\n \r\n+  # \r\n+  allow virtlogd_t self:capability dac_override; \r\n   # libvirtd creates console.log, then virtlogd opens it\r\n   filetrans_pattern(virtd_t, virt_image_t, virt_log_t, file, \"console.log\")\r\n{code}\r\n\r\nI need to look into the rules a little more to see if we can limit this just to the directory or if giving it blanket dac_override is the right thing to do.","updateAuthor":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=sgraham","name":"sgraham","key":"sgraham","accountId":"557058:dab30ab9-44e7-4b70-a841-8b188c40edfc","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/a40e2a7b21096d27f2427d53d5f45fbf?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dsgraham%26avatarId%3D18000%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/a40e2a7b21096d27f2427d53d5f45fbf?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dsgraham%26avatarId%3D18000%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/a40e2a7b21096d27f2427d53d5f45fbf?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dsgraham%26avatarId%3D18000%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/a40e2a7b21096d27f2427d53d5f45fbf?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dsgraham%26avatarId%3D18000%26noRedirect%3Dtrue"},"displayName":"Steven Graham","active":true,"timeZone":"US/Central"},"created":"2017-08-18T15:49:16.676-0500","updated":"2017-08-18T15:49:16.676-0500"},{"self":"https://eucalyptus.atlassian.net/rest/api/2/issue/61603/comment/126707","id":"126707","author":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=tony","name":"tony","key":"tony","accountId":"557058:353956db-b78c-4f3b-9096-f8f58e6709c8","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/14ec1b18e630cc0743492fc327a12df7?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dtony%26avatarId%3D16600%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/14ec1b18e630cc0743492fc327a12df7?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dtony%26avatarId%3D16600%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/14ec1b18e630cc0743492fc327a12df7?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dtony%26avatarId%3D16600%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/14ec1b18e630cc0743492fc327a12df7?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dtony%26avatarId%3D16600%26noRedirect%3Dtrue"},"displayName":"Tony Beckham","active":true,"timeZone":"America/Tijuana"},"body":"[~mbacchi] or [~gholms], do you have any input on limiting to just the directory or allowing blanket dac_override for the policy change?","updateAuthor":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=tony","name":"tony","key":"tony","accountId":"557058:353956db-b78c-4f3b-9096-f8f58e6709c8","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/14ec1b18e630cc0743492fc327a12df7?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dtony%26avatarId%3D16600%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/14ec1b18e630cc0743492fc327a12df7?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dtony%26avatarId%3D16600%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/14ec1b18e630cc0743492fc327a12df7?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dtony%26avatarId%3D16600%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/14ec1b18e630cc0743492fc327a12df7?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dtony%26avatarId%3D16600%26noRedirect%3Dtrue"},"displayName":"Tony Beckham","active":true,"timeZone":"America/Tijuana"},"created":"2017-08-21T14:30:33.036-0500","updated":"2017-08-21T14:30:33.036-0500"},{"self":"https://eucalyptus.atlassian.net/rest/api/2/issue/61603/comment/126709","id":"126709","author":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=sgraham","name":"sgraham","key":"sgraham","accountId":"557058:dab30ab9-44e7-4b70-a841-8b188c40edfc","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/a40e2a7b21096d27f2427d53d5f45fbf?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dsgraham%26avatarId%3D18000%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/a40e2a7b21096d27f2427d53d5f45fbf?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dsgraham%26avatarId%3D18000%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/a40e2a7b21096d27f2427d53d5f45fbf?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dsgraham%26avatarId%3D18000%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/a40e2a7b21096d27f2427d53d5f45fbf?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dsgraham%26avatarId%3D18000%26noRedirect%3Dtrue"},"displayName":"Steven Graham","active":true,"timeZone":"US/Central"},"body":"I think the dac_override is not the right way for this, I'm testing out the following, which is similar to what we did for the node controller. I think this might work for virtlogd (which goes console logging for qemu/kvm):\r\n{code}\r\ndiff --git a/eucalyptus.te b/eucalyptus.te\r\nindex 4a8413f..ac1d881 100644\r\n--- a/eucalyptus.te\r\n+++ b/eucalyptus.te\r\n@@ -547,6 +547,8 @@ optional_policy(`\r\n     type virt_log_t;\r\n   ')\r\n \r\n+  # \r\n+ \r\n   # libvirtd creates console.log, then virtlogd opens it\r\n   filetrans_pattern(virtd_t, virt_image_t, virt_log_t, file, \"console.log\")\r\n \r\n@@ -554,6 +556,10 @@ optional_policy(`\r\n   delete_files_pattern(eucalyptus_node_t, virt_image_t, virt_log_t)\r\n   rename_files_pattern(eucalyptus_node_t, virt_image_t, virt_log_t)\r\n \r\n+  # allow virtlogd to unlink rename console.log \r\n+  delete_files_pattern(virtlogd_t, virt_image_t, virt_log_t)\r\n+  rename_files_pattern(virtlogd_t, virt_image_t, virt_log_t)\r\n{code}\r\n\r\nSome other references: \r\nhttps://bugzilla.redhat.com/show_bug.cgi?id=636156\r\nhttps://bugzilla.redhat.com/show_bug.cgi?id=1004673\r\nhttps://access.redhat.com/solutions/2777871\r\n","updateAuthor":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=sgraham","name":"sgraham","key":"sgraham","accountId":"557058:dab30ab9-44e7-4b70-a841-8b188c40edfc","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/a40e2a7b21096d27f2427d53d5f45fbf?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dsgraham%26avatarId%3D18000%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/a40e2a7b21096d27f2427d53d5f45fbf?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dsgraham%26avatarId%3D18000%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/a40e2a7b21096d27f2427d53d5f45fbf?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dsgraham%26avatarId%3D18000%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/a40e2a7b21096d27f2427d53d5f45fbf?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dsgraham%26avatarId%3D18000%26noRedirect%3Dtrue"},"displayName":"Steven Graham","active":true,"timeZone":"US/Central"},"created":"2017-08-21T14:43:30.832-0500","updated":"2017-08-21T14:43:30.832-0500"},{"self":"https://eucalyptus.atlassian.net/rest/api/2/issue/61603/comment/126800","id":"126800","author":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=mbacchi","name":"mbacchi","key":"mbacchi","accountId":"557058:d650aabc-f00c-4262-93a9-7799945b8eed","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/24b916c1ff78f38b51f4bb1dc66ed58c?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dmbacchi%26avatarId%3D16201%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/24b916c1ff78f38b51f4bb1dc66ed58c?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dmbacchi%26avatarId%3D16201%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/24b916c1ff78f38b51f4bb1dc66ed58c?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dmbacchi%26avatarId%3D16201%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/24b916c1ff78f38b51f4bb1dc66ed58c?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dmbacchi%26avatarId%3D16201%26noRedirect%3Dtrue"},"displayName":"Matt Bacchi","active":true,"timeZone":"US/Central"},"body":"[~sgraham] The best way to write selinux policy is providing the least generic and lowest authority to the target.  The last comment you made is more in line with this goal.  I think if it works to silence the AVC messages then you've got the right solution.","updateAuthor":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=mbacchi","name":"mbacchi","key":"mbacchi","accountId":"557058:d650aabc-f00c-4262-93a9-7799945b8eed","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/24b916c1ff78f38b51f4bb1dc66ed58c?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dmbacchi%26avatarId%3D16201%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/24b916c1ff78f38b51f4bb1dc66ed58c?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dmbacchi%26avatarId%3D16201%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/24b916c1ff78f38b51f4bb1dc66ed58c?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dmbacchi%26avatarId%3D16201%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/24b916c1ff78f38b51f4bb1dc66ed58c?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dmbacchi%26avatarId%3D16201%26noRedirect%3Dtrue"},"displayName":"Matt Bacchi","active":true,"timeZone":"US/Central"},"created":"2017-08-22T07:15:31.312-0500","updated":"2017-08-22T07:15:31.312-0500"},{"self":"https://eucalyptus.atlassian.net/rest/api/2/issue/61603/comment/126801","id":"126801","author":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=sgraham","name":"sgraham","key":"sgraham","accountId":"557058:dab30ab9-44e7-4b70-a841-8b188c40edfc","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/a40e2a7b21096d27f2427d53d5f45fbf?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dsgraham%26avatarId%3D18000%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/a40e2a7b21096d27f2427d53d5f45fbf?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dsgraham%26avatarId%3D18000%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/a40e2a7b21096d27f2427d53d5f45fbf?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dsgraham%26avatarId%3D18000%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/a40e2a7b21096d27f2427d53d5f45fbf?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dsgraham%26avatarId%3D18000%26noRedirect%3Dtrue"},"displayName":"Steven Graham","active":true,"timeZone":"US/Central"},"body":"\r\nMore detailed audit info after performing:\r\n{code:title=auditctl}\r\n# auditctl -a always,exit -S unlink\r\n{code}\r\n\r\n{code:title=ref:/var/log/audit/audit.log}\r\ntype=AVC msg=audit(1503419633.869:39198): avc:  denied  { dac_override } for  pid=24935 comm=\"virtlogd\" capability=1  scontext=system_u:system_r:virtlogd_t:s0-s0:c0.c1023 tcontext=system_u:system_r:virtlogd_t:s0-s0:c0.c1023 tclass=capability\r\n\r\ntype=SYSCALL msg=audit(1503419633.869:39198): arch=c000003e syscall=87 success=no exit=-13 a0=7f2dd4003610 a1=7f2dd4000d50 a2=0 a3=33333164302d692f items=2 ppid=1 pid=24935 auid=4294967295 uid=0 gid=0 euid=0 suid=0 fsuid=0 egid=0 sgid=0 fsgid=0 tty=(none) ses=4294967295 comm=\"virtlogd\" exe=\"/usr/sbin/virtlogd\" subj=system_u:system_r:virtlogd_t:s0-s0:c0.c1023 key=(null)\r\ntype=CWD msg=audit(1503419633.869:39198):  cwd=\"/\"\r\ntype=PATH msg=audit(1503419633.869:39198): item=0 name=\"/var/lib/eucalyptus/instances/work/AIDAAQH6DTC54DUCNXUUR/i-0d133caa/\" inode=67188840 dev=fd:00 mode=040711 ouid=995 ogid=991 rdev=00:00 obj=system_u:object_r:virt_image_t:s0 objtype=PARENT\r\n\r\ntype=PATH msg=audit(1503419633.869:39198): item=1 name=\"/var/lib/eucalyptus/instances/work/AIDAAQH6DTC54DUCNXUUR/i-0d133caa/console.log\" inode=67188857 dev=fd:00 mode=0100600 ouid=0 ogid=0 rdev=00:00 obj=system_u:object_r:virt_log_t:s0 objtype=DELETE\r\n\r\ntype=PROCTITLE msg=audit(1503419633.869:39198): proctitle=\"/usr/sbin/virtlogd\"\r\n{code}","updateAuthor":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=sgraham","name":"sgraham","key":"sgraham","accountId":"557058:dab30ab9-44e7-4b70-a841-8b188c40edfc","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/a40e2a7b21096d27f2427d53d5f45fbf?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dsgraham%26avatarId%3D18000%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/a40e2a7b21096d27f2427d53d5f45fbf?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dsgraham%26avatarId%3D18000%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/a40e2a7b21096d27f2427d53d5f45fbf?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dsgraham%26avatarId%3D18000%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/a40e2a7b21096d27f2427d53d5f45fbf?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dsgraham%26avatarId%3D18000%26noRedirect%3Dtrue"},"displayName":"Steven Graham","active":true,"timeZone":"US/Central"},"created":"2017-08-22T11:41:47.132-0500","updated":"2017-08-22T11:41:47.132-0500"},{"self":"https://eucalyptus.atlassian.net/rest/api/2/issue/61603/comment/126802","id":"126802","author":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=sgraham","name":"sgraham","key":"sgraham","accountId":"557058:dab30ab9-44e7-4b70-a841-8b188c40edfc","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/a40e2a7b21096d27f2427d53d5f45fbf?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dsgraham%26avatarId%3D18000%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/a40e2a7b21096d27f2427d53d5f45fbf?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dsgraham%26avatarId%3D18000%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/a40e2a7b21096d27f2427d53d5f45fbf?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dsgraham%26avatarId%3D18000%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/a40e2a7b21096d27f2427d53d5f45fbf?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dsgraham%26avatarId%3D18000%26noRedirect%3Dtrue"},"displayName":"Steven Graham","active":true,"timeZone":"US/Central"},"body":"The above is with the two rules to allow virtlogd_t access, not sure why its failing:\r\n{code}\r\n  delete_files_pattern(virtlogd_t, virt_image_t, virt_log_t)\r\n  rename_files_pattern(virtlogd_t, virt_image_t, virt_log_t)\r\n{code}","updateAuthor":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=sgraham","name":"sgraham","key":"sgraham","accountId":"557058:dab30ab9-44e7-4b70-a841-8b188c40edfc","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/a40e2a7b21096d27f2427d53d5f45fbf?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dsgraham%26avatarId%3D18000%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/a40e2a7b21096d27f2427d53d5f45fbf?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dsgraham%26avatarId%3D18000%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/a40e2a7b21096d27f2427d53d5f45fbf?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dsgraham%26avatarId%3D18000%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/a40e2a7b21096d27f2427d53d5f45fbf?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dsgraham%26avatarId%3D18000%26noRedirect%3Dtrue"},"displayName":"Steven Graham","active":true,"timeZone":"US/Central"},"created":"2017-08-22T12:01:14.624-0500","updated":"2017-08-22T12:01:14.624-0500"},{"self":"https://eucalyptus.atlassian.net/rest/api/2/issue/61603/comment/126804","id":"126804","author":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=mbacchi","name":"mbacchi","key":"mbacchi","accountId":"557058:d650aabc-f00c-4262-93a9-7799945b8eed","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/24b916c1ff78f38b51f4bb1dc66ed58c?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dmbacchi%26avatarId%3D16201%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/24b916c1ff78f38b51f4bb1dc66ed58c?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dmbacchi%26avatarId%3D16201%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/24b916c1ff78f38b51f4bb1dc66ed58c?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dmbacchi%26avatarId%3D16201%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/24b916c1ff78f38b51f4bb1dc66ed58c?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dmbacchi%26avatarId%3D16201%26noRedirect%3Dtrue"},"displayName":"Matt Bacchi","active":true,"timeZone":"US/Central"},"body":"I have looked at this a little just now on [~sgraham]'s system.  It appears to me that the filetrans_pattern might need to be enhanced to include processes labeled virtlogd_t in addition to virtd_t.\r\n\r\nHere's the file permissions including selinux labels:\r\n\r\n\r\n{code:java}\r\n[root@c-20 eucalyptus-selinux]# ls -aZltr /var/lib/eucalyptus/instances/work/*\r\n/var/lib/eucalyptus/instances/work/AIDAAQH6DTC54DUCNXUUR:\r\ntotal 0\r\ndrwxrwx--x. 4 system_u:object_r:virt_image_t:s0 eucalyptus eucalyptus 82 Aug 22 08:57 ..\r\ndrwx--x--x. 2 system_u:object_r:virt_image_t:s0 eucalyptus eucalyptus  6 Aug 22 10:36 .\r\n\r\n/var/lib/eucalyptus/instances/work/AIDAAI2ODEPBJDK7YS4UL:\r\ntotal 4\r\ndrwxrwx--x. 4 system_u:object_r:virt_image_t:s0 eucalyptus eucalyptus   82 Aug 22 08:57 ..\r\ndrwx--x--x. 3 system_u:object_r:virt_image_t:s0 eucalyptus eucalyptus   24 Aug 22 11:11 .\r\ndrwx--x--x. 2 system_u:object_r:virt_image_t:s0 eucalyptus eucalyptus 4096 Aug 22 11:12 i-c4e34d85\r\n[root@c-20 eucalyptus-selinux]# ls -aZltr /var/lib/eucalyptus/instances/work/*/*\r\ntotal 266556\r\ndrwx--x--x. 3 system_u:object_r:virt_image_t:s0 eucalyptus eucalyptus         24 Aug 22 11:11 ..\r\n-rwx------. 1 system_u:object_r:virt_image_t:s0 eucalyptus eucalyptus    1474560 Aug 22 11:11 floppy\r\n-rw-r-----. 1 system_u:object_r:virt_image_t:s0 eucalyptus eucalyptus         21 Aug 22 11:11 emi-9d87a9e8-14e248fa.sig\r\n-rw-r-----. 1 system_u:object_r:virt_image_t:s0 eucalyptus eucalyptus 2147483648 Aug 22 11:11 emi-9d87a9e8-14e248fa.blocks\r\n-rw-r-----. 1 system_u:object_r:virt_image_t:s0 eucalyptus eucalyptus         10 Aug 22 11:11 emi-9d87a9e8-14e248fa.loopback\r\n-rw-r-----. 1 system_u:object_r:virt_image_t:s0 eucalyptus eucalyptus        196 Aug 22 11:12 emi-9d87a9e8-14e248fa.dm\r\n-rw-r-----. 1 system_u:object_r:virt_image_t:s0 eucalyptus eucalyptus         77 Aug 22 11:12 emi-9d87a9e8-14e248fa.deps\r\nlrwxrwxrwx. 1 system_u:object_r:virt_image_t:s0 eucalyptus eucalyptus         71 Aug 22 11:12 link-to-vda -> /dev/mapper/euca-AIDAAI2ODEPBJDK7YS4UL-i-c4e34d85-emi-9d87a9e8-14e248fa\r\n-rw-r-----. 1 system_u:object_r:virt_image_t:s0 eucalyptus eucalyptus          0 Aug 22 11:12 emi-9d87a9e8-14e248fa.lock\r\n-rw-r-----. 1 system_u:object_r:virt_image_t:s0 eucalyptus eucalyptus         37 Aug 22 11:12 prt-08192ext3-8c587647.sig\r\n-rw-r-----. 1 system_u:object_r:virt_image_t:s0 eucalyptus eucalyptus         10 Aug 22 11:12 prt-08192ext3-8c587647.loopback\r\n-rw-r-----. 1 system_u:object_r:virt_image_t:s0 eucalyptus eucalyptus        199 Aug 22 11:12 prt-08192ext3-8c587647.dm\r\n-rw-r-----. 1 system_u:object_r:virt_image_t:s0 eucalyptus eucalyptus 8589934592 Aug 22 11:12 prt-08192ext3-8c587647.blocks\r\nlrwxrwxrwx. 1 system_u:object_r:virt_image_t:s0 eucalyptus eucalyptus         72 Aug 22 11:12 link-to-vdb -> /dev/mapper/euca-AIDAAI2ODEPBJDK7YS4UL-i-c4e34d85-prt-08192ext3-8c587647\r\n-rw-r-----. 1 system_u:object_r:virt_image_t:s0 eucalyptus eucalyptus          0 Aug 22 11:12 prt-08192ext3-8c587647.lock\r\ndrwx--x--x. 2 system_u:object_r:virt_image_t:s0 eucalyptus eucalyptus       4096 Aug 22 11:12 .\r\n-rw-r--r--. 1 system_u:object_r:virt_image_t:s0 eucalyptus eucalyptus       1691 Aug 22 11:12 instance-libvirt.xml\r\n-rw-rw----. 1 system_u:object_r:virt_image_t:s0 eucalyptus eucalyptus       7371 Aug 22 11:12 instance.xml\r\n\r\n{code}\r\n\r\nHere's the AVC message:\r\n\r\n\r\n{code:java}\r\n----\r\ntime->Tue Aug 22 11:12:19 2017\r\ntype=PROCTITLE msg=audit(1503425539.624:62917): proctitle=\"/usr/sbin/virtlogd\"\r\ntype=PATH msg=audit(1503425539.624:62917): item=1 name=\"/var/lib/eucalyptus/instances/work/AIDAAI2ODEPBJDK7YS4UL/i-c4e34d85/console.log\" objtype=CREATE\r\ntype=PATH msg=audit(1503425539.624:62917): item=0 name=\"/var/lib/eucalyptus/instances/work/AIDAAI2ODEPBJDK7YS4UL/i-c4e34d85/\" inode=67325983 dev=fd:00 mode=040711 ouid=995 ogid=991 rdev=00:00 obj=system_u:object_r:virt_image_t:s0 objtype=PARENT\r\ntype=CWD msg=audit(1503425539.624:62917):  cwd=\"/\"\r\ntype=SYSCALL msg=audit(1503425539.624:62917): arch=c000003e syscall=2 success=no exit=-13 a0=7f2dd4003670 a1=80441 a2=180 a3=7f2dd40036d0 items=2 ppid=1 pid=24935 auid=4294967295 uid=0 gid=0 euid=0 suid=0 fsuid=0 egid=0 sgid=0 fsgid=0 tty=(none) ses=4294967295 comm=\"virtlogd\" exe=\"/usr/sbin/virtlogd\" subj=system_u:system_r:virtlogd_t:s0-s0:c0.c1023 key=(null)\r\ntype=AVC msg=audit(1503425539.624:62917): avc:  denied  { create } for  pid=24935 comm=\"virtlogd\" name=\"console.log\" scontext=system_u:system_r:virtlogd_t:s0-s0:c0.c1023 tcontext=system_u:object_r:virt_image_t:s0 tclass=file\r\n{code}\r\n\r\nThe filetrans_pattern says the label of any file named console.log that is created by a process labeled virtd_t in a directory labeled virt_image_t it is then labeled virt_log_t.  It looks like this:\r\n\r\n{code:java}\r\n  # libvirtd creates console.log, then virtlogd opens it\r\n  filetrans_pattern(virtd_t, virt_image_t, virt_log_t, file, \"console.log\")\r\n{code}\r\n\r\nIf I add the following update to the eucalyptus.te file:\r\n\r\n\r\n{code:java}\r\n[root@c-20 eucalyptus-selinux]# git diff\r\ndiff --git a/eucalyptus.te b/eucalyptus.te\r\nindex 5fe2a07..5e8ecdf 100644\r\n--- a/eucalyptus.te\r\n+++ b/eucalyptus.te\r\n@@ -550,6 +550,10 @@ optional_policy(`\r\n   # libvirtd creates console.log, then virtlogd opens it\r\n   filetrans_pattern(virtd_t, virt_image_t, virt_log_t, file, \"console.log\")\r\n \r\n+  # virtlogd now uses the virtlogd_t process owner, convert file to virt_image_t\r\n+  allow virtlogd_t self:capability { dac_override };\r\n+  filetrans_pattern(virtlogd_t, virt_image_t, virt_log_t, file, \"console.log\")\r\n+\r\n   # allow NC to unlink and rename console.log (EUCA-13138 related fix)\r\n   delete_files_pattern(eucalyptus_node_t, virt_image_t, virt_log_t)\r\n   rename_files_pattern(eucalyptus_node_t, virt_image_t, virt_log_t)\r\n\r\n{code}\r\n\r\n\r\nI get the output:\r\n\r\n\r\n{code:java}\r\n/var/lib/eucalyptus/instances/work/AIDAAQH6DTC54DUCNXUUR/i-a3af85d8:\r\ntotal 325476\r\ndrwx--x--x. 3 system_u:object_r:virt_image_t:s0 eucalyptus eucalyptus         24 Aug 22 11:34 ..\r\n-rw-r-----. 1 system_u:object_r:virt_image_t:s0 eucalyptus eucalyptus         21 Aug 22 11:34 emi-89923dbc-29607e33.sig\r\n-rw-r-----. 1 system_u:object_r:virt_image_t:s0 eucalyptus eucalyptus         10 Aug 22 11:34 emi-89923dbc-29607e33.loopback\r\n-rw-r-----. 1 system_u:object_r:virt_image_t:s0 eucalyptus eucalyptus        196 Aug 22 11:34 emi-89923dbc-29607e33.dm\r\nlrwxrwxrwx. 1 system_u:object_r:virt_image_t:s0 eucalyptus eucalyptus         71 Aug 22 11:34 link-to-vda -> /dev/mapper/euca-AIDAAQH6DTC54DUCNXUUR-i-a3af85d8-emi-89923dbc-29607e33\r\n-rw-r-----. 1 system_u:object_r:virt_image_t:s0 eucalyptus eucalyptus         77 Aug 22 11:34 emi-89923dbc-29607e33.deps\r\n-rw-r-----. 1 system_u:object_r:virt_image_t:s0 eucalyptus eucalyptus          0 Aug 22 11:34 emi-89923dbc-29607e33.lock\r\n-rw-r-----. 1 system_u:object_r:virt_image_t:s0 eucalyptus eucalyptus         37 Aug 22 11:34 prt-07988ext3-9992afdb.sig\r\n-rw-r-----. 1 system_u:object_r:virt_image_t:s0 eucalyptus eucalyptus         10 Aug 22 11:34 prt-07988ext3-9992afdb.loopback\r\n-rw-r-----. 1 system_u:object_r:virt_image_t:s0 eucalyptus eucalyptus        199 Aug 22 11:34 prt-07988ext3-9992afdb.dm\r\nlrwxrwxrwx. 1 system_u:object_r:virt_image_t:s0 eucalyptus eucalyptus         72 Aug 22 11:34 link-to-vdb -> /dev/mapper/euca-AIDAAQH6DTC54DUCNXUUR-i-a3af85d8-prt-07988ext3-9992afdb\r\n-rw-r-----. 1 system_u:object_r:virt_image_t:s0 eucalyptus eucalyptus          0 Aug 22 11:34 prt-07988ext3-9992afdb.lock\r\n-rw-r--r--. 1 system_u:object_r:virt_image_t:s0 eucalyptus eucalyptus       1487 Aug 22 11:34 instance-libvirt.xml\r\ndrwx--x--x. 2 system_u:object_r:virt_image_t:s0 eucalyptus eucalyptus       4096 Aug 22 11:34 .\r\n-rw-------. 1 system_u:object_r:svirt_image_t:s0:c266,c305 qemu       qemu            46117 Aug 22 11:35 console.log\r\n-rw-r-----. 1 system_u:object_r:virt_image_t:s0 eucalyptus eucalyptus 8376025088 Aug 22 11:35 prt-07988ext3-9992afdb.blocks\r\n-rw-r-----. 1 system_u:object_r:virt_image_t:s0 eucalyptus eucalyptus 2361393152 Aug 22 11:35 emi-89923dbc-29607e33.blocks\r\n-rw-rw----. 1 system_u:object_r:virt_image_t:s0 eucalyptus eucalyptus       6767 Aug 22 11:35 instance.xml\r\n{code}\r\n\r\nI'll test this further to verify.","updateAuthor":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=mbacchi","name":"mbacchi","key":"mbacchi","accountId":"557058:d650aabc-f00c-4262-93a9-7799945b8eed","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/24b916c1ff78f38b51f4bb1dc66ed58c?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dmbacchi%26avatarId%3D16201%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/24b916c1ff78f38b51f4bb1dc66ed58c?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dmbacchi%26avatarId%3D16201%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/24b916c1ff78f38b51f4bb1dc66ed58c?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dmbacchi%26avatarId%3D16201%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/24b916c1ff78f38b51f4bb1dc66ed58c?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dmbacchi%26avatarId%3D16201%26noRedirect%3Dtrue"},"displayName":"Matt Bacchi","active":true,"timeZone":"US/Central"},"created":"2017-08-22T13:37:59.964-0500","updated":"2017-08-22T13:56:12.809-0500"},{"self":"https://eucalyptus.atlassian.net/rest/api/2/issue/61603/comment/126900","id":"126900","author":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=mbacchi","name":"mbacchi","key":"mbacchi","accountId":"557058:d650aabc-f00c-4262-93a9-7799945b8eed","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/24b916c1ff78f38b51f4bb1dc66ed58c?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dmbacchi%26avatarId%3D16201%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/24b916c1ff78f38b51f4bb1dc66ed58c?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dmbacchi%26avatarId%3D16201%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/24b916c1ff78f38b51f4bb1dc66ed58c?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dmbacchi%26avatarId%3D16201%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/24b916c1ff78f38b51f4bb1dc66ed58c?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dmbacchi%26avatarId%3D16201%26noRedirect%3Dtrue"},"displayName":"Matt Bacchi","active":true,"timeZone":"US/Central"},"body":"I tried using a nc-hook instead of granting dac_override. Even with the root user added to the eucalyptus group, and with the nc-hook running \"chmod g+rw $inst_dir\" I get the same AVC message:\r\n\r\n{code:java}\r\n----\r\ntime->Wed Aug 23 08:24:05 2017\r\ntype=PROCTITLE msg=audit(1503501845.300:3307): proctitle=\"/usr/sbin/virtlogd\"\r\ntype=SYSCALL msg=audit(1503501845.300:3307): arch=c000003e syscall=87 success=no exit=-13 a0=7f5ae40038d0 a1=7f5ae4000c90 a2=0 a3=36663366342d692f items=0 ppid=1 pid=19508 auid=4294967295 uid=0 gid=0 euid=0 suid=0 fsuid=0 egid=0 sgid=0 fsgid=0 tty=(none) ses=4294967295 comm=\"virtlogd\" exe=\"/usr/sbin/virtlogd\" subj=system_u:system_r:virtlogd_t:s0-s0:c0.c1023 key=(null)\r\ntype=AVC msg=audit(1503501845.300:3307): avc:  denied  { dac_override } for  pid=19508 comm=\"virtlogd\" capability=1  scontext=system_u:system_r:virtlogd_t:s0-s0:c0.c1023 tcontext=system_u:system_r:virtlogd_t:s0-s0:c0.c1023 tclass=capability\r\n{code}\r\n\r\nThe /etc/group looks like this:\r\n\r\n{code:java}\r\n[root@g-12-04 nc-hooks]# grep root /etc/group\r\nroot:x:0:\r\neucalyptus:x:993:eucalyptus,root\r\n{code}\r\n\r\nAnd the hook looks like this:\r\n\r\n\r\n{code:java}\r\n[root@g-12-04 nc-hooks]# pwd\r\n/etc/eucalyptus/nc-hooks\r\n[root@g-12-04 nc-hooks]# ls -l \r\ntotal 16\r\n-rwxr--r--. 1 eucalyptus eucalyptus 4716 Aug 23 08:23 chown-workdir.sh\r\n-rw-r--r--. 1 eucalyptus eucalyptus 4293 Aug 22 13:37 example.sh\r\n[root@g-12-04 nc-hooks]# diff example.sh chown-workdir.sh \r\n99c99,113\r\n< echo `date` \"$event $euca_home $inst_home\" >>$log_file\r\n---\r\n> case \"$event\" in\r\n> \teuca-nc-pre-boot)\r\n> \t\techo `date` \"$event $euca_home $inst_home\" >>$log_file\r\n> \t\techo `date` \"Prior to changing permissions, they are:\" >>$log_file\r\n> \t\techo `date` $(ls -Zld $inst_home) >>$log_file\r\n> \t\techo `date` \"Running \\\"chmod g+w $inst_home\\\"\" >>$log_file\r\n> \t\techo `date` $(chmod g+rw $inst_home 2>&1) >>$log_file\r\n> \t\techo `date` \"After changing permissions, they are:\" >>$log_file\r\n> \t\techo `date` $(ls -Zld $inst_home) >>$log_file\r\n> \t\texit 0\r\n> \t\t;;\r\n> \t*)\r\n> \t\texit 0\r\n> \t\t;;\r\n> esac\r\n{code}\r\n\r\nThe output in the nc-hooks.log is:\r\n\r\n\r\n{code:java}\r\nWed Aug 23 08:23:51 PDT 2017 euca-nc-pre-boot / /var/lib/eucalyptus/instances/work/AIDAAATYWCZFIHMAYARUL/i-4f3f66b7\r\nWed Aug 23 08:23:51 PDT 2017 Prior to changing permissions, they are:\r\nWed Aug 23 08:23:51 PDT 2017 drwx--x--x. 2 system_u:object_r:virt_image_t:s0 eucalyptus eucalyptus 4096 Aug 23 08:23 /var/lib/eucalyptus/instances/work/AIDAAATYWCZFIHMAYARUL/i-4f3f66b7\r\nWed Aug 23 08:23:51 PDT 2017 Running \"chmod g+w /var/lib/eucalyptus/instances/work/AIDAAATYWCZFIHMAYARUL/i-4f3f66b7\"\r\nWed Aug 23 08:23:51 PDT 2017\r\nWed Aug 23 08:23:51 PDT 2017 After changing permissions, they are:\r\nWed Aug 23 08:23:51 PDT 2017 drwxrwx--x. 2 system_u:object_r:virt_image_t:s0 eucalyptus eucalyptus 4096 Aug 23 08:23 /var/lib/eucalyptus/instances/work/AIDAAATYWCZFIHMAYARUL/i-4f3f66b7\r\n{code}\r\n\r\nAnd nc.log:\r\n\r\n{code:java}\r\n2017-08-23 08:24:05 ERROR | [i-4f3f66b7] hypervisor failed to create the instance\r\n2017-08-23 08:24:06  INFO | [i-4f3f66b7] attempt 5 of 5 to create the instance\r\n2017-08-23 08:24:06 ERROR | libvirt: Unable to delete file /var/lib/eucalyptus/instances/work/AIDAAATYWCZFIHMAYARUL/i-4f3f66b7/console.log: Permission denied (code=38)\r\n{code}\r\n\r\nI simply commented out the dac_override self capability in the eucalyptus.te:\r\n\r\n\r\n{code:java}\r\n[root@g-12-04 eucalyptus-selinux]# git diff\r\ndiff --git a/eucalyptus.te b/eucalyptus.te\r\nindex 08b8083..95c658e 100644\r\n--- a/eucalyptus.te\r\n+++ b/eucalyptus.te\r\n@@ -551,7 +551,7 @@ optional_policy(`\r\n   filetrans_pattern(virtd_t, virt_image_t, virt_log_t, file, \"console.log\")\r\n \r\n   # virtlogd now uses the virtlogd_t process owner, convert file to virt_image_t (EUCA-13447)\r\n-  allow virtlogd_t self:capability { dac_override };\r\n+#  allow virtlogd_t self:capability { dac_override };\r\n   filetrans_pattern(virtlogd_t, virt_image_t, virt_log_t, file, \"console.log\")\r\n \r\n   # allow NC to unlink and rename console.log (EUCA-13138 related fix)\r\n{code}\r\n","updateAuthor":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=mbacchi","name":"mbacchi","key":"mbacchi","accountId":"557058:d650aabc-f00c-4262-93a9-7799945b8eed","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/24b916c1ff78f38b51f4bb1dc66ed58c?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dmbacchi%26avatarId%3D16201%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/24b916c1ff78f38b51f4bb1dc66ed58c?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dmbacchi%26avatarId%3D16201%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/24b916c1ff78f38b51f4bb1dc66ed58c?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dmbacchi%26avatarId%3D16201%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/24b916c1ff78f38b51f4bb1dc66ed58c?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dmbacchi%26avatarId%3D16201%26noRedirect%3Dtrue"},"displayName":"Matt Bacchi","active":true,"timeZone":"US/Central"},"created":"2017-08-23T10:31:35.587-0500","updated":"2017-08-23T10:31:35.587-0500"},{"self":"https://eucalyptus.atlassian.net/rest/api/2/issue/61603/comment/126903","id":"126903","author":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=sgraham","name":"sgraham","key":"sgraham","accountId":"557058:dab30ab9-44e7-4b70-a841-8b188c40edfc","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/a40e2a7b21096d27f2427d53d5f45fbf?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dsgraham%26avatarId%3D18000%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/a40e2a7b21096d27f2427d53d5f45fbf?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dsgraham%26avatarId%3D18000%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/a40e2a7b21096d27f2427d53d5f45fbf?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dsgraham%26avatarId%3D18000%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/a40e2a7b21096d27f2427d53d5f45fbf?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dsgraham%26avatarId%3D18000%26noRedirect%3Dtrue"},"displayName":"Steven Graham","active":true,"timeZone":"US/Central"},"body":"Another workaround is to disable virtlogd in qemu: \r\n{code:title=/etc/libvirt/qemu.conf}\r\n#stdio_handler = \"file\"\r\nstdio_handler=\"file\"\r\n{code}","updateAuthor":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=sgraham","name":"sgraham","key":"sgraham","accountId":"557058:dab30ab9-44e7-4b70-a841-8b188c40edfc","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/a40e2a7b21096d27f2427d53d5f45fbf?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dsgraham%26avatarId%3D18000%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/a40e2a7b21096d27f2427d53d5f45fbf?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dsgraham%26avatarId%3D18000%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/a40e2a7b21096d27f2427d53d5f45fbf?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dsgraham%26avatarId%3D18000%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/a40e2a7b21096d27f2427d53d5f45fbf?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dsgraham%26avatarId%3D18000%26noRedirect%3Dtrue"},"displayName":"Steven Graham","active":true,"timeZone":"US/Central"},"created":"2017-08-24T10:40:22.398-0500","updated":"2017-08-24T10:40:22.398-0500"},{"self":"https://eucalyptus.atlassian.net/rest/api/2/issue/61603/comment/127001","id":"127001","author":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=tony","name":"tony","key":"tony","accountId":"557058:353956db-b78c-4f3b-9096-f8f58e6709c8","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/14ec1b18e630cc0743492fc327a12df7?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dtony%26avatarId%3D16600%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/14ec1b18e630cc0743492fc327a12df7?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dtony%26avatarId%3D16600%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/14ec1b18e630cc0743492fc327a12df7?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dtony%26avatarId%3D16600%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/14ec1b18e630cc0743492fc327a12df7?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dtony%26avatarId%3D16600%26noRedirect%3Dtrue"},"displayName":"Tony Beckham","active":true,"timeZone":"America/Tijuana"},"body":"moving to improvement since RHEL 7.4 is not a supported platform.","updateAuthor":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=tony","name":"tony","key":"tony","accountId":"557058:353956db-b78c-4f3b-9096-f8f58e6709c8","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/14ec1b18e630cc0743492fc327a12df7?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dtony%26avatarId%3D16600%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/14ec1b18e630cc0743492fc327a12df7?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dtony%26avatarId%3D16600%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/14ec1b18e630cc0743492fc327a12df7?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dtony%26avatarId%3D16600%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/14ec1b18e630cc0743492fc327a12df7?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dtony%26avatarId%3D16600%26noRedirect%3Dtrue"},"displayName":"Tony Beckham","active":true,"timeZone":"America/Tijuana"},"created":"2017-08-28T16:42:39.092-0500","updated":"2017-08-28T16:42:39.092-0500"},{"self":"https://eucalyptus.atlassian.net/rest/api/2/issue/61603/comment/127100","id":"127100","author":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=sgraham","name":"sgraham","key":"sgraham","accountId":"557058:dab30ab9-44e7-4b70-a841-8b188c40edfc","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/a40e2a7b21096d27f2427d53d5f45fbf?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dsgraham%26avatarId%3D18000%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/a40e2a7b21096d27f2427d53d5f45fbf?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dsgraham%26avatarId%3D18000%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/a40e2a7b21096d27f2427d53d5f45fbf?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dsgraham%26avatarId%3D18000%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/a40e2a7b21096d27f2427d53d5f45fbf?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dsgraham%26avatarId%3D18000%26noRedirect%3Dtrue"},"displayName":"Steven Graham","active":true,"timeZone":"US/Central"},"body":"{code}\r\n[root@c-20 node]# namei -m /var/lib/eucalyptus/instances/work/AIDAAQH6DTC54DUCNXUUR/i-b2f8554f/\r\nf: /var/lib/eucalyptus/instances/work/AIDAAQH6DTC54DUCNXUUR/i-b2f8554f/\r\n drwxr-xr-x /\r\n drwxr-xr-x var\r\n drwxr-xr-x lib\r\n drwxr-xr-x eucalyptus\r\n drwxrwx--x instances\r\n drwxrwx--x work\r\n drwxrwx--x AIDAAQH6DTC54DUCNXUUR\r\n drwxrwx--x i-b2f8554f\r\n{code}\r\n\r\nInstance ownership (eucalyptus.eucalyptus):\r\n{code}\r\n[root@c-20 node]# ls -ld /var/lib/eucalyptus/instances/work/AIDAAQH6DTC54DUCNXUUR/i-b2f8554f/\r\ndrwxrwx--x. 2 eucalyptus eucalyptus 4096 Aug 29 07:31 /var/lib/eucalyptus/instances/work/AIDAAQH6DTC54DUCNXUUR/i-b2f8554f/\r\n{code}\r\n\r\nRoot owns the console.log file\r\n{code}\r\n[root@c-20 node]# ls -ld /var/lib/eucalyptus/instances/work/AIDAAQH6DTC54DUCNXUUR/i-b2f8554f/console.log \r\n-rw-------. 1 root root 0 Aug 29 07:31 /var/lib/eucalyptus/instances/work/AIDAAQH6DTC54DUCNXUUR/i-b2f8554f/console.log\r\n{code}\r\n\r\nGroup definitions, root is in 'eucalyptus'\r\n{code}\r\n[root@c-20 node]# grep eucalyptus /etc/group\r\neucalyptus:x:991:eucalyptus,root\r\neucalyptus-status:x:990:eucalyptus\r\nlibvirt:x:989:eucalyptus,root\r\n{code}\r\n\r\nSo from a DAC standpoint access should be allowed. Root has group rwx in the instance directory, which is what virtlogd is running as...yet it can't remove the file.\r\n\r\nThe AVC output shows the uid/gid and access perms:\r\n{code}\r\n----\r\ntime->Tue Aug 29 07:30:39 2017\r\ntype=PROCTITLE msg=audit(1504017039.777:903787): proctitle=\"/usr/sbin/virtlogd\"\r\n\r\nouid=0\r\nogid=0\r\nmode=0100600\r\n\r\ntype=PATH msg=audit(1504017039.777:903787): item=1 name=\"/var/lib/eucalyptus/instances/work/AIDAAI2ODEPBJDK7YS4UL/i-b5118afe/console.log\" inode=202039350 dev=fd:00 mode=0100600 ouid=0 ogid=0 rdev=00:00 obj=system_u:object_r:virt_log_t:s0 objtype=DELETE\r\n\r\n// Directory access:\r\nouid=995 // eucalyptus\r\nogid=991 // eucalyptus\r\n\r\ntype=PATH msg=audit(1504017039.777:903787): item=0 name=\"/var/lib/eucalyptus/instances/work/AIDAAI2ODEPBJDK7YS4UL/i-b5118afe/\" inode=202039331 dev=fd:00 mode=040771 ouid=995 ogid=991 rdev=00:00 obj=system_u:object_r:virt_image_t:s0 objtype=PARENT\r\n\r\ntype=CWD msg=audit(1504017039.777:903787):  cwd=\"/\"\r\n\r\nThis is the syscall (87 == unlink()). \r\n-13 error code is EACCESS (permission denied)\r\nuid/gid=0\r\n\r\ntype=SYSCALL msg=audit(1504017039.777:903787): arch=c000003e syscall=87 success=no exit=-13 a0=7f2dd4000bf0 a1=7f2dd4000b80 a2=0 a3=38313135622d692f items=2 ppid=1 pid=24935 auid=4294967295 uid=0 gid=0 euid=0 suid=0 fsuid=0 egid=0 sgid=0 fsgid=0 tty=(none) ses=4294967295 comm=\"virtlogd\" exe=\"/usr/sbin/virtlogd\" subj=system_u:system_r:virtlogd_t:s0-s0:c0.c1023 key=(null)\r\ntype=AVC msg=audit(1504017039.777:903787): avc:  denied  { dac_override } for  pid=24935 comm=\"virtlogd\" capability=1  scontext=system_u:system_r:virtlogd_t:s0-s0:c0.c1023 tcontext=system_u:system_r:virtlogd_t:s0-s0:c0.c1023 tclass=capability\r\n{code}\r\n\r\n\r\nThe eucalyptus policy looks like this:\r\n{code}\r\noptional_policy(`\r\n  gen_require(`\r\n    type virtd_t;\r\n    type virtlogd_t;\r\n    type virt_image_t;\r\n    type virt_log_t;\r\n  ')\r\n\r\n  # libvirtd creates console.log, then virtlogd opens it\r\n  filetrans_pattern(virtd_t, virt_image_t, virt_log_t, file, \"console.log\")\r\n\r\n  # virtlogd now uses the virtlogd_t process owner, convert file to virt_image_t\r\n  filetrans_pattern(virtlogd_t, virt_image_t, virt_log_t, file, \"console.log\")\r\n\r\n  # allow NC to unlink and rename console.log (EUCA-13138 related fix)\r\n  delete_files_pattern(eucalyptus_node_t, virt_image_t, virt_log_t)\r\n  rename_files_pattern(eucalyptus_node_t, virt_image_t, virt_log_t)\r\n \r\n\r\n  search_dirs_pattern(virtlogd_t, eucalyptus_var_lib_t, eucalyptus_var_lib_t)\r\n  append_files_pattern(virtlogd_t, virt_image_t, virt_log_t)\r\n  # allow virtlogd access to the console.log file\r\n  delete_files_pattern(virtlogd_t, virt_image_t, virt_log_t)\r\n  rename_files_pattern(virtlogd_t, virt_image_t, virt_log_t)\r\n')\r\n{code}\r\nWhich should allow access to unlink the file along with read access to the directory. \r\n\r\nThe SELinux avc shows:\r\n{code}\r\nFile context: obj=system_u:object_r:virt_log_t:s0\r\n\r\n// filetrans_pattern(virtd_t, virt_mage_t, virt_log_t, file, \"console.log\") is \"working\" since the file context is correct.\r\n// without this rule the context would be virt_image_t\r\n\"/var/lib/eucalyptus/instances/work/AIDAAI2ODEPBJDK7YS4UL/i-b5118afe/console.log\" inode=202039350 dev=fd:00 mode=0100600 ouid=0 ogid=0 rdev=00:00 obj=system_u:object_r:virt_log_t:s0\r\n\r\n// should be allowed via the delete_files_pattern(virtlogd_t, virt_image_t, virt_log_t) rule\r\n// virt_image_t is the directory (\r\nunlink()\r\ncomm=\"virtlogd\" exe=\"/usr/sbin/virtlogd\" subj=system_u:system_r:virtlogd_t:s0-s0:c0.c1023\r\n\r\ntype=AVC msg=audit(1504017039.777:903787): avc:  denied  { dac_override } for  pid=24935 comm=\"virtlogd\" capability=1  scontext=system_u:system_r:virtlogd_t:s0-s0:c0.c1023 tcontext=system_u:system_r:virtlogd_t:s0-s0:c0.c1023 tclass=capability\r\n{code}\r\n\r\nThe way the permission rules work is that the \"DAC\" permissions are checked first, then the SELinux policy rules. If the first fails, then the policy won't be checked, it will flat out fail.\r\n\r\nWhat doesn't make sense is that the permissions look correct, both on the fs level, and in the audit.log. Virtlogd should be able to remove the file. The policy seems to be loaded correctly: \r\n{code}\r\n[root@c-20 eucalyptus-selinux]# sesearch -A | grep virtlogd_t | grep virt_image\r\n   allow virtlogd_t virt_image_t : dir { ioctl read write getattr lock add_name remove_name search open } ; \r\n   allow virtlogd_t svirt_image_t : file { ioctl getattr lock append open } ; \r\n   allow virtlogd_t svirt_image_t : dir { getattr search open } ; \r\n[root@c-20 eucalyptus-selinux]# sesearch -A | grep virtlogd_t | grep virt_log_t\r\n   allow virtlogd_t virt_log_t : file { ioctl read write create getattr setattr lock append unlink link rename open } ; \r\n   allow virtlogd_t virt_log_t : dir { ioctl read write getattr lock add_name remove_name search open } ; \r\n{code}","updateAuthor":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=sgraham","name":"sgraham","key":"sgraham","accountId":"557058:dab30ab9-44e7-4b70-a841-8b188c40edfc","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/a40e2a7b21096d27f2427d53d5f45fbf?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dsgraham%26avatarId%3D18000%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/a40e2a7b21096d27f2427d53d5f45fbf?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dsgraham%26avatarId%3D18000%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/a40e2a7b21096d27f2427d53d5f45fbf?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dsgraham%26avatarId%3D18000%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/a40e2a7b21096d27f2427d53d5f45fbf?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dsgraham%26avatarId%3D18000%26noRedirect%3Dtrue"},"displayName":"Steven Graham","active":true,"timeZone":"US/Central"},"created":"2017-08-29T13:05:45.882-0500","updated":"2017-08-29T13:05:45.882-0500"},{"self":"https://eucalyptus.atlassian.net/rest/api/2/issue/61603/comment/127200","id":"127200","author":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=sjones","name":"sjones","key":"sjones","accountId":"557058:f5dce1b0-db45-4dd6-a0e8-3cea5effb5ce","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/037fddf6d3bf6d691a448e01136f233a?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dsjones%26avatarId%3D18300%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/037fddf6d3bf6d691a448e01136f233a?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dsjones%26avatarId%3D18300%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/037fddf6d3bf6d691a448e01136f233a?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dsjones%26avatarId%3D18300%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/037fddf6d3bf6d691a448e01136f233a?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dsjones%26avatarId%3D18300%26noRedirect%3Dtrue"},"displayName":"Steve Jones","active":true,"timeZone":"America/Los_Angeles"},"body":"I looked into why this occurs on rhel 7.4 but not rhel 7.3. It looks like the important difference is that in rhel 7.4 a bug is fixed with the log file append behaviour:\r\n\r\nhttps://bugzilla.redhat.com/show_bug.cgi?id=1420205\r\n\r\nThis fix means virtlogd truncates the console.log file when the instance starts. You can test this by modifying libvirt.xsl so that we explicitly set the append attribute rather than relying on the default, resulting in e.g.:\r\n\r\n{code}\r\n    <serial type=\"file\">\r\n      <source append=\"on\" path=\"/var/lib/eucalyptus/instances/work/AIDAAYIGU76E3GQTLTD2B/i-19f6e2b7/console.log\"/>\r\n      <target port=\"1\"/>\r\n    </serial>\r\n{code}\r\n\r\nso when we generate append=on, this will work on rhel 7.3 or 7.4, with append=off instances fail to run on both rhel 7.3 and rhel 7.4 when selinux is enabled and enforcing.\r\n\r\nNote that this does mean the log rotation functionality is broken on rhel 7.3. After modifying the rotation settings in /etc/libvirt/virtlogd.conf so rotation occurs on instance launch we see the errors:\r\n\r\n{code}\r\n# journalctl -n 10 -u virtlogd.service --no-pager\r\n-- Logs begin at Thu 2017-08-17 21:34:32 PDT, end at Wed 2017-08-30 09:49:46 PDT. --\r\nAug 29 21:53:06 a-16-l.qa1.eucalyptus-systems.com virtlogd[6818]: End of file while reading data: Input/output error\r\nAug 29 21:56:57 a-16-l.qa1.eucalyptus-systems.com virtlogd[6818]: End of file while reading data: Input/output error\r\nAug 29 21:57:20 a-16-l.qa1.eucalyptus-systems.com virtlogd[6818]: End of file while reading data: Input/output error\r\nAug 30 09:43:28 a-16-l.qa1.eucalyptus-systems.com systemd[1]: Stopping Virtual machine log manager...\r\nAug 30 09:43:28 a-16-l.qa1.eucalyptus-systems.com systemd[1]: Started Virtual machine log manager.\r\nAug 30 09:43:28 a-16-l.qa1.eucalyptus-systems.com systemd[1]: Starting Virtual machine log manager...\r\nAug 30 09:45:03 a-16-l.qa1.eucalyptus-systems.com virtlogd[11433]: libvirt version: 2.0.0, package: 10.el7_3.9 (CentOS BuildSystem <http://bugs.centos.org>, 2017-05-25-20:52:28, c1bm.rdu2.centos.org)\r\nAug 30 09:45:03 a-16-l.qa1.eucalyptus-systems.com virtlogd[11433]: hostname: a-16-l.qa1.eucalyptus-systems.com\r\nAug 30 09:45:03 a-16-l.qa1.eucalyptus-systems.com virtlogd[11433]: End of file while reading data: Input/output error\r\nAug 30 09:45:05 a-16-l.qa1.eucalyptus-systems.com virtlogd[11433]: Unable to rename /var/lib/eucalyptus/instances/work/AIDAA3QVBDDZ5LC3WQ45S/i-6db018c3/console.log to /var/lib/eucalyptus/instances/work/AIDAA3QVBDDZ5LC3WQ45S/i-6db018c3/console.log.0: Permission denied\r\n{code}\r\n\r\nand corresponding denial:\r\n\r\n{code}\r\n# ausearch -m avc -ts recent\r\n----\r\ntime->Wed Aug 30 09:45:05 2017\r\ntype=SYSCALL msg=audit(1504111505.638:531492): arch=c000003e syscall=82 success=no exit=-13 a0=7f836a488db0 a1=7f836a488c90 a2=7f8369600ce3 a3=31306264362d692f items=0 ppid=1 pid=11433 auid=4294967295 uid=0 gid=0 euid=0 suid=0 fsuid=0 egid=0 sgid=0 fsgid=0 tty=(none) ses=4294967295 comm=\"virtlogd\" exe=\"/usr/sbin/virtlogd\" subj=system_u:system_r:virtlogd_t:s0-s0:c0.c1023 key=(null)\r\ntype=AVC msg=audit(1504111505.638:531492): avc:  denied  { dac_override } for  pid=11433 comm=\"virtlogd\" capability=1  scontext=system_u:system_r:virtlogd_t:s0-s0:c0.c1023 tcontext=system_u:system_r:virtlogd_t:s0-s0:c0.c1023 tclass=capability\r\n{code}\r\n\r\nAnother workaround on rhel 7.4 is to change the /etc/eucalyptus/libvirt.xsl so it behaves like rhel 7.3 (append=on) and not make any selinux changes (log rotation would later fail as it does now on rhel 7.3)","updateAuthor":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=sjones","name":"sjones","key":"sjones","accountId":"557058:f5dce1b0-db45-4dd6-a0e8-3cea5effb5ce","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/037fddf6d3bf6d691a448e01136f233a?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dsjones%26avatarId%3D18300%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/037fddf6d3bf6d691a448e01136f233a?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dsjones%26avatarId%3D18300%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/037fddf6d3bf6d691a448e01136f233a?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dsjones%26avatarId%3D18300%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/037fddf6d3bf6d691a448e01136f233a?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dsjones%26avatarId%3D18300%26noRedirect%3Dtrue"},"displayName":"Steve Jones","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-08-30T12:48:20.637-0500","updated":"2017-08-30T12:48:20.637-0500"},{"self":"https://eucalyptus.atlassian.net/rest/api/2/issue/61603/comment/127201","id":"127201","author":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=sjones","name":"sjones","key":"sjones","accountId":"557058:f5dce1b0-db45-4dd6-a0e8-3cea5effb5ce","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/037fddf6d3bf6d691a448e01136f233a?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dsjones%26avatarId%3D18300%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/037fddf6d3bf6d691a448e01136f233a?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dsjones%26avatarId%3D18300%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/037fddf6d3bf6d691a448e01136f233a?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dsjones%26avatarId%3D18300%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/037fddf6d3bf6d691a448e01136f233a?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dsjones%26avatarId%3D18300%26noRedirect%3Dtrue"},"displayName":"Steve Jones","active":true,"timeZone":"America/Los_Angeles"},"body":"With file rotation considered the following permissions appear necessary:\r\n\r\n{code}\r\nallow virtlogd_t self:capability dac_override;\r\n\r\ncreate_files_pattern(virtlogd_t, virt_image_t, virt_log_t)\r\ndelete_files_pattern(virtlogd_t, virt_image_t, virt_log_t)\r\nrename_files_pattern(virtlogd_t, virt_image_t, virt_log_t)\r\n\r\ndelete_files_pattern(virtlogd_t, virt_image_t, svirt_image_t)\r\nrename_files_pattern(virtlogd_t, virt_image_t, svirt_image_t)\r\n\r\nfiletrans_pattern(virtlogd_t, virt_image_t, virt_log_t, file, \"console.log\")\r\n{code}\r\n\r\nWe need both virt_log_t and svirt_image_t for the delete/rename rules as the first console.log file has a different context to those after file rotation (which have virt_log_t rather than svirt_image_t and root.root ownership instead of qemu.qemu)\r\n\r\nFor the instance directory permissions (in the future) we could run virtlogd in the eucalyptus group by adding the file:\r\n\r\n{code}\r\n# cat /etc/systemd/system/virtlogd.service.d/groups.conf \r\n[Service]\r\nSupplementaryGroups=eucalyptus\r\n{code}\r\n\r\nand then modify the group permissions to 771 from 711 (storage/backing.h):\r\n\r\n{code}\r\n#define INSTANCE_DIRECTORY_PERM                  0771   //!< Instace backing directory default permission\r\n{code}\r\n\r\nrotation permissions were tested by setting \"max_size = 2048\" in /etc/libvirt/virtlogd.conf so logs are fully rotated on instance boot.","updateAuthor":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=sjones","name":"sjones","key":"sjones","accountId":"557058:f5dce1b0-db45-4dd6-a0e8-3cea5effb5ce","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/037fddf6d3bf6d691a448e01136f233a?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dsjones%26avatarId%3D18300%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/037fddf6d3bf6d691a448e01136f233a?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dsjones%26avatarId%3D18300%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/037fddf6d3bf6d691a448e01136f233a?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dsjones%26avatarId%3D18300%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/037fddf6d3bf6d691a448e01136f233a?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dsjones%26avatarId%3D18300%26noRedirect%3Dtrue"},"displayName":"Steve Jones","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-08-30T16:08:22.718-0500","updated":"2017-08-30T16:08:22.718-0500"},{"self":"https://eucalyptus.atlassian.net/rest/api/2/issue/61603/comment/128021","id":"128021","author":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=ccassler","name":"ccassler","key":"ccassler","accountId":"557058:8fb32702-a3cf-42d3-9846-95c74f801354","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/ace94e80ebc0a3b718cc5422760b57de?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dccassler%26avatarId%3D14700%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/ace94e80ebc0a3b718cc5422760b57de?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dccassler%26avatarId%3D14700%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/ace94e80ebc0a3b718cc5422760b57de?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dccassler%26avatarId%3D14700%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/ace94e80ebc0a3b718cc5422760b57de?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dccassler%26avatarId%3D14700%26noRedirect%3Dtrue"},"displayName":"Casey Cassler","active":true,"timeZone":"America/Los_Angeles"},"body":"I tried this with a rhel-7.4 cloud and I was able to launch instances without issues.  Just to be sure, I removed the append=\"on\" option from the libvirt.xsl and I was no longer able to launch instances.\r\n{code}\r\n<xsl:when test=\"(/instance/hypervisor/@type = 'kvm' or /instance/hypervisor/@type = 'qemu')\">\r\n        <serial type=\"file\">\r\n                <source append=\"on\">\r\n                         <xsl:attribute name=\"path\">\r\n                                 <xsl:value-of select=\"/instance/consoleLogPath\"/>\r\n                         </xsl:attribute>\r\n                </source>\r\n                <target port=\"1\"/>\r\n        </serial>\r\n</xsl:when>\r\n{code}","updateAuthor":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=ccassler","name":"ccassler","key":"ccassler","accountId":"557058:8fb32702-a3cf-42d3-9846-95c74f801354","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/ace94e80ebc0a3b718cc5422760b57de?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dccassler%26avatarId%3D14700%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/ace94e80ebc0a3b718cc5422760b57de?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dccassler%26avatarId%3D14700%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/ace94e80ebc0a3b718cc5422760b57de?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dccassler%26avatarId%3D14700%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/ace94e80ebc0a3b718cc5422760b57de?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dccassler%26avatarId%3D14700%26noRedirect%3Dtrue"},"displayName":"Casey Cassler","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-10-12T23:23:37.389-0500","updated":"2017-10-12T23:26:56.791-0500"},{"self":"https://eucalyptus.atlassian.net/rest/api/2/issue/61603/comment/128022","id":"128022","author":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=ccassler","name":"ccassler","key":"ccassler","accountId":"557058:8fb32702-a3cf-42d3-9846-95c74f801354","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/ace94e80ebc0a3b718cc5422760b57de?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dccassler%26avatarId%3D14700%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/ace94e80ebc0a3b718cc5422760b57de?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dccassler%26avatarId%3D14700%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/ace94e80ebc0a3b718cc5422760b57de?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dccassler%26avatarId%3D14700%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/ace94e80ebc0a3b718cc5422760b57de?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dccassler%26avatarId%3D14700%26noRedirect%3Dtrue"},"displayName":"Casey Cassler","active":true,"timeZone":"America/Los_Angeles"},"body":"I tried the same libvirt.xsl procedure as described above on CentOS 7.4 and I was also able to launch and access instances.","updateAuthor":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=ccassler","name":"ccassler","key":"ccassler","accountId":"557058:8fb32702-a3cf-42d3-9846-95c74f801354","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/ace94e80ebc0a3b718cc5422760b57de?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dccassler%26avatarId%3D14700%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/ace94e80ebc0a3b718cc5422760b57de?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dccassler%26avatarId%3D14700%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/ace94e80ebc0a3b718cc5422760b57de?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dccassler%26avatarId%3D14700%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/ace94e80ebc0a3b718cc5422760b57de?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dccassler%26avatarId%3D14700%26noRedirect%3Dtrue"},"displayName":"Casey Cassler","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-10-16T18:25:00.334-0500","updated":"2017-10-16T18:25:00.334-0500"},{"self":"https://eucalyptus.atlassian.net/rest/api/2/issue/61603/comment/128023","id":"128023","author":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=sjones","name":"sjones","key":"sjones","accountId":"557058:f5dce1b0-db45-4dd6-a0e8-3cea5effb5ce","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/037fddf6d3bf6d691a448e01136f233a?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dsjones%26avatarId%3D18300%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/037fddf6d3bf6d691a448e01136f233a?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dsjones%26avatarId%3D18300%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/037fddf6d3bf6d691a448e01136f233a?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dsjones%26avatarId%3D18300%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/037fddf6d3bf6d691a448e01136f233a?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dsjones%26avatarId%3D18300%26noRedirect%3Dtrue"},"displayName":"Steve Jones","active":true,"timeZone":"America/Los_Angeles"},"body":"A commit with the libvirt.xsl source append change is here:\r\n\r\nhttps://github.com/sjones4/eucalyptus/commit/488475fb066ce5388ce2a9a0178db6050ea071ce","updateAuthor":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=sjones","name":"sjones","key":"sjones","accountId":"557058:f5dce1b0-db45-4dd6-a0e8-3cea5effb5ce","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/037fddf6d3bf6d691a448e01136f233a?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dsjones%26avatarId%3D18300%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/037fddf6d3bf6d691a448e01136f233a?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dsjones%26avatarId%3D18300%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/037fddf6d3bf6d691a448e01136f233a?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dsjones%26avatarId%3D18300%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/037fddf6d3bf6d691a448e01136f233a?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dsjones%26avatarId%3D18300%26noRedirect%3Dtrue"},"displayName":"Steve Jones","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-10-20T15:01:14.801-0500","updated":"2017-10-20T15:01:14.801-0500"}],"maxResults":17,"total":17,"startAt":0},"votes":{"self":"https://eucalyptus.atlassian.net/rest/api/2/issue/EUCA-13447/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_11808":null}}