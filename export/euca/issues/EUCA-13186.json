{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"54108","self":"https://eucalyptus.atlassian.net/rest/api/2/issue/54108","key":"EUCA-13186","fields":{"issuetype":{"self":"https://eucalyptus.atlassian.net/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://eucalyptus.atlassian.net/secure/viewavatar?size=xsmall&avatarId=14803&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":14803},"timespent":null,"customfield_13100":null,"project":{"self":"https://eucalyptus.atlassian.net/rest/api/2/project/10000","id":"10000","key":"EUCA","name":"Eucalyptus","avatarUrls":{"48x48":"https://eucalyptus.atlassian.net/secure/projectavatar?pid=10000&avatarId=10011","24x24":"https://eucalyptus.atlassian.net/secure/projectavatar?size=small&pid=10000&avatarId=10011","16x16":"https://eucalyptus.atlassian.net/secure/projectavatar?size=xsmall&pid=10000&avatarId=10011","32x32":"https://eucalyptus.atlassian.net/secure/projectavatar?size=medium&pid=10000&avatarId=10011"}},"customfield_11000":null,"fixVersions":[{"self":"https://eucalyptus.atlassian.net/rest/api/2/version/18100","id":"18100","description":"Eucalyptus 4.4.0","name":"4.4.0","archived":false,"released":true,"releaseDate":"2017-03-07"}],"customfield_11001":null,"aggregatetimespent":null,"resolution":{"self":"https://eucalyptus.atlassian.net/rest/api/2/resolution/7","id":"7","description":"Signifies completion of tasks, info requests, etc.","name":"Completed"},"customfield_10310":[{"self":"https://eucalyptus.atlassian.net/rest/api/2/customFieldOption/12601","value":"CentOS 7","id":"12601"}],"customfield_11401":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=tony","name":"tony","key":"tony","accountId":"557058:353956db-b78c-4f3b-9096-f8f58e6709c8","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/14ec1b18e630cc0743492fc327a12df7?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dtony%26avatarId%3D16600%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/14ec1b18e630cc0743492fc327a12df7?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dtony%26avatarId%3D16600%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/14ec1b18e630cc0743492fc327a12df7?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dtony%26avatarId%3D16600%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/14ec1b18e630cc0743492fc327a12df7?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dtony%26avatarId%3D16600%26noRedirect%3Dtrue"},"displayName":"Tony Beckham","active":true,"timeZone":"America/Tijuana"},"customfield_10311":[{"self":"https://eucalyptus.atlassian.net/rest/api/2/customFieldOption/11500","value":"Edge","id":"11500"}],"customfield_11400":null,"customfield_10302":null,"customfield_10500":{"self":"https://eucalyptus.atlassian.net/rest/api/2/customFieldOption/10403","value":"Not Applicable","id":"10403"},"customfield_10104":[],"customfield_10303":null,"customfield_10105":null,"customfield_10700":null,"customfield_10304":null,"customfield_10701":null,"customfield_10306":null,"customfield_10702":null,"customfield_10703":null,"customfield_10704":null,"customfield_10308":null,"resolutiondate":"2017-03-15T23:14:51.463-0500","customfield_10705":null,"customfield_10309":[{"self":"https://eucalyptus.atlassian.net/rest/api/2/customFieldOption/10204","value":"KVM","id":"10204"}],"workratio":-1,"lastViewed":null,"watches":{"self":"https://eucalyptus.atlassian.net/rest/api/2/issue/EUCA-13186/watchers","watchCount":6,"isWatching":false},"created":"2017-02-01T16:17:11.695-0600","customfield_12000":null,"priority":{"self":"https://eucalyptus.atlassian.net/rest/api/2/priority/1","iconUrl":"https://eucalyptus.atlassian.net/images/icons/priorities/blocker.svg","name":"Blocker","id":"1"},"customfield_12400":null,"customfield_12201":null,"customfield_12600":"{pullrequest={dataType=pullrequest, state=MERGED, stateCount=1}, json={\"cachedValue\":{\"errors\":[],\"summary\":{\"pullrequest\":{\"overall\":{\"count\":1,\"lastUpdated\":\"2017-02-08T13:19:36.000-0600\",\"stateCount\":1,\"state\":\"MERGED\",\"dataType\":\"pullrequest\",\"open\":false},\"byInstanceType\":{\"github\":{\"count\":1,\"name\":\"GitHub\"}}}}},\"isStale\":true}}","customfield_10102":null,"customfield_10300":null,"labels":[],"customfield_10301":null,"customfield_11700":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[{"self":"https://eucalyptus.atlassian.net/rest/api/2/version/18100","id":"18100","description":"Eucalyptus 4.4.0","name":"4.4.0","archived":false,"released":true,"releaseDate":"2017-03-07"}],"customfield_11901":null,"issuelinks":[{"id":"48600","self":"https://eucalyptus.atlassian.net/rest/api/2/issueLink/48600","type":{"id":"10103","name":"Relates","inward":"relates to","outward":"relates to","self":"https://eucalyptus.atlassian.net/rest/api/2/issueLinkType/10103"},"outwardIssue":{"id":"53902","key":"EUCA-13172","self":"https://eucalyptus.atlassian.net/rest/api/2/issue/53902","fields":{"summary":"race condition when creating a volume from snapshot","status":{"self":"https://eucalyptus.atlassian.net/rest/api/2/status/10001","description":"This issue has been validated/reproduced, but has not been prioritized yet.","iconUrl":"https://eucalyptus.atlassian.net/images/icons/statuses/generic.png","name":"Confirmed","id":"10001","statusCategory":{"self":"https://eucalyptus.atlassian.net/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"priority":{"self":"https://eucalyptus.atlassian.net/rest/api/2/priority/3","iconUrl":"https://eucalyptus.atlassian.net/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://eucalyptus.atlassian.net/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://eucalyptus.atlassian.net/secure/viewavatar?size=xsmall&avatarId=14803&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":14803}}}}],"assignee":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=ccassler","name":"ccassler","key":"ccassler","accountId":"557058:8fb32702-a3cf-42d3-9846-95c74f801354","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/ace94e80ebc0a3b718cc5422760b57de?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dccassler%26avatarId%3D14700%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/ace94e80ebc0a3b718cc5422760b57de?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dccassler%26avatarId%3D14700%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/ace94e80ebc0a3b718cc5422760b57de?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dccassler%26avatarId%3D14700%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/ace94e80ebc0a3b718cc5422760b57de?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dccassler%26avatarId%3D14700%26noRedirect%3Dtrue"},"displayName":"Casey Cassler","active":true,"timeZone":"America/Los_Angeles"},"updated":"2017-03-15T23:14:51.474-0500","status":{"self":"https://eucalyptus.atlassian.net/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://eucalyptus.atlassian.net/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://eucalyptus.atlassian.net/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://eucalyptus.atlassian.net/rest/api/2/component/10014","id":"10014","name":"Storage Controller"}],"timeoriginalestimate":null,"description":"I was continuing to run automated tests for snapshot delta testing.  One of the tests was as follows:\r\n\r\n1. Set maxsnapshotdeltas to 25\r\n2. Create 70 snapshots and volumes from those snapshots (one snapshot at a time)\r\n3. Delete the snapshots\r\n4. Change the maxsnapshotdeltas to 50\r\n5. Start creating snapshots and volumes again to max 70\r\n\r\nThe test started creating snapshots when the maxsnapshotdeltas was set to 50 and the first snapshot showed a failure because it couldn't find previous snapshot delta data.  However, the snapshot was still created.  Then, the script attempted to create a new volume from the snapshot but it looks like it failed because the snapshot was corrupted or incomplete.  Here's what appeared in the logs:\r\n{code}\r\nWed Feb 1 06:10:46 2017 DEBUG [CephRbdProvider:eucalyptus-storage-volumecreator-worker-544] Dump from rbd command:\r\nReturn value=0\r\nOutput=\r\nDebug=^MImporting image diff: 40% complete...^MImporting image diff: 80% complete...^MImporting image diff: 99% complete...^MImporting image diff: 100% complete...done.\r\n\r\nWed Feb 1 06:10:46 2017  INFO [VolumeCreator:eucalyptus-storage-volumecreator-worker-544] Download snap-4e90fca8 (delta from snap-12ca854b) and restore it on snap-4e90fca8\r\nWed Feb 1 06:10:46 2017 DEBUG [S3SnapshotTransfer:eucalyptus-storage-volumecreator-worker-544] Dowloading snapshot from objectstorage: snapshotId=snap-4e90fca8, bucket=snapshots-f397bf11bbc741279361eee21e29bd0f, key=snap-4e90fca8\r\nWed Feb 1 06:10:46 2017 DEBUG [SANManager:eucalyptus-storage-volumecreator-worker-544] Applying snapshot delta between snap-4e90fca8 and snap-12ca854b on base tempsnap/snap-4e90fca8\r\nWed Feb 1 06:10:46 2017  INFO [CephRbdProvider:eucalyptus-storage-volumecreator-worker-544] Restoring delta on base=tempsnap/snap-4e90fca8, snapshotId=snap-4e90fca8, snapsDeltaFile=/var/tmp/snap-4e90fca8_snap-12ca854b_7489300886625898952.diff\r\nWed Feb 1 06:10:46 2017 DEBUG [CephRbdProvider:eucalyptus-storage-volumecreator-worker-544] Executing: ///usr/lib/eucalyptus/euca_rootwrap rbd --id qatemp --keyring /etc/ceph/ceph.client.qatemp.keyring import-diff /var/tmp/snap-4e90fca8_snap-12ca854b_7489300886625898952.diff tempsnap/snap-4e90fca8\r\nWed Feb 1 06:10:47 2017 DEBUG [CephRbdProvider:eucalyptus-storage-volumecreator-worker-544] Dump from rbd command:\r\nReturn value=22\r\nOutput=\r\nDebug=start snapshot 'sp-for-snap-fd63f9a1' does not exist in the image, aborting\r\n^MImporting image diff: 0% complete...failed.\r\nrbd: import-diff failed: (22) Invalid argument\r\n\r\nWed Feb 1 06:10:47 2017  WARN [CephRbdProvider:eucalyptus-storage-volumecreator-worker-544] Failed to apply snapshot delta on tempsnap/snap-4e90fca8\r\ncom.eucalyptus.util.EucalyptusCloudException: Unable to execute rbd command. Failed with error:\r\nstart snapshot 'sp-for-snap-fd63f9a1' does not exist in the image, aborting\r\n\r\nImporting image diff: 0% complete...failed.\r\nrbd: import-diff failed: (22) Invalid argument\r\n\r\n        at com.eucalyptus.blockstorage.ceph.CephRbdProvider.restoreSnapshotDelta(CephRbdProvider.java:713)\r\n        at com.eucalyptus.blockstorage.san.common.SANManager.restoreSnapshotDelta(SANManager.java:1413)\r\n        at com.eucalyptus.blockstorage.async.VolumeCreator.downloadAndRestoreDelta(VolumeCreator.java:631)\r\n        at com.eucalyptus.blockstorage.async.VolumeCreator.run(VolumeCreator.java:256)\r\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\r\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\r\n        at java.lang.Thread.run(Thread.java:745)\r\nWed Feb 1 06:10:47 2017  WARN [SANManager:eucalyptus-storage-volumecreator-worker-544] Failed to apply delta between snap-4e90fca8 and snap-12ca854b on base tempsnap/snap-4e90fca8\r\nWed Feb 1 06:10:47 2017 ERROR [VolumeCreator:eucalyptus-storage-volumecreator-worker-544] Failed to create volume vol-635372f6\r\ncom.eucalyptus.util.EucalyptusCloudException: Failed to apply delta between snap-4e90fca8 and snap-12ca854b on base tempsnap/snap-4e90fca8\r\n        at com.eucalyptus.blockstorage.san.common.SANManager.restoreSnapshotDelta(SANManager.java:1416)\r\n        at com.eucalyptus.blockstorage.async.VolumeCreator.downloadAndRestoreDelta(VolumeCreator.java:631)\r\n        at com.eucalyptus.blockstorage.async.VolumeCreator.run(VolumeCreator.java:256)\r\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\r\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\r\n        at java.lang.Thread.run(Thread.java:745)\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\nWed Feb 1 13:36:50 2017  INFO [CephRbdProvider:eucalyptus-storage-volumecreator-worker-608] Creating volume volumeId=vol-f95ef329, snapshotId=snap-4e90fca8, size=1GB, snapshotIqn=tempsnap/snap-4e90fca8\r\nWed Feb 1 13:36:50 2017  INFO [CephRbdFormatTwoAdapter:eucalyptus-storage-volumecreator-worker-608] Clone (and resize) ceph-rbd image parentName=snap-4e90fca8, snapName=sp-on-snap-4e90fca8, cloneName=vol-f95ef329, size=null, parentPoolName=tempsnap\r\nWed Feb 1 13:36:50 2017 DEBUG [CephRbdFormatTwoAdapter:eucalyptus-storage-volumecreator-worker-608] Cloning snapshot=sp-on-snap-4e90fca8, image=snap-4e90fca8, pool=tempsnap to image=vol-f95ef329, pool=tempvol\r\nWed Feb 1 13:36:50 2017  WARN [CephRbdFormatTwoAdapter:eucalyptus-storage-volumecreator-worker-608] Caught error while cloning/resizing image vol-f95ef329 from source image snap-4e90fca8: Failed to clone image snap-4e90fca8@sp-on-snap-4e90fca8 to vol-f95ef329\r\nWed Feb 1 13:36:50 2017 ERROR [VolumeCreator:eucalyptus-storage-volumecreator-worker-608] Failed to create volume vol-f95ef329\r\ncom.eucalyptus.blockstorage.ceph.exceptions.EucalyptusCephException: Failed to clone/resize image vol-f95ef329 from source image snap-4e90fca8\r\n        at com.eucalyptus.blockstorage.ceph.CephRbdFormatTwoAdapter$10$1.apply(CephRbdFormatTwoAdapter.java:579)\r\n        at com.eucalyptus.blockstorage.ceph.CephRbdFormatTwoAdapter$10$1.apply(CephRbdFormatTwoAdapter.java:551)\r\n        at com.eucalyptus.blockstorage.ceph.CephRbdFormatTwoAdapter.executeRbdOpInPool(CephRbdFormatTwoAdapter.java:623)\r\n        at com.eucalyptus.blockstorage.ceph.CephRbdFormatTwoAdapter.executeRbdOpInRandomPool(CephRbdFormatTwoAdapter.java:642)\r\n        at com.eucalyptus.blockstorage.ceph.CephRbdFormatTwoAdapter.access$100(CephRbdFormatTwoAdapter.java:91)\r\n        at com.eucalyptus.blockstorage.ceph.CephRbdFormatTwoAdapter$10.apply(CephRbdFormatTwoAdapter.java:551)\r\n        at com.eucalyptus.blockstorage.ceph.CephRbdFormatTwoAdapter$10.apply(CephRbdFormatTwoAdapter.java:545)\r\n        at com.eucalyptus.blockstorage.ceph.CephRbdFormatTwoAdapter.executeRbdOpInPool(CephRbdFormatTwoAdapter.java:623)\r\n        at com.eucalyptus.blockstorage.ceph.CephRbdFormatTwoAdapter.cloneAndResizeImage(CephRbdFormatTwoAdapter.java:545)\r\n        at com.eucalyptus.blockstorage.ceph.CephRbdProvider.createVolume(CephRbdProvider.java:185)\r\n        at com.eucalyptus.blockstorage.san.common.SANManager.createVolume(SANManager.java:534)\r\n        at com.eucalyptus.blockstorage.async.VolumeCreator.run(VolumeCreator.java:311)\r\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\r\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\r\n        at java.lang.Thread.run(Thread.java:745)\r\nCaused by: com.ceph.rbd.RbdException: Failed to clone image snap-4e90fca8@sp-on-snap-4e90fca8 to vol-f95ef329\r\n        at com.ceph.rbd.Rbd.clone(Rbd.java:346)\r\n        at com.eucalyptus.blockstorage.ceph.CephRbdFormatTwoAdapter$10$1.apply(CephRbdFormatTwoAdapter.java:563)\r\n        ... 14 more\r\n{code}","customfield_13000":null,"customfield_13200":null,"customfield_11300":"EUCA-5313","customfield_11500":null,"timetracking":{},"customfield_10005":null,"customfield_10401":null,"customfield_10600":null,"customfield_12900":null,"aggregatetimeestimate":null,"attachment":[{"self":"https://eucalyptus.atlassian.net/rest/api/2/attachment/38706","id":"38706","filename":"Timeline 1.gliffy","author":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=addon_com.gliffy.integration.jira","name":"addon_com.gliffy.integration.jira","key":"addon_com.gliffy.integration.jira","accountId":"557058:8f10a0a5-d759-4932-8870-eac8ad18fc0a","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/4145cc1cfb434da684155400a72fed2c?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FavatarId%3D10122%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/4145cc1cfb434da684155400a72fed2c?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26avatarId%3D10122%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/4145cc1cfb434da684155400a72fed2c?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26avatarId%3D10122%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/4145cc1cfb434da684155400a72fed2c?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26avatarId%3D10122%26noRedirect%3Dtrue"},"displayName":"Gliffy Diagrams for JIRA Cloud","active":true,"timeZone":"US/Central"},"created":"2017-02-02T18:12:18.472-0600","size":45566,"mimeType":"application/octet-stream","content":"https://eucalyptus.atlassian.net/secure/attachment/38706/Timeline+1.gliffy"},{"self":"https://eucalyptus.atlassian.net/rest/api/2/attachment/39017","id":"39017","filename":"Timeline 2.gliffy","author":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=addon_com.gliffy.integration.jira","name":"addon_com.gliffy.integration.jira","key":"addon_com.gliffy.integration.jira","accountId":"557058:8f10a0a5-d759-4932-8870-eac8ad18fc0a","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/4145cc1cfb434da684155400a72fed2c?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FavatarId%3D10122%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/4145cc1cfb434da684155400a72fed2c?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26avatarId%3D10122%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/4145cc1cfb434da684155400a72fed2c?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26avatarId%3D10122%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/4145cc1cfb434da684155400a72fed2c?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26avatarId%3D10122%26noRedirect%3Dtrue"},"displayName":"Gliffy Diagrams for JIRA Cloud","active":true,"timeZone":"US/Central"},"created":"2017-02-08T13:53:13.760-0600","size":57164,"mimeType":"application/octet-stream","content":"https://eucalyptus.atlassian.net/secure/attachment/39017/Timeline+2.gliffy"}],"summary":"volume from snapshot fails because snapshot delta failed","creator":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=ccassler","name":"ccassler","key":"ccassler","accountId":"557058:8fb32702-a3cf-42d3-9846-95c74f801354","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/ace94e80ebc0a3b718cc5422760b57de?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dccassler%26avatarId%3D14700%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/ace94e80ebc0a3b718cc5422760b57de?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dccassler%26avatarId%3D14700%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/ace94e80ebc0a3b718cc5422760b57de?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dccassler%26avatarId%3D14700%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/ace94e80ebc0a3b718cc5422760b57de?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dccassler%26avatarId%3D14700%26noRedirect%3Dtrue"},"displayName":"Casey Cassler","active":true,"timeZone":"America/Los_Angeles"},"subtasks":[],"reporter":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=ccassler","name":"ccassler","key":"ccassler","accountId":"557058:8fb32702-a3cf-42d3-9846-95c74f801354","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/ace94e80ebc0a3b718cc5422760b57de?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dccassler%26avatarId%3D14700%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/ace94e80ebc0a3b718cc5422760b57de?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dccassler%26avatarId%3D14700%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/ace94e80ebc0a3b718cc5422760b57de?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dccassler%26avatarId%3D14700%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/ace94e80ebc0a3b718cc5422760b57de?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dccassler%26avatarId%3D14700%26noRedirect%3Dtrue"},"displayName":"Casey Cassler","active":true,"timeZone":"America/Los_Angeles"},"customfield_12100":"0|i042b3:","aggregateprogress":{"progress":0,"total":0},"customfield_10000":"3_*:*_1_*:*_13367_*|*_10000_*:*_1_*:*_614259_*|*_10001_*:*_1_*:*_602695974_*|*_10003_*:*_1_*:*_1718818994_*|*_10006_*:*_1_*:*_0","customfield_10001":"2017-02-02T21:16:26.254-0600","customfield_10200":null,"customfield_10002":null,"customfield_10003":null,"customfield_12500":null,"customfield_10400":null,"customfield_10116":null,"customfield_11600":["ccassler(ccassler)","lbiasi(lbiasi)","lincoln.thomas(lincoln.thomas)"],"customfield_10117":null,"environment":null,"customfield_11800":null,"customfield_11802":null,"customfield_11805":null,"duedate":null,"customfield_11806":null,"progress":{"progress":0,"total":0},"votes":{"self":"https://eucalyptus.atlassian.net/rest/api/2/issue/EUCA-13186/votes","votes":0,"hasVoted":false},"comment":{"comments":[{"self":"https://eucalyptus.atlassian.net/rest/api/2/issue/54108/comment/116936","id":"116936","author":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=lincoln.thomas","name":"lincoln.thomas","key":"lincoln.thomas","accountId":"557058:f9364c00-87ee-4948-b657-bb8f8f2030ea","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/c21bba9797b880c34a5d772e6db4664f?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dlincoln.thomas%26avatarId%3D17800%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/c21bba9797b880c34a5d772e6db4664f?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dlincoln.thomas%26avatarId%3D17800%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/c21bba9797b880c34a5d772e6db4664f?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dlincoln.thomas%26avatarId%3D17800%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/c21bba9797b880c34a5d772e6db4664f?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dlincoln.thomas%26avatarId%3D17800%26noRedirect%3Dtrue"},"displayName":"Lincoln Thomas","active":true,"timeZone":"America/Los_Angeles"},"body":"A picture's worth 1k words... see Gliffy diagram. Investigation continues...","updateAuthor":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=lincoln.thomas","name":"lincoln.thomas","key":"lincoln.thomas","accountId":"557058:f9364c00-87ee-4948-b657-bb8f8f2030ea","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/c21bba9797b880c34a5d772e6db4664f?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dlincoln.thomas%26avatarId%3D17800%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/c21bba9797b880c34a5d772e6db4664f?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dlincoln.thomas%26avatarId%3D17800%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/c21bba9797b880c34a5d772e6db4664f?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dlincoln.thomas%26avatarId%3D17800%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/c21bba9797b880c34a5d772e6db4664f?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dlincoln.thomas%26avatarId%3D17800%26noRedirect%3Dtrue"},"displayName":"Lincoln Thomas","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-02-02T21:16:26.254-0600","updated":"2017-02-02T21:16:26.254-0600"},{"self":"https://eucalyptus.atlassian.net/rest/api/2/issue/54108/comment/116944","id":"116944","author":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=lincoln.thomas","name":"lincoln.thomas","key":"lincoln.thomas","accountId":"557058:f9364c00-87ee-4948-b657-bb8f8f2030ea","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/c21bba9797b880c34a5d772e6db4664f?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dlincoln.thomas%26avatarId%3D17800%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/c21bba9797b880c34a5d772e6db4664f?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dlincoln.thomas%26avatarId%3D17800%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/c21bba9797b880c34a5d772e6db4664f?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dlincoln.thomas%26avatarId%3D17800%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/c21bba9797b880c34a5d772e6db4664f?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dlincoln.thomas%26avatarId%3D17800%26noRedirect%3Dtrue"},"displayName":"Lincoln Thomas","active":true,"timeZone":"America/Los_Angeles"},"body":"# When a snapshot is being created, it looks for the most recent snapshot (full or delta), and does a delta from that (or a full snap if we've exceeded the max). \r\n** However, snapshots that are in the \"deleting\" state are not being excluded, so it can find snapshots that are in the process of being deleted. \r\n# When a volume is being created from a snapshot 'A', it looks for the most recent full snapshot and builds the volume from that full snapshot and the deltas beyond it, up through snapshot 'A'.\r\n** However, snapshots that are in the \"deleting\" or \"deletedfromebs\" state are not being excluded, so it can find snapshots that are in the process of being deleted. \r\n\r\nCasey's script deletes all snapshots, then starts creating a snap and a volume, then a snap and a volume, etc., deleting each volume (but not snap) after creating that volume. He was running the script in series, so the snaps before the red one were created by run 'X', then run 'Y' issued deletions for all those snapshots, then started created new snaps and volumes.\r\n\r\nSnapshot deletions from EBS and OSG are lazy and are still happening when the next set of snaps and volumes are being created.\r\n\r\n_In the case found here, shown in the gliffy Timeline 1:_\r\n\r\nThe red snapshot is created incorrectly, because all the snapshot above it have been deleted (or are being deleted). It should create a new full snapshot, but it incorrectly finds snap-fd63f9a1 (upper left) which (I believe but have no proof) is in the \"deleting\" state.\r\n\r\nFurthermore, when creating a volume from that red snapshot, being a snap delta, it looks for the most recent full snapshot earlier than the red delta snapshot. It finds the wrong full snap-34d969c0 (the end of the green arrows), which (I believe) is in the \"deletingfromebs\" state, as are _some_ of the snap deltas beyond it. \r\n\r\nIt then attempts to build the volume from that wrong full snapshot and deltas, which fails when it gets to the red snapshot because it is not in the same chain of deltas.\r\n\r\n_Solution:_\r\n\r\nBy excluding snapshots in the \"deleting\" or \"deletedfromebs\" state (and the other invalid states \"creating\" and \"pending\") from being used for either snapshot delta creation or volume creation (snapshot delta reconstruction), we should not encounter this issue.\r\n\r\nIn the gliffy diagram, the corrected code would have created the red snapshot as a new full snapshot, with no green arrows except from the volume being created. Then the volume would have been created correctly from the one full snap.\r\n\r\nTrying to make a reproducer, adapting [~ccassler]'s test script, unsuccessful so far. If I continue to be unsuccessful, I could commit it anyway and use regression tests and current QA testing incl [~ccassler] and assume that if we never see it again and don't break anything, it's a good change.\r\n\r\nI have the 1-line code change here, untested: \r\nhttps://github.com/eucalyptus/eucalyptus/pull/95/files\r\nBuilding a cloud with that branch to test regression and reproducer.\r\n","updateAuthor":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=lincoln.thomas","name":"lincoln.thomas","key":"lincoln.thomas","accountId":"557058:f9364c00-87ee-4948-b657-bb8f8f2030ea","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/c21bba9797b880c34a5d772e6db4664f?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dlincoln.thomas%26avatarId%3D17800%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/c21bba9797b880c34a5d772e6db4664f?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dlincoln.thomas%26avatarId%3D17800%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/c21bba9797b880c34a5d772e6db4664f?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dlincoln.thomas%26avatarId%3D17800%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/c21bba9797b880c34a5d772e6db4664f?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dlincoln.thomas%26avatarId%3D17800%26noRedirect%3Dtrue"},"displayName":"Lincoln Thomas","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-02-03T00:25:56.263-0600","updated":"2017-02-03T08:56:59.158-0600"},{"self":"https://eucalyptus.atlassian.net/rest/api/2/issue/54108/comment/117004","id":"117004","author":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=lincoln.thomas","name":"lincoln.thomas","key":"lincoln.thomas","accountId":"557058:f9364c00-87ee-4948-b657-bb8f8f2030ea","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/c21bba9797b880c34a5d772e6db4664f?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dlincoln.thomas%26avatarId%3D17800%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/c21bba9797b880c34a5d772e6db4664f?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dlincoln.thomas%26avatarId%3D17800%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/c21bba9797b880c34a5d772e6db4664f?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dlincoln.thomas%26avatarId%3D17800%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/c21bba9797b880c34a5d772e6db4664f?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dlincoln.thomas%26avatarId%3D17800%26noRedirect%3Dtrue"},"displayName":"Lincoln Thomas","active":true,"timeZone":"America/Los_Angeles"},"body":"This may fix EUCA-13172 as well.","updateAuthor":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=lincoln.thomas","name":"lincoln.thomas","key":"lincoln.thomas","accountId":"557058:f9364c00-87ee-4948-b657-bb8f8f2030ea","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/c21bba9797b880c34a5d772e6db4664f?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dlincoln.thomas%26avatarId%3D17800%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/c21bba9797b880c34a5d772e6db4664f?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dlincoln.thomas%26avatarId%3D17800%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/c21bba9797b880c34a5d772e6db4664f?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dlincoln.thomas%26avatarId%3D17800%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/c21bba9797b880c34a5d772e6db4664f?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dlincoln.thomas%26avatarId%3D17800%26noRedirect%3Dtrue"},"displayName":"Lincoln Thomas","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-02-03T08:57:11.597-0600","updated":"2017-02-03T08:57:11.597-0600"},{"self":"https://eucalyptus.atlassian.net/rest/api/2/issue/54108/comment/117020","id":"117020","author":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=lincoln.thomas","name":"lincoln.thomas","key":"lincoln.thomas","accountId":"557058:f9364c00-87ee-4948-b657-bb8f8f2030ea","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/c21bba9797b880c34a5d772e6db4664f?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dlincoln.thomas%26avatarId%3D17800%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/c21bba9797b880c34a5d772e6db4664f?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dlincoln.thomas%26avatarId%3D17800%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/c21bba9797b880c34a5d772e6db4664f?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dlincoln.thomas%26avatarId%3D17800%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/c21bba9797b880c34a5d772e6db4664f?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dlincoln.thomas%26avatarId%3D17800%26noRedirect%3Dtrue"},"displayName":"Lincoln Thomas","active":true,"timeZone":"America/Los_Angeles"},"body":"I now believe the only change needed to original code (not my previous changes) is to add \"deleting\" to the list of exclusions for creating snapshots (DELTA_GENERATION_STATE_EXCLUSION). In that case, the red snap would have been created as a full snapshot, which would have been correct. Creating the volume would have succeeded. In the debug output, the full snap in the upper left is the only one (full or delta) that was in the \"deleting\" state rather than the \"deletedfromebs\" or \"deleted\" state, so it erroneously created the snap as a delta from that one. In further thought experiments and diagramming, this algorithm seems to hold true. Investigation continues, as will instrumented code and testing with delays to catch the issue.","updateAuthor":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=lincoln.thomas","name":"lincoln.thomas","key":"lincoln.thomas","accountId":"557058:f9364c00-87ee-4948-b657-bb8f8f2030ea","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/c21bba9797b880c34a5d772e6db4664f?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dlincoln.thomas%26avatarId%3D17800%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/c21bba9797b880c34a5d772e6db4664f?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dlincoln.thomas%26avatarId%3D17800%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/c21bba9797b880c34a5d772e6db4664f?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dlincoln.thomas%26avatarId%3D17800%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/c21bba9797b880c34a5d772e6db4664f?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dlincoln.thomas%26avatarId%3D17800%26noRedirect%3Dtrue"},"displayName":"Lincoln Thomas","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-02-03T17:06:30.871-0600","updated":"2017-02-03T17:06:30.871-0600"},{"self":"https://eucalyptus.atlassian.net/rest/api/2/issue/54108/comment/117246","id":"117246","author":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=lincoln.thomas","name":"lincoln.thomas","key":"lincoln.thomas","accountId":"557058:f9364c00-87ee-4948-b657-bb8f8f2030ea","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/c21bba9797b880c34a5d772e6db4664f?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dlincoln.thomas%26avatarId%3D17800%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/c21bba9797b880c34a5d772e6db4664f?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dlincoln.thomas%26avatarId%3D17800%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/c21bba9797b880c34a5d772e6db4664f?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dlincoln.thomas%26avatarId%3D17800%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/c21bba9797b880c34a5d772e6db4664f?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dlincoln.thomas%26avatarId%3D17800%26noRedirect%3Dtrue"},"displayName":"Lincoln Thomas","active":true,"timeZone":"America/Los_Angeles"},"body":"I was able to create a 100% reproducer, but I had to insert a delay between cleaning up snapshots from EBS and from OSG, which normally happen immediately in series. This delay simulates an SC heavily loaded with cleanup tasks.\r\n\r\nThe Eucalyptus code changes are here: https://github.com/eucalyptus/eucalyptus/pull/96\r\n\r\nThe inserted code to {{SnapshotDeleter#run}} added temporarily to run the reproducer is the \"try\" block below:\r\n\r\n*_Note: This is diagnostic code created only to run the reproducer, it's not committed into the Eucalyptus code repository. Shown here only for anyone trying to re-create this reproducer on the old/new code._*\r\n\r\n{noformat}\r\n  public void run() {\r\n    // Clean up on EBS backend\r\n    deleteFromEBS();\r\n    // EUCA-13186 patch, to delay deletions from OSG, to give more time for snapshots to be\r\n    // in 'deletedfromebs' state to simulate heavy deletion load\r\n    try {\r\n      LOG.debug(\"Waiting 2 minutes before deleting from OSG\");\r\n      Thread.sleep(120000);\r\n    } catch (InterruptedException e) {\r\n      LOG.error(\"SnapshotDeleter interrupted while sleeping between delete from EBS and OSG\");\r\n      return;\r\n    }\r\n    // end of EUCA-13186 patch\r\n    // Clean up on OSG\r\n    deleteFromOSG();\r\n  }\r\n{noformat}\r\n\r\nThe test requires two zones (SCs) that use different Ceph clusters for block storage.\r\n\r\nThe manual test steps are:\r\n\r\nOn SC1:\r\n# tail -f /var/log/eucalyptus/cloud-debug.log | grep \"originates from this az, acquire semaphore before deletion\" \r\n\r\nOn CLC:\r\n# euctl one.storage.maxsnapshotdeltas=2\r\n# euctl two.storage.maxsnapshotdeltas=2\r\n# euca-create-volume -z one -s 1\r\n# vol=vol-faf1be83    (insert the returned new volume name)\r\n# euca-describe-volumes $vol    (wait for volume to become available)\r\n# euca-create-snapshot -d full-A $vol\r\n# euca-describe-snapshots    (wait for snapshot to become completed)\r\n# euca-create-snapshot -d delta-A1 $vol\r\n# euca-describe-snapshots\r\n# euca-create-snapshot -d delta-A2 $vol\r\n# euca-describe-snapshots\r\n# euca-create-snapshot -d full-B $vol\r\n# euca-describe-snapshots\r\n# euca-create-snapshot -d delta-B1 $vol\r\n# euca-describe-snapshots\r\n# euca-delete-snapshot snap-0cdeecff; euca-delete-snapshot snap-4d0271eb; euca-delete-snapshot snap-60e5fbea; euca-delete-snapshot snap-9a0f3603    (Use the snapshot IDs for A1, A2, B, and B1, but NOT A)\r\n\r\nOn SC1:\r\n# Wait for those 4 snapshots to appear in the tail output, indicating they have been moved from 'deleting' to 'deletedfromebs'\r\n\r\nOn CLC, before those snapshots are deleted from OSG (2 minutes after that tail output appears):\r\n# euca-delete-snapshot snap-9ba3e8db    (the A snapshot)\r\n# euca-create-snapshot -d snap-X $vol\r\n# euca-describe-snapshots\r\n# euca-create-volume -z two --snapshot snap-d6628cd0    (the returned snapshot)\r\n# euca-describe-volumes vol-cefedd9a    (the returned volume from snap)\r\n\r\nWith the old code, the volume will eventually change to the \"failed\" state.\r\nOn SC2, you will get output in cloud-debug.log like:\r\n\r\n{noformat}\r\nTue Feb 7 21:22:11 2017 DEBUG [S3SnapshotTransfer:eucalyptus-storage-volumecreator-worker-742] Dowloading snapshot from objectstorage: snapshotId=snap-9a0f3603, bucket=snapshots-f397bf11bbc741279361eee21e29bd0\\\r\nf, key=snap-9a0f3603\r\nTue Feb 7 21:22:11 2017 DEBUG [SANManager:eucalyptus-storage-volumecreator-worker-742] Applying snapshot delta between snap-9a0f3603 and snap-60e5fbea on base tempsnap/snap-d6628cd0\r\nTue Feb 7 21:22:11 2017  INFO [CephRbdProvider:eucalyptus-storage-volumecreator-worker-742] Restoring delta on base=tempsnap/snap-d6628cd0, snapshotId=snap-9a0f3603, snapsDeltaFile=/var/tmp/snap-9a0f3603_snap-\\\r\n60e5fbea_446009444776996797.diff\r\nTue Feb 7 21:22:11 2017 DEBUG [CephRbdProvider:eucalyptus-storage-volumecreator-worker-742] Executing: ///usr/lib/eucalyptus/euca_rootwrap rbd --id qatemp --keyring /etc/ceph/ceph.client.qatemp.keyring import-\\\r\ndiff /var/tmp/snap-9a0f3603_snap-60e5fbea_446009444776996797.diff tempsnap/snap-d6628cd0\r\nTue Feb 7 21:22:12 2017 DEBUG [CephRbdProvider:eucalyptus-storage-volumecreator-worker-742] Dump from rbd command:\r\nReturn value=0\r\nOutput=\r\nDebug=^MImporting image diff: 51% complete...^MImporting image diff: 86% complete...^MImporting image diff: 98% complete...^MImporting image diff: 100% complete...done.\r\n\r\nTue Feb 7 21:22:12 2017  INFO [VolumeCreator:eucalyptus-storage-volumecreator-worker-742] Download snap-d6628cd0 (delta from snap-9a0f3603) and restore it on snap-d6628cd0\r\nTue Feb 7 21:22:12 2017 DEBUG [S3SnapshotTransfer:eucalyptus-storage-volumecreator-worker-742] Dowloading snapshot from objectstorage: snapshotId=snap-d6628cd0, bucket=snapshots-f397bf11bbc741279361eee21e29bd0\\\r\nf, key=snap-d6628cd0\r\nTue Feb 7 21:22:12 2017 DEBUG [SANManager:eucalyptus-storage-volumecreator-worker-742] Applying snapshot delta between snap-d6628cd0 and snap-9a0f3603 on base tempsnap/snap-d6628cd0\r\nTue Feb 7 21:22:12 2017  INFO [CephRbdProvider:eucalyptus-storage-volumecreator-worker-742] Restoring delta on base=tempsnap/snap-d6628cd0, snapshotId=snap-d6628cd0, snapsDeltaFile=/var/tmp/snap-d6628cd0_snap-\\\r\n9a0f3603_6462489029741744937.diff\r\nTue Feb 7 21:22:12 2017 DEBUG [CephRbdProvider:eucalyptus-storage-volumecreator-worker-742] Executing: ///usr/lib/eucalyptus/euca_rootwrap rbd --id qatemp --keyring /etc/ceph/ceph.client.qatemp.keyring import-\\\r\ndiff /var/tmp/snap-d6628cd0_snap-9a0f3603_6462489029741744937.diff tempsnap/snap-d6628cd0\r\nTue Feb 7 21:22:12 2017 DEBUG [CephRbdProvider:eucalyptus-storage-volumecreator-worker-742] Dump from rbd command:\r\nReturn value=22\r\nOutput=\r\nDebug=start snapshot 'sp-for-snap-9ba3e8db' does not exist in the image, aborting\r\n^MImporting image diff: 0% complete...failed.\r\nrbd: import-diff failed: (22) Invalid argument\r\n\r\nTue Feb 7 21:22:12 2017  WARN [CephRbdProvider:eucalyptus-storage-volumecreator-worker-742] Failed to apply snapshot delta on tempsnap/snap-d6628cd0\r\ncom.eucalyptus.util.EucalyptusCloudException: Unable to execute rbd command. Failed with error:\r\nstart snapshot 'sp-for-snap-9ba3e8db' does not exist in the image, aborting\r\n\r\nImporting image diff: 0% complete...failed.\r\nrbd: import-diff failed: (22) Invalid argument\r\n\r\n        at com.eucalyptus.blockstorage.ceph.CephRbdProvider.restoreSnapshotDelta(CephRbdProvider.java:713)\r\n        at com.eucalyptus.blockstorage.san.common.SANManager.restoreSnapshotDelta(SANManager.java:1413)\r\n        at com.eucalyptus.blockstorage.async.VolumeCreator.downloadAndRestoreDelta(VolumeCreator.java:631)\r\n        at com.eucalyptus.blockstorage.async.VolumeCreator.run(VolumeCreator.java:256)\r\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\r\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\r\n        at java.lang.Thread.run(Thread.java:745)\r\nTue Feb 7 21:22:12 2017  WARN [SANManager:eucalyptus-storage-volumecreator-worker-742] Failed to apply delta between snap-d6628cd0 and snap-9a0f3603 on base tempsnap/snap-d6628cd0\r\nTue Feb 7 21:22:12 2017 ERROR [VolumeCreator:eucalyptus-storage-volumecreator-worker-742] Failed to create volume vol-cefedd9a\r\ncom.eucalyptus.util.EucalyptusCloudException: Failed to apply delta between snap-d6628cd0 and snap-9a0f3603 on base tempsnap/snap-d6628cd0\r\n        at com.eucalyptus.blockstorage.san.common.SANManager.restoreSnapshotDelta(SANManager.java:1416)\r\n        at com.eucalyptus.blockstorage.async.VolumeCreator.downloadAndRestoreDelta(VolumeCreator.java:631)\r\n        at com.eucalyptus.blockstorage.async.VolumeCreator.run(VolumeCreator.java:256)\r\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\r\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\r\n        at java.lang.Thread.run(Thread.java:745)\r\n{noformat}\r\n\r\nThe error occurs because the creation of the snap-X uses the latest snapshot in the 'deleting' or 'available' state, finding snap A which is 'deleting'. However, when a volume is created from this snapshot (in the other zone, which requires downloading snaps and deltas from OSG), it looks for the most recent full snapshot NOT in the 'deleted' state, and finds B which is in the 'deletedfromebs' state. It starts the construction with B, then applies B1, but then attempting to apply snap-X fails because its parent snapshot is A, not a delta from B1.\r\n\r\nWith the fixed code, the volume will eventually change to the \"available\" state.\r\nOn SC2, you will see no errors in cloud-debug.log.\r\n\r\nIn the new code, snap-X does not pick any existing snapshot because they are all in some 'delet*' state, so it creates a new full snapshot, which is used correctly when constructing the new volume from it.\r\n\r\nA general reproducer to cause an error in the old code without this diagnostic patch will be hard to achieve since it requires an SC heavily loaded with deletions of volumes and snapshots while creating a new snapshot and volume from it. \r\n\r\nHints:\r\n* Set max snaps to a low number like 2, so there's lots of other full snaps that might be in the 'deleting' state (waiting to be cleaned up) rather than 'deletedfromebs'.\r\n* After creating lots of snapshots and volumes from them, delete all the volumes and snapshots all at once at the end (instead of deleting a volume after creating it), which will cause a lot of SC work in cleanup, slowing down the common worker. Wait 1 minute before creating new snapshots and volumes, for the cleaners to begin.\r\n\r\nNew diagram of this test sequence is here as \"Timeline 2\".\r\nRegression testing of new successful.","updateAuthor":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=lincoln.thomas","name":"lincoln.thomas","key":"lincoln.thomas","accountId":"557058:f9364c00-87ee-4948-b657-bb8f8f2030ea","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/c21bba9797b880c34a5d772e6db4664f?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dlincoln.thomas%26avatarId%3D17800%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/c21bba9797b880c34a5d772e6db4664f?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dlincoln.thomas%26avatarId%3D17800%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/c21bba9797b880c34a5d772e6db4664f?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dlincoln.thomas%26avatarId%3D17800%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/c21bba9797b880c34a5d772e6db4664f?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dlincoln.thomas%26avatarId%3D17800%26noRedirect%3Dtrue"},"displayName":"Lincoln Thomas","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-02-08T01:52:38.868-0600","updated":"2017-02-08T16:02:22.663-0600"},{"self":"https://eucalyptus.atlassian.net/rest/api/2/issue/54108/comment/118306","id":"118306","author":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=ccassler","name":"ccassler","key":"ccassler","accountId":"557058:8fb32702-a3cf-42d3-9846-95c74f801354","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/ace94e80ebc0a3b718cc5422760b57de?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dccassler%26avatarId%3D14700%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/ace94e80ebc0a3b718cc5422760b57de?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dccassler%26avatarId%3D14700%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/ace94e80ebc0a3b718cc5422760b57de?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dccassler%26avatarId%3D14700%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/ace94e80ebc0a3b718cc5422760b57de?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dccassler%26avatarId%3D14700%26noRedirect%3Dtrue"},"displayName":"Casey Cassler","active":true,"timeZone":"America/Los_Angeles"},"body":"I am no longer able to reproduce using different versions of my automated scripts.  My original script no longer reproduces this and a modified version that creates 35 snapshots and 35 volumes of the snapshots and then deletes them.  Fix verified.\r\n{code}\r\n[root@b-25 ~]# rpm -qi eucalyptus\r\nName        : eucalyptus\r\nVersion     : 4.4.0\r\nRelease     : 0.25808.161.20170217git82fb574.el7\r\nArchitecture: x86_64\r\nInstall Date: Fri 17 Feb 2017 02:52:52 PM PST\r\nGroup       : Unspecified\r\nSize        : 248082\r\nLicense     : GPLv3\r\nSignature   : (none)\r\nSource RPM  : eucalyptus-4.4.0-0.25808.161.20170217git82fb574.el7.src.rpm\r\nBuild Date  : Fri 17 Feb 2017 12:48:32 PM PST\r\nBuild Host  : buildsys.qa1.eucalyptus-systems.com\r\n{code}","updateAuthor":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=ccassler","name":"ccassler","key":"ccassler","accountId":"557058:8fb32702-a3cf-42d3-9846-95c74f801354","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/ace94e80ebc0a3b718cc5422760b57de?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dccassler%26avatarId%3D14700%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/ace94e80ebc0a3b718cc5422760b57de?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dccassler%26avatarId%3D14700%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/ace94e80ebc0a3b718cc5422760b57de?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dccassler%26avatarId%3D14700%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/ace94e80ebc0a3b718cc5422760b57de?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dccassler%26avatarId%3D14700%26noRedirect%3Dtrue"},"displayName":"Casey Cassler","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-02-28T13:19:34.268-0600","updated":"2017-02-28T13:19:34.268-0600"},{"self":"https://eucalyptus.atlassian.net/rest/api/2/issue/54108/comment/119258","id":"119258","author":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=lbiasi","name":"lbiasi","key":"lbiasi","accountId":"557058:daaebf52-3713-4e4f-a29b-79f55aed32c9","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/3d92822583af436915b8264dbff0d30a?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dlbiasi%26avatarId%3D15002%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/3d92822583af436915b8264dbff0d30a?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dlbiasi%26avatarId%3D15002%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/3d92822583af436915b8264dbff0d30a?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dlbiasi%26avatarId%3D15002%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/3d92822583af436915b8264dbff0d30a?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dlbiasi%26avatarId%3D15002%26noRedirect%3Dtrue"},"displayName":"Leslie Biasi","active":false,"timeZone":"US/Central"},"body":"Moving 4.4.0 Issues from Release Pending to Resolved","updateAuthor":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=lbiasi","name":"lbiasi","key":"lbiasi","accountId":"557058:daaebf52-3713-4e4f-a29b-79f55aed32c9","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/3d92822583af436915b8264dbff0d30a?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dlbiasi%26avatarId%3D15002%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/3d92822583af436915b8264dbff0d30a?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dlbiasi%26avatarId%3D15002%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/3d92822583af436915b8264dbff0d30a?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dlbiasi%26avatarId%3D15002%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/3d92822583af436915b8264dbff0d30a?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dlbiasi%26avatarId%3D15002%26noRedirect%3Dtrue"},"displayName":"Leslie Biasi","active":false,"timeZone":"US/Central"},"created":"2017-03-15T23:14:51.471-0500","updated":"2017-03-15T23:14:51.471-0500"}],"maxResults":7,"total":7,"startAt":0},"customfield_11808":null,"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]}}}