{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"28711","self":"https://eucalyptus.atlassian.net/rest/api/2/issue/28711","key":"EUCA-9069","fields":{"issuetype":{"self":"https://eucalyptus.atlassian.net/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://eucalyptus.atlassian.net/secure/viewavatar?size=xsmall&avatarId=14803&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":14803},"timespent":null,"customfield_13100":null,"project":{"self":"https://eucalyptus.atlassian.net/rest/api/2/project/10000","id":"10000","key":"EUCA","name":"Eucalyptus","avatarUrls":{"48x48":"https://eucalyptus.atlassian.net/secure/projectavatar?pid=10000&avatarId=10011","24x24":"https://eucalyptus.atlassian.net/secure/projectavatar?size=small&pid=10000&avatarId=10011","16x16":"https://eucalyptus.atlassian.net/secure/projectavatar?size=xsmall&pid=10000&avatarId=10011","32x32":"https://eucalyptus.atlassian.net/secure/projectavatar?size=medium&pid=10000&avatarId=10011"}},"customfield_11000":null,"fixVersions":[],"customfield_11001":null,"aggregatetimespent":null,"customfield_10310":null,"resolution":{"self":"https://eucalyptus.atlassian.net/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_10311":null,"customfield_11401":null,"customfield_11400":null,"customfield_10104":[],"customfield_10500":{"self":"https://eucalyptus.atlassian.net/rest/api/2/customFieldOption/10400","value":"Premium","id":"10400"},"customfield_10302":null,"customfield_10105":{"self":"https://eucalyptus.atlassian.net/rest/api/2/customFieldOption/10101","value":"No","id":"10101"},"customfield_10303":null,"customfield_10304":null,"customfield_10700":null,"customfield_10701":null,"customfield_10702":null,"customfield_10306":{"self":"https://eucalyptus.atlassian.net/rest/api/2/customFieldOption/10200","value":"High","id":"10200"},"customfield_10703":null,"resolutiondate":"2016-11-21T18:19:33.064-0600","customfield_10704":null,"customfield_10308":null,"customfield_10309":null,"customfield_10705":null,"workratio":-1,"lastViewed":null,"watches":{"self":"https://eucalyptus.atlassian.net/rest/api/2/issue/EUCA-9069/watchers","watchCount":5,"isWatching":false},"created":"2014-04-04T12:36:39.420-0500","customfield_12000":null,"priority":{"self":"https://eucalyptus.atlassian.net/rest/api/2/priority/2","iconUrl":"https://eucalyptus.atlassian.net/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"customfield_12400":null,"customfield_12201":null,"customfield_10300":null,"customfield_12600":"{}","customfield_10102":null,"customfield_10301":null,"labels":[],"customfield_11700":null,"aggregatetimeoriginalestimate":null,"timeestimate":null,"versions":[{"self":"https://eucalyptus.atlassian.net/rest/api/2/version/13700","id":"13700","description":"Eucalyptus 3.4.2","name":"3.4.2","archived":false,"released":true,"releaseDate":"2014-02-24"}],"customfield_11901":null,"issuelinks":[],"assignee":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=dmitrii","name":"dmitrii","key":"dmitrii","accountId":"557058:1e0ea807-434b-4b54-967f-1dec4a9ede55","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/efb56b507e22d4fc0d8d5e900e5651d5?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Ddmitrii%26avatarId%3D15900%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/efb56b507e22d4fc0d8d5e900e5651d5?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Ddmitrii%26avatarId%3D15900%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/efb56b507e22d4fc0d8d5e900e5651d5?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Ddmitrii%26avatarId%3D15900%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/efb56b507e22d4fc0d8d5e900e5651d5?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Ddmitrii%26avatarId%3D15900%26noRedirect%3Dtrue"},"displayName":"Dmitrii Calzago","active":false,"timeZone":"America/Los_Angeles"},"updated":"2016-11-21T18:19:33.071-0600","status":{"self":"https://eucalyptus.atlassian.net/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://eucalyptus.atlassian.net/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://eucalyptus.atlassian.net/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://eucalyptus.atlassian.net/rest/api/2/component/10010","id":"10010","name":"Node Controller"}],"timeoriginalestimate":null,"description":"*NOTE*\r\nThis ticket and the investigation focuses on the error message:\r\n- failed to remove some artifacts in /var/lib/eucalyptus/instances/work/<random>/<instance ID> \r\n\r\n*Assessment*\r\n\r\nCloud is throwing various ERROR messages on the NC, not the least of which pertains to failing to remove artifacts.  \r\n\r\n*Signs*\r\n\r\nThe following ERROR messages on the NC:\r\n\r\n- failed to remove some artifacts in /var/lib/eucalyptus/instances/work/<random>/<instance ID> \r\n- failed to allocate artifact <kernel ID> (12 blobstore.c:1057 unknown error) on try 1 \r\n- failed to create a pipe \r\n- error: failed to create pipe for stderr: Too many open files \r\n- failed to write instance XML to /var/lib/eucalyptus/instances/work/<random>/<instance>/instance.xml\r\n\r\n*Actions*\r\n\r\n- reviewed nc.log \r\n- checked ulimit\r\n\r\n*Pertinent Data*\r\n\r\nNode controllers are getting messy and leaving behind artifacts (loopbacks, device mapper entries). Snippet from logs showing some errors:\r\n\r\n{code}\r\n2014-02-20 16:00:33 ERROR | [i-5BA243F9] failed to remove some artifacts in /var/lib/eucalyptus/instances/work/AIDG0UUPV7VVY2T57FNNK/i-5BA243F9 \r\n2014-02-20 16:00:33 INFO | [i-5BA243F9] stopping the network (vlan=38) \r\n2014-02-20 16:00:33 WARN | libvirt: Domain not found: no domain with matching name 'i-347441BC' (code=42) \r\n2014-02-20 16:00:33 INFO | [i-347441BC] cleaning up state for instance \r\n2014-02-20 16:00:34 ERROR | [i-347441BC] failed to remove some artifacts in /var/lib/eucalyptus/instances/work/AIDHTYISEIUBZHQTKQ7SA/i-347441BC \r\n2014-02-20 16:00:34 WARN | [i-347441BC] failed to remove backing directory /var/lib/eucalyptus/instances/work/AIDHTYISEIUBZHQTKQ7SA/i-347441BC \r\n2014-02-20 16:00:34 INFO | [i-347441BC] stopping the network (vlan=76) \r\n2014-02-20 16:00:46 INFO | [i-56103E13] running instance cores=1 disk=5 memory=256 vlan=89 net=91 priMAC=D0:0D:56:10:3E:13 privIp=10.200.43.219 plat=linux kernel=(null) ramdisk=(null) \r\n2014-02-20 16:00:46 INFO | creating path /var/lib/eucalyptus/instances/work/AIDQSTHYMPZZIDC8S4YPK/i-56103E13 \r\n2014-02-20 16:00:46 INFO | downloading http://192.168.249.20:8773/services/Walrus/centos-starter/vmlinuz-2.6.32-358.11.1.el6.x86_64.manifest.xml \r\n2014-02-20 16:00:46 INFO | downloaded /tmp/walrus-digest-15FAud \r\n2014-02-20 16:00:46 INFO | downloading http://192.168.249.20:8773/services/Walrus/centos-starter/initramfs-2.6.32-358.11.1.el6.x86_64.img.manifest.xml \r\n2014-02-20 16:00:46 INFO | downloaded /tmp/walrus-digest-211mGB \r\n2014-02-20 16:00:46 INFO | downloading http://192.168.249.20:8773/services/Walrus/centos-starter/euca-centos6.4-ec2user-2013.07.12-x86_64.img.manifest.xml \r\n2014-02-20 16:00:46 INFO | downloaded /tmp/walrus-digest-wKPS0Z \r\n2014-02-20 16:00:46 ERROR | [i-56103E13] failed to allocate artifact eki-9C5B381E-c3a4ada6 (12 blobstore.c:1057 unknown error) on try 1 \r\n2014-02-20 16:00:46 ERROR | failed to create a pipe \r\n2014-02-20 16:00:47 ERROR | failed to create a pipe \r\n2014-02-20 16:00:48 ERROR | failed to create a pipe \r\n2014-02-20 16:00:49 ERROR | failed to create a pipe \r\n2014-02-20 16:00:49 FATAL | hooks prevented check on the hypervisor \r\n2014-02-20 16:00:50 ERROR | failed to create a pipe \r\n2014-02-20 16:00:51 ERROR | failed to create a pipe \r\n2014-02-20 16:00:52 ERROR | failed to create a pipe \r\n2014-02-20 16:00:53 ERROR | failed to create a pipe \r\n2014-02-20 16:00:54 ERROR | failed to create a pipe \r\n2014-02-20 16:00:54 FATAL | hooks prevented check on the hypervisor \r\n2014-02-20 16:00:55 WARN | cannot detach loop device \r\n2014-02-20 16:00:55 ERROR | [i-56103E13] failed to provision dependency eki-9C5B381E-c3a4ada6 for artifact i-56103E13 (error=12) on try 1 \r\n2014-02-20 16:00:55 ERROR | [i-56103E13] failed to implement backing for instance \r\n2014-02-20 16:00:55 ERROR | [i-56103E13] failed to prepare images for instance (error=1) \r\n2014-02-20 16:01:00 WARN | libvirt: Domain not found: no domain with matching name 'i-56103E13' (code=42) \r\n2014-02-20 16:01:00 INFO | [i-56103E13] cleaning up state for instance \r\n2014-02-20 16:01:00 INFO | [i-56103E13] stopping the network (vlan=89) \r\n2014-02-20 16:01:05 ERROR | error: failed to create pipe for stderr: Too many open files \r\n2014-02-20 16:01:05 WARN | invocation 'blkid /var/lib/eucalyptus/instances/work/AIDSFIORXQE1G9ZUUNH9B/i-8AEA42D7/link-to-sda' failed with -1 (attempt 1) \r\n2014-02-20 16:01:05 ERROR | error: failed to create pipe for stdout: Too many open files \r\n2014-02-20 16:01:05 WARN | invocation 'blkid /var/lib/eucalyptus/instances/work/AIDSFIORXQE1G9ZUUNH9B/i-8AEA42D7/link-to-sda' failed with -1 (attempt 2) \r\n2014-02-20 16:01:05 ERROR | error: failed to create pipe for stdout: Too many open files \r\n2014-02-20 16:01:05 WARN | invocation 'blkid /var/lib/eucalyptus/instances/work/AIDSFIORXQE1G9ZUUNH9B/i-8AEA42D7/link-to-sda' failed with -1 (attempt 3) \r\n2014-02-20 16:01:05 ERROR | [i-8AEA42D7] failed to write instance XML to /var/lib/eucalyptus/instances/work/AIDSFIORXQE1G9ZUUNH9B/i-8AEA42D7/instance.xml \r\n2014-02-20 16:01:10 FATAL | hooks prevented check on the hypervisor \r\n2014-02-20 16:01:13 INFO | [i-840743B1] running instance cores=1 disk=10 memory=1024 vlan=76 net=59 priMAC=D0:0D:84:07:43:B1 privIp=10.200.37.59 plat=linux kernel=(null) ramdisk=(null)\r\n{code}\r\n\r\nThis is part of a wider problem, I have attached the nc.log (/var/log/eucalyptus/nc.log) in question (inside sosreport). A good instance to track is i-347441BC since I still have such artifacts on the system. Note the complaint about too many open files. My ulimit is pretty low:\r\n\r\n{code}\r\n[root@ecc-node-0 ~]# ulimit -Hn; ulimit -Sn \r\n4096 \r\n1024\r\n{code}\r\n\r\n1024 is actually crazy low I think, we should be bumping this up as part of the eucalyptus-nc install or even just the init script (although sysctl.conf editing would be better). It means each process has a soft limit of 1024. Currently I'm getting this readout from the system for lsof against given processes:\r\n\r\n{code}\r\n[root@ecc-node-0 ~]# lsof | awk '{ print $2; }' | sort -rn | uniq -c | sort -rn | head \r\n125 1994 \r\n100 3128 \r\n97 3212 \r\n85 9120 \r\n85 858 \r\n85 31509 \r\n58 6342 \r\n58 17369 \r\n48 9072 \r\n45 2008\r\n{code}\r\n\r\nAnyhow, after these failures at termination time the problem is that we don't clean up resources:\r\n\r\n{code}\r\n/dev/loop0: [fd02]:10092603 (/var/lib/eucalyptus/instances/work/AIDG0UUPV7VVY2T57FNNK/i-5BA*) \r\n/dev/loop1: [fd02]:10747912 (/var/lib/eucalyptus/instances/work/AIDHTYISEIUBZHQTKQ7SA/i-347*) \r\n/dev/loop2: [fd02]:10354714 (/var/lib/eucalyptus/instances/work/AIDHU807MJNLIZF7UCJ8C/i-C9D*) \r\n/dev/loop3: [fd02]:10747908 (/var/lib/eucalyptus/instances/work/AIDHTYISEIUBZHQTKQ7SA/i-347*) \r\n/dev/loop4: [fd02]:11010073 (/var/lib/eucalyptus/instances/cache/prt-00512swap-ac8d5670/blo*) \r\n/dev/loop5: [fd02]:11010126 (/var/lib/eucalyptus/instances/cache/prt-02858ext3-5c099eef/blo*) \r\n/dev/loop6: [fd02]:10354721 (/var/lib/eucalyptus/instances/work/AIDHU807MJNLIZF7UCJ8C/i-C9D*) \r\n/dev/loop7: [fd02]:10354728 (/var/lib/eucalyptus/instances/work/AIDHU807MJNLIZF7UCJ8C/i-C9D*) \r\n/dev/loop8: [fd02]:10354737 (/var/lib/eucalyptus/instances/work/AIDHU807MJNLIZF7UCJ8C/i-C9D*) \r\n/dev/loop9: [fd02]:10092560 (/var/lib/eucalyptus/instances/work/AIDHMCVEC2DDT5C3NJO7B/i-F79*) \r\n/dev/loop10: [fd02]:10092569 (/var/lib/eucalyptus/instances/work/AIDHMCVEC2DDT5C3NJO7B/i-F79*) \r\n/dev/loop11: [fd02]:10092577 (/var/lib/eucalyptus/instances/work/AIDHMCVEC2DDT5C3NJO7B/i-F79*) \r\n/dev/loop12: [fd02]:10092585 (/var/lib/eucalyptus/instances/work/AIDHMCVEC2DDT5C3NJO7B/i-F79*) \r\n/dev/loop14: [fd02]:11010111 (/var/lib/eucalyptus/instances/cache/emi-F477344D-560943bc/bloc*) \r\n/dev/loop20: [fd02]:10092622 (/var/lib/eucalyptus/instances/work/AIDG0UUPV7VVY2T57FNNK/i-F5E*) \r\n/dev/loop21: [fd02]:11010150 (/var/lib/eucalyptus/instances/cache/prt-07978ext3-2c4dffe4/blo*) \r\n/dev/loop22: [fd02]:10092629 (/var/lib/eucalyptus/instances/work/AIDG0UUPV7VVY2T57FNNK/i-F5E*) \r\n/dev/loop23: [fd02]:10092637 (/var/lib/eucalyptus/instances/work/AIDG0UUPV7VVY2T57FNNK/i-F5E*) \r\n/dev/loop24: [fd02]:10092645 (/var/lib/eucalyptus/instances/work/AIDG0UUPV7VVY2T57FNNK/i-F5E*) \r\n/dev/loop27: [fd02]:11010166 (/var/lib/eucalyptus/instances/cache/emi-B7ED33E9-45292f1f/bloc*) \r\n/dev/loop28: [fd02]:10747916 (/var/lib/eucalyptus/instances/work/AIDHTYISEIUBZHQTKQ7SA/i-347*) \r\n/dev/loop29: [fd02]:11010158 (/var/lib/eucalyptus/instances/cache/prt-08078ext3-ef112f02/blo*) \r\n/dev/loop30: [fd02]:10747923 (/var/lib/eucalyptus/instances/work/AIDHTYISEIUBZHQTKQ7SA/i-347*) \r\n/dev/loop31: [fd02]:10747930 (/var/lib/eucalyptus/instances/work/AIDHTYISEIUBZHQTKQ7SA/i-347*) \r\n/dev/loop32: [fd02]:10747937 (/var/lib/eucalyptus/instances/work/AIDHTYISEIUBZHQTKQ7SA/i-347*)\r\n{code}\r\n\r\nSee the i-347* entries. Next, dmsetup ls:\r\n\r\n{code}\r\n[root@ecc-node-0 ~]# dmsetup ls \r\neuca-AIDHU807MJNLIZF7UCJ8C-i-C9D6439B-emi-F477344D-8a9f90a7-p0-back (253:3) \r\neuca-AIDG0UUPV7VVY2T57FNNK-i-F5E645E2-prt-07978ext3-2c4dffe4-p0-back (253:52) \r\neuca-AIDHMCVEC2DDT5C3NJO7B-i-F79640B2-dsk-F477344D-6c193ab9p3 (253:33) \r\nvg01-lv_swap (253:0) \r\neuca-AIDHMCVEC2DDT5C3NJO7B-i-F79640B2-emi-F477344D-8a9f90a7-p0-back (253:19) \r\neuca-AIDG0UUPV7VVY2T57FNNK-i-F5E645E2-emi-F477344D-1cde527d-p0-snap (253:50) \r\nvg01-lv_root (253:1) \r\neuca-AIDHTYISEIUBZHQTKQ7SA-i-347441BC-emi-B7ED33E9-8a9f90a7-p0-snap (253:80) \r\neuca-AIDHMCVEC2DDT5C3NJO7B-i-F79640B2-dsk-F477344D-6c193ab9p2 (253:32) \r\neuca-AIDHU807MJNLIZF7UCJ8C-i-C9D6439B-prt-02858ext3-5c099eef-p0-back (253:6) \r\neuca-AIDHTYISEIUBZHQTKQ7SA-i-347441BC-dsk-B7ED33E9-f6604bb3-p0-back (253:88) \r\neuca-AIDG0UUPV7VVY2T57FNNK-i-F5E645E2-dsk-F477344D-6238dc41-p0-back (253:58) \r\neuca-AIDHU807MJNLIZF7UCJ8C-i-C9D6439B-dsk-F477344D-6c193ab9-p0-back (253:13) \r\neuca-AIDHMCVEC2DDT5C3NJO7B-i-F79640B2-dsk-F477344D-6c193ab9p1 (253:31) \r\neuca-AIDHU807MJNLIZF7UCJ8C-i-C9D6439B-emi-F477344D-8a9f90a7 (253:5) \r\neuca-AIDG0UUPV7VVY2T57FNNK-i-F5E645E2-prt-07978ext3-2c4dffe4 (253:54) \r\neuca-AIDHMCVEC2DDT5C3NJO7B-i-F79640B2-dsk-F477344D-6c193ab9-p0-back (253:28) \r\neuca-AIDHMCVEC2DDT5C3NJO7B-i-F79640B2-prt-00512swap-ac8d5670-p0-back (253:25) \r\neuca-AIDHU807MJNLIZF7UCJ8C-i-C9D6439B-prt-02858ext3-5c099eef (253:8) \r\neuca-AIDHTYISEIUBZHQTKQ7SA-i-347441BC-dsk-B7ED33E9-f6604bb3 (253:90) \r\neuca-AIDHTYISEIUBZHQTKQ7SA-i-347441BC-prt-00512swap-ac8d5670-p0-back (253:85) \r\neuca-AIDHTYISEIUBZHQTKQ7SA-i-347441BC-emi-B7ED33E9-8a9f90a7 (253:81) \r\neuca-AIDHMCVEC2DDT5C3NJO7B-i-F79640B2-prt-02858ext3-5c099eef-p0-snap (253:23) \r\neuca-AIDG0UUPV7VVY2T57FNNK-i-F5E645E2-prt-00512swap-ac8d5670-p0-back (253:55) \r\neuca-AIDHU807MJNLIZF7UCJ8C-i-C9D6439B-dsk-F477344D-6c193ab9 (253:15) \r\neuca-AIDHU807MJNLIZF7UCJ8C-i-C9D6439B-dsk-F477344D-6c193ab9p3 (253:18) \r\neuca-AIDHTYISEIUBZHQTKQ7SA-i-347441BC-prt-08078ext3-ef112f02-p0-snap (253:83) \r\neuca-AIDHU807MJNLIZF7UCJ8C-i-C9D6439B-dsk-F477344D-6c193ab9p2 (253:17) \r\neuca-AIDHU807MJNLIZF7UCJ8C-i-C9D6439B-prt-00512swap-ac8d5670-p0-back (253:9) \r\neuca-AIDHU807MJNLIZF7UCJ8C-i-C9D6439B-emi-F477344D-8a9f90a7-p0-snap (253:4) \r\neuca-AIDG0UUPV7VVY2T57FNNK-i-F5E645E2-prt-07978ext3-2c4dffe4-p0-snap (253:53) \r\neuca-AIDHTYISEIUBZHQTKQ7SA-i-347441BC-prt-00512swap-ac8d5670 (253:87) \r\neuca-AIDG0UUPV7VVY2T57FNNK-i-F5E645E2-prt-00512swap-ac8d5670 (253:57) \r\neuca-AIDHMCVEC2DDT5C3NJO7B-i-F79640B2-emi-F477344D-8a9f90a7-p0-snap (253:20) \r\neuca-AIDHU807MJNLIZF7UCJ8C-i-C9D6439B-dsk-F477344D-6c193ab9p1 (253:16) \r\neuca-AIDHMCVEC2DDT5C3NJO7B-i-F79640B2-prt-02858ext3-5c099eef (253:24) \r\neuca-AIDHU807MJNLIZF7UCJ8C-i-C9D6439B-prt-02858ext3-5c099eef-p0-snap (253:7) \r\neuca-AIDHTYISEIUBZHQTKQ7SA-i-347441BC-dsk-B7ED33E9-f6604bb3-p0-snap (253:89) \r\nvg01-lv_instances (253:2) \r\neuca-AIDG0UUPV7VVY2T57FNNK-i-F5E645E2-dsk-F477344D-6238dc41-p0-snap (253:59) \r\neuca-AIDHTYISEIUBZHQTKQ7SA-i-347441BC-prt-08078ext3-ef112f02 (253:84) \r\neuca-AIDG0UUPV7VVY2T57FNNK-i-F5E645E2-emi-F477344D-1cde527d-p0-back (253:49) \r\neuca-AIDHU807MJNLIZF7UCJ8C-i-C9D6439B-dsk-F477344D-6c193ab9-p0-snap (253:14) \r\neuca-AIDHU807MJNLIZF7UCJ8C-i-C9D6439B-prt-00512swap-ac8d5670 (253:11) \r\neuca-AIDHTYISEIUBZHQTKQ7SA-i-347441BC-emi-B7ED33E9-8a9f90a7-p0-back (253:79) \r\neuca-AIDHMCVEC2DDT5C3NJO7B-i-F79640B2-dsk-F477344D-6c193ab9-p0-snap (253:29) \r\neuca-AIDHMCVEC2DDT5C3NJO7B-i-F79640B2-prt-00512swap-ac8d5670-p0-snap (253:26) \r\neuca-AIDG0UUPV7VVY2T57FNNK-i-F5E645E2-dsk-F477344D-6238dc41p3 (253:63) \r\neuca-zero (253:12) \r\neuca-AIDHMCVEC2DDT5C3NJO7B-i-F79640B2-emi-F477344D-8a9f90a7 (253:21) \r\neuca-AIDHTYISEIUBZHQTKQ7SA-i-347441BC-prt-00512swap-ac8d5670-p0-snap (253:86) \r\neuca-AIDG0UUPV7VVY2T57FNNK-i-F5E645E2-dsk-F477344D-6238dc41p2 (253:62) \r\neuca-AIDG0UUPV7VVY2T57FNNK-i-F5E645E2-prt-00512swap-ac8d5670-p0-snap (253:56) \r\neuca-AIDG0UUPV7VVY2T57FNNK-i-F5E645E2-emi-F477344D-1cde527d (253:51) \r\neuca-AIDG0UUPV7VVY2T57FNNK-i-F5E645E2-dsk-F477344D-6238dc41 (253:60) \r\neuca-AIDHTYISEIUBZHQTKQ7SA-i-347441BC-dsk-B7ED33E9-f6604bb3p3 (253:93) \r\neuca-AIDG0UUPV7VVY2T57FNNK-i-F5E645E2-dsk-F477344D-6238dc41p1 (253:61) \r\neuca-AIDHMCVEC2DDT5C3NJO7B-i-F79640B2-prt-02858ext3-5c099eef-p0-back (253:22) \r\neuca-AIDHTYISEIUBZHQTKQ7SA-i-347441BC-dsk-B7ED33E9-f6604bb3p2 (253:92) \r\neuca-AIDHMCVEC2DDT5C3NJO7B-i-F79640B2-dsk-F477344D-6c193ab9 (253:30) \r\neuca-AIDHMCVEC2DDT5C3NJO7B-i-F79640B2-prt-00512swap-ac8d5670 (253:27) \r\neuca-AIDHU807MJNLIZF7UCJ8C-i-C9D6439B-prt-00512swap-ac8d5670-p0-snap (253:10) \r\neuca-AIDHTYISEIUBZHQTKQ7SA-i-347441BC-prt-08078ext3-ef112f02-p0-back (253:82) \r\neuca-AIDHTYISEIUBZHQTKQ7SA-i-347441BC-dsk-B7ED33E9-f6604bb3p1 (253:91) \r\n[root@ecc-node-0 ~]#\r\n{code}\r\n\r\nOn a system with lots of churn, we could end up running out of loopback devices, as one such consequence problem. We need to be cleaning up after a failed instance termination. We know the instance termination has been requested, so either we continually try to clean up or we print an ERROR message warning the administrator of orphaned artifacts. So, two issues here:\r\n\r\n1) ulimit should be bumped up by us during install. The default is too low. \r\n2) We should clean up after ourselves, the NC process probably needs to retrospectively look at the state of the system and attempt a periodic purge\r\n\r\n*Workaround*\r\n\r\nUnknown/untested, but manually bumping up ulimit should help to eliminate at least a couple of the ERROR messages being thrown.\r\n\r\n*Affected Version*\r\n\r\n3.4.2\r\n\r\n*Network Mode*\r\n\r\nMANAGED\r\n\r\n*Environment*\r\n\r\nSeparate CLC/CC/Walrus/SC and 8 separate NC's.\r\n\r\n","customfield_13000":null,"customfield_13200":null,"customfield_11300":null,"customfield_11500":null,"timetracking":{},"customfield_10401":null,"customfield_10005":null,"customfield_10600":null,"customfield_12900":null,"aggregatetimeestimate":null,"attachment":[],"summary":"Node controller fails to remove artifacts from instance directory","creator":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=kedwards","name":"kedwards","key":"kedwards","accountId":"557058:f9c2f8da-1fc6-4aa7-8fb0-750e7e422b6b","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/d1746a6d05a30ca027012a7da4545962?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dkedwards%26avatarId%3D10200%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/d1746a6d05a30ca027012a7da4545962?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dkedwards%26avatarId%3D10200%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/d1746a6d05a30ca027012a7da4545962?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dkedwards%26avatarId%3D10200%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/d1746a6d05a30ca027012a7da4545962?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dkedwards%26avatarId%3D10200%26noRedirect%3Dtrue"},"displayName":"Ken Edwards","active":true,"timeZone":"America/Los_Angeles"},"subtasks":[],"reporter":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=kedwards","name":"kedwards","key":"kedwards","accountId":"557058:f9c2f8da-1fc6-4aa7-8fb0-750e7e422b6b","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/d1746a6d05a30ca027012a7da4545962?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dkedwards%26avatarId%3D10200%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/d1746a6d05a30ca027012a7da4545962?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dkedwards%26avatarId%3D10200%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/d1746a6d05a30ca027012a7da4545962?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dkedwards%26avatarId%3D10200%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/d1746a6d05a30ca027012a7da4545962?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dkedwards%26avatarId%3D10200%26noRedirect%3Dtrue"},"displayName":"Ken Edwards","active":true,"timeZone":"America/Los_Angeles"},"aggregateprogress":{"progress":0,"total":0},"customfield_10000":"5_*:*_1_*:*_0_*|*_10000_*:*_1_*:*_347276510_*|*_10001_*:*_1_*:*_82793697142","customfield_12100":"0|i02mc7:","customfield_10001":"2014-04-10T06:15:10.978-0500","customfield_10002":[{"self":"https://eucalyptus.atlassian.net/rest/api/2/customFieldOption/10000","value":"Customer Affecting","id":"10000"}],"customfield_10200":null,"customfield_10003":null,"customfield_12500":null,"customfield_10400":null,"customfield_10116":null,"customfield_11600":["dmitrii(dmitrii)","kedwards(kedwards)","lwade(lwade)"],"customfield_10117":null,"environment":null,"customfield_11800":null,"customfield_11802":null,"customfield_11805":null,"duedate":null,"progress":{"progress":0,"total":0},"customfield_11806":null,"votes":{"self":"https://eucalyptus.atlassian.net/rest/api/2/issue/EUCA-9069/votes","votes":1,"hasVoted":false},"comment":{"comments":[{"self":"https://eucalyptus.atlassian.net/rest/api/2/issue/28711/comment/66531","id":"66531","author":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=lwade","name":"lwade","key":"lwade","accountId":"557058:2fc477e4-c115-44ac-a23b-69acd1771151","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/beca0913accb99cac83a11f82082ef21?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dlwade%26avatarId%3D11103%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/beca0913accb99cac83a11f82082ef21?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dlwade%26avatarId%3D11103%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/beca0913accb99cac83a11f82082ef21?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dlwade%26avatarId%3D11103%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/beca0913accb99cac83a11f82082ef21?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dlwade%26avatarId%3D11103%26noRedirect%3Dtrue"},"displayName":"Lester Wade","active":true,"timeZone":"Europe/London"},"body":"{code}\r\n2014-04-10 04:21:49 INFO | [i-946F409E] copying/cloning blob eki-36273561-1dafb96b to blob JWMONTEH7DVYBQSPS1TZU/i-946F409E/eki-36273561-1dafb96b \r\n2014-04-10 04:21:49 INFO | copying data from '/var/lib/eucalyptus/instances/cache/eki-36273561-1dafb96b/blocks' \r\n2014-04-10 04:21:49 INFO | to '/var/lib/eucalyptus/instances/work/JWMONTEH7DVYBQSPS1TZU/i-946F409E/eki-36273561-1dafb96b.blocks' \r\n2014-04-10 04:21:49 INFO | of 249187 blocks (bs=16), seeking 0, skipping 0 \r\n2014-04-10 04:21:49 INFO | [i-946F409E] copying/cloning blob eri-61803208-dba64d69 to blob JWMONTEH7DVYBQSPS1TZU/i-946F409E/eri-61803208-dba64d69 \r\n2014-04-10 04:21:49 INFO | copying data from '/var/lib/eucalyptus/instances/cache/eri-61803208-dba64d69/blocks' \r\n2014-04-10 04:21:49 INFO | to '/var/lib/eucalyptus/instances/work/JWMONTEH7DVYBQSPS1TZU/i-946F409E/eri-61803208-dba64d69.blocks' \r\n2014-04-10 04:21:49 INFO | of 15864277 blocks (bs=1), seeking 0, skipping 0 \r\n2014-04-10 04:22:09 INFO | [i-946F409E] copying/cloning blob emi-F6B03091-66c907f9 to blob JWMONTEH7DVYBQSPS1TZU/i-946F409E/emi-F6B03091-3bfda72e \r\n2014-04-10 04:22:09 INFO | [i-946F409E] tuning root file system on disk 0 partition 1 \r\n2014-04-10 04:22:09 INFO | [i-946F409E] injecting the ssh key \r\n2014-04-10 04:22:09 INFO | [i-946F409E] copying/cloning blob prt-97981ext3-39fbbcc7 to blob JWMONTEH7DVYBQSPS1TZU/i-946F409E/prt-97981ext3-39fbbcc7 \r\n2014-04-10 04:22:09 INFO | [i-946F409E] copying/cloning blob prt-00512swap-ac8d5670 to blob JWMONTEH7DVYBQSPS1TZU/i-946F409E/prt-00512swap-ac8d5670 \r\n2014-04-10 04:22:09 INFO | [i-946F409E] constructing disk of size 107374214656 bytes in dsk-F6B03091-5159fe40 (/dev/loop24) \r\n2014-04-10 04:22:10 INFO | [i-946F409E] creating MBR \r\n2014-04-10 04:22:10 INFO | [i-946F409E] adding partition 1 to partition table (/dev/mapper/euca-JWMONTEH7DVYBQSPS1TZU-i-946F409E-dsk-F6B03091-5159fe40) \r\n2014-04-10 04:22:10 INFO | [i-946F409E] adding partition 2 to partition table (/dev/mapper/euca-JWMONTEH7DVYBQSPS1TZU-i-946F409E-dsk-F6B03091-5159fe40) \r\n2014-04-10 04:22:10 INFO | [i-946F409E] adding partition 3 to partition table (/dev/mapper/euca-JWMONTEH7DVYBQSPS1TZU-i-946F409E-dsk-F6B03091-5159fe40) \r\n2014-04-10 04:22:10 INFO | allocated new sensor resource i-946F409E \r\n2014-04-10 04:22:10 INFO | [i-946F409E] booting \r\n2014-04-10 04:27:26 INFO | [i-946F409E] termination requested \r\n2014-04-10 04:27:32 WARN | [i-946F409E] hypervisor reported previously running domain as Shutdown \r\n2014-04-10 04:27:32 INFO | [i-946F409E] cleaning up state for instance \r\n2014-04-10 04:27:33 ERROR | [i-946F409E] failed to remove some artifacts in /var/lib/eucalyptus/instances/work/JWMONTEH7DVYBQSPS1TZU/i-946F409E \r\n2014-04-10 04:27:33 WARN | [i-946F409E] failed to remove backing directory /var/lib/eucalyptus/instances/work/JWMONTEH7DVYBQSPS1TZU/i-946F409E \r\n2014-04-10 04:27:33 INFO | [i-946F409E] stopping the network (vlan=2078) \r\n2014-04-10 04:27:33 WARN | libvirt: Domain not found: no domain with matching name 'i-946F409E' (code=42) \r\n2014-04-10 04:27:33 INFO | [i-946F409E] instance terminated \r\n2014-04-10 04:30:34 INFO | [i-946F409E] forgetting about instance \r\n2014-04-10 05:33:43 INFO | expiring resource i-946F409E from sensor cache, no update in 3976 seconds, timeout is 3945 seconds \r\n2014-04-10 05:33:43 INFO | 1 resource entries expired from sensor cache\r\n{code}\r\n\r\nIf I look at /var/log/messages I see nothing out of the ordinary at this point in time:\r\n\r\n{code}\r\nApr 10 04:27:32 esclos59032 kernel: eucabr2078: port 2(vnet3) entering disabled state \r\nApr 10 04:27:32 esclos59032 kernel: device vnet3 left promiscuous mode \r\nApr 10 04:27:32 esclos59032 kernel: eucabr2078: port 2(vnet3) entering disabled state \r\nApr 10 04:27:33 esclos59032 kernel: eucabr2078: port 1(eth0.2078) entering disabled state \r\nApr 10 04:27:33 esclos59032 kernel: device eth0.2078 left promiscuous mode \r\nApr 10 04:27:33 esclos59032 kernel: eucabr2078: port 1(eth0.2078) entering disabled state \r\nApr 10 04:27:33 esclos59032 kernel: (null): Dropping TSO features since no CSUM feature. \r\nApr 10 04:27:33 esclos59032 kernel: (null): Dropping TSO6 features since no CSUM feature. \r\nApr 10 04:27:34 esclos59032 ntpd[6901]: Deleting interface #273 vnet3, fe80::fc0d:94ff:fe6f:409e#123, interface stats: received=0, sent=0, dropped=0, active_time=322 secs \r\nApr 10 04:27:34 esclos59032 ntpd[6901]: Deleting interface #272 eucabr2078, fe80::f292:1cff:fe02:4e80#123, interface stats: received=0, sent=0, dropped=0, active_time=343 secs \r\nApr 10 04:27:34 esclos59032 ntpd[6901]: Deleting interface #271 eth0.2078, fe80::f292:1cff:fe02:4e80#123, interface stats: received=0, sent=0, dropped=0, active_time=343 secs \r\nApr 10 04:27:34 esclos59032 ntpd[6901]: peers refreshed\r\n{code}\r\n\r\nHowever, if we look at the libvirt logs we see:\r\n\r\n{code}\r\n2014-04-10 01:22:10.218+0000: starting up \r\nLC_ALL=C PATH=/sbin:/usr/sbin:/bin:/usr/bin /usr/libexec/qemu-kvm -name i-946F409E -S -M rhel6.4.0 -enable-kvm -m 15360 -smp 4,sockets=4,cores=1,threads=1 -uuid 14ff0454-3558-fdcc-3af4-c575d003440c -nographic -nodefconfig -nodefaults -chardev socket,id=charmonitor,path=/var/lib/libvirt/qemu/i-946F409E.monitor,server,nowait -mon chardev=charmonitor,id=monitor,mode=control -rtc base=localtime -no-shutdown -kernel /var/lib/eucalyptus/instances/work/JWMONTEH7DVYBQSPS1TZU/i-946F409E/link-to-kernel -initrd /var/lib/eucalyptus/instances/work/JWMONTEH7DVYBQSPS1TZU/i-946F409E/link-to-ramdisk -append root=/dev/vda1 console=ttyS0 -device piix3-usb-uhci,id=usb,bus=pci.0,addr=0x1.0x2 -drive file=/var/lib/eucalyptus/instances/work/JWMONTEH7DVYBQSPS1TZU/i-946F409E/link-to-sda,if=none,id=drive-virtio-disk0,format=raw,cache=none -device virtio-blk-pci,scsi=off,bus=pci.0,addr=0x4,drive=drive-virtio-disk0,id=virtio-disk0,bootindex=1 -netdev tap,fd=23,id=hostnet0,vhost=on,vhostfd=26 -device virtio-net-pci,netdev=hostnet0,id=net0,mac=d0:0d:94:6f:40:9e,bus=pci.0,addr=0x3 -chardev file,id=charserial0,path=/var/lib/eucalyptus/instances/work/JWMONTEH7DVYBQSPS1TZU/i-946F409E/console.log -device isa-serial,chardev=charserial0,id=serial0 -device virtio-balloon-pci,id=balloon0,bus=pci.0,addr=0x5 \r\nqemu: terminating on signal 15 from pid 49031 \r\n2014-04-10 01:27:32.536+0000: shutting down\r\n{code}\r\n\r\nThe shutting down time is:\r\n\r\n{code}\r\n2014-04-10 01:27:32.536+0000: shutting down\r\n{code}\r\n\r\nI'm unsure of the significance of this, it doesn't make sense. 01:27 is not even UTC.\r\n\r\nLooking in the logs I don't see any loopback or device mapper entries still being consumed:\r\n\r\n{code}\r\nlwade@dreadnought:~/Downloads/esclos59032-2014041012291397122149/sos_commands> cat devicemapper/vgscan_-vvv | grep -i \"i-946F409E\" \r\nlwade@dreadnought:~/Downloads/esclos59032-2014041012291397122149/sos_commands>\r\n{code}\r\n\r\n{code}\r\nlwade@dreadnought:~/Downloads/esclos59032-2014041012291397122149/sos_commands/filesys> cat blkid_-c_.dev.null \r\n/dev/loop0: LABEL=\"79d3d2d4\" UUID=\"ae394be9-8ba0-4749-8f93-26283c8e2cc3\" TYPE=\"ext4\" \r\n/dev/loop2: UUID=\"84adb923-a281-4624-839d-ade28b36b3e7\" TYPE=\"ext3\" \r\n/dev/loop3: UUID=\"4027f44b-4d63-4193-8526-7c3b061716f6\" TYPE=\"swap\" \r\n/dev/loop6: LABEL=\"79d3d2d4\" UUID=\"ae394be9-8ba0-4749-8f93-26283c8e2cc3\" TYPE=\"ext4\" \r\n/dev/sdb1: UUID=\"cgSexq-M1Rk-618C-DCbU-P1o4-kwSl-X2GBk4\" TYPE=\"LVM2_member\" \r\n/dev/sda1: UUID=\"0ec69984-7953-4497-9056-49e51e8f2fb4\" TYPE=\"ext4\" \r\n/dev/sda2: UUID=\"VdRnk1-sYMo-y1EK-fxFM-bCnw-Yq2Q-597GJK\" TYPE=\"LVM2_member\" \r\n/dev/mapper/vg00-lvol1: UUID=\"1d29e810-cb5b-4a8e-97d2-b8c01603019e\" TYPE=\"ext4\" \r\n/dev/mapper/vg00-lvol2: UUID=\"de618c8d-6436-4d14-bfaa-b314dc9899af\" TYPE=\"swap\" \r\n/dev/mapper/vgdata-lvdata: UUID=\"661552c4-944f-40ce-9e85-03404a6e28c8\" TYPE=\"ext4\" \r\n/dev/mapper/vg00-lvol3: UUID=\"cfd296a5-a7ae-4a11-a0a8-093d664fea32\" TYPE=\"ext4\" \r\n/dev/loop8: UUID=\"40a3befa-bf1c-4bb6-a193-dbd3fb2120ab\" SEC_TYPE=\"ext2\" TYPE=\"ext3\" \r\n/dev/loop9: UUID=\"40a3befa-bf1c-4bb6-a193-dbd3fb2120ab\" TYPE=\"ext3\" \r\n/dev/loop10: UUID=\"612154b0-3973-4d81-9eb8-28a94d6f3214\" TYPE=\"swap\" \r\n/dev/mapper/euca-AID5GTGWISIWHHBI56U9J-i-352542F4-emi-52F839C3-04112434-p0-snap: LABEL=\"79d3d2d4\" UUID=\"ae394be9-8ba0-4749-8f93-26283c8e2cc3\" TYPE=\"ext4\" \r\n/dev/mapper/euca-AID5GTGWISIWHHBI56U9J-i-352542F4-emi-52F839C3-04112434: LABEL=\"79d3d2d4\" UUID=\"ae394be9-8ba0-4749-8f93-26283c8e2cc3\" TYPE=\"ext4\" \r\n/dev/mapper/euca-AID5GTGWISIWHHBI56U9J-i-352542F4-prt-00512swap-ac8d5670-p0-snap: UUID=\"4027f44b-4d63-4193-8526-7c3b061716f6\" TYPE=\"swap\" \r\n/dev/mapper/euca-AID5GTGWISIWHHBI56U9J-i-352542F4-prt-00512swap-ac8d5670: UUID=\"4027f44b-4d63-4193-8526-7c3b061716f6\" TYPE=\"swap\" \r\n/dev/mapper/euca-AID5GTGWISIWHHBI56U9J-i-352542F4-dsk-52F839C3-0f7475ecp1: LABEL=\"79d3d2d4\" UUID=\"ae394be9-8ba0-4749-8f93-26283c8e2cc3\" TYPE=\"ext4\" \r\n/dev/mapper/euca-AID5GTGWISIWHHBI56U9J-i-352542F4-dsk-52F839C3-0f7475ecp2: UUID=\"84adb923-a281-4624-839d-ade28b36b3e7\" TYPE=\"ext3\" \r\n/dev/mapper/euca-AID5GTGWISIWHHBI56U9J-i-352542F4-dsk-52F839C3-0f7475ecp3: UUID=\"4027f44b-4d63-4193-8526-7c3b061716f6\" TYPE=\"swap\" \r\n/dev/loop13: LABEL=\"rootdisk\" UUID=\"16be9d48-f04e-4c96-83a2-f471accec086\" TYPE=\"ext4\" \r\n/dev/mapper/euca-AIDJK1OIG1BVYTEHS4CDE-i-24084345-emi-52F839C3-7008d4e7-p0-snap: LABEL=\"79d3d2d4\" UUID=\"ae394be9-8ba0-4749-8f93-26283c8e2cc3\" TYPE=\"ext4\" \r\n/dev/mapper/euca-AIDJK1OIG1BVYTEHS4CDE-i-24084345-emi-52F839C3-7008d4e7: LABEL=\"79d3d2d4\" UUID=\"ae394be9-8ba0-4749-8f93-26283c8e2cc3\" TYPE=\"ext4\" \r\n/dev/mapper/euca-AIDJK1OIG1BVYTEHS4CDE-i-24084345-prt-93696ext3-094b47e6-p0-back: UUID=\"40a3befa-bf1c-4bb6-a193-dbd3fb2120ab\" TYPE=\"ext3\" \r\n/dev/mapper/euca-AIDJK1OIG1BVYTEHS4CDE-i-24084345-prt-93696ext3-094b47e6-p0-snap: UUID=\"40a3befa-bf1c-4bb6-a193-dbd3fb2120ab\" TYPE=\"ext3\" \r\n/dev/mapper/euca-AIDJK1OIG1BVYTEHS4CDE-i-24084345-prt-93696ext3-094b47e6: UUID=\"40a3befa-bf1c-4bb6-a193-dbd3fb2120ab\" TYPE=\"ext3\" \r\n/dev/mapper/euca-AIDJK1OIG1BVYTEHS4CDE-i-24084345-prt-00512swap-ac8d5670-p0-snap: UUID=\"612154b0-3973-4d81-9eb8-28a94d6f3214\" TYPE=\"swap\" \r\n/dev/mapper/euca-AIDJK1OIG1BVYTEHS4CDE-i-24084345-prt-00512swap-ac8d5670: UUID=\"612154b0-3973-4d81-9eb8-28a94d6f3214\" TYPE=\"swap\" \r\n/dev/mapper/euca-AIDJK1OIG1BVYTEHS4CDE-i-24084345-dsk-52F839C3-ec1e18afp1: LABEL=\"79d3d2d4\" UUID=\"ae394be9-8ba0-4749-8f93-26283c8e2cc3\" TYPE=\"ext4\" \r\n/dev/mapper/euca-AIDJK1OIG1BVYTEHS4CDE-i-24084345-dsk-52F839C3-ec1e18afp2: UUID=\"40a3befa-bf1c-4bb6-a193-dbd3fb2120ab\" TYPE=\"ext3\" \r\n/dev/mapper/euca-AIDJK1OIG1BVYTEHS4CDE-i-24084345-dsk-52F839C3-ec1e18afp3: UUID=\"612154b0-3973-4d81-9eb8-28a94d6f3214\" TYPE=\"swap\" \r\n/dev/loop15: UUID=\"5ca43c77-42dd-428a-9f21-433acc501395\" SEC_TYPE=\"ext2\" TYPE=\"ext3\" \r\n/dev/loop16: UUID=\"5ca43c77-42dd-428a-9f21-433acc501395\" TYPE=\"ext3\" \r\n/dev/mapper/euca-AIDSVRYVHJ38XDGV7PBBN-i-8DCA3A3D-emi-B18F332B-4b1c12e7-p0-snap: LABEL=\"rootdisk\" UUID=\"16be9d48-f04e-4c96-83a2-f471accec086\" TYPE=\"ext4\" \r\n/dev/mapper/euca-AIDSVRYVHJ38XDGV7PBBN-i-8DCA3A3D-emi-B18F332B-4b1c12e7: LABEL=\"rootdisk\" UUID=\"16be9d48-f04e-4c96-83a2-f471accec086\" TYPE=\"ext4\" \r\n/dev/mapper/euca-AIDSVRYVHJ38XDGV7PBBN-i-8DCA3A3D-prt-86263ext3-b202ccb0-p0-back: UUID=\"5ca43c77-42dd-428a-9f21-433acc501395\" TYPE=\"ext3\" \r\n/dev/mapper/euca-AIDSVRYVHJ38XDGV7PBBN-i-8DCA3A3D-prt-86263ext3-b202ccb0-p0-snap: UUID=\"5ca43c77-42dd-428a-9f21-433acc501395\" TYPE=\"ext3\" \r\n/dev/mapper/euca-AIDSVRYVHJ38XDGV7PBBN-i-8DCA3A3D-prt-86263ext3-b202ccb0: UUID=\"5ca43c77-42dd-428a-9f21-433acc501395\" TYPE=\"ext3\" \r\n/dev/mapper/euca-AIDSVRYVHJ38XDGV7PBBN-i-8DCA3A3D-prt-00512swap-ac8d5670-p0-snap: UUID=\"612154b0-3973-4d81-9eb8-28a94d6f3214\" TYPE=\"swap\" \r\n/dev/mapper/euca-AIDSVRYVHJ38XDGV7PBBN-i-8DCA3A3D-prt-00512swap-ac8d5670: UUID=\"612154b0-3973-4d81-9eb8-28a94d6f3214\" TYPE=\"swap\" \r\n/dev/mapper/euca-AIDSVRYVHJ38XDGV7PBBN-i-8DCA3A3D-dsk-B18F332B-fe78d7f1p1: LABEL=\"rootdisk\" UUID=\"16be9d48-f04e-4c96-83a2-f471accec086\" TYPE=\"ext4\" \r\n/dev/mapper/euca-AIDSVRYVHJ38XDGV7PBBN-i-8DCA3A3D-dsk-B18F332B-fe78d7f1p2: UUID=\"5ca43c77-42dd-428a-9f21-433acc501395\" TYPE=\"ext3\" \r\n/dev/mapper/euca-AIDSVRYVHJ38XDGV7PBBN-i-8DCA3A3D-dsk-B18F332B-fe78d7f1p3: UUID=\"612154b0-3973-4d81-9eb8-28a94d6f3214\" TYPE=\"swap\"\r\n{code}\r\n\r\nIt looks like a dependent call fails:\r\n\r\n{code}\r\n# ls -al /var/lib/eucalyptus/instances/work/JWMONTEH7DVYBQSPS1TZU/i-946F409E \r\ntotal 19408 \r\ndrwxrwx--x 2 eucalyptus root 4096 Apr 10 04:27 . \r\ndrwxrwx--x 3 eucalyptus root 4096 Apr 10 04:21 .. \r\n-rw-rw---- 1 root root 3986992 Apr 10 04:21 eki-36273561-1dafb96b.blocks \r\n-rw-rw---- 1 eucalyptus eucalyptus 0 Apr 10 04:27 eki-36273561-1dafb96b.lock \r\n-rw-rw---- 1 eucalyptus eucalyptus 21 Apr 10 04:21 eki-36273561-1dafb96b.sig \r\n-rw-rw---- 1 root root 15864277 Apr 10 04:22 eri-61803208-dba64d69.blocks \r\n-rw-rw---- 1 eucalyptus eucalyptus 0 Apr 10 04:27 eri-61803208-dba64d69.lock \r\n-rw-rw---- 1 eucalyptus eucalyptus 21 Apr 10 04:21 eri-61803208-dba64d69.sig \r\n{code}\r\n\r\nSo the eki and eri components are left behind. I run the following on each of these artifacts:\r\n\r\n{code}\r\n$ for i in `cat bits.txt`; do grep -r -i \"$i\"; done\r\n$\r\n{code}\r\n\r\nThey *only* show in the nc.log. So it seems like these were probably in-use when we tried to remove them and thus it failed (note the .lock files). So, are we trying to remove the components too quickly?\r\n\r\n{code}\r\nLooks like the code path is in vbr.c:\r\n\r\n// unmount partition and delete the mount point \r\nif (diskutil_umount(mnt_pt) != EUCA_OK) { \r\nLOGERROR(\"[%s] failed to unmount %s (there may be a resource leak)\\n\", a->instanceId, mnt_pt); \r\ninjection_failed = 1; \r\n} \r\nif (rmdir(mnt_pt) != 0) { \r\nLOGERROR(\"[%s] failed to remove %s (there may be a resource leak): %s\\n\", a->instanceId, mnt_pt, strerror(errno)); \r\ninjection_failed = 1;\r\n{code}\r\n\r\nI'm suggesting that we try to remove the directory too quickly after the unmount.\r\n\r\nLooking at the unmount dependency, in diskutil.c we see a rootwrap call to umount the loopback:\r\n\r\n{code}\r\nint diskutil_umount(const char *dev) \r\n{ \r\nchar *output = NULL;\r\n\r\nif (dev) { \r\nsem_p(loop_sem); \r\n{ \r\noutput = pruntf(TRUE, \"%s %s umount %s\", helpers_path[ROOTWRAP], helpers_path[MOUNTWRAP], dev); \r\n} \r\nsem_v(loop_sem);\r\n\r\nif (!output) { \r\nLOGERROR(\"cannot unmount device '%s'\\n\", dev); \r\nreturn (EUCA_ERROR); \r\n}\r\n{code}\r\n\r\nThis would print a message if it had failed; we're not seeing this. This suggests the umount runs correctly and so its more of a timing issue.\r\n\r\nNote that this code is identical in both 3.4.2 and 4.0.0.\r\n","updateAuthor":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=lwade","name":"lwade","key":"lwade","accountId":"557058:2fc477e4-c115-44ac-a23b-69acd1771151","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/beca0913accb99cac83a11f82082ef21?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Dlwade%26avatarId%3D11103%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/beca0913accb99cac83a11f82082ef21?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Dlwade%26avatarId%3D11103%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/beca0913accb99cac83a11f82082ef21?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Dlwade%26avatarId%3D11103%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/beca0913accb99cac83a11f82082ef21?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Dlwade%26avatarId%3D11103%26noRedirect%3Dtrue"},"displayName":"Lester Wade","active":true,"timeZone":"Europe/London"},"created":"2014-04-10T06:23:28.752-0500","updated":"2014-04-14T13:47:39.799-0500"},{"self":"https://eucalyptus.atlassian.net/rest/api/2/issue/28711/comment/75129","id":"75129","author":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=dmitrii","name":"dmitrii","key":"dmitrii","accountId":"557058:1e0ea807-434b-4b54-967f-1dec4a9ede55","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/efb56b507e22d4fc0d8d5e900e5651d5?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Ddmitrii%26avatarId%3D15900%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/efb56b507e22d4fc0d8d5e900e5651d5?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Ddmitrii%26avatarId%3D15900%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/efb56b507e22d4fc0d8d5e900e5651d5?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Ddmitrii%26avatarId%3D15900%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/efb56b507e22d4fc0d8d5e900e5651d5?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Ddmitrii%26avatarId%3D15900%26noRedirect%3Dtrue"},"displayName":"Dmitrii Calzago","active":false,"timeZone":"America/Los_Angeles"},"body":"Regarding the two solutions proposed:\r\n\r\n1) *Bumping up ulimit:* Completed in 4.0.1 (EUCA-9557). From everything I see in the logs above, that's the root cause of all the errors. When a critical resource is exhausted, the NC is unable to function reliably, leaving around artifacts. With the higher limit, I think this ticket should be considered resolved.\r\n\r\n2) *Periodic integrity checks:* I am filing an enhancement request: EUCA-9888.","updateAuthor":{"self":"https://eucalyptus.atlassian.net/rest/api/2/user?username=dmitrii","name":"dmitrii","key":"dmitrii","accountId":"557058:1e0ea807-434b-4b54-967f-1dec4a9ede55","avatarUrls":{"48x48":"https://avatar-cdn.atlassian.com/efb56b507e22d4fc0d8d5e900e5651d5?s=48&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3FownerId%3Ddmitrii%26avatarId%3D15900%26noRedirect%3Dtrue","24x24":"https://avatar-cdn.atlassian.com/efb56b507e22d4fc0d8d5e900e5651d5?s=24&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dsmall%26ownerId%3Ddmitrii%26avatarId%3D15900%26noRedirect%3Dtrue","16x16":"https://avatar-cdn.atlassian.com/efb56b507e22d4fc0d8d5e900e5651d5?s=16&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dxsmall%26ownerId%3Ddmitrii%26avatarId%3D15900%26noRedirect%3Dtrue","32x32":"https://avatar-cdn.atlassian.com/efb56b507e22d4fc0d8d5e900e5651d5?s=32&d=https%3A%2F%2Feucalyptus.atlassian.net%2Fsecure%2Fuseravatar%3Fsize%3Dmedium%26ownerId%3Ddmitrii%26avatarId%3D15900%26noRedirect%3Dtrue"},"displayName":"Dmitrii Calzago","active":false,"timeZone":"America/Los_Angeles"},"created":"2014-08-18T17:46:17.991-0500","updated":"2014-08-18T17:46:17.991-0500"}],"maxResults":2,"total":2,"startAt":0},"customfield_11808":null,"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]}}}