*** ./clc/modules/walrus/src/main/java/edu/ucsb/eucalyptus/cloud/ws/WalrusImageManager.java	2010-08-22 10:53:44.000000000 -0700
--- ./clc/modules/walrus/src/main/java/edu/ucsb/eucalyptus/cloud/ws/WalrusImageManager.java.new	2010-09-21 09:06:04.000000000 -0700
***************
*** 230,242 ****
  					if(isAdministrator) {
  						try {
  							boolean verified = false;
  							for(User user:Users.listAllUsers( )) {
! 								X509Certificate cert = user.getX509Certificate( );
! 								if(cert != null)
  									verified = canVerifySignature(sigVerifier, cert, signature, verificationString);
  								if(verified)
  									break;
  							}
  							if(!verified) {
  								X509Certificate cert = SystemCredentialProvider.getCredentialProvider(Component.eucalyptus).getCertificate();
  								if(cert != null)
--- 230,248 ----
  					if(isAdministrator) {
  						try {
  							boolean verified = false;
+ 							
  							for(User user:Users.listAllUsers( )) {
! 								// Try to verify signature against all available user certificates
! 								for(X509Certificate cert:user.getAllX509Certificates( )){
  									verified = canVerifySignature(sigVerifier, cert, signature, verificationString);
+ 									if(verified)
+ 										break;
+ 								}
+ 
  								if(verified)
  									break;
  							}
+ 
  							if(!verified) {
  								X509Certificate cert = SystemCredentialProvider.getCredentialProvider(Component.eucalyptus).getCertificate();
  								if(cert != null)
***************
*** 259,266 ****
  							throw new AccessDeniedException(userId,e);            
  						}         
  						try {
! 							X509Certificate cert = user.getX509Certificate( );
! 							signatureVerified = canVerifySignature(sigVerifier, cert, signature, verificationString);
  						} catch(Exception ex) {
  							db.rollback();
  							LOG.error(ex, ex);
--- 265,276 ----
  							throw new AccessDeniedException(userId,e);            
  						}         
  						try {
! 							// Try to verify signature against all available user certificates
! 							for(X509Certificate cert:user.getAllX509Certificates( )){
! 								signatureVerified = canVerifySignature(sigVerifier, cert, signature, verificationString);
! 								if(signatureVerified)
! 									break;
! 							}
  						} catch(Exception ex) {
  							db.rollback();
  							LOG.error(ex, ex);
