{
	"AWSTemplateFormatVersion":"2010-09-09",
	"Parameters":{
		"ImageId":{
			"Description":"Image id",
			"Type":"String"
		}
	},
	"Resources":{
		"LaunchConfig":{
			"Type":"AWS::AutoScaling::LaunchConfiguration",
			"Properties":{
				"ImageId":{
					"Ref":"ImageId"
				},
				"InstanceType":"m1.small",
				"BlockDeviceMappings":[
					{
						"DeviceName":"/dev/sdc",
						"VirtualName":"ephemeral0"
					},
					{
						"DeviceName":"/dev/sdc",
						"Ebs":{
							"VolumeSize":"10"
						}
					}
				],
				"SecurityGroups":[
					{
						"Ref":"InstanceSecurityGroup"
					}
				]
			}
		},
		"ASG1":{
			"UpdatePolicy":{
				"AutoScalingRollingUpdate":{
					"MinInstancesInService":"1",
					"MaxBatchSize":"1",
					"PauseTime":"PT12M5S"
				}
			},
			"Type":"AWS::AutoScaling::AutoScalingGroup",
			"Properties":{
				"AvailabilityZones":{
					"Fn::GetAZs":{
						"Ref":"AWS::Region"
					}
				},
				"LaunchConfigurationName":{
					"Ref":"LaunchConfig"
				},
				"MaxSize":"3",
				"MinSize":"1"
			}
		},
		"ScaleUpPolicy":{
			"Type":"AWS::AutoScaling::ScalingPolicy",
			"Properties":{
				"AdjustmentType":"ChangeInCapacity",
				"AutoScalingGroupName":{
					"Ref":"ASG1"
				},
				"Cooldown":"1",
				"ScalingAdjustment":"1"
			}
		},
		"CPUAlarmHigh":{
			"Type":"AWS::CloudWatch::Alarm",
			"Properties":{
				"EvaluationPeriods":"1",
				"Statistic":"Average",
				"Threshold":"10",
				"AlarmDescription":"Alarm if CPU too high or metric disappears indicating instance is down",
				"Period":"60",
				"AlarmActions":[
					{
						"Ref":"ScaleUpPolicy"
					}
				],
				"Namespace":"AWS/EC2",
				"Dimensions":[
					{
						"Name":"AutoScalingGroupName",
						"Value":{
							"Ref":"ASG1"
						}
					}
				],
				"ComparisonOperator":"GreaterThanThreshold",
				"MetricName":"CPUUtilization"
			}
		},
		"InstanceSecurityGroup":{
			"Type":"AWS::EC2::SecurityGroup",
			"Properties":{
				"GroupDescription":"Cloudformation Group",
				"SecurityGroupIngress":[
					{
						"IpProtocol":"tcp",
						"FromPort":"22",
						"ToPort":"22",
						"CidrIp":"0.0.0.0/0"
					}
				]
			}
		},
		"IngressRule":{
			"Type":"AWS::EC2::SecurityGroupIngress",
			"Properties":{
				"GroupName":{
					"Ref":"InstanceSecurityGroup"
				},
				"FromPort":"80",
				"ToPort":"80",
				"IpProtocol":"tcp",
				"SourceSecurityGroupName":{
					"Ref":"InstanceSecurityGroup"
				}
			}
               }

	}
}
