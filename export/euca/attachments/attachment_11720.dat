#!/usr/bin/python

import urllib2
import sys

timeout = 2
url = "http://169.254.169.254/latest/meta-data/instance-id"
sleeps = 10

if len(sys.argv) > 1:
    url = sys.argv[1]
if len(sys.argv) > 2:
    if sys.argv[2] == "unset":
        timeout = "unset"
    elif sys.argv[2] == "None":
        timeout = None
    else:
        timeout = float(sys.argv[2])

print "attempting %s with timeout=%s" % (url, timeout)

for x in range(sleeps):
    # given 100 sleeps, this ends up total sleep time of 1050 sec
    sleeptime=int(x/5)+1

    reason = ""
    try:
        req = urllib2.Request(url)
        if timeout == "unset":
            resp = urllib2.urlopen(req)
        else:
            resp = urllib2.urlopen(req, timeout=timeout)
        content = resp.read()
        if content == "":
            reason = "empty data [%s]" % resp.getcode()
    except urllib2.HTTPError as e:
        reason = "http error [%s]" % e.code
    except urllib2.URLError as e:
        reason = "url error [%s]" % e.reason

    if reason == "":
        print "Looks good"
        sys.exit(0)
    else:
        print "failed, %s" % reason

sys.exit(1)
